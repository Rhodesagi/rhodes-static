{"version":3,"file":"index-Be1x309M.js","sources":["../../src/engine/math.ts","../../src/engine/renderer.ts","../../src/engine/input.ts","../../src/engine/audio.ts","../../src/game/musket.ts","../../src/game/bayonet.ts","../../src/game/opponent.ts","../../src/game/weapon-view.ts","../../src/game/sprites.ts","../../src/game/maps.ts","../../src/game/game.ts","../../src/main.ts"],"sourcesContent":["// Mathematical utilities for the engine\n\nimport { Vec2, Vec3 } from './types';\n\nexport const PI = Math.PI;\nexport const TWO_PI = Math.PI * 2;\nexport const HALF_PI = Math.PI / 2;\nexport const DEG_TO_RAD = Math.PI / 180;\nexport const RAD_TO_DEG = 180 / Math.PI;\n\n// Vector operations\nexport function vec2(x: number = 0, y: number = 0): Vec2 {\n  return { x, y };\n}\n\nexport function vec3(x: number = 0, y: number = 0, z: number = 0): Vec3 {\n  return { x, y, z };\n}\n\nexport function vec2Add(a: Vec2, b: Vec2): Vec2 {\n  return { x: a.x + b.x, y: a.y + b.y };\n}\n\nexport function vec2Sub(a: Vec2, b: Vec2): Vec2 {\n  return { x: a.x - b.x, y: a.y - b.y };\n}\n\nexport function vec2Scale(v: Vec2, s: number): Vec2 {\n  return { x: v.x * s, y: v.y * s };\n}\n\nexport function vec2Length(v: Vec2): number {\n  return Math.sqrt(v.x * v.x + v.y * v.y);\n}\n\nexport function vec2Normalize(v: Vec2): Vec2 {\n  const len = vec2Length(v);\n  if (len === 0) return { x: 0, y: 0 };\n  return { x: v.x / len, y: v.y / len };\n}\n\nexport function vec2Dot(a: Vec2, b: Vec2): number {\n  return a.x * b.x + a.y * b.y;\n}\n\nexport function vec2Distance(a: Vec2, b: Vec2): number {\n  const dx = b.x - a.x;\n  const dy = b.y - a.y;\n  return Math.sqrt(dx * dx + dy * dy);\n}\n\nexport function vec2Rotate(v: Vec2, angle: number): Vec2 {\n  const cos = Math.cos(angle);\n  const sin = Math.sin(angle);\n  return {\n    x: v.x * cos - v.y * sin,\n    y: v.x * sin + v.y * cos\n  };\n}\n\nexport function vec2FromAngle(angle: number): Vec2 {\n  return { x: Math.cos(angle), y: Math.sin(angle) };\n}\n\nexport function vec2Angle(v: Vec2): number {\n  return Math.atan2(v.y, v.x);\n}\n\nexport function vec2Lerp(a: Vec2, b: Vec2, t: number): Vec2 {\n  return {\n    x: a.x + (b.x - a.x) * t,\n    y: a.y + (b.y - a.y) * t\n  };\n}\n\n// 3D vector operations\nexport function vec3Add(a: Vec3, b: Vec3): Vec3 {\n  return { x: a.x + b.x, y: a.y + b.y, z: a.z + b.z };\n}\n\nexport function vec3Sub(a: Vec3, b: Vec3): Vec3 {\n  return { x: a.x - b.x, y: a.y - b.y, z: a.z - b.z };\n}\n\nexport function vec3Scale(v: Vec3, s: number): Vec3 {\n  return { x: v.x * s, y: v.y * s, z: v.z * s };\n}\n\nexport function vec3Length(v: Vec3): number {\n  return Math.sqrt(v.x * v.x + v.y * v.y + v.z * v.z);\n}\n\nexport function vec3Normalize(v: Vec3): Vec3 {\n  const len = vec3Length(v);\n  if (len === 0) return { x: 0, y: 0, z: 0 };\n  return { x: v.x / len, y: v.y / len, z: v.z / len };\n}\n\nexport function vec3Dot(a: Vec3, b: Vec3): number {\n  return a.x * b.x + a.y * b.y + a.z * b.z;\n}\n\nexport function vec3Cross(a: Vec3, b: Vec3): Vec3 {\n  return {\n    x: a.y * b.z - a.z * b.y,\n    y: a.z * b.x - a.x * b.z,\n    z: a.x * b.y - a.y * b.x\n  };\n}\n\nexport function vec3Lerp(a: Vec3, b: Vec3, t: number): Vec3 {\n  return {\n    x: a.x + (b.x - a.x) * t,\n    y: a.y + (b.y - a.y) * t,\n    z: a.z + (b.z - a.z) * t\n  };\n}\n\n// Angle utilities\nexport function normalizeAngle(angle: number): number {\n  while (angle < 0) angle += TWO_PI;\n  while (angle >= TWO_PI) angle -= TWO_PI;\n  return angle;\n}\n\nexport function angleDifference(a: number, b: number): number {\n  let diff = normalizeAngle(b - a);\n  if (diff > PI) diff -= TWO_PI;\n  return diff;\n}\n\nexport function lerpAngle(a: number, b: number, t: number): number {\n  const diff = angleDifference(a, b);\n  return normalizeAngle(a + diff * t);\n}\n\n// General math utilities\nexport function clamp(value: number, min: number, max: number): number {\n  return Math.max(min, Math.min(max, value));\n}\n\nexport function lerp(a: number, b: number, t: number): number {\n  return a + (b - a) * t;\n}\n\nexport function smoothstep(edge0: number, edge1: number, x: number): number {\n  const t = clamp((x - edge0) / (edge1 - edge0), 0, 1);\n  return t * t * (3 - 2 * t);\n}\n\nexport function smootherstep(edge0: number, edge1: number, x: number): number {\n  const t = clamp((x - edge0) / (edge1 - edge0), 0, 1);\n  return t * t * t * (t * (t * 6 - 15) + 10);\n}\n\nexport function inverseLerp(a: number, b: number, value: number): number {\n  if (a === b) return 0;\n  return (value - a) / (b - a);\n}\n\nexport function remap(value: number, inMin: number, inMax: number, outMin: number, outMax: number): number {\n  return lerp(outMin, outMax, inverseLerp(inMin, inMax, value));\n}\n\nexport function randomRange(min: number, max: number): number {\n  return min + Math.random() * (max - min);\n}\n\nexport function randomInt(min: number, max: number): number {\n  return Math.floor(randomRange(min, max + 1));\n}\n\nexport function randomChoice<T>(array: T[]): T {\n  return array[Math.floor(Math.random() * array.length)];\n}\n\nexport function shuffle<T>(array: T[]): T[] {\n  const result = [...array];\n  for (let i = result.length - 1; i > 0; i--) {\n    const j = Math.floor(Math.random() * (i + 1));\n    [result[i], result[j]] = [result[j], result[i]];\n  }\n  return result;\n}\n\n// Easing functions\nexport const ease = {\n  linear: (t: number) => t,\n  quadIn: (t: number) => t * t,\n  quadOut: (t: number) => t * (2 - t),\n  quadInOut: (t: number) => t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t,\n  cubicIn: (t: number) => t * t * t,\n  cubicOut: (t: number) => (--t) * t * t + 1,\n  cubicInOut: (t: number) => t < 0.5 ? 4 * t * t * t : (t - 1) * (2 * t - 2) * (2 * t - 2) + 1,\n  elasticOut: (t: number) => {\n    const p = 0.3;\n    return Math.pow(2, -10 * t) * Math.sin((t - p / 4) * (2 * PI) / p) + 1;\n  },\n  bounceOut: (t: number) => {\n    if (t < 1 / 2.75) return 7.5625 * t * t;\n    if (t < 2 / 2.75) return 7.5625 * (t -= 1.5 / 2.75) * t + 0.75;\n    if (t < 2.5 / 2.75) return 7.5625 * (t -= 2.25 / 2.75) * t + 0.9375;\n    return 7.5625 * (t -= 2.625 / 2.75) * t + 0.984375;\n  }\n};\n\n// Noise functions for procedural generation\nexport class SimplexNoise {\n  private perm: number[] = [];\n\n  constructor(seed: number = Math.random() * 65536) {\n    const p: number[] = [];\n    for (let i = 0; i < 256; i++) p[i] = i;\n\n    // Fisher-Yates shuffle with seed\n    let s = seed;\n    for (let i = 255; i > 0; i--) {\n      s = (s * 16807) % 2147483647;\n      const j = s % (i + 1);\n      [p[i], p[j]] = [p[j], p[i]];\n    }\n\n    for (let i = 0; i < 512; i++) {\n      this.perm[i] = p[i & 255];\n    }\n  }\n\n  noise2D(x: number, y: number): number {\n    const F2 = 0.5 * (Math.sqrt(3) - 1);\n    const G2 = (3 - Math.sqrt(3)) / 6;\n\n    const s = (x + y) * F2;\n    const i = Math.floor(x + s);\n    const j = Math.floor(y + s);\n\n    const t = (i + j) * G2;\n    const X0 = i - t;\n    const Y0 = j - t;\n    const x0 = x - X0;\n    const y0 = y - Y0;\n\n    let i1: number, j1: number;\n    if (x0 > y0) { i1 = 1; j1 = 0; }\n    else { i1 = 0; j1 = 1; }\n\n    const x1 = x0 - i1 + G2;\n    const y1 = y0 - j1 + G2;\n    const x2 = x0 - 1 + 2 * G2;\n    const y2 = y0 - 1 + 2 * G2;\n\n    const ii = i & 255;\n    const jj = j & 255;\n\n    let n0 = 0, n1 = 0, n2 = 0;\n\n    let t0 = 0.5 - x0 * x0 - y0 * y0;\n    if (t0 >= 0) {\n      t0 *= t0;\n      n0 = t0 * t0 * this.grad2(this.perm[ii + this.perm[jj]], x0, y0);\n    }\n\n    let t1 = 0.5 - x1 * x1 - y1 * y1;\n    if (t1 >= 0) {\n      t1 *= t1;\n      n1 = t1 * t1 * this.grad2(this.perm[ii + i1 + this.perm[jj + j1]], x1, y1);\n    }\n\n    let t2 = 0.5 - x2 * x2 - y2 * y2;\n    if (t2 >= 0) {\n      t2 *= t2;\n      n2 = t2 * t2 * this.grad2(this.perm[ii + 1 + this.perm[jj + 1]], x2, y2);\n    }\n\n    return 70 * (n0 + n1 + n2);\n  }\n\n  private grad2(hash: number, x: number, y: number): number {\n    const h = hash & 7;\n    const u = h < 4 ? x : y;\n    const v = h < 4 ? y : x;\n    return ((h & 1) ? -u : u) + ((h & 2) ? -2 * v : 2 * v);\n  }\n\n  fbm(x: number, y: number, octaves: number = 4, lacunarity: number = 2, persistence: number = 0.5): number {\n    let value = 0;\n    let amplitude = 1;\n    let frequency = 1;\n    let maxValue = 0;\n\n    for (let i = 0; i < octaves; i++) {\n      value += amplitude * this.noise2D(x * frequency, y * frequency);\n      maxValue += amplitude;\n      amplitude *= persistence;\n      frequency *= lacunarity;\n    }\n\n    return value / maxValue;\n  }\n}\n","// Core raycasting renderer with advanced features\n\nimport { Vec2, RayHit, Player, Sprite, GameMap, RenderConfig, Texture, LightingData } from './types';\nimport { vec2, vec2FromAngle, vec2Length, vec2Normalize, vec2Sub, clamp, lerp } from './math';\n\nexport class Renderer {\n  private canvas: HTMLCanvasElement;\n  private ctx: CanvasRenderingContext2D;\n  private imageData: ImageData;\n  private pixels: Uint32Array;\n  private depthBuffer: Float32Array;\n  private textures: Map<string, Texture> = new Map();\n  private config: RenderConfig;\n\n  // Pre-computed tables for performance\n  private cosTable: Float32Array;\n  private sinTable: Float32Array;\n  private tanTable: Float32Array;\n  private fisheyeCorrection: Float32Array;\n\n  constructor(canvas: HTMLCanvasElement, config: RenderConfig) {\n    this.canvas = canvas;\n    this.config = config;\n\n    canvas.width = config.width;\n    canvas.height = config.height;\n\n    const ctx = canvas.getContext('2d', { alpha: false });\n    if (!ctx) throw new Error('Could not get 2D context');\n    this.ctx = ctx;\n\n    this.imageData = ctx.createImageData(config.width, config.height);\n    this.pixels = new Uint32Array(this.imageData.data.buffer);\n    this.depthBuffer = new Float32Array(config.width);\n\n    // Pre-compute lookup tables\n    const tableSize = 3600; // 0.1 degree precision\n    this.cosTable = new Float32Array(tableSize);\n    this.sinTable = new Float32Array(tableSize);\n    this.tanTable = new Float32Array(tableSize);\n\n    for (let i = 0; i < tableSize; i++) {\n      const angle = (i / tableSize) * Math.PI * 2;\n      this.cosTable[i] = Math.cos(angle);\n      this.sinTable[i] = Math.sin(angle);\n      this.tanTable[i] = Math.tan(angle);\n    }\n\n    // Fisheye correction for each column\n    this.fisheyeCorrection = new Float32Array(config.width);\n    const halfWidth = config.width / 2;\n    const fovRad = config.fov * Math.PI / 180;\n    for (let x = 0; x < config.width; x++) {\n      const rayAngle = Math.atan2(x - halfWidth, halfWidth / Math.tan(fovRad / 2));\n      this.fisheyeCorrection[x] = Math.cos(rayAngle);\n    }\n  }\n\n  async loadTexture(id: string, url: string): Promise<void> {\n    return new Promise((resolve, reject) => {\n      const img = new Image();\n      img.onload = () => {\n        const tempCanvas = document.createElement('canvas');\n        tempCanvas.width = img.width;\n        tempCanvas.height = img.height;\n        const tempCtx = tempCanvas.getContext('2d')!;\n        tempCtx.drawImage(img, 0, 0);\n        const imgData = tempCtx.getImageData(0, 0, img.width, img.height);\n\n        // Convert to Uint32Array for fast pixel access\n        const data = new Uint32Array(img.width * img.height);\n        const srcData = imgData.data;\n        for (let i = 0; i < data.length; i++) {\n          const j = i * 4;\n          // ABGR format for little-endian systems\n          data[i] = (srcData[j + 3] << 24) | (srcData[j + 2] << 16) | (srcData[j + 1] << 8) | srcData[j];\n        }\n\n        this.textures.set(id, {\n          id,\n          width: img.width,\n          height: img.height,\n          data,\n          image: img\n        });\n        resolve();\n      };\n      img.onerror = reject;\n      img.src = url;\n    });\n  }\n\n  generateProceduralTexture(id: string, width: number, height: number, generator: (x: number, y: number) => [number, number, number, number]): void {\n    const data = new Uint32Array(width * height);\n    for (let y = 0; y < height; y++) {\n      for (let x = 0; x < width; x++) {\n        const [r, g, b, a] = generator(x, y);\n        data[y * width + x] = (a << 24) | (b << 16) | (g << 8) | r;\n      }\n    }\n    this.textures.set(id, { id, width, height, data });\n  }\n\n  registerTexture(id: string, texture: Texture): void {\n    this.textures.set(id, texture);\n  }\n\n  clear(r: number, g: number, b: number): void {\n    const color = (255 << 24) | (b << 16) | (g << 8) | r;\n    this.pixels.fill(color);\n    this.depthBuffer.fill(Infinity);\n  }\n\n  renderSkyAndFloor(player: Player, map: GameMap): void {\n    const { width, height } = this.config;\n    const halfHeight = height / 2;\n    const pitchOffset = player.pitch * height / 2;\n    const horizonY = halfHeight + pitchOffset;\n\n    // Sky gradient\n    const skyTop: [number, number, number] = [135, 180, 220];\n    const skyHorizon: [number, number, number] = [200, 220, 240];\n\n    // Floor/ground color\n    const groundNear: [number, number, number] = [80, 60, 40];\n    const groundFar: [number, number, number] = [60, 50, 35];\n\n    for (let y = 0; y < height; y++) {\n      const rowOffset = y * width;\n\n      if (y < horizonY) {\n        // Sky\n        const t = y / horizonY;\n        const r = Math.floor(lerp(skyTop[0], skyHorizon[0], t));\n        const g = Math.floor(lerp(skyTop[1], skyHorizon[1], t));\n        const b = Math.floor(lerp(skyTop[2], skyHorizon[2], t));\n        const color = (255 << 24) | (b << 16) | (g << 8) | r;\n\n        for (let x = 0; x < width; x++) {\n          this.pixels[rowOffset + x] = color;\n        }\n      } else {\n        // Floor with distance fog\n        const floorDist = (height - horizonY) / (y - horizonY + 0.001);\n        const fogFactor = Math.min(1, floorDist / this.config.renderDistance);\n        const t = clamp(fogFactor, 0, 1);\n\n        const r = Math.floor(lerp(groundNear[0], groundFar[0], t));\n        const g = Math.floor(lerp(groundNear[1], groundFar[1], t));\n        const b = Math.floor(lerp(groundNear[2], groundFar[2], t));\n        const color = (255 << 24) | (b << 16) | (g << 8) | r;\n\n        for (let x = 0; x < width; x++) {\n          this.pixels[rowOffset + x] = color;\n        }\n      }\n    }\n  }\n\n  castRay(map: GameMap, startX: number, startY: number, angle: number): RayHit | null {\n    const dirX = Math.cos(angle);\n    const dirY = Math.sin(angle);\n\n    let mapX = Math.floor(startX);\n    let mapY = Math.floor(startY);\n\n    const deltaDistX = Math.abs(1 / dirX);\n    const deltaDistY = Math.abs(1 / dirY);\n\n    let stepX: number, stepY: number;\n    let sideDistX: number, sideDistY: number;\n\n    if (dirX < 0) {\n      stepX = -1;\n      sideDistX = (startX - mapX) * deltaDistX;\n    } else {\n      stepX = 1;\n      sideDistX = (mapX + 1 - startX) * deltaDistX;\n    }\n\n    if (dirY < 0) {\n      stepY = -1;\n      sideDistY = (startY - mapY) * deltaDistY;\n    } else {\n      stepY = 1;\n      sideDistY = (mapY + 1 - startY) * deltaDistY;\n    }\n\n    let side: 0 | 1 = 0;\n    let hit = false;\n    let maxSteps = 100;\n\n    while (!hit && maxSteps-- > 0) {\n      if (sideDistX < sideDistY) {\n        sideDistX += deltaDistX;\n        mapX += stepX;\n        side = 0;\n      } else {\n        sideDistY += deltaDistY;\n        mapY += stepY;\n        side = 1;\n      }\n\n      if (mapX < 0 || mapX >= map.width || mapY < 0 || mapY >= map.height) {\n        return null;\n      }\n\n      if (map.tiles[mapY][mapX] > 0) {\n        hit = true;\n      }\n    }\n\n    if (!hit) return null;\n\n    let perpWallDist: number;\n    let wallX: number;\n\n    if (side === 0) {\n      perpWallDist = (mapX - startX + (1 - stepX) / 2) / dirX;\n      wallX = startY + perpWallDist * dirY;\n    } else {\n      perpWallDist = (mapY - startY + (1 - stepY) / 2) / dirY;\n      wallX = startX + perpWallDist * dirX;\n    }\n    wallX -= Math.floor(wallX);\n\n    const tileType = map.tiles[mapY][mapX];\n\n    // Calculate texture X coordinate\n    let textureX = wallX;\n    if ((side === 0 && dirX > 0) || (side === 1 && dirY < 0)) {\n      textureX = 1 - textureX;\n    }\n\n    return {\n      distance: perpWallDist,\n      wallX,\n      side,\n      mapX,\n      mapY,\n      tileType,\n      textureX\n    };\n  }\n\n  renderWalls(player: Player, map: GameMap): void {\n    const { width, height, fov, renderDistance } = this.config;\n    const halfHeight = height / 2;\n    const fovRad = fov * Math.PI / 180;\n    const pitchOffset = player.pitch * height / 2;\n\n    for (let x = 0; x < width; x++) {\n      // Calculate ray angle for this column\n      const cameraX = 2 * x / width - 1;\n      const rayAngle = player.angle + Math.atan(cameraX * Math.tan(fovRad / 2));\n\n      const hit = this.castRay(map, player.x, player.y, rayAngle);\n\n      if (!hit) {\n        this.depthBuffer[x] = Infinity;\n        continue;\n      }\n\n      // Apply fisheye correction\n      const correctedDist = hit.distance * this.fisheyeCorrection[x];\n      this.depthBuffer[x] = correctedDist;\n\n      if (correctedDist > renderDistance) continue;\n\n      // Calculate wall height\n      const wallHeight = Math.floor(height / correctedDist);\n      const drawStart = Math.max(0, Math.floor(halfHeight - wallHeight / 2 + pitchOffset));\n      const drawEnd = Math.min(height - 1, Math.floor(halfHeight + wallHeight / 2 + pitchOffset));\n\n      // Get texture\n      const textureId = this.getTextureForTile(hit.tileType);\n      const texture = this.textures.get(textureId);\n\n      if (!texture) {\n        // Fallback solid color\n        const shade = hit.side === 1 ? 0.7 : 1.0;\n        const fog = 1 - Math.min(1, correctedDist / renderDistance);\n        const brightness = Math.floor(128 * shade * fog);\n        const color = (255 << 24) | (brightness << 16) | (brightness << 8) | brightness;\n\n        for (let y = drawStart; y <= drawEnd; y++) {\n          this.pixels[y * width + x] = color;\n        }\n        continue;\n      }\n\n      // Textured wall rendering\n      const texX = Math.floor(hit.textureX * texture.width) & (texture.width - 1);\n      const step = texture.height / wallHeight;\n      let texPos = (drawStart - pitchOffset - halfHeight + wallHeight / 2) * step;\n\n      const shade = hit.side === 1 ? 0.7 : 1.0;\n      const fogFactor = 1 - Math.min(1, correctedDist / renderDistance);\n\n      for (let y = drawStart; y <= drawEnd; y++) {\n        const texY = Math.floor(texPos) & (texture.height - 1);\n        texPos += step;\n\n        let pixel = texture.data[texY * texture.width + texX];\n\n        // Apply shading and fog\n        let r = (pixel & 0xFF);\n        let g = (pixel >> 8) & 0xFF;\n        let b = (pixel >> 16) & 0xFF;\n\n        r = Math.floor(r * shade * fogFactor);\n        g = Math.floor(g * shade * fogFactor);\n        b = Math.floor(b * shade * fogFactor);\n\n        this.pixels[y * width + x] = (255 << 24) | (b << 16) | (g << 8) | r;\n      }\n    }\n  }\n\n  renderSprite(sprite: Sprite, player: Player): void {\n    const { width, height } = this.config;\n    const halfHeight = height / 2;\n    const pitchOffset = player.pitch * height / 2;\n\n    // Calculate sprite position relative to player\n    const dx = sprite.x - player.x;\n    const dy = sprite.y - player.y;\n\n    // Transform sprite with camera matrix\n    const invDet = 1.0 / (Math.cos(player.angle + Math.PI / 2) * Math.sin(player.angle) -\n      Math.cos(player.angle) * Math.sin(player.angle + Math.PI / 2));\n\n    const transformX = invDet * (Math.sin(player.angle) * dx - Math.cos(player.angle) * dy);\n    const transformY = invDet * (-Math.sin(player.angle + Math.PI / 2) * dx +\n      Math.cos(player.angle + Math.PI / 2) * dy);\n\n    if (transformY <= 0.1) return; // Behind player\n\n    const spriteScreenX = Math.floor((width / 2) * (1 + transformX / transformY));\n\n    // Calculate sprite dimensions\n    const spriteHeight = Math.abs(Math.floor(height / transformY)) * sprite.scale;\n    const spriteWidth = spriteHeight; // Square sprites for now\n\n    const drawStartY = Math.floor(halfHeight - spriteHeight / 2 + pitchOffset + sprite.z * height / transformY);\n    const drawEndY = Math.floor(halfHeight + spriteHeight / 2 + pitchOffset + sprite.z * height / transformY);\n    const drawStartX = Math.floor(spriteScreenX - spriteWidth / 2);\n    const drawEndX = Math.floor(spriteScreenX + spriteWidth / 2);\n\n    const texture = this.textures.get(sprite.texture);\n    if (!texture) return;\n\n    // Handle directional sprites\n    let frameOffsetX = 0;\n    if (sprite.directional && sprite.directions) {\n      const angleToSprite = Math.atan2(dy, dx);\n      let relativeAngle = angleToSprite - (sprite as any).angle;\n      while (relativeAngle < 0) relativeAngle += Math.PI * 2;\n      while (relativeAngle >= Math.PI * 2) relativeAngle -= Math.PI * 2;\n      const direction = Math.floor(relativeAngle / (Math.PI * 2 / sprite.directions));\n      frameOffsetX = direction * (texture.width / sprite.directions);\n    }\n\n    // Handle animation frames\n    if (sprite.animated && sprite.frames) {\n      frameOffsetX += (sprite.currentFrame || 0) * (texture.width / sprite.frames);\n    }\n\n    const fogFactor = 1 - Math.min(1, transformY / this.config.renderDistance);\n\n    for (let stripe = drawStartX; stripe < drawEndX; stripe++) {\n      if (stripe < 0 || stripe >= width) continue;\n      if (transformY >= this.depthBuffer[stripe]) continue;\n\n      const texX = Math.floor((stripe - drawStartX) / spriteWidth * (texture.width / (sprite.frames || 1))) + frameOffsetX;\n\n      for (let y = Math.max(0, drawStartY); y < Math.min(height, drawEndY); y++) {\n        const texY = Math.floor((y - drawStartY) / spriteHeight * texture.height);\n        const pixel = texture.data[texY * texture.width + (texX & (texture.width - 1))];\n\n        // Check alpha\n        const alpha = (pixel >> 24) & 0xFF;\n        if (alpha < 128) continue;\n\n        let r = (pixel & 0xFF);\n        let g = (pixel >> 8) & 0xFF;\n        let b = (pixel >> 16) & 0xFF;\n\n        r = Math.floor(r * fogFactor);\n        g = Math.floor(g * fogFactor);\n        b = Math.floor(b * fogFactor);\n\n        this.pixels[y * width + stripe] = (255 << 24) | (b << 16) | (g << 8) | r;\n      }\n    }\n  }\n\n  renderSprites(sprites: Sprite[], player: Player): void {\n    // Sort sprites by distance (far to near)\n    const sortedSprites = sprites\n      .map(sprite => ({\n        sprite,\n        distance: (sprite.x - player.x) ** 2 + (sprite.y - player.y) ** 2\n      }))\n      .sort((a, b) => b.distance - a.distance);\n\n    for (const { sprite } of sortedSprites) {\n      this.renderSprite(sprite, player);\n    }\n  }\n\n  private getTextureForTile(tileType: number): string {\n    const textureMap: Record<number, string> = {\n      1: 'wall_brick',\n      2: 'wall_stone',\n      3: 'wall_wood',\n      4: 'wall_plaster',\n      5: 'wall_hedge'\n    };\n    return textureMap[tileType] || 'wall_brick';\n  }\n\n  present(): void {\n    this.ctx.putImageData(this.imageData, 0, 0);\n  }\n\n  getDepthAt(screenX: number): number {\n    if (screenX < 0 || screenX >= this.config.width) return Infinity;\n    return this.depthBuffer[Math.floor(screenX)];\n  }\n\n  drawRect(x: number, y: number, w: number, h: number, r: number, g: number, b: number, a: number = 255): void {\n    const color = (a << 24) | (b << 16) | (g << 8) | r;\n    const { width, height } = this.config;\n\n    const x1 = Math.max(0, Math.floor(x));\n    const y1 = Math.max(0, Math.floor(y));\n    const x2 = Math.min(width, Math.floor(x + w));\n    const y2 = Math.min(height, Math.floor(y + h));\n\n    for (let py = y1; py < y2; py++) {\n      const rowOffset = py * width;\n      for (let px = x1; px < x2; px++) {\n        if (a === 255) {\n          this.pixels[rowOffset + px] = color;\n        } else {\n          // Alpha blending\n          const dst = this.pixels[rowOffset + px];\n          const dstR = dst & 0xFF;\n          const dstG = (dst >> 8) & 0xFF;\n          const dstB = (dst >> 16) & 0xFF;\n          const alpha = a / 255;\n          const invAlpha = 1 - alpha;\n          const blendR = Math.floor(r * alpha + dstR * invAlpha);\n          const blendG = Math.floor(g * alpha + dstG * invAlpha);\n          const blendB = Math.floor(b * alpha + dstB * invAlpha);\n          this.pixels[rowOffset + px] = (255 << 24) | (blendB << 16) | (blendG << 8) | blendR;\n        }\n      }\n    }\n  }\n\n  getWidth(): number { return this.config.width; }\n  getHeight(): number { return this.config.height; }\n  getConfig(): RenderConfig { return this.config; }\n}\n","// Input handling with mouse look and keyboard controls\n\nimport { InputState } from './types';\n\nexport class InputManager {\n  private state: InputState = {\n    forward: false,\n    backward: false,\n    left: false,\n    right: false,\n    turnLeft: false,\n    turnRight: false,\n    fire: false,\n    aim: false,\n    reload: false,\n    bayonet: false,\n    crouch: false,\n    sprint: false,\n    interact: false,\n    mouseX: 0,\n    mouseY: 0,\n    mouseDeltaX: 0,\n    mouseDeltaY: 0,\n    mouseDown: false,\n    rightMouseDown: false\n  };\n\n  private canvas: HTMLCanvasElement;\n  private isPointerLocked: boolean = false;\n  private sensitivity: number = 0.002;\n  private invertY: boolean = false;\n\n  // Key bindings (customizable)\n  private bindings: Record<string, keyof InputState> = {\n    'KeyW': 'forward',\n    'ArrowUp': 'forward',\n    'KeyS': 'backward',\n    'ArrowDown': 'backward',\n    'KeyA': 'left',\n    'ArrowLeft': 'left',\n    'KeyD': 'right',\n    'ArrowRight': 'right',\n    'KeyQ': 'turnLeft',\n    'KeyE': 'turnRight',\n    'KeyR': 'reload',\n    'KeyB': 'bayonet',\n    'KeyC': 'crouch',\n    'ControlLeft': 'crouch',\n    'ShiftLeft': 'sprint',\n    'KeyF': 'interact',\n    'Space': 'interact'\n  };\n\n  constructor(canvas: HTMLCanvasElement) {\n    this.canvas = canvas;\n    this.setupEventListeners();\n  }\n\n  private setupEventListeners(): void {\n    // Keyboard events\n    document.addEventListener('keydown', this.handleKeyDown.bind(this));\n    document.addEventListener('keyup', this.handleKeyUp.bind(this));\n\n    // Mouse events\n    this.canvas.addEventListener('click', this.requestPointerLock.bind(this));\n    document.addEventListener('pointerlockchange', this.handlePointerLockChange.bind(this));\n    document.addEventListener('mousemove', this.handleMouseMove.bind(this));\n    document.addEventListener('mousedown', this.handleMouseDown.bind(this));\n    document.addEventListener('mouseup', this.handleMouseUp.bind(this));\n\n    // Prevent context menu on right click\n    this.canvas.addEventListener('contextmenu', (e) => e.preventDefault());\n\n    // Handle focus loss\n    window.addEventListener('blur', this.resetState.bind(this));\n  }\n\n  private handleKeyDown(event: KeyboardEvent): void {\n    // Prevent default for game keys\n    if (this.bindings[event.code]) {\n      event.preventDefault();\n    }\n\n    const binding = this.bindings[event.code];\n    if (binding && typeof this.state[binding] === 'boolean') {\n      (this.state as any)[binding] = true;\n    }\n\n    // Handle escape to exit pointer lock\n    if (event.code === 'Escape' && this.isPointerLocked) {\n      document.exitPointerLock();\n    }\n  }\n\n  private handleKeyUp(event: KeyboardEvent): void {\n    const binding = this.bindings[event.code];\n    if (binding && typeof this.state[binding] === 'boolean') {\n      (this.state as any)[binding] = false;\n    }\n  }\n\n  private handleMouseMove(event: MouseEvent): void {\n    if (!this.isPointerLocked) return;\n\n    this.state.mouseDeltaX = event.movementX * this.sensitivity;\n    this.state.mouseDeltaY = event.movementY * this.sensitivity * (this.invertY ? -1 : 1);\n\n    this.state.mouseX += this.state.mouseDeltaX;\n    this.state.mouseY += this.state.mouseDeltaY;\n  }\n\n  private handleMouseDown(event: MouseEvent): void {\n    if (!this.isPointerLocked) return;\n\n    if (event.button === 0) {\n      this.state.fire = true;\n      this.state.mouseDown = true;\n    } else if (event.button === 2) {\n      this.state.aim = true;\n      this.state.rightMouseDown = true;\n    }\n  }\n\n  private handleMouseUp(event: MouseEvent): void {\n    if (event.button === 0) {\n      this.state.fire = false;\n      this.state.mouseDown = false;\n    } else if (event.button === 2) {\n      this.state.aim = false;\n      this.state.rightMouseDown = false;\n    }\n  }\n\n  private requestPointerLock(): void {\n    this.canvas.requestPointerLock();\n  }\n\n  private handlePointerLockChange(): void {\n    this.isPointerLocked = document.pointerLockElement === this.canvas;\n\n    if (!this.isPointerLocked) {\n      this.resetState();\n    }\n  }\n\n  private resetState(): void {\n    this.state = {\n      forward: false,\n      backward: false,\n      left: false,\n      right: false,\n      turnLeft: false,\n      turnRight: false,\n      fire: false,\n      aim: false,\n      reload: false,\n      bayonet: false,\n      crouch: false,\n      sprint: false,\n      interact: false,\n      mouseX: this.state.mouseX,\n      mouseY: this.state.mouseY,\n      mouseDeltaX: 0,\n      mouseDeltaY: 0,\n      mouseDown: false,\n      rightMouseDown: false\n    };\n  }\n\n  update(): void {\n    // Reset mouse deltas after they've been consumed\n    this.state.mouseDeltaX = 0;\n    this.state.mouseDeltaY = 0;\n  }\n\n  getState(): InputState {\n    return { ...this.state };\n  }\n\n  isLocked(): boolean {\n    return this.isPointerLocked;\n  }\n\n  setSensitivity(value: number): void {\n    this.sensitivity = Math.max(0.0001, Math.min(0.01, value));\n  }\n\n  setInvertY(value: boolean): void {\n    this.invertY = value;\n  }\n\n  setBinding(key: string, action: keyof InputState): void {\n    this.bindings[key] = action;\n  }\n\n  getBindings(): Record<string, keyof InputState> {\n    return { ...this.bindings };\n  }\n}\n","// Professional audio system with 3D positioning and procedural generation\n\nexport interface SoundConfig {\n  volume: number;\n  loop: boolean;\n  pitch: number;\n  pitchVariation: number;\n  fadeIn: number;\n  fadeOut: number;\n  spatial: boolean;\n  maxDistance: number;\n  rolloffFactor: number;\n}\n\nconst DEFAULT_SOUND_CONFIG: SoundConfig = {\n  volume: 1.0,\n  loop: false,\n  pitch: 1.0,\n  pitchVariation: 0,\n  fadeIn: 0,\n  fadeOut: 0,\n  spatial: false,\n  maxDistance: 50,\n  rolloffFactor: 1\n};\n\nexport class AudioSystem {\n  private ctx: AudioContext;\n  private masterGain: GainNode;\n  private sfxGain: GainNode;\n  private musicGain: GainNode;\n  private ambientGain: GainNode;\n\n  private buffers: Map<string, AudioBuffer> = new Map();\n  private activeSounds: Map<string, AudioBufferSourceNode[]> = new Map();\n  private listener: { x: number; y: number; angle: number } = { x: 0, y: 0, angle: 0 };\n\n  // For procedural audio\n  private noiseBuffer: AudioBuffer | null = null;\n\n  constructor() {\n    this.ctx = new AudioContext();\n\n    // Create gain nodes for mixing\n    this.masterGain = this.ctx.createGain();\n    this.masterGain.connect(this.ctx.destination);\n\n    this.sfxGain = this.ctx.createGain();\n    this.sfxGain.connect(this.masterGain);\n\n    this.musicGain = this.ctx.createGain();\n    this.musicGain.connect(this.masterGain);\n\n    this.ambientGain = this.ctx.createGain();\n    this.ambientGain.connect(this.masterGain);\n\n    // Generate noise buffer for procedural sounds\n    this.generateNoiseBuffer();\n  }\n\n  private generateNoiseBuffer(): void {\n    const bufferSize = this.ctx.sampleRate * 2; // 2 seconds of noise\n    this.noiseBuffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);\n    const data = this.noiseBuffer.getChannelData(0);\n\n    for (let i = 0; i < bufferSize; i++) {\n      data[i] = Math.random() * 2 - 1;\n    }\n  }\n\n  async loadSound(id: string, url: string): Promise<void> {\n    try {\n      const response = await fetch(url);\n      const arrayBuffer = await response.arrayBuffer();\n      const audioBuffer = await this.ctx.decodeAudioData(arrayBuffer);\n      this.buffers.set(id, audioBuffer);\n    } catch (error) {\n      console.warn(`Failed to load sound: ${id}`, error);\n    }\n  }\n\n  play(id: string, config: Partial<SoundConfig> = {}): AudioBufferSourceNode | null {\n    const buffer = this.buffers.get(id);\n    if (!buffer) {\n      console.warn(`Sound not found: ${id}`);\n      return null;\n    }\n\n    const cfg = { ...DEFAULT_SOUND_CONFIG, ...config };\n\n    const source = this.ctx.createBufferSource();\n    source.buffer = buffer;\n    source.loop = cfg.loop;\n\n    // Apply pitch with variation\n    const pitchVariation = cfg.pitchVariation > 0\n      ? (Math.random() - 0.5) * 2 * cfg.pitchVariation\n      : 0;\n    source.playbackRate.value = cfg.pitch + pitchVariation;\n\n    // Create gain node for this sound\n    const gainNode = this.ctx.createGain();\n    gainNode.gain.value = cfg.volume;\n\n    source.connect(gainNode);\n    gainNode.connect(this.sfxGain);\n\n    // Fade in\n    if (cfg.fadeIn > 0) {\n      gainNode.gain.setValueAtTime(0, this.ctx.currentTime);\n      gainNode.gain.linearRampToValueAtTime(cfg.volume, this.ctx.currentTime + cfg.fadeIn);\n    }\n\n    source.start();\n\n    // Track active sounds\n    if (!this.activeSounds.has(id)) {\n      this.activeSounds.set(id, []);\n    }\n    this.activeSounds.get(id)!.push(source);\n\n    source.onended = () => {\n      const sounds = this.activeSounds.get(id);\n      if (sounds) {\n        const index = sounds.indexOf(source);\n        if (index > -1) sounds.splice(index, 1);\n      }\n    };\n\n    return source;\n  }\n\n  playSpatial(id: string, x: number, y: number, config: Partial<SoundConfig> = {}): AudioBufferSourceNode | null {\n    const buffer = this.buffers.get(id);\n    if (!buffer) return null;\n\n    const cfg = { ...DEFAULT_SOUND_CONFIG, spatial: true, ...config };\n\n    // Calculate distance and pan\n    const dx = x - this.listener.x;\n    const dy = y - this.listener.y;\n    const distance = Math.sqrt(dx * dx + dy * dy);\n\n    if (distance > cfg.maxDistance) return null;\n\n    // Calculate volume based on distance\n    const volumeMultiplier = Math.max(0, 1 - (distance / cfg.maxDistance) ** cfg.rolloffFactor);\n\n    // Calculate stereo pan based on angle to source\n    const angleToSource = Math.atan2(dy, dx);\n    const relativeAngle = angleToSource - this.listener.angle;\n    const pan = Math.sin(relativeAngle);\n\n    const source = this.ctx.createBufferSource();\n    source.buffer = buffer;\n\n    const pitchVariation = cfg.pitchVariation > 0\n      ? (Math.random() - 0.5) * 2 * cfg.pitchVariation\n      : 0;\n    source.playbackRate.value = cfg.pitch + pitchVariation;\n\n    const gainNode = this.ctx.createGain();\n    gainNode.gain.value = cfg.volume * volumeMultiplier;\n\n    const panNode = this.ctx.createStereoPanner();\n    panNode.pan.value = pan;\n\n    source.connect(gainNode);\n    gainNode.connect(panNode);\n    panNode.connect(this.sfxGain);\n\n    source.start();\n    return source;\n  }\n\n  // Procedural musket shot sound\n  playMusketShot(x: number, y: number): void {\n    const now = this.ctx.currentTime;\n\n    // Calculate spatial factors\n    const dx = x - this.listener.x;\n    const dy = y - this.listener.y;\n    const distance = Math.sqrt(dx * dx + dy * dy);\n    const volumeMultiplier = Math.max(0.1, 1 - distance / 100);\n\n    // Main explosion\n    const explosionOsc = this.ctx.createOscillator();\n    explosionOsc.type = 'sawtooth';\n    explosionOsc.frequency.setValueAtTime(150, now);\n    explosionOsc.frequency.exponentialRampToValueAtTime(30, now + 0.15);\n\n    const explosionGain = this.ctx.createGain();\n    explosionGain.gain.setValueAtTime(0.8 * volumeMultiplier, now);\n    explosionGain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);\n\n    const explosionFilter = this.ctx.createBiquadFilter();\n    explosionFilter.type = 'lowpass';\n    explosionFilter.frequency.setValueAtTime(2000, now);\n    explosionFilter.frequency.exponentialRampToValueAtTime(200, now + 0.15);\n\n    explosionOsc.connect(explosionFilter);\n    explosionFilter.connect(explosionGain);\n    explosionGain.connect(this.sfxGain);\n\n    explosionOsc.start(now);\n    explosionOsc.stop(now + 0.25);\n\n    // Crack/snap component\n    if (this.noiseBuffer) {\n      const crackSource = this.ctx.createBufferSource();\n      crackSource.buffer = this.noiseBuffer;\n\n      const crackGain = this.ctx.createGain();\n      crackGain.gain.setValueAtTime(0.4 * volumeMultiplier, now);\n      crackGain.gain.exponentialRampToValueAtTime(0.01, now + 0.05);\n\n      const crackFilter = this.ctx.createBiquadFilter();\n      crackFilter.type = 'highpass';\n      crackFilter.frequency.value = 3000;\n\n      crackSource.connect(crackFilter);\n      crackFilter.connect(crackGain);\n      crackGain.connect(this.sfxGain);\n\n      crackSource.start(now);\n      crackSource.stop(now + 0.08);\n    }\n\n    // Low thump\n    const thumpOsc = this.ctx.createOscillator();\n    thumpOsc.type = 'sine';\n    thumpOsc.frequency.setValueAtTime(80, now);\n    thumpOsc.frequency.exponentialRampToValueAtTime(20, now + 0.3);\n\n    const thumpGain = this.ctx.createGain();\n    thumpGain.gain.setValueAtTime(0.6 * volumeMultiplier, now);\n    thumpGain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);\n\n    thumpOsc.connect(thumpGain);\n    thumpGain.connect(this.sfxGain);\n\n    thumpOsc.start(now);\n    thumpOsc.stop(now + 0.35);\n\n    // Reverb tail (simulated with delayed noise)\n    if (this.noiseBuffer && distance < 50) {\n      const reverbSource = this.ctx.createBufferSource();\n      reverbSource.buffer = this.noiseBuffer;\n\n      const reverbGain = this.ctx.createGain();\n      reverbGain.gain.setValueAtTime(0, now);\n      reverbGain.gain.linearRampToValueAtTime(0.15 * volumeMultiplier, now + 0.05);\n      reverbGain.gain.exponentialRampToValueAtTime(0.01, now + 1.5);\n\n      const reverbFilter = this.ctx.createBiquadFilter();\n      reverbFilter.type = 'lowpass';\n      reverbFilter.frequency.value = 800;\n\n      reverbSource.connect(reverbFilter);\n      reverbFilter.connect(reverbGain);\n      reverbGain.connect(this.sfxGain);\n\n      reverbSource.start(now + 0.02);\n      reverbSource.stop(now + 1.5);\n    }\n  }\n\n  // Bayonet clash sound\n  playBayonetClash(): void {\n    const now = this.ctx.currentTime;\n\n    // Metal clang\n    const clangOsc = this.ctx.createOscillator();\n    clangOsc.type = 'triangle';\n    clangOsc.frequency.setValueAtTime(800 + Math.random() * 400, now);\n    clangOsc.frequency.exponentialRampToValueAtTime(200, now + 0.3);\n\n    const clangGain = this.ctx.createGain();\n    clangGain.gain.setValueAtTime(0.3, now);\n    clangGain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);\n\n    clangOsc.connect(clangGain);\n    clangGain.connect(this.sfxGain);\n\n    clangOsc.start(now);\n    clangOsc.stop(now + 0.35);\n\n    // Secondary ring\n    const ringOsc = this.ctx.createOscillator();\n    ringOsc.type = 'sine';\n    ringOsc.frequency.setValueAtTime(1200 + Math.random() * 300, now);\n\n    const ringGain = this.ctx.createGain();\n    ringGain.gain.setValueAtTime(0.15, now);\n    ringGain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);\n\n    ringOsc.connect(ringGain);\n    ringGain.connect(this.sfxGain);\n\n    ringOsc.start(now);\n    ringOsc.stop(now + 0.55);\n  }\n\n  // Footstep sound\n  playFootstep(surface: 'dirt' | 'wood' | 'stone' = 'dirt'): void {\n    const now = this.ctx.currentTime;\n\n    if (!this.noiseBuffer) return;\n\n    const footstepSource = this.ctx.createBufferSource();\n    footstepSource.buffer = this.noiseBuffer;\n\n    const gain = this.ctx.createGain();\n    const filter = this.ctx.createBiquadFilter();\n\n    switch (surface) {\n      case 'dirt':\n        filter.type = 'lowpass';\n        filter.frequency.value = 400;\n        gain.gain.setValueAtTime(0.15, now);\n        break;\n      case 'wood':\n        filter.type = 'bandpass';\n        filter.frequency.value = 800;\n        gain.gain.setValueAtTime(0.2, now);\n        break;\n      case 'stone':\n        filter.type = 'highpass';\n        filter.frequency.value = 500;\n        gain.gain.setValueAtTime(0.12, now);\n        break;\n    }\n\n    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);\n\n    footstepSource.connect(filter);\n    filter.connect(gain);\n    gain.connect(this.sfxGain);\n\n    footstepSource.start(now);\n    footstepSource.stop(now + 0.12);\n  }\n\n  // Impact/hit sound\n  playImpact(type: 'flesh' | 'metal' | 'wood' = 'flesh'): void {\n    const now = this.ctx.currentTime;\n\n    const impactOsc = this.ctx.createOscillator();\n    impactOsc.type = 'sine';\n\n    const gain = this.ctx.createGain();\n\n    switch (type) {\n      case 'flesh':\n        impactOsc.frequency.setValueAtTime(100, now);\n        impactOsc.frequency.exponentialRampToValueAtTime(40, now + 0.1);\n        gain.gain.setValueAtTime(0.4, now);\n        break;\n      case 'metal':\n        impactOsc.frequency.setValueAtTime(600, now);\n        impactOsc.frequency.exponentialRampToValueAtTime(100, now + 0.15);\n        gain.gain.setValueAtTime(0.25, now);\n        break;\n      case 'wood':\n        impactOsc.frequency.setValueAtTime(200, now);\n        impactOsc.frequency.exponentialRampToValueAtTime(60, now + 0.12);\n        gain.gain.setValueAtTime(0.3, now);\n        break;\n    }\n\n    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);\n\n    impactOsc.connect(gain);\n    gain.connect(this.sfxGain);\n\n    impactOsc.start(now);\n    impactOsc.stop(now + 0.2);\n\n    // Add noise component\n    if (this.noiseBuffer) {\n      const noiseSource = this.ctx.createBufferSource();\n      noiseSource.buffer = this.noiseBuffer;\n\n      const noiseGain = this.ctx.createGain();\n      noiseGain.gain.setValueAtTime(0.2, now);\n      noiseGain.gain.exponentialRampToValueAtTime(0.01, now + 0.08);\n\n      const noiseFilter = this.ctx.createBiquadFilter();\n      noiseFilter.type = 'lowpass';\n      noiseFilter.frequency.value = type === 'flesh' ? 500 : 2000;\n\n      noiseSource.connect(noiseFilter);\n      noiseFilter.connect(noiseGain);\n      noiseGain.connect(this.sfxGain);\n\n      noiseSource.start(now);\n      noiseSource.stop(now + 0.1);\n    }\n  }\n\n  // Reload mechanical sounds\n  playReloadStep(step: string): void {\n    const now = this.ctx.currentTime;\n\n    switch (step) {\n      case 'half_cock':\n        this.playMechanicalClick(0.3, 400);\n        break;\n      case 'handle_cartridge':\n        this.playRustleSound(0.1);\n        break;\n      case 'bite_cartridge':\n        this.playMechanicalClick(0.15, 200);\n        break;\n      case 'prime_pan':\n        this.playPowderSound();\n        break;\n      case 'close_frizzen':\n        this.playMechanicalClick(0.25, 600);\n        break;\n      case 'pour_powder':\n        this.playPowderSound();\n        break;\n      case 'draw_ramrod':\n        this.playMetalSlide(true);\n        break;\n      case 'ram_charge':\n        this.playRammingSound();\n        break;\n      case 'return_ramrod':\n        this.playMetalSlide(false);\n        break;\n    }\n  }\n\n  private playMechanicalClick(volume: number, frequency: number): void {\n    const now = this.ctx.currentTime;\n\n    const osc = this.ctx.createOscillator();\n    osc.type = 'square';\n    osc.frequency.setValueAtTime(frequency, now);\n    osc.frequency.exponentialRampToValueAtTime(frequency * 0.5, now + 0.05);\n\n    const gain = this.ctx.createGain();\n    gain.gain.setValueAtTime(volume, now);\n    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.05);\n\n    osc.connect(gain);\n    gain.connect(this.sfxGain);\n\n    osc.start(now);\n    osc.stop(now + 0.06);\n  }\n\n  private playRustleSound(volume: number): void {\n    if (!this.noiseBuffer) return;\n\n    const now = this.ctx.currentTime;\n    const source = this.ctx.createBufferSource();\n    source.buffer = this.noiseBuffer;\n\n    const gain = this.ctx.createGain();\n    gain.gain.setValueAtTime(volume, now);\n    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);\n\n    const filter = this.ctx.createBiquadFilter();\n    filter.type = 'bandpass';\n    filter.frequency.value = 3000;\n    filter.Q.value = 2;\n\n    source.connect(filter);\n    filter.connect(gain);\n    gain.connect(this.sfxGain);\n\n    source.start(now);\n    source.stop(now + 0.2);\n  }\n\n  private playPowderSound(): void {\n    if (!this.noiseBuffer) return;\n\n    const now = this.ctx.currentTime;\n    const source = this.ctx.createBufferSource();\n    source.buffer = this.noiseBuffer;\n\n    const gain = this.ctx.createGain();\n    gain.gain.setValueAtTime(0.08, now);\n    gain.gain.linearRampToValueAtTime(0.15, now + 0.1);\n    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.4);\n\n    const filter = this.ctx.createBiquadFilter();\n    filter.type = 'highpass';\n    filter.frequency.value = 4000;\n\n    source.connect(filter);\n    filter.connect(gain);\n    gain.connect(this.sfxGain);\n\n    source.start(now);\n    source.stop(now + 0.45);\n  }\n\n  private playMetalSlide(drawing: boolean): void {\n    const now = this.ctx.currentTime;\n\n    const osc = this.ctx.createOscillator();\n    osc.type = 'sawtooth';\n\n    if (drawing) {\n      osc.frequency.setValueAtTime(200, now);\n      osc.frequency.linearRampToValueAtTime(800, now + 0.3);\n    } else {\n      osc.frequency.setValueAtTime(800, now);\n      osc.frequency.linearRampToValueAtTime(200, now + 0.3);\n    }\n\n    const gain = this.ctx.createGain();\n    gain.gain.setValueAtTime(0.08, now);\n    gain.gain.linearRampToValueAtTime(0.12, now + 0.15);\n    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.35);\n\n    const filter = this.ctx.createBiquadFilter();\n    filter.type = 'bandpass';\n    filter.frequency.value = 1500;\n    filter.Q.value = 5;\n\n    osc.connect(filter);\n    filter.connect(gain);\n    gain.connect(this.sfxGain);\n\n    osc.start(now);\n    osc.stop(now + 0.4);\n  }\n\n  private playRammingSound(): void {\n    const now = this.ctx.currentTime;\n\n    // Multiple thunks for ramming\n    for (let i = 0; i < 3; i++) {\n      const delay = i * 0.25;\n\n      const osc = this.ctx.createOscillator();\n      osc.type = 'sine';\n      osc.frequency.setValueAtTime(120, now + delay);\n      osc.frequency.exponentialRampToValueAtTime(50, now + delay + 0.1);\n\n      const gain = this.ctx.createGain();\n      gain.gain.setValueAtTime(0.2 + i * 0.05, now + delay);\n      gain.gain.exponentialRampToValueAtTime(0.01, now + delay + 0.15);\n\n      osc.connect(gain);\n      gain.connect(this.sfxGain);\n\n      osc.start(now + delay);\n      osc.stop(now + delay + 0.2);\n    }\n  }\n\n  setListenerPosition(x: number, y: number, angle: number): void {\n    this.listener = { x, y, angle };\n  }\n\n  setMasterVolume(volume: number): void {\n    this.masterGain.gain.value = Math.max(0, Math.min(1, volume));\n  }\n\n  setSfxVolume(volume: number): void {\n    this.sfxGain.gain.value = Math.max(0, Math.min(1, volume));\n  }\n\n  setMusicVolume(volume: number): void {\n    this.musicGain.gain.value = Math.max(0, Math.min(1, volume));\n  }\n\n  resume(): void {\n    if (this.ctx.state === 'suspended') {\n      this.ctx.resume();\n    }\n  }\n\n  stop(id: string): void {\n    const sounds = this.activeSounds.get(id);\n    if (sounds) {\n      sounds.forEach(s => s.stop());\n      this.activeSounds.set(id, []);\n    }\n  }\n\n  stopAll(): void {\n    this.activeSounds.forEach((sounds, id) => {\n      sounds.forEach(s => s.stop());\n    });\n    this.activeSounds.clear();\n  }\n}\n","// Authentic musket mechanics with realistic reload and firing\n\nimport { Player, InputState } from '../engine/types';\nimport { clamp, lerp, randomRange, ease } from '../engine/math';\n\nexport type MusketState =\n  | 'ready'\n  | 'aiming'\n  | 'firing'\n  | 'fired'\n  // Reload states - full 12-step historical reload\n  | 'reload_half_cock'\n  | 'reload_handle_cartridge'\n  | 'reload_bite_cartridge'\n  | 'reload_prime_pan'\n  | 'reload_close_frizzen'\n  | 'reload_cast_about'\n  | 'reload_pour_powder'\n  | 'reload_seat_ball'\n  | 'reload_draw_ramrod'\n  | 'reload_ram_charge'\n  | 'reload_return_ramrod'\n  | 'reload_shoulder';\n\nexport interface MusketConfig {\n  // Timing (in seconds)\n  aimTime: number;\n  fireLockTime: number;  // Delay between trigger and ignition\n  recoilTime: number;\n  smokeLingerTime: number;\n\n  // Reload step durations\n  reloadTimes: Record<string, number>;\n\n  // Accuracy\n  baseAccuracy: number;  // Radians of spread at rest\n  aimAccuracy: number;   // Radians of spread when fully aimed\n  breathSway: number;    // Amplitude of breathing sway\n  movementPenalty: number;  // Accuracy penalty while moving\n\n  // Ballistics\n  muzzleVelocity: number;  // Units per second\n  bulletDrop: number;      // Gravity effect\n  effectiveRange: number;  // Range where damage starts to drop\n  maxRange: number;        // Maximum bullet travel\n\n  // Damage\n  baseDamage: number;\n  headMultiplier: number;\n  bodyMultiplier: number;\n  limbMultiplier: number;\n\n  // Visual\n  recoilKick: number;      // Visual recoil amount\n  recoilRecovery: number;  // How fast recoil recovers\n}\n\nexport const DEFAULT_MUSKET_CONFIG: MusketConfig = {\n  aimTime: 0.8,\n  fireLockTime: 0.15,  // Flintlock delay\n  recoilTime: 0.3,\n  smokeLingerTime: 3.0,\n\n  reloadTimes: {\n    'reload_half_cock': 0.6,\n    'reload_handle_cartridge': 0.8,\n    'reload_bite_cartridge': 0.5,\n    'reload_prime_pan': 0.7,\n    'reload_close_frizzen': 0.3,\n    'reload_cast_about': 0.6,\n    'reload_pour_powder': 0.8,\n    'reload_seat_ball': 0.5,\n    'reload_draw_ramrod': 0.8,\n    'reload_ram_charge': 1.2,\n    'reload_return_ramrod': 0.8,\n    'reload_shoulder': 0.5\n  },\n\n  baseAccuracy: 0.08,\n  aimAccuracy: 0.02,\n  breathSway: 0.015,\n  movementPenalty: 0.05,\n\n  muzzleVelocity: 400,\n  bulletDrop: 9.8,\n  effectiveRange: 50,\n  maxRange: 150,\n\n  baseDamage: 100,\n  headMultiplier: 2.5,\n  bodyMultiplier: 1.0,\n  limbMultiplier: 0.6,\n\n  recoilKick: 0.15,\n  recoilRecovery: 3.0\n};\n\nexport interface SmokeParticle {\n  x: number;\n  y: number;\n  z: number;\n  vx: number;\n  vy: number;\n  vz: number;\n  size: number;\n  alpha: number;\n  life: number;\n  maxLife: number;\n}\n\nexport interface Projectile {\n  x: number;\n  y: number;\n  z: number;\n  vx: number;\n  vy: number;\n  vz: number;\n  damage: number;\n  ownerId: string;\n  timeAlive: number;\n}\n\nexport class Musket {\n  private state: MusketState = 'ready';\n  private stateTimer: number = 0;\n  private config: MusketConfig;\n\n  // Aiming\n  private aimProgress: number = 0;\n  private breathCycle: number = 0;\n  private currentSway: { x: number; y: number } = { x: 0, y: 0 };\n\n  // Firing\n  private hasCharge: boolean = true;\n  private hasPrimed: boolean = true;\n  private recoilAmount: number = 0;\n  private lastFireTime: number = 0;\n\n  // Visual state\n  private weaponX: number = 0;  // Screen position offset\n  private weaponY: number = 0;\n  private weaponAngle: number = 0;\n\n  // Particles\n  private smokeParticles: SmokeParticle[] = [];\n  private projectiles: Projectile[] = [];\n\n  // Reload tracking\n  private reloadStepIndex: number = 0;\n  private static readonly RELOAD_SEQUENCE: MusketState[] = [\n    'reload_half_cock',\n    'reload_handle_cartridge',\n    'reload_bite_cartridge',\n    'reload_prime_pan',\n    'reload_close_frizzen',\n    'reload_cast_about',\n    'reload_pour_powder',\n    'reload_seat_ball',\n    'reload_draw_ramrod',\n    'reload_ram_charge',\n    'reload_return_ramrod',\n    'reload_shoulder'\n  ];\n\n  constructor(config: MusketConfig = DEFAULT_MUSKET_CONFIG) {\n    this.config = config;\n  }\n\n  update(dt: number, input: InputState, player: Player): void {\n    this.stateTimer += dt;\n    this.breathCycle += dt * 0.8;  // Breathing rhythm\n\n    // Update particles\n    this.updateSmoke(dt);\n    this.updateProjectiles(dt);\n\n    // Update weapon visual position\n    this.updateWeaponPosition(dt, input, player);\n\n    // State machine\n    switch (this.state) {\n      case 'ready':\n        this.handleReadyState(input);\n        break;\n\n      case 'aiming':\n        this.handleAimingState(dt, input, player);\n        break;\n\n      case 'firing':\n        this.handleFiringState(dt, player);\n        break;\n\n      case 'fired':\n        this.handleFiredState(dt);\n        break;\n\n      default:\n        if (this.state.startsWith('reload_')) {\n          this.handleReloadState(dt);\n        }\n    }\n\n    // Recoil recovery\n    if (this.recoilAmount > 0) {\n      this.recoilAmount = Math.max(0, this.recoilAmount - dt * this.config.recoilRecovery);\n    }\n  }\n\n  private handleReadyState(input: InputState): void {\n    if (input.aim && this.hasCharge) {\n      this.state = 'aiming';\n      this.stateTimer = 0;\n      this.aimProgress = 0;\n    }\n\n    if (input.reload && !this.hasCharge) {\n      this.startReload();\n    }\n  }\n\n  private handleAimingState(dt: number, input: InputState, player: Player): void {\n    // Build up aim\n    this.aimProgress = Math.min(1, this.aimProgress + dt / this.config.aimTime);\n\n    // Calculate breathing sway\n    const swayAmount = this.config.breathSway * (1 - this.aimProgress * 0.7);\n    this.currentSway.x = Math.sin(this.breathCycle * 2.1) * swayAmount;\n    this.currentSway.y = Math.sin(this.breathCycle * 1.7 + 0.5) * swayAmount * 0.7;\n\n    // Movement penalty\n    if (player.isMoving) {\n      this.currentSway.x += Math.sin(this.breathCycle * 8) * this.config.movementPenalty;\n      this.currentSway.y += Math.sin(this.breathCycle * 6) * this.config.movementPenalty * 0.5;\n    }\n\n    // Fire!\n    if (input.fire && this.hasCharge) {\n      this.state = 'firing';\n      this.stateTimer = 0;\n    }\n\n    // Release aim\n    if (!input.aim) {\n      this.state = 'ready';\n      this.aimProgress = Math.max(0, this.aimProgress - dt * 2);\n    }\n  }\n\n  private handleFiringState(dt: number, player: Player): void {\n    // Flintlock delay - the hammer falls, sparks hit the pan\n    if (this.stateTimer >= this.config.fireLockTime) {\n      this.fire(player);\n      this.state = 'fired';\n      this.stateTimer = 0;\n    }\n  }\n\n  private handleFiredState(dt: number): void {\n    if (this.stateTimer >= this.config.recoilTime) {\n      this.state = 'ready';\n      this.hasCharge = false;\n      this.hasPrimed = false;\n    }\n  }\n\n  private handleReloadState(dt: number): void {\n    const currentStep = Musket.RELOAD_SEQUENCE[this.reloadStepIndex];\n    const stepDuration = this.config.reloadTimes[currentStep] || 0.5;\n\n    if (this.stateTimer >= stepDuration) {\n      this.reloadStepIndex++;\n\n      if (this.reloadStepIndex >= Musket.RELOAD_SEQUENCE.length) {\n        // Reload complete\n        this.state = 'ready';\n        this.hasCharge = true;\n        this.hasPrimed = true;\n        this.reloadStepIndex = 0;\n      } else {\n        this.state = Musket.RELOAD_SEQUENCE[this.reloadStepIndex];\n        this.stateTimer = 0;\n      }\n    }\n  }\n\n  private startReload(): void {\n    this.state = 'reload_half_cock';\n    this.stateTimer = 0;\n    this.reloadStepIndex = 0;\n    this.aimProgress = 0;\n  }\n\n  private fire(player: Player): void {\n    // Calculate accuracy\n    const accuracy = lerp(this.config.baseAccuracy, this.config.aimAccuracy, this.aimProgress);\n    const spreadX = randomRange(-accuracy, accuracy) + this.currentSway.x;\n    const spreadY = randomRange(-accuracy, accuracy) + this.currentSway.y;\n\n    // Create projectile\n    const dirX = Math.cos(player.angle + spreadX);\n    const dirY = Math.sin(player.angle + spreadX);\n    const dirZ = player.pitch + spreadY;\n\n    this.projectiles.push({\n      x: player.x + dirX * 0.5,\n      y: player.y + dirY * 0.5,\n      z: player.z + 0.5,  // Barrel height\n      vx: dirX * this.config.muzzleVelocity,\n      vy: dirY * this.config.muzzleVelocity,\n      vz: dirZ * this.config.muzzleVelocity,\n      damage: this.config.baseDamage,\n      ownerId: 'player',\n      timeAlive: 0\n    });\n\n    // Visual recoil\n    this.recoilAmount = this.config.recoilKick;\n\n    // Spawn muzzle smoke\n    this.spawnMuzzleSmoke(player);\n\n    this.lastFireTime = performance.now();\n  }\n\n  private spawnMuzzleSmoke(player: Player): void {\n    const muzzleX = player.x + Math.cos(player.angle) * 1.2;\n    const muzzleY = player.y + Math.sin(player.angle) * 1.2;\n    const muzzleZ = player.z + 0.4;\n\n    // Large smoke cloud\n    for (let i = 0; i < 30; i++) {\n      const speed = randomRange(0.5, 2);\n      const angle = player.angle + randomRange(-0.3, 0.3);\n\n      this.smokeParticles.push({\n        x: muzzleX + randomRange(-0.1, 0.1),\n        y: muzzleY + randomRange(-0.1, 0.1),\n        z: muzzleZ + randomRange(-0.1, 0.1),\n        vx: Math.cos(angle) * speed + randomRange(-0.3, 0.3),\n        vy: Math.sin(angle) * speed + randomRange(-0.3, 0.3),\n        vz: randomRange(0.1, 0.5),\n        size: randomRange(0.3, 0.8),\n        alpha: randomRange(0.6, 1.0),\n        life: 0,\n        maxLife: this.config.smokeLingerTime * randomRange(0.7, 1.3)\n      });\n    }\n  }\n\n  private updateSmoke(dt: number): void {\n    for (let i = this.smokeParticles.length - 1; i >= 0; i--) {\n      const p = this.smokeParticles[i];\n\n      // Physics\n      p.x += p.vx * dt;\n      p.y += p.vy * dt;\n      p.z += p.vz * dt;\n\n      // Drag and rise\n      p.vx *= 0.98;\n      p.vy *= 0.98;\n      p.vz += 0.1 * dt;  // Smoke rises\n\n      // Expand\n      p.size += dt * 0.3;\n\n      // Fade\n      p.life += dt;\n      p.alpha = 1 - (p.life / p.maxLife);\n\n      if (p.life >= p.maxLife) {\n        this.smokeParticles.splice(i, 1);\n      }\n    }\n  }\n\n  private updateProjectiles(dt: number): void {\n    for (let i = this.projectiles.length - 1; i >= 0; i--) {\n      const p = this.projectiles[i];\n\n      p.x += p.vx * dt;\n      p.y += p.vy * dt;\n      p.z += p.vz * dt;\n\n      // Gravity\n      p.vz -= this.config.bulletDrop * dt;\n\n      p.timeAlive += dt;\n\n      // Remove if too old or hit ground\n      if (p.timeAlive > 2 || p.z < 0) {\n        this.projectiles.splice(i, 1);\n      }\n    }\n  }\n\n  private updateWeaponPosition(dt: number, input: InputState, player: Player): void {\n    // Target positions based on state\n    let targetX = 0;\n    let targetY = 0;\n    let targetAngle = 0;\n\n    if (this.state === 'aiming') {\n      // Iron sights position - centered\n      targetX = 0;\n      targetY = -0.1;  // Slightly raised\n      targetAngle = 0;\n    } else if (this.state === 'ready') {\n      // Hip position\n      targetX = 0.15;\n      targetY = 0.2;\n      targetAngle = -0.05;\n    } else if (this.state.startsWith('reload_')) {\n      // Reload positions vary by step\n      const positions = this.getReloadPosition();\n      targetX = positions.x;\n      targetY = positions.y;\n      targetAngle = positions.angle;\n    }\n\n    // Apply recoil\n    targetY += this.recoilAmount * 0.3;\n    targetAngle -= this.recoilAmount * 0.5;\n\n    // Smooth movement\n    this.weaponX = lerp(this.weaponX, targetX, dt * 10);\n    this.weaponY = lerp(this.weaponY, targetY, dt * 10);\n    this.weaponAngle = lerp(this.weaponAngle, targetAngle, dt * 8);\n\n    // Bob while moving\n    if (player.isMoving && this.state === 'ready') {\n      const bobSpeed = player.isSprinting ? 12 : 8;\n      const bobAmount = player.isSprinting ? 0.04 : 0.02;\n      this.weaponY += Math.sin(this.breathCycle * bobSpeed) * bobAmount;\n      this.weaponX += Math.sin(this.breathCycle * bobSpeed * 0.5) * bobAmount * 0.5;\n    }\n  }\n\n  private getReloadPosition(): { x: number; y: number; angle: number } {\n    // Each reload step has specific weapon positioning\n    const positions: Record<string, { x: number; y: number; angle: number }> = {\n      'reload_half_cock': { x: 0.2, y: 0.1, angle: -0.1 },\n      'reload_handle_cartridge': { x: 0.3, y: 0.2, angle: -0.3 },\n      'reload_bite_cartridge': { x: 0.25, y: 0.15, angle: -0.4 },\n      'reload_prime_pan': { x: 0.15, y: 0.1, angle: -0.2 },\n      'reload_close_frizzen': { x: 0.1, y: 0.1, angle: -0.1 },\n      'reload_cast_about': { x: 0, y: 0.3, angle: 0.5 },\n      'reload_pour_powder': { x: -0.05, y: 0.35, angle: 0.6 },\n      'reload_seat_ball': { x: -0.05, y: 0.3, angle: 0.5 },\n      'reload_draw_ramrod': { x: -0.1, y: 0.2, angle: 0.4 },\n      'reload_ram_charge': { x: -0.1, y: 0.25, angle: 0.5 },\n      'reload_return_ramrod': { x: -0.1, y: 0.2, angle: 0.4 },\n      'reload_shoulder': { x: 0.1, y: 0.15, angle: -0.05 }\n    };\n\n    return positions[this.state] || { x: 0.15, y: 0.2, angle: 0 };\n  }\n\n  // Getters for rendering\n  getState(): MusketState { return this.state; }\n  getStateTimer(): number { return this.stateTimer; }\n  getAimProgress(): number { return this.aimProgress; }\n  getSway(): { x: number; y: number } { return this.currentSway; }\n  getRecoil(): number { return this.recoilAmount; }\n  getWeaponOffset(): { x: number; y: number; angle: number } {\n    return { x: this.weaponX, y: this.weaponY, angle: this.weaponAngle };\n  }\n  getSmokeParticles(): SmokeParticle[] { return this.smokeParticles; }\n  getProjectiles(): Projectile[] { return this.projectiles; }\n  hasAmmo(): boolean { return this.hasCharge; }\n  getReloadProgress(): number {\n    if (!this.state.startsWith('reload_')) return this.hasCharge ? 1 : 0;\n\n    const totalSteps = Musket.RELOAD_SEQUENCE.length;\n    const currentStep = Musket.RELOAD_SEQUENCE[this.reloadStepIndex];\n    const stepDuration = this.config.reloadTimes[currentStep] || 0.5;\n    const stepProgress = this.stateTimer / stepDuration;\n\n    return (this.reloadStepIndex + stepProgress) / totalSteps;\n  }\n\n  getReloadStepName(): string {\n    if (!this.state.startsWith('reload_')) return '';\n\n    const names: Record<string, string> = {\n      'reload_half_cock': 'Half-cock the hammer',\n      'reload_handle_cartridge': 'Handle cartridge',\n      'reload_bite_cartridge': 'Bite cartridge',\n      'reload_prime_pan': 'Prime the pan',\n      'reload_close_frizzen': 'Close frizzen',\n      'reload_cast_about': 'Cast about',\n      'reload_pour_powder': 'Pour powder',\n      'reload_seat_ball': 'Seat the ball',\n      'reload_draw_ramrod': 'Draw ramrod',\n      'reload_ram_charge': 'Ram the charge',\n      'reload_return_ramrod': 'Return ramrod',\n      'reload_shoulder': 'Shoulder arms'\n    };\n\n    return names[this.state] || '';\n  }\n\n  removeProjectile(index: number): void {\n    if (index >= 0 && index < this.projectiles.length) {\n      this.projectiles.splice(index, 1);\n    }\n  }\n}\n","// Authentic bayonet combat system with realistic damage and mechanics\n\nimport { Player, InputState, Entity } from '../engine/types';\nimport { vec2Distance, vec2, vec2Sub, vec2Normalize, vec2Angle, angleDifference, lerp, clamp, randomRange } from '../engine/math';\n\nexport type BayonetState =\n  | 'sheathed'      // Bayonet not fixed\n  | 'fixed'         // Bayonet attached, ready position\n  | 'guard_high'    // High guard stance\n  | 'guard_low'     // Low guard stance\n  | 'thrust'        // Thrusting attack\n  | 'thrust_recovery' // Recovering from thrust\n  | 'slash'         // Horizontal slash with bayonet\n  | 'slash_recovery'\n  | 'parry'         // Blocking incoming attack\n  | 'parry_success' // Successfully blocked\n  | 'recoil'        // Hit by enemy attack\n  | 'fixing'        // Attaching bayonet to musket\n  | 'unfixing';     // Removing bayonet\n\nexport interface BayonetConfig {\n  // Timing\n  fixTime: number;\n  unfixTime: number;\n  thrustWindup: number;\n  thrustDuration: number;\n  thrustRecovery: number;\n  slashWindup: number;\n  slashDuration: number;\n  slashRecovery: number;\n  parryDuration: number;\n  parryWindow: number;  // Active parry frames\n  recoilDuration: number;\n\n  // Combat\n  thrustDamage: number;\n  slashDamage: number;\n  thrustRange: number;\n  slashRange: number;\n  thrustAngle: number;   // Cone of attack in radians\n  slashAngle: number;\n  knockback: number;\n\n  // Movement penalties\n  movementPenalty: number;  // Speed reduction when bayonet fixed\n  attackMovementPenalty: number;  // Speed during attacks\n}\n\nexport const DEFAULT_BAYONET_CONFIG: BayonetConfig = {\n  fixTime: 1.5,\n  unfixTime: 1.0,\n  thrustWindup: 0.2,\n  thrustDuration: 0.15,\n  thrustRecovery: 0.4,\n  slashWindup: 0.25,\n  slashDuration: 0.2,\n  slashRecovery: 0.5,\n  parryDuration: 0.6,\n  parryWindow: 0.15,\n  recoilDuration: 0.5,\n\n  thrustDamage: 85,\n  slashDamage: 45,\n  thrustRange: 2.0,\n  slashRange: 1.8,\n  thrustAngle: 0.15,\n  slashAngle: 0.8,\n  knockback: 0.5,\n\n  movementPenalty: 0.15,\n  attackMovementPenalty: 0.7\n};\n\nexport interface BayonetHit {\n  targetId: string;\n  damage: number;\n  knockbackX: number;\n  knockbackY: number;\n  hitType: 'thrust' | 'slash';\n  isCritical: boolean;\n}\n\nexport interface BayonetVisuals {\n  offsetX: number;\n  offsetY: number;\n  angle: number;\n  bloodSplatter: BloodParticle[];\n}\n\nexport interface BloodParticle {\n  x: number;\n  y: number;\n  z: number;\n  vx: number;\n  vy: number;\n  vz: number;\n  size: number;\n  alpha: number;\n  life: number;\n}\n\nexport class Bayonet {\n  private state: BayonetState = 'sheathed';\n  private stateTimer: number = 0;\n  private config: BayonetConfig;\n\n  // Combat tracking\n  private isFixed: boolean = false;\n  private currentGuard: 'high' | 'low' | 'neutral' = 'neutral';\n  private hasHitThisAttack: boolean = false;\n  private lastAttackTime: number = 0;\n  private comboCount: number = 0;\n\n  // Visual state\n  private visualOffsetX: number = 0;\n  private visualOffsetY: number = 0;\n  private visualAngle: number = 0;\n  private targetOffsetX: number = 0;\n  private targetOffsetY: number = 0;\n  private targetAngle: number = 0;\n\n  // Particles\n  private bloodParticles: BloodParticle[] = [];\n\n  // Pending hits to be processed by game\n  private pendingHits: BayonetHit[] = [];\n\n  constructor(config: BayonetConfig = DEFAULT_BAYONET_CONFIG) {\n    this.config = config;\n  }\n\n  update(dt: number, input: InputState, player: Player, enemies: Entity[]): void {\n    this.stateTimer += dt;\n\n    // Update blood particles\n    this.updateBloodParticles(dt);\n\n    // State machine\n    switch (this.state) {\n      case 'sheathed':\n        this.handleSheathedState(input);\n        break;\n\n      case 'fixing':\n        this.handleFixingState();\n        break;\n\n      case 'unfixing':\n        this.handleUnfixingState();\n        break;\n\n      case 'fixed':\n      case 'guard_high':\n      case 'guard_low':\n        this.handleReadyState(dt, input, player);\n        break;\n\n      case 'thrust':\n        this.handleThrustState(dt, player, enemies);\n        break;\n\n      case 'thrust_recovery':\n        this.handleRecoveryState('thrust');\n        break;\n\n      case 'slash':\n        this.handleSlashState(dt, player, enemies);\n        break;\n\n      case 'slash_recovery':\n        this.handleRecoveryState('slash');\n        break;\n\n      case 'parry':\n        this.handleParryState();\n        break;\n\n      case 'parry_success':\n        this.handleParrySuccessState();\n        break;\n\n      case 'recoil':\n        this.handleRecoilState();\n        break;\n    }\n\n    // Update visuals smoothly\n    this.updateVisuals(dt);\n\n    // Reset combo if too much time passed\n    if (performance.now() - this.lastAttackTime > 1000) {\n      this.comboCount = 0;\n    }\n  }\n\n  private handleSheathedState(input: InputState): void {\n    if (input.bayonet) {\n      this.state = 'fixing';\n      this.stateTimer = 0;\n    }\n  }\n\n  private handleFixingState(): void {\n    // Animate fixing the bayonet\n    const progress = this.stateTimer / this.config.fixTime;\n    this.targetOffsetY = 0.3 - progress * 0.1;\n    this.targetAngle = 0.2 * (1 - progress);\n\n    if (this.stateTimer >= this.config.fixTime) {\n      this.state = 'fixed';\n      this.isFixed = true;\n      this.stateTimer = 0;\n    }\n  }\n\n  private handleUnfixingState(): void {\n    const progress = this.stateTimer / this.config.unfixTime;\n    this.targetOffsetY = 0.2 + progress * 0.1;\n\n    if (this.stateTimer >= this.config.unfixTime) {\n      this.state = 'sheathed';\n      this.isFixed = false;\n      this.stateTimer = 0;\n    }\n  }\n\n  private handleReadyState(dt: number, input: InputState, player: Player): void {\n    // Guard stance management\n    if (input.crouch) {\n      this.currentGuard = 'low';\n      this.state = 'guard_low';\n    } else if (input.aim) {\n      this.currentGuard = 'high';\n      this.state = 'guard_high';\n    } else {\n      this.currentGuard = 'neutral';\n      this.state = 'fixed';\n    }\n\n    // Attack inputs\n    if (input.fire) {\n      this.initiateThrust();\n    } else if (input.rightMouseDown) {\n      this.initiateSlash();\n    }\n\n    // Unfix bayonet\n    if (input.bayonet && !input.fire && !input.rightMouseDown) {\n      this.state = 'unfixing';\n      this.stateTimer = 0;\n    }\n\n    // Update visual targets based on guard\n    this.setGuardVisuals();\n  }\n\n  private setGuardVisuals(): void {\n    switch (this.currentGuard) {\n      case 'high':\n        this.targetOffsetX = 0;\n        this.targetOffsetY = -0.1;\n        this.targetAngle = -0.2;\n        break;\n      case 'low':\n        this.targetOffsetX = 0.05;\n        this.targetOffsetY = 0.15;\n        this.targetAngle = 0.1;\n        break;\n      default:\n        this.targetOffsetX = 0.08;\n        this.targetOffsetY = 0.05;\n        this.targetAngle = 0;\n    }\n  }\n\n  private initiateThrust(): void {\n    this.state = 'thrust';\n    this.stateTimer = 0;\n    this.hasHitThisAttack = false;\n    this.lastAttackTime = performance.now();\n    this.comboCount++;\n  }\n\n  private initiateSlash(): void {\n    this.state = 'slash';\n    this.stateTimer = 0;\n    this.hasHitThisAttack = false;\n    this.lastAttackTime = performance.now();\n    this.comboCount++;\n  }\n\n  private handleThrustState(dt: number, player: Player, enemies: Entity[]): void {\n    const { thrustWindup, thrustDuration, thrustRecovery } = this.config;\n    const totalTime = thrustWindup + thrustDuration;\n\n    if (this.stateTimer < thrustWindup) {\n      // Wind up - pull back\n      const t = this.stateTimer / thrustWindup;\n      this.targetOffsetX = -0.1 * t;\n      this.targetOffsetY = 0.1 * t;\n      this.targetAngle = 0.1 * t;\n    } else if (this.stateTimer < totalTime) {\n      // Thrust forward\n      const t = (this.stateTimer - thrustWindup) / thrustDuration;\n      this.targetOffsetX = -0.1 + 0.3 * t;\n      this.targetOffsetY = 0.1 - 0.2 * t;\n      this.targetAngle = 0.1 - 0.15 * t;\n\n      // Check for hits during active frames\n      if (!this.hasHitThisAttack) {\n        this.checkThrustHits(player, enemies);\n      }\n    } else {\n      this.state = 'thrust_recovery';\n      this.stateTimer = 0;\n    }\n  }\n\n  private handleSlashState(dt: number, player: Player, enemies: Entity[]): void {\n    const { slashWindup, slashDuration } = this.config;\n    const totalTime = slashWindup + slashDuration;\n\n    if (this.stateTimer < slashWindup) {\n      // Wind up - swing back\n      const t = this.stateTimer / slashWindup;\n      this.targetOffsetX = -0.2 * t;\n      this.targetOffsetY = -0.1 * t;\n      this.targetAngle = -0.4 * t;\n    } else if (this.stateTimer < totalTime) {\n      // Slash across\n      const t = (this.stateTimer - slashWindup) / slashDuration;\n      this.targetOffsetX = -0.2 + 0.4 * t;\n      this.targetOffsetY = -0.1 + 0.05 * t;\n      this.targetAngle = -0.4 + 0.8 * t;\n\n      // Check for hits during active frames\n      if (!this.hasHitThisAttack) {\n        this.checkSlashHits(player, enemies);\n      }\n    } else {\n      this.state = 'slash_recovery';\n      this.stateTimer = 0;\n    }\n  }\n\n  private handleRecoveryState(attackType: 'thrust' | 'slash'): void {\n    const duration = attackType === 'thrust'\n      ? this.config.thrustRecovery\n      : this.config.slashRecovery;\n\n    const t = this.stateTimer / duration;\n    // Return to ready position\n    this.targetOffsetX = lerp(this.visualOffsetX, 0.08, t);\n    this.targetOffsetY = lerp(this.visualOffsetY, 0.05, t);\n    this.targetAngle = lerp(this.visualAngle, 0, t);\n\n    if (this.stateTimer >= duration) {\n      this.state = 'fixed';\n      this.stateTimer = 0;\n    }\n  }\n\n  private handleParryState(): void {\n    this.targetOffsetX = 0.15;\n    this.targetOffsetY = -0.15;\n    this.targetAngle = -0.3;\n\n    if (this.stateTimer >= this.config.parryDuration) {\n      this.state = 'fixed';\n      this.stateTimer = 0;\n    }\n  }\n\n  private handleParrySuccessState(): void {\n    // Brief stagger after successful parry\n    if (this.stateTimer >= 0.2) {\n      this.state = 'fixed';\n      this.stateTimer = 0;\n    }\n  }\n\n  private handleRecoilState(): void {\n    const t = this.stateTimer / this.config.recoilDuration;\n    this.targetOffsetX = 0.2 * (1 - t);\n    this.targetOffsetY = 0.2 * (1 - t);\n    this.targetAngle = 0.3 * (1 - t);\n\n    if (this.stateTimer >= this.config.recoilDuration) {\n      this.state = 'fixed';\n      this.stateTimer = 0;\n    }\n  }\n\n  private checkThrustHits(player: Player, enemies: Entity[]): void {\n    for (const enemy of enemies) {\n      if (enemy.state === 'dead' || enemy.state === 'dying') continue;\n\n      const dist = vec2Distance({ x: player.x, y: player.y }, { x: enemy.x, y: enemy.y });\n\n      if (dist > this.config.thrustRange) continue;\n\n      // Check angle\n      const toEnemy = vec2Sub({ x: enemy.x, y: enemy.y }, { x: player.x, y: player.y });\n      const enemyAngle = vec2Angle(toEnemy);\n      const angleDiff = Math.abs(angleDifference(player.angle, enemyAngle));\n\n      if (angleDiff > this.config.thrustAngle) continue;\n\n      // Hit!\n      this.registerHit(enemy, 'thrust', player);\n      this.hasHitThisAttack = true;\n      break;  // Only one hit per attack\n    }\n  }\n\n  private checkSlashHits(player: Player, enemies: Entity[]): void {\n    for (const enemy of enemies) {\n      if (enemy.state === 'dead' || enemy.state === 'dying') continue;\n\n      const dist = vec2Distance({ x: player.x, y: player.y }, { x: enemy.x, y: enemy.y });\n\n      if (dist > this.config.slashRange) continue;\n\n      // Slash has wider angle\n      const toEnemy = vec2Sub({ x: enemy.x, y: enemy.y }, { x: player.x, y: player.y });\n      const enemyAngle = vec2Angle(toEnemy);\n      const angleDiff = Math.abs(angleDifference(player.angle, enemyAngle));\n\n      if (angleDiff > this.config.slashAngle) continue;\n\n      // Hit!\n      this.registerHit(enemy, 'slash', player);\n      // Slash can hit multiple enemies, don't break\n    }\n\n    if (this.pendingHits.length > 0) {\n      this.hasHitThisAttack = true;\n    }\n  }\n\n  private registerHit(enemy: Entity, hitType: 'thrust' | 'slash', player: Player): void {\n    const baseDamage = hitType === 'thrust'\n      ? this.config.thrustDamage\n      : this.config.slashDamage;\n\n    // Critical hit chance based on combo\n    const critChance = Math.min(0.3, this.comboCount * 0.1);\n    const isCritical = Math.random() < critChance;\n    const damage = isCritical ? baseDamage * 1.5 : baseDamage;\n\n    // Knockback direction\n    const knockDir = vec2Normalize(vec2Sub(\n      { x: enemy.x, y: enemy.y },\n      { x: player.x, y: player.y }\n    ));\n\n    this.pendingHits.push({\n      targetId: enemy.id,\n      damage,\n      knockbackX: knockDir.x * this.config.knockback,\n      knockbackY: knockDir.y * this.config.knockback,\n      hitType,\n      isCritical\n    });\n\n    // Spawn blood\n    this.spawnBlood(enemy.x, enemy.y, enemy.z + 0.5, knockDir.x, knockDir.y, isCritical);\n  }\n\n  private spawnBlood(x: number, y: number, z: number, dirX: number, dirY: number, isCritical: boolean): void {\n    const count = isCritical ? 25 : 12;\n\n    for (let i = 0; i < count; i++) {\n      const speed = randomRange(1, 4);\n      const spreadAngle = randomRange(-0.5, 0.5);\n\n      this.bloodParticles.push({\n        x: x + randomRange(-0.1, 0.1),\n        y: y + randomRange(-0.1, 0.1),\n        z: z + randomRange(-0.1, 0.1),\n        vx: (dirX + Math.cos(spreadAngle) * 0.3) * speed,\n        vy: (dirY + Math.sin(spreadAngle) * 0.3) * speed,\n        vz: randomRange(0.5, 2),\n        size: randomRange(0.05, 0.15),\n        alpha: 1,\n        life: randomRange(0.5, 1.5)\n      });\n    }\n  }\n\n  private updateBloodParticles(dt: number): void {\n    for (let i = this.bloodParticles.length - 1; i >= 0; i--) {\n      const p = this.bloodParticles[i];\n\n      p.x += p.vx * dt;\n      p.y += p.vy * dt;\n      p.z += p.vz * dt;\n\n      // Gravity\n      p.vz -= 15 * dt;\n\n      // Drag\n      p.vx *= 0.98;\n      p.vy *= 0.98;\n\n      // Fade\n      p.life -= dt;\n      p.alpha = clamp(p.life, 0, 1);\n\n      // Remove dead particles or ground hits\n      if (p.life <= 0 || p.z < 0) {\n        this.bloodParticles.splice(i, 1);\n      }\n    }\n  }\n\n  private updateVisuals(dt: number): void {\n    const smoothing = 15;\n    this.visualOffsetX = lerp(this.visualOffsetX, this.targetOffsetX, dt * smoothing);\n    this.visualOffsetY = lerp(this.visualOffsetY, this.targetOffsetY, dt * smoothing);\n    this.visualAngle = lerp(this.visualAngle, this.targetAngle, dt * smoothing);\n  }\n\n  // Public methods for receiving attacks\n  attemptParry(attackDirection: number, playerAngle: number): boolean {\n    if (this.state !== 'fixed' && this.state !== 'guard_high' && this.state !== 'guard_low') {\n      return false;\n    }\n\n    const angleDiff = Math.abs(angleDifference(playerAngle, attackDirection + Math.PI));\n\n    if (angleDiff < 0.5) {  // Facing the attack\n      this.state = 'parry_success';\n      this.stateTimer = 0;\n      return true;\n    }\n\n    return false;\n  }\n\n  receiveHit(): void {\n    if (this.state !== 'parry' && this.state !== 'parry_success') {\n      this.state = 'recoil';\n      this.stateTimer = 0;\n    }\n  }\n\n  // Getters\n  getState(): BayonetState { return this.state; }\n  isFixed_(): boolean { return this.isFixed; }  // Renamed to avoid conflict\n  getCurrentGuard(): 'high' | 'low' | 'neutral' { return this.currentGuard; }\n  getVisuals(): BayonetVisuals {\n    return {\n      offsetX: this.visualOffsetX,\n      offsetY: this.visualOffsetY,\n      angle: this.visualAngle,\n      bloodSplatter: this.bloodParticles\n    };\n  }\n  getBloodParticles(): BloodParticle[] { return this.bloodParticles; }\n  getPendingHits(): BayonetHit[] {\n    const hits = [...this.pendingHits];\n    this.pendingHits = [];\n    return hits;\n  }\n  getMovementMultiplier(): number {\n    if (!this.isFixed) return 1;\n\n    if (this.state === 'thrust' || this.state === 'slash') {\n      return 1 - this.config.attackMovementPenalty;\n    }\n\n    return 1 - this.config.movementPenalty;\n  }\n  canShoot(): boolean {\n    // Can only shoot if bayonet is not fixed or in ready state\n    return !this.isFixed || this.state === 'fixed' || this.state === 'guard_high' || this.state === 'guard_low';\n  }\n}\n","// Sophisticated AI opponent for musket dueling\n\nimport { Entity, EntityState, Player, GameMap, AIBehavior } from '../engine/types';\nimport { vec2, vec2Distance, vec2Sub, vec2Normalize, vec2Add, vec2Scale, vec2Angle, vec2FromAngle, angleDifference, normalizeAngle, clamp, lerp, randomRange, randomChoice } from '../engine/math';\nimport { Musket, MusketState, DEFAULT_MUSKET_CONFIG } from './musket';\nimport { Bayonet, BayonetState, DEFAULT_BAYONET_CONFIG } from './bayonet';\n\nexport interface OpponentConfig {\n  // Combat behavior\n  preferredRange: number;       // Distance AI tries to maintain\n  aggressionLevel: number;      // 0-1, how likely to charge\n  accuracy: number;             // 0-1, shooting accuracy\n  reactionTime: number;         // Seconds to react to player\n  aimTime: number;              // Time to line up shot\n\n  // Movement\n  moveSpeed: number;\n  strafeSpeed: number;\n  turnSpeed: number;\n\n  // Tactics\n  flanking: boolean;            // Will try to circle around\n  useCover: boolean;            // Will use map features\n  feinting: boolean;            // Will fake attacks\n  bayonetProficiency: number;   // 0-1, melee skill\n\n  // Personality\n  patience: number;             // 0-1, how long they'll wait for good shot\n  bravery: number;              // 0-1, willingness to take risks\n  adaptability: number;         // 0-1, how quickly they change tactics\n}\n\nexport const OPPONENT_PRESETS: Record<string, OpponentConfig> = {\n  'militia': {\n    preferredRange: 25,\n    aggressionLevel: 0.3,\n    accuracy: 0.4,\n    reactionTime: 0.8,\n    aimTime: 2.0,\n    moveSpeed: 2.5,\n    strafeSpeed: 1.5,\n    turnSpeed: 2.0,\n    flanking: false,\n    useCover: false,\n    feinting: false,\n    bayonetProficiency: 0.3,\n    patience: 0.3,\n    bravery: 0.4,\n    adaptability: 0.2\n  },\n  'regular': {\n    preferredRange: 20,\n    aggressionLevel: 0.5,\n    accuracy: 0.6,\n    reactionTime: 0.5,\n    aimTime: 1.5,\n    moveSpeed: 3.0,\n    strafeSpeed: 2.0,\n    turnSpeed: 2.5,\n    flanking: true,\n    useCover: true,\n    feinting: false,\n    bayonetProficiency: 0.5,\n    patience: 0.5,\n    bravery: 0.5,\n    adaptability: 0.4\n  },\n  'grenadier': {\n    preferredRange: 12,\n    aggressionLevel: 0.8,\n    accuracy: 0.5,\n    reactionTime: 0.4,\n    aimTime: 1.2,\n    moveSpeed: 2.8,\n    strafeSpeed: 1.8,\n    turnSpeed: 2.2,\n    flanking: false,\n    useCover: false,\n    feinting: true,\n    bayonetProficiency: 0.8,\n    patience: 0.2,\n    bravery: 0.9,\n    adaptability: 0.3\n  },\n  'officer': {\n    preferredRange: 18,\n    aggressionLevel: 0.6,\n    accuracy: 0.8,\n    reactionTime: 0.3,\n    aimTime: 1.0,\n    moveSpeed: 3.2,\n    strafeSpeed: 2.2,\n    turnSpeed: 3.0,\n    flanking: true,\n    useCover: true,\n    feinting: true,\n    bayonetProficiency: 0.7,\n    patience: 0.7,\n    bravery: 0.6,\n    adaptability: 0.8\n  },\n  'veteran': {\n    preferredRange: 15,\n    aggressionLevel: 0.7,\n    accuracy: 0.85,\n    reactionTime: 0.25,\n    aimTime: 0.8,\n    moveSpeed: 3.5,\n    strafeSpeed: 2.5,\n    turnSpeed: 3.5,\n    flanking: true,\n    useCover: true,\n    feinting: true,\n    bayonetProficiency: 0.9,\n    patience: 0.8,\n    bravery: 0.7,\n    adaptability: 0.9\n  }\n};\n\ntype AIState =\n  | 'spawning'\n  | 'idle'\n  | 'patrol'\n  | 'alert'\n  | 'engaging'\n  | 'aiming'\n  | 'firing'\n  | 'reloading'\n  | 'advancing'\n  | 'retreating'\n  | 'flanking'\n  | 'charging'      // Bayonet charge\n  | 'melee'\n  | 'recovering'\n  | 'dying'\n  | 'dead';\n\nexport class Opponent {\n  // Identity\n  public id: string;\n  public type: string;\n\n  // Position and movement\n  public x: number;\n  public y: number;\n  public z: number = 0;\n  public angle: number;\n  public velocityX: number = 0;\n  public velocityY: number = 0;\n\n  // State\n  private aiState: AIState = 'spawning';\n  private stateTimer: number = 0;\n  private previousState: AIState = 'spawning';\n\n  // Combat\n  public health: number = 100;\n  public maxHealth: number = 100;\n  private musket: Musket;\n  private bayonet: Bayonet;\n  private hasLineOfSight: boolean = false;\n  private lastSeenPlayerPos: { x: number; y: number } | null = null;\n  private lastSeenTime: number = 0;\n\n  // AI decision making\n  private config: OpponentConfig;\n  private currentBehavior: AIBehavior = 'patrol';\n  private targetPosition: { x: number; y: number } | null = null;\n  private aimProgress: number = 0;\n  private decisionCooldown: number = 0;\n  private threatLevel: number = 0;\n\n  // Animation/visuals\n  private animState: EntityState = 'idle';\n  private animFrame: number = 0;\n  private animTimer: number = 0;\n\n  // Combat tracking\n  private lastDamageTime: number = 0;\n  private consecutiveHits: number = 0;\n  private playerPatternMemory: number[] = [];  // Track player behavior\n\n  constructor(id: string, x: number, y: number, angle: number, type: string = 'regular') {\n    this.id = id;\n    this.x = x;\n    this.y = y;\n    this.angle = angle;\n    this.type = type;\n    this.config = OPPONENT_PRESETS[type] || OPPONENT_PRESETS['regular'];\n\n    this.musket = new Musket(DEFAULT_MUSKET_CONFIG);\n    this.bayonet = new Bayonet(DEFAULT_BAYONET_CONFIG);\n  }\n\n  update(dt: number, player: Player, map: GameMap): void {\n    this.stateTimer += dt;\n    this.decisionCooldown = Math.max(0, this.decisionCooldown - dt);\n\n    // Check line of sight to player\n    this.updateLineOfSight(player, map);\n\n    // Update threat assessment\n    this.updateThreatLevel(player);\n\n    // AI State machine\n    switch (this.aiState) {\n      case 'spawning':\n        this.handleSpawningState();\n        break;\n\n      case 'idle':\n      case 'patrol':\n        this.handleIdleState(dt, player);\n        break;\n\n      case 'alert':\n        this.handleAlertState(dt, player);\n        break;\n\n      case 'engaging':\n        this.handleEngagingState(dt, player, map);\n        break;\n\n      case 'aiming':\n        this.handleAimingState(dt, player);\n        break;\n\n      case 'firing':\n        this.handleFiringState(dt);\n        break;\n\n      case 'reloading':\n        this.handleReloadingState(dt);\n        break;\n\n      case 'advancing':\n        this.handleAdvancingState(dt, player, map);\n        break;\n\n      case 'retreating':\n        this.handleRetreatingState(dt, player, map);\n        break;\n\n      case 'flanking':\n        this.handleFlankingState(dt, player, map);\n        break;\n\n      case 'charging':\n        this.handleChargingState(dt, player);\n        break;\n\n      case 'melee':\n        this.handleMeleeState(dt, player);\n        break;\n\n      case 'recovering':\n        this.handleRecoveringState(dt);\n        break;\n\n      case 'dying':\n        this.handleDyingState(dt);\n        break;\n\n      case 'dead':\n        // No updates when dead\n        break;\n    }\n\n    // Apply velocity\n    this.x += this.velocityX * dt;\n    this.y += this.velocityY * dt;\n\n    // Update weapons\n    this.updateWeapons(dt, player);\n\n    // Update animation\n    this.updateAnimation(dt);\n  }\n\n  private updateLineOfSight(player: Player, map: GameMap): void {\n    const dx = player.x - this.x;\n    const dy = player.y - this.y;\n    const dist = Math.sqrt(dx * dx + dy * dy);\n\n    if (dist > 50) {\n      this.hasLineOfSight = false;\n      return;\n    }\n\n    // Simple raycast to check for walls\n    const steps = Math.ceil(dist * 2);\n    const stepX = dx / steps;\n    const stepY = dy / steps;\n\n    let checkX = this.x;\n    let checkY = this.y;\n\n    for (let i = 0; i < steps; i++) {\n      checkX += stepX;\n      checkY += stepY;\n\n      const tileX = Math.floor(checkX);\n      const tileY = Math.floor(checkY);\n\n      if (tileX >= 0 && tileX < map.width && tileY >= 0 && tileY < map.height) {\n        if (map.tiles[tileY][tileX] > 0) {\n          this.hasLineOfSight = false;\n          return;\n        }\n      }\n    }\n\n    this.hasLineOfSight = true;\n    this.lastSeenPlayerPos = { x: player.x, y: player.y };\n    this.lastSeenTime = performance.now();\n  }\n\n  private updateThreatLevel(player: Player): void {\n    const dist = vec2Distance({ x: this.x, y: this.y }, { x: player.x, y: player.y });\n\n    // Base threat from distance\n    this.threatLevel = clamp(1 - dist / 30, 0, 1);\n\n    // Increase if player is aiming at us\n    const playerToUs = Math.atan2(this.y - player.y, this.x - player.x);\n    const angleDiff = Math.abs(angleDifference(player.angle, playerToUs));\n    if (angleDiff < 0.3) {\n      this.threatLevel += 0.3;\n    }\n\n    // Increase if we've been hit recently\n    if (performance.now() - this.lastDamageTime < 3000) {\n      this.threatLevel += 0.2;\n    }\n\n    this.threatLevel = clamp(this.threatLevel, 0, 1);\n  }\n\n  private handleSpawningState(): void {\n    if (this.stateTimer >= 1.0) {\n      this.changeState('idle');\n    }\n  }\n\n  private handleIdleState(dt: number, player: Player): void {\n    if (this.hasLineOfSight) {\n      this.changeState('alert');\n      return;\n    }\n\n    // Slowly turn, looking around\n    this.angle += Math.sin(this.stateTimer * 0.5) * dt * 0.3;\n  }\n\n  private handleAlertState(dt: number, player: Player): void {\n    // Turn to face player\n    const targetAngle = Math.atan2(player.y - this.y, player.x - this.x);\n    this.turnToward(targetAngle, dt);\n\n    // React after reaction time\n    if (this.stateTimer >= this.config.reactionTime) {\n      this.makeEngagementDecision(player);\n    }\n  }\n\n  private handleEngagingState(dt: number, player: Player, map: GameMap): void {\n    const dist = vec2Distance({ x: this.x, y: this.y }, { x: player.x, y: player.y });\n\n    // Turn to face player\n    const targetAngle = Math.atan2(player.y - this.y, player.x - this.x);\n    this.turnToward(targetAngle, dt);\n\n    // Make tactical decisions\n    if (this.decisionCooldown <= 0) {\n      this.makeEngagementDecision(player);\n      this.decisionCooldown = randomRange(0.5, 1.5);\n    }\n  }\n\n  private makeEngagementDecision(player: Player): void {\n    const dist = vec2Distance({ x: this.x, y: this.y }, { x: player.x, y: player.y });\n    const hasAmmo = this.musket.hasAmmo();\n\n    // Close range - consider melee\n    if (dist < 4 && this.config.bayonetProficiency > 0.4) {\n      if (Math.random() < this.config.aggressionLevel) {\n        this.changeState('charging');\n        return;\n      }\n    }\n\n    // No ammo - must reload or charge\n    if (!hasAmmo) {\n      if (dist < 8 && this.config.aggressionLevel > 0.5) {\n        this.changeState('charging');\n      } else if (dist < this.config.preferredRange) {\n        this.changeState('retreating');\n      } else {\n        this.changeState('reloading');\n      }\n      return;\n    }\n\n    // Good shooting distance\n    if (dist < this.config.preferredRange * 1.2 && dist > this.config.preferredRange * 0.5) {\n      if (this.hasLineOfSight) {\n        this.changeState('aiming');\n      }\n      return;\n    }\n\n    // Too far - advance\n    if (dist > this.config.preferredRange) {\n      if (this.config.flanking && Math.random() < 0.3) {\n        this.changeState('flanking');\n      } else {\n        this.changeState('advancing');\n      }\n      return;\n    }\n\n    // Too close - retreat or charge\n    if (dist < this.config.preferredRange * 0.5) {\n      if (Math.random() < this.config.aggressionLevel) {\n        this.changeState('charging');\n      } else {\n        this.changeState('retreating');\n      }\n    }\n  }\n\n  private handleAimingState(dt: number, player: Player): void {\n    // Turn to track player\n    const targetAngle = Math.atan2(player.y - this.y, player.x - this.x);\n    this.turnToward(targetAngle, dt * 0.5);  // Slower turning while aiming\n\n    // Build up aim\n    this.aimProgress += dt / this.config.aimTime;\n\n    // Add some pre-shot tells based on patience\n    const fireThreshold = lerp(0.6, 1.0, this.config.patience);\n\n    if (this.aimProgress >= fireThreshold) {\n      // Check if shot is good enough\n      const angleDiff = Math.abs(angleDifference(this.angle, targetAngle));\n      const accuracyRequired = lerp(0.2, 0.05, this.config.accuracy);\n\n      if (angleDiff < accuracyRequired && this.hasLineOfSight) {\n        this.changeState('firing');\n      } else if (this.aimProgress >= 1.5) {\n        // Taking too long, reconsider\n        this.changeState('engaging');\n      }\n    }\n\n    // Can be interrupted by high threat\n    if (this.threatLevel > 0.8 && !this.config.bravery) {\n      this.changeState('retreating');\n    }\n  }\n\n  private handleFiringState(dt: number): void {\n    // The musket handles actual firing\n    if (this.stateTimer >= 0.3) {  // Lock time + fire\n      this.aimProgress = 0;\n      this.changeState('recovering');\n    }\n  }\n\n  private handleReloadingState(dt: number): void {\n    this.animState = 'reloading';\n\n    // Total reload time is sum of all steps\n    const totalReloadTime = Object.values(DEFAULT_MUSKET_CONFIG.reloadTimes)\n      .reduce((a, b) => a + b, 0);\n\n    if (this.stateTimer >= totalReloadTime) {\n      this.changeState('engaging');\n    }\n\n    // Can be interrupted by close threats\n    if (this.threatLevel > 0.7) {\n      const dist = this.lastSeenPlayerPos\n        ? vec2Distance({ x: this.x, y: this.y }, this.lastSeenPlayerPos)\n        : 999;\n\n      if (dist < 8) {\n        this.changeState('charging');\n      }\n    }\n  }\n\n  private handleAdvancingState(dt: number, player: Player, map: GameMap): void {\n    const targetAngle = Math.atan2(player.y - this.y, player.x - this.x);\n    this.turnToward(targetAngle, dt);\n\n    // Move forward\n    const moveDir = vec2FromAngle(this.angle);\n    this.velocityX = moveDir.x * this.config.moveSpeed;\n    this.velocityY = moveDir.y * this.config.moveSpeed;\n\n    // Check if reached desired range\n    const dist = vec2Distance({ x: this.x, y: this.y }, { x: player.x, y: player.y });\n    if (dist <= this.config.preferredRange) {\n      this.stopMovement();\n      this.changeState('engaging');\n    }\n\n    // Switch to aiming if we have a good shot\n    if (this.hasLineOfSight && this.musket.hasAmmo() && Math.random() < 0.02) {\n      this.stopMovement();\n      this.changeState('aiming');\n    }\n  }\n\n  private handleRetreatingState(dt: number, player: Player, map: GameMap): void {\n    const awayAngle = Math.atan2(this.y - player.y, this.x - player.x);\n    this.turnToward(awayAngle + Math.PI, dt);  // Face player while retreating\n\n    // Move backward\n    const moveDir = vec2FromAngle(awayAngle);\n    this.velocityX = moveDir.x * this.config.moveSpeed * 0.7;\n    this.velocityY = moveDir.y * this.config.moveSpeed * 0.7;\n\n    const dist = vec2Distance({ x: this.x, y: this.y }, { x: player.x, y: player.y });\n    if (dist >= this.config.preferredRange) {\n      this.stopMovement();\n      this.changeState('engaging');\n    }\n\n    if (this.stateTimer > 3) {\n      this.stopMovement();\n      this.changeState('engaging');\n    }\n  }\n\n  private handleFlankingState(dt: number, player: Player, map: GameMap): void {\n    // Move perpendicular to player\n    const toPlayer = Math.atan2(player.y - this.y, player.x - this.x);\n    const flankAngle = toPlayer + (Math.random() > 0.5 ? Math.PI / 2 : -Math.PI / 2);\n\n    this.turnToward(toPlayer, dt);  // Keep facing player\n\n    const moveDir = vec2FromAngle(flankAngle);\n    this.velocityX = moveDir.x * this.config.strafeSpeed;\n    this.velocityY = moveDir.y * this.config.strafeSpeed;\n\n    if (this.stateTimer > 2 || !this.hasLineOfSight) {\n      this.stopMovement();\n      this.changeState('engaging');\n    }\n  }\n\n  private handleChargingState(dt: number, player: Player): void {\n    const targetAngle = Math.atan2(player.y - this.y, player.x - this.x);\n    this.turnToward(targetAngle, dt * 2);  // Fast turn during charge\n\n    // Sprint toward player\n    const moveDir = vec2FromAngle(this.angle);\n    this.velocityX = moveDir.x * this.config.moveSpeed * 1.5;\n    this.velocityY = moveDir.y * this.config.moveSpeed * 1.5;\n\n    this.animState = 'running';\n\n    const dist = vec2Distance({ x: this.x, y: this.y }, { x: player.x, y: player.y });\n    if (dist < 2.5) {\n      this.stopMovement();\n      this.changeState('melee');\n    }\n\n    // Abort charge if taking fire\n    if (this.threatLevel > 0.9 && Math.random() < 0.1) {\n      this.stopMovement();\n      this.changeState('retreating');\n    }\n  }\n\n  private handleMeleeState(dt: number, player: Player): void {\n    const dist = vec2Distance({ x: this.x, y: this.y }, { x: player.x, y: player.y });\n\n    // Turn to face player\n    const targetAngle = Math.atan2(player.y - this.y, player.x - this.x);\n    this.turnToward(targetAngle, dt * 3);\n\n    this.animState = 'bayonet_thrust';\n\n    // Attack timing based on proficiency\n    const attackInterval = lerp(1.5, 0.6, this.config.bayonetProficiency);\n\n    if (this.stateTimer >= attackInterval) {\n      // Attack!\n      this.stateTimer = 0;\n\n      // Feinting\n      if (this.config.feinting && Math.random() < 0.3) {\n        // Fake attack - don't actually hit\n        this.animState = 'bayonet_ready';\n      }\n    }\n\n    // Disengage if too far\n    if (dist > 4) {\n      this.changeState('engaging');\n    }\n  }\n\n  private handleRecoveringState(dt: number): void {\n    this.stopMovement();\n\n    if (this.stateTimer >= 0.5) {\n      if (this.musket.hasAmmo()) {\n        this.changeState('engaging');\n      } else {\n        this.changeState('reloading');\n      }\n    }\n  }\n\n  private handleDyingState(dt: number): void {\n    this.animState = 'dying';\n    this.stopMovement();\n\n    if (this.stateTimer >= 2.0) {\n      this.aiState = 'dead';\n      this.animState = 'dead';\n    }\n  }\n\n  private changeState(newState: AIState): void {\n    this.previousState = this.aiState;\n    this.aiState = newState;\n    this.stateTimer = 0;\n  }\n\n  private turnToward(targetAngle: number, dt: number): void {\n    const diff = angleDifference(this.angle, targetAngle);\n    const turnAmount = clamp(diff, -this.config.turnSpeed * dt, this.config.turnSpeed * dt);\n    this.angle = normalizeAngle(this.angle + turnAmount);\n  }\n\n  private stopMovement(): void {\n    this.velocityX = 0;\n    this.velocityY = 0;\n  }\n\n  private updateWeapons(dt: number, player: Player): void {\n    // Create fake input for AI weapons\n    const fakeInput = {\n      forward: false, backward: false, left: false, right: false,\n      turnLeft: false, turnRight: false,\n      fire: this.aiState === 'firing',\n      aim: this.aiState === 'aiming' || this.aiState === 'firing',\n      reload: this.aiState === 'reloading',\n      bayonet: this.aiState === 'charging' || this.aiState === 'melee',\n      crouch: false, sprint: this.aiState === 'charging',\n      interact: false,\n      mouseX: 0, mouseY: 0, mouseDeltaX: 0, mouseDeltaY: 0,\n      mouseDown: false, rightMouseDown: false\n    };\n\n    const fakePlayer: Player = {\n      x: this.x, y: this.y, z: this.z,\n      angle: this.angle, pitch: 0,\n      velocityX: this.velocityX, velocityY: this.velocityY, velocityZ: 0,\n      isMoving: this.velocityX !== 0 || this.velocityY !== 0,\n      isCrouching: false, isSprinting: this.aiState === 'charging',\n      stamina: 100, health: this.health\n    };\n\n    this.musket.update(dt, fakeInput, fakePlayer);\n    this.bayonet.update(dt, fakeInput, fakePlayer, []);\n  }\n\n  private updateAnimation(dt: number): void {\n    this.animTimer += dt;\n\n    // Update animation frame based on state\n    switch (this.aiState) {\n      case 'idle':\n      case 'alert':\n        this.animState = 'idle';\n        break;\n      case 'advancing':\n      case 'retreating':\n      case 'flanking':\n        this.animState = 'walking';\n        break;\n      case 'charging':\n        this.animState = 'running';\n        break;\n      case 'aiming':\n        this.animState = 'aiming';\n        break;\n      case 'firing':\n        this.animState = 'firing';\n        break;\n      case 'reloading':\n        this.animState = 'reloading';\n        break;\n      case 'melee':\n        this.animState = 'bayonet_thrust';\n        break;\n    }\n  }\n\n  // Public methods\n  takeDamage(amount: number, fromAngle: number): void {\n    this.health -= amount;\n    this.lastDamageTime = performance.now();\n    this.consecutiveHits++;\n\n    if (this.health <= 0) {\n      this.health = 0;\n      this.changeState('dying');\n    } else {\n      // React to damage\n      this.animState = 'hit';\n\n      // Might change behavior based on damage\n      if (this.consecutiveHits >= 2 && Math.random() > this.config.bravery) {\n        this.changeState('retreating');\n      }\n    }\n  }\n\n  getAnimState(): EntityState { return this.animState; }\n  getAIState(): AIState { return this.aiState; }\n  getMusket(): Musket { return this.musket; }\n  getBayonet(): Bayonet { return this.bayonet; }\n  isAlive(): boolean { return this.aiState !== 'dead'; }\n  isDying(): boolean { return this.aiState === 'dying'; }\n  getAimProgress(): number { return this.aimProgress; }\n\n  // Get shooting direction with accuracy applied\n  getShootDirection(): { angle: number; pitch: number } {\n    const accuracySpread = lerp(0.15, 0.02, this.config.accuracy);\n    return {\n      angle: this.angle + randomRange(-accuracySpread, accuracySpread),\n      pitch: randomRange(-accuracySpread * 0.5, accuracySpread * 0.5)\n    };\n  }\n\n  // For collision detection\n  getHitbox(): { x: number; y: number; radius: number; height: number } {\n    return {\n      x: this.x,\n      y: this.y,\n      radius: 0.4,\n      height: 1.8\n    };\n  }\n}\n","// First-person weapon rendering with iron sights\n\nimport { Musket, MusketState, SmokeParticle } from './musket';\nimport { Bayonet, BayonetState, BloodParticle } from './bayonet';\nimport { lerp, clamp, ease } from '../engine/math';\n\nexport interface WeaponViewConfig {\n  // Positioning\n  baseX: number;\n  baseY: number;\n  hipOffsetX: number;\n  hipOffsetY: number;\n  adsOffsetX: number;\n  adsOffsetY: number;\n\n  // Animation\n  swayAmount: number;\n  bobAmount: number;\n  bobSpeed: number;\n  adsTransitionSpeed: number;\n}\n\nconst DEFAULT_WEAPON_VIEW_CONFIG: WeaponViewConfig = {\n  baseX: 0.5,\n  baseY: 0.85,\n  hipOffsetX: 0.15,\n  hipOffsetY: 0.1,\n  adsOffsetX: 0,\n  adsOffsetY: -0.1,\n  swayAmount: 0.02,\n  bobAmount: 0.015,\n  bobSpeed: 8,\n  adsTransitionSpeed: 6\n};\n\nexport class WeaponView {\n  private config: WeaponViewConfig;\n\n  // Animation state\n  private currentX: number = 0;\n  private currentY: number = 0;\n  private currentAngle: number = 0;\n  private bobPhase: number = 0;\n  private recoilOffset: number = 0;\n  private muzzleFlashAlpha: number = 0;\n\n  constructor(config: WeaponViewConfig = DEFAULT_WEAPON_VIEW_CONFIG) {\n    this.config = config;\n  }\n\n  update(dt: number, musket: Musket, bayonet: Bayonet, isMoving: boolean, isSprinting: boolean): void {\n    const weaponOffset = musket.getWeaponOffset();\n    const aimProgress = musket.getAimProgress();\n    const sway = musket.getSway();\n\n    // Target position based on aim state\n    const hipX = this.config.hipOffsetX;\n    const hipY = this.config.hipOffsetY;\n    const adsX = this.config.adsOffsetX;\n    const adsY = this.config.adsOffsetY;\n\n    let targetX = lerp(hipX, adsX, aimProgress);\n    let targetY = lerp(hipY, adsY, aimProgress);\n\n    // Add weapon system offsets\n    targetX += weaponOffset.x;\n    targetY += weaponOffset.y;\n\n    // Add sway\n    targetX += sway.x * (1 - aimProgress * 0.5);\n    targetY += sway.y * (1 - aimProgress * 0.5);\n\n    // Movement bob\n    if (isMoving) {\n      const speed = isSprinting ? this.config.bobSpeed * 1.5 : this.config.bobSpeed;\n      const amount = isSprinting ? this.config.bobAmount * 2 : this.config.bobAmount;\n      this.bobPhase += dt * speed;\n\n      targetY += Math.sin(this.bobPhase) * amount * (1 - aimProgress * 0.8);\n      targetX += Math.sin(this.bobPhase * 0.5) * amount * 0.5 * (1 - aimProgress * 0.8);\n    }\n\n    // Bayonet adjustments\n    const bayonetVisuals = bayonet.getVisuals();\n    if (bayonet.isFixed_()) {\n      targetX += bayonetVisuals.offsetX * 0.5;\n      targetY += bayonetVisuals.offsetY * 0.5;\n    }\n\n    // Smooth transitions\n    const transitionSpeed = this.config.adsTransitionSpeed;\n    this.currentX = lerp(this.currentX, targetX, dt * transitionSpeed);\n    this.currentY = lerp(this.currentY, targetY, dt * transitionSpeed);\n    this.currentAngle = lerp(this.currentAngle, weaponOffset.angle + bayonetVisuals.angle * 0.5, dt * transitionSpeed);\n\n    // Recoil decay\n    this.recoilOffset = lerp(this.recoilOffset, 0, dt * 8);\n\n    // Muzzle flash decay\n    this.muzzleFlashAlpha = Math.max(0, this.muzzleFlashAlpha - dt * 15);\n\n    // Trigger muzzle flash on fire\n    if (musket.getState() === 'fired' && musket.getStateTimer() < 0.02) {\n      this.recoilOffset = 0.08;\n      this.muzzleFlashAlpha = 1;\n    }\n  }\n\n  render(ctx: CanvasRenderingContext2D, width: number, height: number, musket: Musket, bayonet: Bayonet): void {\n    const baseX = width * this.config.baseX;\n    const baseY = height * this.config.baseY;\n\n    const weaponX = baseX + this.currentX * width;\n    const weaponY = baseY + this.currentY * height + this.recoilOffset * height;\n\n    ctx.save();\n    ctx.translate(weaponX, weaponY);\n    ctx.rotate(this.currentAngle - this.recoilOffset * 2);\n\n    const aimProgress = musket.getAimProgress();\n    const scale = lerp(1, 1.3, aimProgress);\n    ctx.scale(scale, scale);\n\n    // Draw musket\n    this.drawMusket(ctx, width, height, musket, bayonet, aimProgress);\n\n    ctx.restore();\n\n    // Draw muzzle flash (in screen space, above everything)\n    if (this.muzzleFlashAlpha > 0) {\n      this.drawMuzzleFlash(ctx, weaponX, weaponY - height * 0.15, this.muzzleFlashAlpha);\n    }\n\n    // Draw smoke particles\n    this.drawSmoke(ctx, width, height, musket.getSmokeParticles());\n\n    // Draw blood particles\n    this.drawBlood(ctx, width, height, bayonet.getBloodParticles());\n\n    // Draw reload step indicator\n    this.drawReloadIndicator(ctx, width, height, musket);\n  }\n\n  private drawMusket(\n    ctx: CanvasRenderingContext2D,\n    width: number,\n    height: number,\n    musket: Musket,\n    bayonet: Bayonet,\n    aimProgress: number\n  ): void {\n    const scale = height / 600; // Scale based on canvas height\n\n    // Colors\n    const woodColor = '#5c3d2e';\n    const woodDark = '#3a2518';\n    const metalColor = '#444';\n    const metalLight = '#666';\n    const metalDark = '#222';\n    const brassColor = '#b8860b';\n    const bayonetColor = '#9ca3af';\n    const bayonetShine = '#e5e7eb';\n\n    // Stock\n    ctx.fillStyle = woodColor;\n    ctx.beginPath();\n    ctx.moveTo(-100 * scale, 40 * scale);\n    ctx.quadraticCurveTo(-60 * scale, 35 * scale, 0, 25 * scale);\n    ctx.lineTo(30 * scale, 20 * scale);\n    ctx.lineTo(30 * scale, 30 * scale);\n    ctx.quadraticCurveTo(-20 * scale, 35 * scale, -60 * scale, 45 * scale);\n    ctx.lineTo(-100 * scale, 55 * scale);\n    ctx.closePath();\n    ctx.fill();\n\n    // Stock grain/detail\n    ctx.strokeStyle = woodDark;\n    ctx.lineWidth = 1;\n    ctx.beginPath();\n    ctx.moveTo(-90 * scale, 45 * scale);\n    ctx.quadraticCurveTo(-40 * scale, 38 * scale, 20 * scale, 28 * scale);\n    ctx.stroke();\n\n    // Barrel\n    ctx.fillStyle = metalColor;\n    const barrelLength = lerp(200, 160, aimProgress);\n    ctx.fillRect(20 * scale, 10 * scale, barrelLength * scale, 10 * scale);\n\n    // Barrel highlight\n    ctx.fillStyle = metalLight;\n    ctx.fillRect(20 * scale, 10 * scale, barrelLength * scale, 3 * scale);\n\n    // Barrel bands\n    ctx.fillStyle = brassColor;\n    ctx.fillRect(50 * scale, 8 * scale, 8 * scale, 14 * scale);\n    ctx.fillRect(120 * scale, 8 * scale, 8 * scale, 14 * scale);\n\n    // Lock plate\n    ctx.fillStyle = metalLight;\n    ctx.beginPath();\n    ctx.roundRect(25 * scale, 5 * scale, 45 * scale, 20 * scale, 3 * scale);\n    ctx.fill();\n\n    // Hammer/cock\n    const hammerAngle = musket.hasAmmo() ? -0.3 : 0;\n    ctx.save();\n    ctx.translate(45 * scale, 8 * scale);\n    ctx.rotate(hammerAngle);\n    ctx.fillStyle = metalDark;\n    ctx.fillRect(-3 * scale, -15 * scale, 6 * scale, 18 * scale);\n    // Flint\n    ctx.fillStyle = '#888';\n    ctx.fillRect(-2 * scale, -18 * scale, 4 * scale, 5 * scale);\n    ctx.restore();\n\n    // Frizzen (closed if primed)\n    ctx.fillStyle = metalColor;\n    ctx.fillRect(52 * scale, 2 * scale, 12 * scale, 12 * scale);\n\n    // Pan\n    ctx.fillStyle = brassColor;\n    ctx.fillRect(50 * scale, 12 * scale, 18 * scale, 5 * scale);\n\n    // Trigger guard\n    ctx.strokeStyle = brassColor;\n    ctx.lineWidth = 3 * scale;\n    ctx.beginPath();\n    ctx.arc(20 * scale, 35 * scale, 12 * scale, 0, Math.PI);\n    ctx.stroke();\n\n    // Trigger\n    ctx.fillStyle = metalColor;\n    ctx.fillRect(18 * scale, 30 * scale, 4 * scale, 10 * scale);\n\n    // Ramrod (if visible during reload)\n    const state = musket.getState();\n    if (state === 'reload_draw_ramrod' || state === 'reload_ram_charge' || state === 'reload_return_ramrod') {\n      ctx.fillStyle = woodColor;\n      ctx.fillRect(25 * scale, 35 * scale, 180 * scale, 4 * scale);\n    }\n\n    // Bayonet\n    if (bayonet.isFixed_()) {\n      const bayonetState = bayonet.getState();\n      let bayonetExtend = 1;\n\n      if (bayonetState === 'thrust') {\n        const timer = bayonet.getVisuals().offsetX;\n        bayonetExtend = 1 + timer * 2;\n      }\n\n      ctx.save();\n      ctx.translate((20 + barrelLength) * scale, 15 * scale);\n\n      // Bayonet socket\n      ctx.fillStyle = metalColor;\n      ctx.beginPath();\n      ctx.ellipse(0, 0, 6 * scale, 4 * scale, 0, 0, Math.PI * 2);\n      ctx.fill();\n\n      // Blade\n      ctx.fillStyle = bayonetColor;\n      const bladeLength = 70 * bayonetExtend;\n      ctx.beginPath();\n      ctx.moveTo(5 * scale, -3 * scale);\n      ctx.lineTo(bladeLength * scale, 0);\n      ctx.lineTo(5 * scale, 3 * scale);\n      ctx.closePath();\n      ctx.fill();\n\n      // Blade edge highlight\n      ctx.strokeStyle = bayonetShine;\n      ctx.lineWidth = 1;\n      ctx.beginPath();\n      ctx.moveTo(8 * scale, -2 * scale);\n      ctx.lineTo((bladeLength - 5) * scale, 0);\n      ctx.stroke();\n\n      // Blood on bayonet (if recently hit)\n      const blood = bayonet.getBloodParticles();\n      if (blood.length > 0) {\n        ctx.fillStyle = 'rgba(139, 0, 0, 0.7)';\n        ctx.beginPath();\n        ctx.ellipse(30 * scale, 0, 8 * scale, 2 * scale, 0, 0, Math.PI * 2);\n        ctx.fill();\n      }\n\n      ctx.restore();\n    }\n\n    // Iron sights when aiming\n    if (aimProgress > 0.3) {\n      const sightAlpha = (aimProgress - 0.3) / 0.7;\n      ctx.globalAlpha = sightAlpha;\n\n      // Rear sight (V-notch)\n      ctx.fillStyle = metalDark;\n      const rearSightX = lerp(60, 40, aimProgress);\n      ctx.fillRect(rearSightX * scale, -10 * scale, 20 * scale, 15 * scale);\n\n      // Notch cut\n      ctx.fillStyle = '#000';\n      ctx.beginPath();\n      ctx.moveTo((rearSightX + 7) * scale, -10 * scale);\n      ctx.lineTo((rearSightX + 10) * scale, 2 * scale);\n      ctx.lineTo((rearSightX + 13) * scale, -10 * scale);\n      ctx.closePath();\n      ctx.fill();\n\n      // Front sight post\n      ctx.fillStyle = metalDark;\n      const frontSightX = lerp(180, 140, aimProgress);\n      ctx.fillRect(frontSightX * scale, 0 * scale, 5 * scale, -15 * scale);\n\n      // Front sight blade\n      ctx.fillRect((frontSightX + 1) * scale, -18 * scale, 3 * scale, 8 * scale);\n\n      ctx.globalAlpha = 1;\n    }\n\n    // Hands\n    ctx.fillStyle = '#e8c39e';\n\n    // Forward hand (on forestock)\n    ctx.beginPath();\n    ctx.ellipse(-20 * scale, 30 * scale, 18 * scale, 12 * scale, -0.3, 0, Math.PI * 2);\n    ctx.fill();\n\n    // Fingers wrapped around\n    for (let i = 0; i < 4; i++) {\n      ctx.beginPath();\n      ctx.ellipse((-25 + i * 8) * scale, 22 * scale, 4 * scale, 8 * scale, 0, 0, Math.PI * 2);\n      ctx.fill();\n    }\n\n    // Rear hand (on grip) - partially visible\n    ctx.beginPath();\n    ctx.ellipse(-70 * scale, 35 * scale, 15 * scale, 10 * scale, 0.2, 0, Math.PI * 2);\n    ctx.fill();\n  }\n\n  private drawMuzzleFlash(ctx: CanvasRenderingContext2D, x: number, y: number, alpha: number): void {\n    ctx.save();\n    ctx.translate(x + 180, y);\n    ctx.globalAlpha = alpha;\n\n    // Outer glow\n    const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, 60);\n    gradient.addColorStop(0, 'rgba(255, 255, 200, 1)');\n    gradient.addColorStop(0.3, 'rgba(255, 200, 100, 0.8)');\n    gradient.addColorStop(0.6, 'rgba(255, 150, 50, 0.4)');\n    gradient.addColorStop(1, 'rgba(255, 100, 0, 0)');\n\n    ctx.fillStyle = gradient;\n    ctx.beginPath();\n    ctx.arc(0, 0, 60, 0, Math.PI * 2);\n    ctx.fill();\n\n    // Core flash\n    ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';\n    ctx.beginPath();\n    ctx.arc(0, 0, 15, 0, Math.PI * 2);\n    ctx.fill();\n\n    // Sparks\n    ctx.strokeStyle = 'rgba(255, 200, 100, 0.8)';\n    ctx.lineWidth = 2;\n    for (let i = 0; i < 8; i++) {\n      const angle = (i / 8) * Math.PI * 2 + Math.random() * 0.5;\n      const length = 20 + Math.random() * 30;\n      ctx.beginPath();\n      ctx.moveTo(10 * Math.cos(angle), 10 * Math.sin(angle));\n      ctx.lineTo(length * Math.cos(angle), length * Math.sin(angle));\n      ctx.stroke();\n    }\n\n    ctx.restore();\n  }\n\n  private drawSmoke(ctx: CanvasRenderingContext2D, width: number, height: number, particles: SmokeParticle[]): void {\n    // Smoke is rendered in world space by the main renderer\n    // This is for any screen-space smoke effects\n  }\n\n  private drawBlood(ctx: CanvasRenderingContext2D, width: number, height: number, particles: BloodParticle[]): void {\n    // Screen-space blood splatter\n    for (const p of particles) {\n      if (p.z < 0.5) continue; // Only show close particles\n\n      const screenX = width / 2 + (p.x - 0.5) * width * 0.5;\n      const screenY = height / 2 + (p.y - 0.5) * height * 0.5;\n\n      ctx.fillStyle = `rgba(139, 0, 0, ${p.alpha * 0.5})`;\n      ctx.beginPath();\n      ctx.arc(screenX, screenY, p.size * 20, 0, Math.PI * 2);\n      ctx.fill();\n    }\n  }\n\n  private drawReloadIndicator(ctx: CanvasRenderingContext2D, width: number, height: number, musket: Musket): void {\n    const progress = musket.getReloadProgress();\n    const stepName = musket.getReloadStepName();\n\n    if (!stepName) return;\n\n    const barWidth = 300;\n    const barHeight = 25;\n    const x = (width - barWidth) / 2;\n    const y = height - 60;\n\n    // Background\n    ctx.fillStyle = 'rgba(0, 0, 0, 0.6)';\n    ctx.beginPath();\n    ctx.roundRect(x - 5, y - 5, barWidth + 10, barHeight + 30, 5);\n    ctx.fill();\n\n    // Progress bar background\n    ctx.fillStyle = 'rgba(60, 40, 20, 0.8)';\n    ctx.fillRect(x, y, barWidth, barHeight);\n\n    // Progress bar fill\n    const gradient = ctx.createLinearGradient(x, y, x + barWidth * progress, y);\n    gradient.addColorStop(0, '#8b6914');\n    gradient.addColorStop(1, '#c9a55a');\n    ctx.fillStyle = gradient;\n    ctx.fillRect(x, y, barWidth * progress, barHeight);\n\n    // Border\n    ctx.strokeStyle = '#c9a55a';\n    ctx.lineWidth = 2;\n    ctx.strokeRect(x, y, barWidth, barHeight);\n\n    // Step name\n    ctx.fillStyle = '#fff';\n    ctx.font = '14px \"Palatino Linotype\", serif';\n    ctx.textAlign = 'center';\n    ctx.fillText(stepName, width / 2, y + barHeight + 18);\n  }\n}\n","// Procedural sprite generation for opponents and effects\n\nexport class SpriteGenerator {\n  private canvas: HTMLCanvasElement;\n  private ctx: CanvasRenderingContext2D;\n\n  constructor() {\n    this.canvas = document.createElement('canvas');\n    this.ctx = this.canvas.getContext('2d')!;\n  }\n\n  generateOpponentSprite(\n    state: string,\n    coatColor: [number, number, number],\n    width: number = 64,\n    height: number = 128\n  ): ImageData {\n    this.canvas.width = width;\n    this.canvas.height = height;\n    const ctx = this.ctx;\n\n    ctx.clearRect(0, 0, width, height);\n\n    const centerX = width / 2;\n\n    // Base colors\n    const coatRGB = `rgb(${coatColor[0]}, ${coatColor[1]}, ${coatColor[2]})`;\n    const coatDark = `rgb(${Math.floor(coatColor[0] * 0.7)}, ${Math.floor(coatColor[1] * 0.7)}, ${Math.floor(coatColor[2] * 0.7)})`;\n    const skinColor = '#e8c39e';\n    const hairColor = '#3a2a1a';\n    const pantsColor = '#f5f5dc';\n    const bootColor = '#2a1a0a';\n    const metalColor = '#555';\n    const woodColor = '#5c3d2e';\n    const bayonetColor = '#c0c0c0';\n\n    // Animation offsets\n    let armAngle = 0;\n    let legOffset = 0;\n    let weaponAngle = 0;\n    let weaponOffset = 0;\n\n    switch (state) {\n      case 'walking':\n        legOffset = Math.sin(Date.now() * 0.01) * 5;\n        armAngle = Math.sin(Date.now() * 0.01) * 0.2;\n        break;\n      case 'running':\n        legOffset = Math.sin(Date.now() * 0.02) * 8;\n        armAngle = Math.sin(Date.now() * 0.02) * 0.3;\n        break;\n      case 'aiming':\n        weaponAngle = -0.2;\n        weaponOffset = -10;\n        break;\n      case 'firing':\n        weaponAngle = -0.15;\n        weaponOffset = -8;\n        break;\n      case 'reloading':\n        weaponAngle = 0.3;\n        weaponOffset = 15;\n        break;\n      case 'bayonet_thrust':\n        weaponAngle = -0.4;\n        weaponOffset = -20;\n        break;\n      case 'hit':\n        // Recoil effect\n        break;\n      case 'dying':\n        // Falling animation\n        break;\n      case 'dead':\n        // Lying down\n        break;\n    }\n\n    // Draw in layers (back to front)\n\n    // Back arm (if visible)\n    ctx.fillStyle = coatDark;\n    ctx.save();\n    ctx.translate(centerX - 8, height * 0.35);\n    ctx.rotate(armAngle);\n    ctx.fillRect(-4, 0, 8, 25);\n    ctx.restore();\n\n    // Legs\n    ctx.fillStyle = pantsColor;\n    // Left leg\n    ctx.save();\n    ctx.translate(centerX - 6, height * 0.6);\n    ctx.fillRect(-5, legOffset, 10, 30);\n    ctx.restore();\n\n    // Right leg\n    ctx.save();\n    ctx.translate(centerX + 6, height * 0.6);\n    ctx.fillRect(-5, -legOffset, 10, 30);\n    ctx.restore();\n\n    // Boots\n    ctx.fillStyle = bootColor;\n    ctx.fillRect(centerX - 12, height * 0.88 + legOffset, 12, 10);\n    ctx.fillRect(centerX, height * 0.88 - legOffset, 12, 10);\n\n    // Body/Coat\n    ctx.fillStyle = coatRGB;\n    ctx.beginPath();\n    ctx.moveTo(centerX - 15, height * 0.28);\n    ctx.lineTo(centerX + 15, height * 0.28);\n    ctx.lineTo(centerX + 18, height * 0.6);\n    ctx.lineTo(centerX - 18, height * 0.6);\n    ctx.closePath();\n    ctx.fill();\n\n    // Coat tails\n    ctx.fillStyle = coatDark;\n    ctx.fillRect(centerX - 18, height * 0.55, 36, 15);\n\n    // Coat buttons (gold)\n    ctx.fillStyle = '#c9a55a';\n    for (let i = 0; i < 5; i++) {\n      ctx.beginPath();\n      ctx.arc(centerX, height * 0.32 + i * 6, 2, 0, Math.PI * 2);\n      ctx.fill();\n    }\n\n    // Crossbelt\n    ctx.strokeStyle = '#f5f5dc';\n    ctx.lineWidth = 4;\n    ctx.beginPath();\n    ctx.moveTo(centerX - 15, height * 0.3);\n    ctx.lineTo(centerX + 15, height * 0.55);\n    ctx.stroke();\n    ctx.beginPath();\n    ctx.moveTo(centerX + 15, height * 0.3);\n    ctx.lineTo(centerX - 15, height * 0.55);\n    ctx.stroke();\n\n    // Neck\n    ctx.fillStyle = skinColor;\n    ctx.fillRect(centerX - 5, height * 0.22, 10, 8);\n\n    // Head\n    ctx.fillStyle = skinColor;\n    ctx.beginPath();\n    ctx.ellipse(centerX, height * 0.15, 10, 12, 0, 0, Math.PI * 2);\n    ctx.fill();\n\n    // Hair/wig\n    ctx.fillStyle = hairColor;\n    ctx.beginPath();\n    ctx.ellipse(centerX, height * 0.11, 11, 8, 0, Math.PI, Math.PI * 2);\n    ctx.fill();\n\n    // Tricorn hat\n    ctx.fillStyle = '#1a1a1a';\n    ctx.beginPath();\n    ctx.moveTo(centerX - 18, height * 0.08);\n    ctx.lineTo(centerX, height * 0.02);\n    ctx.lineTo(centerX + 18, height * 0.08);\n    ctx.lineTo(centerX + 12, height * 0.12);\n    ctx.lineTo(centerX - 12, height * 0.12);\n    ctx.closePath();\n    ctx.fill();\n\n    // Hat cockade\n    ctx.fillStyle = '#c9a55a';\n    ctx.beginPath();\n    ctx.arc(centerX, height * 0.06, 3, 0, Math.PI * 2);\n    ctx.fill();\n\n    // Front arm holding musket\n    ctx.save();\n    ctx.translate(centerX + 8, height * 0.35);\n    ctx.rotate(-armAngle + weaponAngle);\n\n    // Arm\n    ctx.fillStyle = coatRGB;\n    ctx.fillRect(-4, 0, 8, 25);\n\n    // Hand\n    ctx.fillStyle = skinColor;\n    ctx.beginPath();\n    ctx.ellipse(0, 27, 5, 4, 0, 0, Math.PI * 2);\n    ctx.fill();\n\n    // Musket\n    ctx.save();\n    ctx.translate(5 + weaponOffset, 20);\n    ctx.rotate(0.3 + weaponAngle);\n\n    // Stock\n    ctx.fillStyle = woodColor;\n    ctx.beginPath();\n    ctx.moveTo(-15, 5);\n    ctx.lineTo(20, -5);\n    ctx.lineTo(22, -2);\n    ctx.lineTo(-13, 8);\n    ctx.closePath();\n    ctx.fill();\n\n    // Barrel\n    ctx.fillStyle = metalColor;\n    ctx.fillRect(15, -8, 45, 4);\n\n    // Bayonet\n    ctx.fillStyle = bayonetColor;\n    ctx.beginPath();\n    ctx.moveTo(58, -6);\n    ctx.lineTo(75, -6);\n    ctx.lineTo(78, -4);\n    ctx.lineTo(75, -2);\n    ctx.lineTo(58, -2);\n    ctx.closePath();\n    ctx.fill();\n\n    // Bayonet shine\n    ctx.strokeStyle = '#fff';\n    ctx.lineWidth = 1;\n    ctx.beginPath();\n    ctx.moveTo(60, -6);\n    ctx.lineTo(73, -6);\n    ctx.stroke();\n\n    ctx.restore(); // musket transform\n    ctx.restore(); // arm transform\n\n    // Eyes (simple)\n    ctx.fillStyle = '#1a1a1a';\n    ctx.beginPath();\n    ctx.arc(centerX - 4, height * 0.14, 1.5, 0, Math.PI * 2);\n    ctx.arc(centerX + 4, height * 0.14, 1.5, 0, Math.PI * 2);\n    ctx.fill();\n\n    return ctx.getImageData(0, 0, width, height);\n  }\n\n  generateSmokeSprite(size: number = 32): ImageData {\n    this.canvas.width = size;\n    this.canvas.height = size;\n    const ctx = this.ctx;\n\n    ctx.clearRect(0, 0, size, size);\n\n    const center = size / 2;\n\n    // Create radial gradient for smoke\n    const gradient = ctx.createRadialGradient(center, center, 0, center, center, center);\n    gradient.addColorStop(0, 'rgba(200, 200, 200, 0.8)');\n    gradient.addColorStop(0.5, 'rgba(180, 180, 180, 0.5)');\n    gradient.addColorStop(1, 'rgba(150, 150, 150, 0)');\n\n    ctx.fillStyle = gradient;\n    ctx.beginPath();\n    ctx.arc(center, center, center, 0, Math.PI * 2);\n    ctx.fill();\n\n    return ctx.getImageData(0, 0, size, size);\n  }\n\n  generateMuzzleFlashSprite(size: number = 48): ImageData {\n    this.canvas.width = size;\n    this.canvas.height = size;\n    const ctx = this.ctx;\n\n    ctx.clearRect(0, 0, size, size);\n\n    const center = size / 2;\n\n    // Outer glow\n    const gradient = ctx.createRadialGradient(center, center, 0, center, center, center);\n    gradient.addColorStop(0, 'rgba(255, 255, 200, 1)');\n    gradient.addColorStop(0.2, 'rgba(255, 200, 100, 0.9)');\n    gradient.addColorStop(0.5, 'rgba(255, 150, 50, 0.5)');\n    gradient.addColorStop(1, 'rgba(255, 100, 0, 0)');\n\n    ctx.fillStyle = gradient;\n    ctx.beginPath();\n    ctx.arc(center, center, center, 0, Math.PI * 2);\n    ctx.fill();\n\n    // Inner flash (star shape)\n    ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';\n    ctx.beginPath();\n    for (let i = 0; i < 8; i++) {\n      const angle = (i / 8) * Math.PI * 2;\n      const r = i % 2 === 0 ? center * 0.7 : center * 0.3;\n      const x = center + Math.cos(angle) * r;\n      const y = center + Math.sin(angle) * r;\n      if (i === 0) ctx.moveTo(x, y);\n      else ctx.lineTo(x, y);\n    }\n    ctx.closePath();\n    ctx.fill();\n\n    return ctx.getImageData(0, 0, size, size);\n  }\n\n  generateBloodSprite(size: number = 16): ImageData {\n    this.canvas.width = size;\n    this.canvas.height = size;\n    const ctx = this.ctx;\n\n    ctx.clearRect(0, 0, size, size);\n\n    const center = size / 2;\n\n    // Blood droplet\n    const gradient = ctx.createRadialGradient(center, center, 0, center, center, center);\n    gradient.addColorStop(0, 'rgba(180, 0, 0, 1)');\n    gradient.addColorStop(0.5, 'rgba(139, 0, 0, 0.8)');\n    gradient.addColorStop(1, 'rgba(100, 0, 0, 0)');\n\n    ctx.fillStyle = gradient;\n    ctx.beginPath();\n    ctx.arc(center, center, center * 0.8, 0, Math.PI * 2);\n    ctx.fill();\n\n    return ctx.getImageData(0, 0, size, size);\n  }\n\n  generateDirtSprite(size: number = 8): ImageData {\n    this.canvas.width = size;\n    this.canvas.height = size;\n    const ctx = this.ctx;\n\n    ctx.clearRect(0, 0, size, size);\n\n    const center = size / 2;\n\n    ctx.fillStyle = 'rgba(80, 60, 40, 0.8)';\n    ctx.beginPath();\n    ctx.arc(center, center, center * 0.7, 0, Math.PI * 2);\n    ctx.fill();\n\n    return ctx.getImageData(0, 0, size, size);\n  }\n}\n\n// Coat colors for different armies\nexport const COAT_COLORS = {\n  british_line: [170, 30, 30] as [number, number, number],      // Red coat\n  british_guards: [180, 20, 20] as [number, number, number],    // Darker red\n  french_line: [200, 200, 200] as [number, number, number],     // White/grey coat\n  french_guards: [30, 30, 170] as [number, number, number],     // Blue coat\n  prussian: [30, 50, 150] as [number, number, number],          // Prussian blue\n  austrian: [200, 200, 200] as [number, number, number],        // White coat\n  russian: [40, 100, 40] as [number, number, number],           // Green coat\n  hessian: [30, 80, 150] as [number, number, number],           // Blue coat\n  american_continental: [30, 50, 120] as [number, number, number], // Blue coat\n  american_militia: [120, 80, 40] as [number, number, number],  // Brown coat\n};\n","// Map definitions for Musket Duel\n\nimport { GameMap } from '../engine/types';\n\nexport interface MapDefinition {\n  id: string;\n  name: string;\n  description: string;\n  thumbnail?: string;\n  create: () => GameMap;\n}\n\n// Duel Field - Basic open dueling ground\nfunction createDuelField(): GameMap {\n  const width = 32;\n  const height = 32;\n\n  const tiles: number[][] = [];\n  const floor: number[][] = [];\n  const ceiling: number[][] = [];\n  const heightMap: number[][] = [];\n\n  for (let y = 0; y < height; y++) {\n    tiles[y] = [];\n    floor[y] = [];\n    ceiling[y] = [];\n    heightMap[y] = [];\n\n    for (let x = 0; x < width; x++) {\n      // Border walls (hedges)\n      if (x === 0 || x === width - 1 || y === 0 || y === height - 1) {\n        tiles[y][x] = 5;\n      }\n      // Some scattered obstacles\n      else if ((x === 8 && y >= 10 && y <= 14) ||\n               (x === 24 && y >= 18 && y <= 22) ||\n               (x >= 14 && x <= 18 && y === 16)) {\n        tiles[y][x] = 3; // Wood barrier\n      }\n      else {\n        tiles[y][x] = 0;\n      }\n\n      floor[y][x] = 1;\n      ceiling[y][x] = 0;\n      heightMap[y][x] = 1;\n    }\n  }\n\n  return {\n    width,\n    height,\n    tiles,\n    floor,\n    ceiling,\n    heightMap,\n    entities: [],\n    spawnPoints: [\n      { x: 5, y: 16 },\n      { x: 27, y: 16 }\n    ],\n    lighting: {\n      ambient: 0.3,\n      fogColor: [180, 190, 200],\n      fogDensity: 0.02,\n      lights: []\n    }\n  };\n}\n\n// Courtyard - A manor house courtyard with columns\nfunction createCourtyard(): GameMap {\n  const width = 40;\n  const height = 40;\n\n  const tiles: number[][] = [];\n  const floor: number[][] = [];\n  const ceiling: number[][] = [];\n  const heightMap: number[][] = [];\n\n  for (let y = 0; y < height; y++) {\n    tiles[y] = [];\n    floor[y] = [];\n    ceiling[y] = [];\n    heightMap[y] = [];\n\n    for (let x = 0; x < width; x++) {\n      // Outer walls (stone)\n      if (x === 0 || x === width - 1 || y === 0 || y === height - 1) {\n        tiles[y][x] = 2; // Stone\n      }\n      // Inner colonnade\n      else if ((x === 5 || x === width - 6) && y >= 5 && y <= height - 6 && y % 4 === 1) {\n        tiles[y][x] = 2; // Column (stone)\n      }\n      else if ((y === 5 || y === height - 6) && x >= 5 && x <= width - 6 && x % 4 === 1) {\n        tiles[y][x] = 2; // Column (stone)\n      }\n      // Central fountain/obstacle\n      else if (x >= 18 && x <= 22 && y >= 18 && y <= 22) {\n        if (x === 18 || x === 22 || y === 18 || y === 22) {\n          tiles[y][x] = 2; // Stone border\n        } else {\n          tiles[y][x] = 0;\n        }\n      }\n      // Some planters\n      else if ((x === 12 && y === 12) || (x === 28 && y === 12) ||\n               (x === 12 && y === 28) || (x === 28 && y === 28)) {\n        tiles[y][x] = 5; // Hedge/planter\n      }\n      else {\n        tiles[y][x] = 0;\n      }\n\n      floor[y][x] = 2; // Stone floor\n      ceiling[y][x] = 0;\n      heightMap[y][x] = 1;\n    }\n  }\n\n  return {\n    width,\n    height,\n    tiles,\n    floor,\n    ceiling,\n    heightMap,\n    entities: [],\n    spawnPoints: [\n      { x: 10, y: 20 },\n      { x: 30, y: 20 }\n    ],\n    lighting: {\n      ambient: 0.35,\n      fogColor: [200, 195, 185],\n      fogDensity: 0.015,\n      lights: []\n    }\n  };\n}\n\n// Forest Clearing - Trees and natural cover\nfunction createForestClearing(): GameMap {\n  const width = 48;\n  const height = 48;\n\n  const tiles: number[][] = [];\n  const floor: number[][] = [];\n  const ceiling: number[][] = [];\n  const heightMap: number[][] = [];\n\n  // Seeded random for consistent map\n  let seed = 12345;\n  const seededRandom = () => {\n    seed = (seed * 1103515245 + 12345) % 2147483648;\n    return seed / 2147483648;\n  };\n\n  for (let y = 0; y < height; y++) {\n    tiles[y] = [];\n    floor[y] = [];\n    ceiling[y] = [];\n    heightMap[y] = [];\n\n    for (let x = 0; x < width; x++) {\n      // Dense forest border\n      const distFromCenter = Math.sqrt((x - width/2)**2 + (y - height/2)**2);\n      const clearingRadius = 18;\n\n      if (x <= 1 || x >= width - 2 || y <= 1 || y >= height - 2) {\n        // Map boundary - dense trees\n        tiles[y][x] = 5; // Tree/hedge\n      }\n      else if (distFromCenter > clearingRadius) {\n        // Forest area - scattered trees\n        if (seededRandom() < 0.4) {\n          tiles[y][x] = 5; // Tree\n        } else {\n          tiles[y][x] = 0;\n        }\n      }\n      else if (distFromCenter > clearingRadius - 3) {\n        // Edge of clearing - sparse trees\n        if (seededRandom() < 0.15) {\n          tiles[y][x] = 5;\n        } else {\n          tiles[y][x] = 0;\n        }\n      }\n      else {\n        // Clearing with some cover\n        // A few fallen logs or rocks\n        if ((x === 20 && y >= 22 && y <= 26) ||\n            (x === 28 && y >= 22 && y <= 26) ||\n            (y === 24 && x >= 22 && x <= 26)) {\n          tiles[y][x] = 3; // Wood (log)\n        } else {\n          tiles[y][x] = 0;\n        }\n      }\n\n      floor[y][x] = 1;\n      ceiling[y][x] = 0;\n      heightMap[y][x] = 1;\n    }\n  }\n\n  return {\n    width,\n    height,\n    tiles,\n    floor,\n    ceiling,\n    heightMap,\n    entities: [],\n    spawnPoints: [\n      { x: 12, y: 24 },\n      { x: 36, y: 24 }\n    ],\n    lighting: {\n      ambient: 0.25, // Darker forest lighting\n      fogColor: [150, 170, 140], // Greenish fog\n      fogDensity: 0.03, // Denser fog\n      lights: []\n    }\n  };\n}\n\n// Town Square - Urban combat with buildings\nfunction createTownSquare(): GameMap {\n  const width = 50;\n  const height = 50;\n\n  const tiles: number[][] = [];\n  const floor: number[][] = [];\n  const ceiling: number[][] = [];\n  const heightMap: number[][] = [];\n\n  for (let y = 0; y < height; y++) {\n    tiles[y] = [];\n    floor[y] = [];\n    ceiling[y] = [];\n    heightMap[y] = [];\n\n    for (let x = 0; x < width; x++) {\n      // Outer boundary\n      if (x === 0 || x === width - 1 || y === 0 || y === height - 1) {\n        tiles[y][x] = 1; // Brick\n      }\n      // Building 1 (top-left)\n      else if (x >= 3 && x <= 12 && y >= 3 && y <= 12) {\n        if (x === 3 || x === 12 || y === 3 || y === 12) {\n          tiles[y][x] = 1; // Brick walls\n        } else {\n          tiles[y][x] = 0; // Interior (could add rooms)\n        }\n      }\n      // Building 2 (top-right)\n      else if (x >= 37 && x <= 46 && y >= 3 && y <= 12) {\n        if (x === 37 || x === 46 || y === 3 || y === 12) {\n          tiles[y][x] = 1;\n        } else {\n          tiles[y][x] = 0;\n        }\n      }\n      // Building 3 (bottom-left)\n      else if (x >= 3 && x <= 12 && y >= 37 && y <= 46) {\n        if (x === 3 || x === 12 || y === 37 || y === 46) {\n          tiles[y][x] = 1;\n        } else {\n          tiles[y][x] = 0;\n        }\n      }\n      // Building 4 (bottom-right)\n      else if (x >= 37 && x <= 46 && y >= 37 && y <= 46) {\n        if (x === 37 || x === 46 || y === 37 || y === 46) {\n          tiles[y][x] = 1;\n        } else {\n          tiles[y][x] = 0;\n        }\n      }\n      // Central monument/well\n      else if (x >= 23 && x <= 27 && y >= 23 && y <= 27) {\n        tiles[y][x] = 2; // Stone\n      }\n      // Market stalls (wooden barriers)\n      else if ((x >= 18 && x <= 20 && y === 15) ||\n               (x >= 30 && x <= 32 && y === 15) ||\n               (x >= 18 && x <= 20 && y === 35) ||\n               (x >= 30 && x <= 32 && y === 35)) {\n        tiles[y][x] = 3; // Wood\n      }\n      else {\n        tiles[y][x] = 0;\n      }\n\n      // Cobblestone floor pattern\n      floor[y][x] = ((x + y) % 2 === 0) ? 2 : 1;\n      ceiling[y][x] = 0;\n      heightMap[y][x] = 1;\n    }\n  }\n\n  return {\n    width,\n    height,\n    tiles,\n    floor,\n    ceiling,\n    heightMap,\n    entities: [],\n    spawnPoints: [\n      { x: 8, y: 25 },\n      { x: 42, y: 25 }\n    ],\n    lighting: {\n      ambient: 0.35,\n      fogColor: [180, 175, 165],\n      fogDensity: 0.018,\n      lights: []\n    }\n  };\n}\n\n// Bridge - Linear map with chokepoint\nfunction createBridge(): GameMap {\n  const width = 60;\n  const height = 24;\n\n  const tiles: number[][] = [];\n  const floor: number[][] = [];\n  const ceiling: number[][] = [];\n  const heightMap: number[][] = [];\n\n  for (let y = 0; y < height; y++) {\n    tiles[y] = [];\n    floor[y] = [];\n    ceiling[y] = [];\n    heightMap[y] = [];\n\n    for (let x = 0; x < width; x++) {\n      // River/chasm edges\n      if (y === 0 || y === height - 1) {\n        tiles[y][x] = 5; // Hedge/riverbank\n      }\n      // Bridge section (narrower)\n      else if (x >= 25 && x <= 35) {\n        if (y <= 6 || y >= height - 7) {\n          tiles[y][x] = 5; // Chasm edge\n        } else if (y === 7 || y === height - 8) {\n          tiles[y][x] = 2; // Stone railing\n        } else {\n          tiles[y][x] = 0; // Bridge walkway\n        }\n      }\n      // Land sections\n      else if (x < 25 || x > 35) {\n        if (y <= 2 || y >= height - 3) {\n          tiles[y][x] = 5; // Edge vegetation\n        }\n        // Some cover on land\n        else if ((x === 8 && y >= 8 && y <= 16) ||\n                 (x === 52 && y >= 8 && y <= 16) ||\n                 (x === 15 && y === 12) ||\n                 (x === 45 && y === 12)) {\n          tiles[y][x] = 3; // Wood barricade\n        }\n        else {\n          tiles[y][x] = 0;\n        }\n      }\n      else {\n        tiles[y][x] = 0;\n      }\n\n      floor[y][x] = (x >= 25 && x <= 35) ? 2 : 1; // Stone on bridge\n      ceiling[y][x] = 0;\n      heightMap[y][x] = 1;\n    }\n  }\n\n  return {\n    width,\n    height,\n    tiles,\n    floor,\n    ceiling,\n    heightMap,\n    entities: [],\n    spawnPoints: [\n      { x: 5, y: 12 },\n      { x: 55, y: 12 }\n    ],\n    lighting: {\n      ambient: 0.35,\n      fogColor: [170, 185, 200], // Blueish river mist\n      fogDensity: 0.02,\n      lights: []\n    }\n  };\n}\n\n// Estate Gardens - Formal garden with hedges\nfunction createEstateGardens(): GameMap {\n  const width = 44;\n  const height = 44;\n\n  const tiles: number[][] = [];\n  const floor: number[][] = [];\n  const ceiling: number[][] = [];\n  const heightMap: number[][] = [];\n\n  for (let y = 0; y < height; y++) {\n    tiles[y] = [];\n    floor[y] = [];\n    ceiling[y] = [];\n    heightMap[y] = [];\n\n    for (let x = 0; x < width; x++) {\n      // Outer wall\n      if (x === 0 || x === width - 1 || y === 0 || y === height - 1) {\n        tiles[y][x] = 1; // Brick wall\n      }\n      // Formal hedge patterns - outer square\n      else if ((x === 6 || x === width - 7) && y >= 6 && y <= height - 7) {\n        tiles[y][x] = 5; // Hedge\n      }\n      else if ((y === 6 || y === height - 7) && x >= 6 && x <= width - 7) {\n        // Openings in hedge\n        if ((x >= 20 && x <= 24) || (x >= width - 25 && x <= width - 21)) {\n          tiles[y][x] = 0;\n        } else {\n          tiles[y][x] = 5;\n        }\n      }\n      // Inner hedge square\n      else if ((x === 14 || x === width - 15) && y >= 14 && y <= height - 15) {\n        tiles[y][x] = 5;\n      }\n      else if ((y === 14 || y === height - 15) && x >= 14 && x <= width - 15) {\n        if (x === 22 || x === width - 23) {\n          tiles[y][x] = 0; // Opening\n        } else {\n          tiles[y][x] = 5;\n        }\n      }\n      // Center - decorative\n      else if (x >= 20 && x <= 24 && y >= 20 && y <= 24) {\n        if (x === 22 && y === 22) {\n          tiles[y][x] = 2; // Central statue/stone\n        } else if (x === 20 || x === 24 || y === 20 || y === 24) {\n          tiles[y][x] = 5; // Hedge\n        } else {\n          tiles[y][x] = 0;\n        }\n      }\n      // Corner decorations\n      else if ((x === 10 && y === 10) || (x === width - 11 && y === 10) ||\n               (x === 10 && y === height - 11) || (x === width - 11 && y === height - 11)) {\n        tiles[y][x] = 2; // Stone ornaments\n      }\n      else {\n        tiles[y][x] = 0;\n      }\n\n      floor[y][x] = 1;\n      ceiling[y][x] = 0;\n      heightMap[y][x] = 1;\n    }\n  }\n\n  return {\n    width,\n    height,\n    tiles,\n    floor,\n    ceiling,\n    heightMap,\n    entities: [],\n    spawnPoints: [\n      { x: 10, y: 22 },\n      { x: 34, y: 22 }\n    ],\n    lighting: {\n      ambient: 0.4,\n      fogColor: [190, 200, 180], // Garden green tint\n      fogDensity: 0.012,\n      lights: []\n    }\n  };\n}\n\n// Export all maps\nexport const MAPS: MapDefinition[] = [\n  {\n    id: 'duel_field',\n    name: 'Dueling Field',\n    description: 'A gentleman\\'s dueling ground with sparse cover',\n    create: createDuelField\n  },\n  {\n    id: 'courtyard',\n    name: 'Manor Courtyard',\n    description: 'An elegant stone courtyard with columns',\n    create: createCourtyard\n  },\n  {\n    id: 'forest',\n    name: 'Forest Clearing',\n    description: 'A woodland clearing surrounded by dense trees',\n    create: createForestClearing\n  },\n  {\n    id: 'town_square',\n    name: 'Town Square',\n    description: 'A busy market square with multiple buildings',\n    create: createTownSquare\n  },\n  {\n    id: 'bridge',\n    name: 'Stone Bridge',\n    description: 'A narrow bridge crossing - no retreat',\n    create: createBridge\n  },\n  {\n    id: 'gardens',\n    name: 'Estate Gardens',\n    description: 'Formal gardens with maze-like hedgerows',\n    create: createEstateGardens\n  }\n];\n\nexport function getMapById(id: string): MapDefinition | undefined {\n  return MAPS.find(m => m.id === id);\n}\n\nexport function getRandomMap(): MapDefinition {\n  return MAPS[Math.floor(Math.random() * MAPS.length)];\n}\n","// Main game orchestrator\n\nimport { Player, GameMap, InputState, RenderConfig, Entity, Sprite } from '../engine/types';\nimport { Renderer } from '../engine/renderer';\nimport { InputManager } from '../engine/input';\nimport { AudioSystem } from '../engine/audio';\nimport { vec2Distance, vec2, vec2FromAngle, vec2Add, vec2Scale, clamp, normalizeAngle, lerp } from '../engine/math';\nimport { Musket, SmokeParticle } from './musket';\nimport { Bayonet, BloodParticle } from './bayonet';\nimport { Opponent, OPPONENT_PRESETS } from './opponent';\nimport { WeaponView } from './weapon-view';\nimport { SpriteGenerator, COAT_COLORS } from './sprites';\nimport { MAPS, MapDefinition, getMapById } from './maps';\n\nexport type GameState = 'menu' | 'loading' | 'playing' | 'paused' | 'victory' | 'defeat' | 'intermission';\n\nexport interface GameMode {\n  name: string;\n  description: string;\n  rounds: number;\n  timeLimit: number;  // seconds, 0 = no limit\n  respawn: boolean;\n  opponentTypes: string[];\n}\n\nexport const GAME_MODES: Record<string, GameMode> = {\n  'duel': {\n    name: 'Gentleman\\'s Duel',\n    description: 'A formal duel. One shot, one chance. First to land a hit wins.',\n    rounds: 3,\n    timeLimit: 0,\n    respawn: false,\n    opponentTypes: ['regular']\n  },\n  'skirmish': {\n    name: 'Skirmish',\n    description: 'Face multiple opponents in succession.',\n    rounds: 5,\n    timeLimit: 120,\n    respawn: false,\n    opponentTypes: ['militia', 'regular', 'regular', 'grenadier', 'officer']\n  },\n  'survival': {\n    name: 'Survival',\n    description: 'How long can you last against endless waves?',\n    rounds: 999,\n    timeLimit: 0,\n    respawn: true,\n    opponentTypes: ['militia', 'regular', 'grenadier', 'veteran']\n  },\n  'campaign': {\n    name: 'Campaign',\n    description: 'Fight through the ranks from militia to facing veteran duelists.',\n    rounds: 10,\n    timeLimit: 0,\n    respawn: false,\n    opponentTypes: ['militia', 'militia', 'regular', 'regular', 'regular', 'grenadier', 'grenadier', 'officer', 'officer', 'veteran']\n  }\n};\n\nexport class Game {\n  // Core systems\n  private renderer: Renderer;\n  private input: InputManager;\n  private audio: AudioSystem;\n\n  // Game state\n  private gameState: GameState = 'menu';\n  private currentMode: GameMode | null = null;\n  private currentRound: number = 0;\n  private roundTime: number = 0;\n  private score: number = 0;\n  private selectedMapIndex: number = 0;\n  private menuSection: 'modes' | 'maps' = 'modes';\n\n  // Player\n  private player: Player;\n  private playerMusket: Musket;\n  private playerBayonet: Bayonet;\n\n  // Opponents\n  private opponents: Opponent[] = [];\n  private activeOpponent: Opponent | null = null;\n\n  // Map\n  private map: GameMap;\n\n  // Visual effects\n  private sprites: Sprite[] = [];\n  private screenShake: number = 0;\n  private screenFlash: number = 0;\n  private hitMarker: number = 0;\n\n  // Timing\n  private lastTime: number = 0;\n  private deltaTime: number = 0;\n  private fps: number = 0;\n  private frameCount: number = 0;\n  private fpsTimer: number = 0;\n\n  // UI elements\n  private canvas: HTMLCanvasElement;\n  private uiCanvas: HTMLCanvasElement;\n  private uiCtx: CanvasRenderingContext2D;\n\n  // Weapon view\n  private weaponView: WeaponView;\n\n  // Sprite generator\n  private spriteGenerator: SpriteGenerator;\n\n  constructor(gameCanvas: HTMLCanvasElement, uiCanvas: HTMLCanvasElement) {\n    this.canvas = gameCanvas;\n    this.uiCanvas = uiCanvas;\n    this.uiCtx = uiCanvas.getContext('2d')!;\n\n    // Initialize renderer\n    const renderConfig: RenderConfig = {\n      width: 800,\n      height: 600,\n      fov: 75,\n      renderDistance: 60,\n      textureQuality: 'high',\n      enableLighting: true,\n      enableFog: true,\n      enableParticles: true,\n      enableShadows: false\n    };\n\n    this.renderer = new Renderer(gameCanvas, renderConfig);\n    this.input = new InputManager(gameCanvas);\n    this.audio = new AudioSystem();\n\n    // Initialize player\n    this.player = this.createPlayer();\n    this.playerMusket = new Musket();\n    this.playerBayonet = new Bayonet();\n\n    // Initialize map\n    this.map = this.createDuelMap();\n\n    // Initialize weapon view\n    this.weaponView = new WeaponView();\n\n    // Initialize sprite generator\n    this.spriteGenerator = new SpriteGenerator();\n\n    // Generate textures\n    this.generateTextures();\n\n    // Generate opponent sprites\n    this.generateOpponentSprites();\n  }\n\n  private createPlayer(): Player {\n    return {\n      x: 5,\n      y: 10,\n      z: 0,\n      angle: 0,\n      pitch: 0,\n      velocityX: 0,\n      velocityY: 0,\n      velocityZ: 0,\n      isMoving: false,\n      isCrouching: false,\n      isSprinting: false,\n      stamina: 100,\n      health: 100\n    };\n  }\n\n  private createDuelMap(): GameMap {\n    // Simple dueling ground - open field with some cover\n    const width = 32;\n    const height = 32;\n\n    const tiles: number[][] = [];\n    const floor: number[][] = [];\n    const ceiling: number[][] = [];\n    const heightMap: number[][] = [];\n\n    for (let y = 0; y < height; y++) {\n      tiles[y] = [];\n      floor[y] = [];\n      ceiling[y] = [];\n      heightMap[y] = [];\n\n      for (let x = 0; x < width; x++) {\n        // Border walls\n        if (x === 0 || x === width - 1 || y === 0 || y === height - 1) {\n          tiles[y][x] = 5; // Hedge\n        }\n        // Some obstacles\n        else if ((x === 8 && y >= 10 && y <= 14) ||\n          (x === 24 && y >= 18 && y <= 22) ||\n          (x >= 14 && x <= 18 && y === 16)) {\n          tiles[y][x] = 3; // Wood barrier\n        }\n        else {\n          tiles[y][x] = 0; // Empty\n        }\n\n        floor[y][x] = 1;\n        ceiling[y][x] = 0;\n        heightMap[y][x] = 1;\n      }\n    }\n\n    return {\n      width,\n      height,\n      tiles,\n      floor,\n      ceiling,\n      heightMap,\n      entities: [],\n      spawnPoints: [\n        { x: 5, y: 16 },\n        { x: 27, y: 16 }\n      ],\n      lighting: {\n        ambient: 0.3,\n        fogColor: [180, 190, 200],\n        fogDensity: 0.02,\n        lights: []\n      }\n    };\n  }\n\n  private generateTextures(): void {\n    // Wall brick texture\n    this.renderer.generateProceduralTexture('wall_brick', 64, 64, (x, y) => {\n      const brickW = 16;\n      const brickH = 8;\n      const mortarW = 1;\n\n      const bx = x % brickW;\n      const by = y % brickH;\n      const row = Math.floor(y / brickH);\n      const offset = row % 2 === 0 ? 0 : brickW / 2;\n      const ax = (x + offset) % brickW;\n\n      // Mortar\n      if (ax < mortarW || by < mortarW) {\n        return [80, 80, 75, 255];\n      }\n\n      // Brick with variation\n      const noise = Math.random() * 20 - 10;\n      const r = 140 + noise;\n      const g = 70 + noise * 0.5;\n      const b = 60 + noise * 0.3;\n\n      return [r, g, b, 255];\n    });\n\n    // Stone texture\n    this.renderer.generateProceduralTexture('wall_stone', 64, 64, (x, y) => {\n      const noise = Math.random() * 30;\n      const base = 100 + Math.sin(x * 0.2) * 10 + Math.cos(y * 0.3) * 10;\n      return [base + noise, base + noise - 5, base + noise - 10, 255];\n    });\n\n    // Wood texture\n    this.renderer.generateProceduralTexture('wall_wood', 64, 64, (x, y) => {\n      const grain = Math.sin(y * 0.8 + Math.sin(x * 0.1) * 3) * 20;\n      const base = 120;\n      return [base + grain, base - 30 + grain * 0.5, base - 60 + grain * 0.3, 255];\n    });\n\n    // Plaster texture\n    this.renderer.generateProceduralTexture('wall_plaster', 64, 64, (x, y) => {\n      const noise = Math.random() * 15;\n      return [230 - noise, 220 - noise, 200 - noise, 255];\n    });\n\n    // Hedge texture\n    this.renderer.generateProceduralTexture('wall_hedge', 64, 64, (x, y) => {\n      const noise = Math.random() * 40;\n      const isLeaf = Math.random() > 0.3;\n      if (isLeaf) {\n        return [30 + noise, 80 + noise, 30 + noise * 0.5, 255];\n      } else {\n        return [40, 30, 20, 255];  // Branch\n      }\n    });\n  }\n\n  private generateOpponentSprites(): void {\n    // Animation states to generate\n    const states = ['idle', 'walking', 'running', 'aiming', 'firing', 'reloading', 'bayonet_thrust', 'hit', 'dying', 'dead'];\n\n    // Generate sprites for each state\n    for (const state of states) {\n      const imageData = this.spriteGenerator.generateOpponentSprite(state, COAT_COLORS.british_line, 64, 128);\n\n      // Convert ImageData to Uint32Array for renderer\n      const data = new Uint32Array(imageData.width * imageData.height);\n      const srcData = imageData.data;\n      for (let i = 0; i < data.length; i++) {\n        const j = i * 4;\n        // ABGR format for little-endian systems\n        data[i] = (srcData[j + 3] << 24) | (srcData[j + 2] << 16) | (srcData[j + 1] << 8) | srcData[j];\n      }\n\n      this.renderer.registerTexture(`opponent_${state}`, {\n        id: `opponent_${state}`,\n        width: imageData.width,\n        height: imageData.height,\n        data\n      });\n    }\n\n    // Generate smoke particle texture\n    const smokeData = this.spriteGenerator.generateSmokeSprite(32);\n    const smokePixels = new Uint32Array(smokeData.width * smokeData.height);\n    const smokeSrc = smokeData.data;\n    for (let i = 0; i < smokePixels.length; i++) {\n      const j = i * 4;\n      smokePixels[i] = (smokeSrc[j + 3] << 24) | (smokeSrc[j + 2] << 16) | (smokeSrc[j + 1] << 8) | smokeSrc[j];\n    }\n    this.renderer.registerTexture('smoke', {\n      id: 'smoke',\n      width: smokeData.width,\n      height: smokeData.height,\n      data: smokePixels\n    });\n\n    // Generate muzzle flash texture\n    const flashData = this.spriteGenerator.generateMuzzleFlashSprite(48);\n    const flashPixels = new Uint32Array(flashData.width * flashData.height);\n    const flashSrc = flashData.data;\n    for (let i = 0; i < flashPixels.length; i++) {\n      const j = i * 4;\n      flashPixels[i] = (flashSrc[j + 3] << 24) | (flashSrc[j + 2] << 16) | (flashSrc[j + 1] << 8) | flashSrc[j];\n    }\n    this.renderer.registerTexture('muzzle_flash', {\n      id: 'muzzle_flash',\n      width: flashData.width,\n      height: flashData.height,\n      data: flashPixels\n    });\n\n    // Generate blood particle texture\n    const bloodData = this.spriteGenerator.generateBloodSprite(16);\n    const bloodPixels = new Uint32Array(bloodData.width * bloodData.height);\n    const bloodSrc = bloodData.data;\n    for (let i = 0; i < bloodPixels.length; i++) {\n      const j = i * 4;\n      bloodPixels[i] = (bloodSrc[j + 3] << 24) | (bloodSrc[j + 2] << 16) | (bloodSrc[j + 1] << 8) | bloodSrc[j];\n    }\n    this.renderer.registerTexture('blood', {\n      id: 'blood',\n      width: bloodData.width,\n      height: bloodData.height,\n      data: bloodPixels\n    });\n  }\n\n  async initialize(): Promise<void> {\n    // Load any external assets here\n    // For now we're using procedural generation\n\n    this.gameState = 'menu';\n  }\n\n  startGame(modeName: string): void {\n    const mode = GAME_MODES[modeName];\n    if (!mode) return;\n\n    this.currentMode = mode;\n    this.currentRound = 0;\n    this.score = 0;\n    this.gameState = 'loading';\n\n    // Create the selected map\n    const mapDef = MAPS[this.selectedMapIndex];\n    this.map = mapDef.create();\n\n    // Reset player\n    this.player = this.createPlayer();\n    this.player.x = this.map.spawnPoints[0].x;\n    this.player.y = this.map.spawnPoints[0].y;\n    this.player.angle = 0;\n\n    this.playerMusket = new Musket();\n    this.playerBayonet = new Bayonet();\n\n    // Start first round\n    this.startRound();\n  }\n\n  private startRound(): void {\n    if (!this.currentMode) return;\n\n    this.currentRound++;\n    this.roundTime = 0;\n\n    // Reset player position and health\n    this.player.x = this.map.spawnPoints[0].x;\n    this.player.y = this.map.spawnPoints[0].y;\n    this.player.angle = 0;\n    this.player.health = 100;\n\n    // Spawn opponent\n    const opponentType = this.currentMode.opponentTypes[\n      Math.min(this.currentRound - 1, this.currentMode.opponentTypes.length - 1)\n    ];\n\n    this.activeOpponent = new Opponent(\n      `opponent_${this.currentRound}`,\n      this.map.spawnPoints[1].x,\n      this.map.spawnPoints[1].y,\n      Math.PI,\n      opponentType\n    );\n\n    this.opponents = [this.activeOpponent];\n    this.gameState = 'playing';\n  }\n\n  update(timestamp: number): void {\n    // Calculate delta time\n    if (this.lastTime === 0) this.lastTime = timestamp;\n    this.deltaTime = Math.min((timestamp - this.lastTime) / 1000, 0.1);  // Cap at 100ms\n    this.lastTime = timestamp;\n\n    // FPS counter\n    this.frameCount++;\n    this.fpsTimer += this.deltaTime;\n    if (this.fpsTimer >= 1) {\n      this.fps = this.frameCount;\n      this.frameCount = 0;\n      this.fpsTimer = 0;\n    }\n\n    // Get input\n    const inputState = this.input.getState();\n\n    // State-specific updates\n    switch (this.gameState) {\n      case 'playing':\n        this.updatePlaying(inputState);\n        break;\n      case 'paused':\n        if (inputState.interact) {\n          this.gameState = 'playing';\n        }\n        break;\n      case 'menu':\n        // Menu handled by UI\n        break;\n    }\n\n    // Render\n    this.render();\n\n    // Clear mouse deltas\n    this.input.update();\n  }\n\n  private updatePlaying(input: InputState): void {\n    const dt = this.deltaTime;\n\n    // Update round time\n    this.roundTime += dt;\n\n    // Check time limit\n    if (this.currentMode && this.currentMode.timeLimit > 0) {\n      if (this.roundTime >= this.currentMode.timeLimit) {\n        this.endRound(false);\n        return;\n      }\n    }\n\n    // Update player\n    this.updatePlayer(input, dt);\n\n    // Update weapons\n    this.playerMusket.update(dt, input, this.player);\n    this.playerBayonet.update(dt, input, this.player, this.opponents.map(o => ({\n      id: o.id,\n      type: 'opponent' as const,\n      x: o.x,\n      y: o.y,\n      z: o.z,\n      angle: o.angle,\n      state: o.getAnimState(),\n      health: o.health,\n      sprite: { id: o.id, x: o.x, y: o.y, z: 0, texture: 'opponent', scale: 1 }\n    })));\n\n    // Update opponents\n    for (const opponent of this.opponents) {\n      opponent.update(dt, this.player, this.map);\n    }\n\n    // Process combat\n    this.processCombat(dt);\n\n    // Update audio listener position\n    this.audio.setListenerPosition(this.player.x, this.player.y, this.player.angle);\n\n    // Decay visual effects\n    this.screenShake *= 0.9;\n    this.screenFlash *= 0.95;\n    this.hitMarker = Math.max(0, this.hitMarker - dt * 3);\n\n    // Check win/lose conditions\n    this.checkRoundEnd();\n  }\n\n  private updatePlayer(input: InputState, dt: number): void {\n    // Mouse look\n    if (this.input.isLocked()) {\n      this.player.angle = normalizeAngle(this.player.angle + input.mouseDeltaX);\n      this.player.pitch = clamp(this.player.pitch - input.mouseDeltaY, -0.5, 0.5);\n    }\n\n    // Keyboard turning (backup)\n    if (input.turnLeft) this.player.angle = normalizeAngle(this.player.angle - 2 * dt);\n    if (input.turnRight) this.player.angle = normalizeAngle(this.player.angle + 2 * dt);\n\n    // Movement\n    const moveSpeed = input.sprint && !input.aim ? 5 : (input.crouch ? 1.5 : 3);\n    const bayonetMult = this.playerBayonet.getMovementMultiplier();\n\n    let moveX = 0;\n    let moveY = 0;\n\n    if (input.forward) {\n      moveX += Math.cos(this.player.angle);\n      moveY += Math.sin(this.player.angle);\n    }\n    if (input.backward) {\n      moveX -= Math.cos(this.player.angle) * 0.6;\n      moveY -= Math.sin(this.player.angle) * 0.6;\n    }\n    if (input.left) {\n      moveX += Math.cos(this.player.angle - Math.PI / 2) * 0.7;\n      moveY += Math.sin(this.player.angle - Math.PI / 2) * 0.7;\n    }\n    if (input.right) {\n      moveX += Math.cos(this.player.angle + Math.PI / 2) * 0.7;\n      moveY += Math.sin(this.player.angle + Math.PI / 2) * 0.7;\n    }\n\n    // Normalize diagonal movement\n    const moveLen = Math.sqrt(moveX * moveX + moveY * moveY);\n    if (moveLen > 0) {\n      moveX /= moveLen;\n      moveY /= moveLen;\n    }\n\n    // Apply movement\n    const newX = this.player.x + moveX * moveSpeed * bayonetMult * dt;\n    const newY = this.player.y + moveY * moveSpeed * bayonetMult * dt;\n\n    // Collision detection\n    if (!this.checkCollision(newX, this.player.y)) {\n      this.player.x = newX;\n    }\n    if (!this.checkCollision(this.player.x, newY)) {\n      this.player.y = newY;\n    }\n\n    this.player.isMoving = moveLen > 0;\n    this.player.isCrouching = input.crouch;\n    this.player.isSprinting = input.sprint && !input.aim;\n\n    // Footsteps\n    if (this.player.isMoving) {\n      const footstepInterval = this.player.isSprinting ? 0.3 : 0.5;\n      // Audio footsteps would go here\n    }\n  }\n\n  private checkCollision(x: number, y: number): boolean {\n    const margin = 0.3;\n    const corners = [\n      { x: x - margin, y: y - margin },\n      { x: x + margin, y: y - margin },\n      { x: x - margin, y: y + margin },\n      { x: x + margin, y: y + margin }\n    ];\n\n    for (const corner of corners) {\n      const tileX = Math.floor(corner.x);\n      const tileY = Math.floor(corner.y);\n\n      if (tileX < 0 || tileX >= this.map.width || tileY < 0 || tileY >= this.map.height) {\n        return true;\n      }\n\n      if (this.map.tiles[tileY][tileX] > 0) {\n        return true;\n      }\n    }\n\n    return false;\n  }\n\n  private processCombat(dt: number): void {\n    // Player projectiles hitting opponents\n    const projectiles = this.playerMusket.getProjectiles();\n    for (let i = projectiles.length - 1; i >= 0; i--) {\n      const proj = projectiles[i];\n\n      for (const opponent of this.opponents) {\n        if (!opponent.isAlive()) continue;\n\n        const hitbox = opponent.getHitbox();\n        const dist = Math.sqrt(\n          (proj.x - hitbox.x) ** 2 +\n          (proj.y - hitbox.y) ** 2\n        );\n\n        if (dist < hitbox.radius && proj.z > 0 && proj.z < hitbox.height) {\n          // Hit!\n          const damage = proj.damage;\n          opponent.takeDamage(damage, Math.atan2(proj.vy, proj.vx));\n\n          this.playerMusket.removeProjectile(i);\n          this.screenShake = 0.05;\n          this.hitMarker = 1;\n          this.audio.playImpact('flesh');\n          break;\n        }\n      }\n\n      // Check wall collision\n      const tileX = Math.floor(proj.x);\n      const tileY = Math.floor(proj.y);\n      if (tileX >= 0 && tileX < this.map.width && tileY >= 0 && tileY < this.map.height) {\n        if (this.map.tiles[tileY][tileX] > 0) {\n          this.playerMusket.removeProjectile(i);\n          this.audio.playImpact('wood');\n        }\n      }\n    }\n\n    // Player bayonet hits\n    const bayonetHits = this.playerBayonet.getPendingHits();\n    for (const hit of bayonetHits) {\n      const opponent = this.opponents.find(o => o.id === hit.targetId);\n      if (opponent && opponent.isAlive()) {\n        opponent.takeDamage(hit.damage, this.player.angle);\n        this.screenShake = 0.08;\n        this.hitMarker = 1;\n        this.audio.playBayonetClash();\n\n        if (hit.isCritical) {\n          this.screenFlash = 0.3;\n        }\n      }\n    }\n\n    // Opponent shooting at player\n    for (const opponent of this.opponents) {\n      if (!opponent.isAlive()) continue;\n\n      const oppProjectiles = opponent.getMusket().getProjectiles();\n      for (let i = oppProjectiles.length - 1; i >= 0; i--) {\n        const proj = oppProjectiles[i];\n        const dist = Math.sqrt(\n          (proj.x - this.player.x) ** 2 +\n          (proj.y - this.player.y) ** 2\n        );\n\n        if (dist < 0.5 && proj.z > 0 && proj.z < 1.8) {\n          // Player hit!\n          this.player.health -= proj.damage;\n          opponent.getMusket().removeProjectile(i);\n          this.screenShake = 0.15;\n          this.screenFlash = 0.5;\n          this.audio.playImpact('flesh');\n          break;\n        }\n      }\n\n      // Opponent bayonet\n      const oppBayonetHits = opponent.getBayonet().getPendingHits();\n      // (would need to check if player was hit)\n    }\n\n    // Trigger shooting sounds\n    if (this.playerMusket.getState() === 'fired' && this.playerMusket.getStateTimer() < 0.02) {\n      this.audio.playMusketShot(this.player.x, this.player.y);\n      this.screenShake = 0.1;\n    }\n\n    for (const opponent of this.opponents) {\n      const state = opponent.getMusket().getState();\n      if (state === 'fired' && opponent.getMusket().getStateTimer() < 0.02) {\n        this.audio.playMusketShot(opponent.x, opponent.y);\n      }\n    }\n  }\n\n  private checkRoundEnd(): void {\n    // Player dead\n    if (this.player.health <= 0) {\n      this.endRound(false);\n      return;\n    }\n\n    // All opponents dead\n    const allDead = this.opponents.every(o => !o.isAlive());\n    if (allDead) {\n      this.endRound(true);\n      return;\n    }\n  }\n\n  private endRound(victory: boolean): void {\n    if (victory) {\n      this.score += 100 + Math.floor(this.player.health);\n\n      if (this.currentMode && this.currentRound >= this.currentMode.rounds) {\n        this.gameState = 'victory';\n      } else {\n        this.gameState = 'intermission';\n        setTimeout(() => this.startRound(), 3000);\n      }\n    } else {\n      this.gameState = 'defeat';\n    }\n  }\n\n  private render(): void {\n    // Apply screen shake\n    const shakeX = (Math.random() - 0.5) * this.screenShake * 20;\n    const shakeY = (Math.random() - 0.5) * this.screenShake * 20;\n\n    // Clear and render 3D scene\n    this.renderer.clear(100, 150, 200);\n    this.renderer.renderSkyAndFloor(this.player, this.map);\n    this.renderer.renderWalls(this.player, this.map);\n\n    // Render sprites (opponents, particles)\n    const allSprites: Sprite[] = [];\n\n    // Add opponent sprites\n    for (const opponent of this.opponents) {\n      allSprites.push({\n        id: opponent.id,\n        x: opponent.x,\n        y: opponent.y,\n        z: 0,\n        texture: 'opponent_' + opponent.getAnimState(),\n        scale: 1,\n        billboard: true\n      });\n    }\n\n    // Add smoke particles\n    for (const particle of this.playerMusket.getSmokeParticles()) {\n      allSprites.push({\n        id: `smoke_${Math.random()}`,\n        x: particle.x,\n        y: particle.y,\n        z: particle.z,\n        texture: 'smoke',\n        scale: particle.size,\n        billboard: true\n      });\n    }\n\n    this.renderer.renderSprites(allSprites, this.player);\n\n    // Present 3D scene\n    this.renderer.present();\n\n    // Render UI overlay\n    this.renderUI(shakeX, shakeY);\n  }\n\n  private renderUI(shakeX: number, shakeY: number): void {\n    const ctx = this.uiCtx;\n    const w = this.uiCanvas.width;\n    const h = this.uiCanvas.height;\n\n    ctx.clearRect(0, 0, w, h);\n\n    // Apply shake to UI canvas position\n    ctx.save();\n    ctx.translate(shakeX, shakeY);\n\n    // Screen flash\n    if (this.screenFlash > 0.01) {\n      ctx.fillStyle = `rgba(255, 0, 0, ${this.screenFlash * 0.5})`;\n      ctx.fillRect(0, 0, w, h);\n    }\n\n    // Render weapon view\n    this.renderWeapon(ctx, w, h);\n\n    // Render HUD elements (minimal - no artificial overlays per spec)\n    this.renderHUD(ctx, w, h);\n\n    // Hit marker\n    if (this.hitMarker > 0) {\n      ctx.strokeStyle = `rgba(255, 255, 255, ${this.hitMarker})`;\n      ctx.lineWidth = 2;\n      const cx = w / 2;\n      const cy = h / 2;\n      const size = 15;\n\n      ctx.beginPath();\n      ctx.moveTo(cx - size, cy - size);\n      ctx.lineTo(cx - size / 2, cy - size / 2);\n      ctx.moveTo(cx + size, cy - size);\n      ctx.lineTo(cx + size / 2, cy - size / 2);\n      ctx.moveTo(cx - size, cy + size);\n      ctx.lineTo(cx - size / 2, cy + size / 2);\n      ctx.moveTo(cx + size, cy + size);\n      ctx.lineTo(cx + size / 2, cy + size / 2);\n      ctx.stroke();\n    }\n\n    // Game state overlays\n    if (this.gameState === 'menu') {\n      this.renderMenu(ctx, w, h);\n    } else if (this.gameState === 'victory') {\n      this.renderEndScreen(ctx, w, h, true);\n    } else if (this.gameState === 'defeat') {\n      this.renderEndScreen(ctx, w, h, false);\n    } else if (this.gameState === 'intermission') {\n      this.renderIntermission(ctx, w, h);\n    }\n\n    ctx.restore();\n  }\n\n  private renderWeapon(ctx: CanvasRenderingContext2D, w: number, h: number): void {\n    // Update and render weapon view\n    this.weaponView.update(\n      this.deltaTime,\n      this.playerMusket,\n      this.playerBayonet,\n      this.player.isMoving,\n      this.player.isSprinting\n    );\n\n    this.weaponView.render(ctx, w, h, this.playerMusket, this.playerBayonet);\n  }\n\n  private renderHUD(ctx: CanvasRenderingContext2D, w: number, h: number): void {\n    // Minimal HUD - health shown subtly as screen vignette\n    if (this.player.health < 50) {\n      const intensity = (50 - this.player.health) / 50;\n      const gradient = ctx.createRadialGradient(w / 2, h / 2, h / 3, w / 2, h / 2, h);\n      gradient.addColorStop(0, 'rgba(139, 0, 0, 0)');\n      gradient.addColorStop(1, `rgba(139, 0, 0, ${intensity * 0.5})`);\n      ctx.fillStyle = gradient;\n      ctx.fillRect(0, 0, w, h);\n    }\n\n    // Round info (top)\n    if (this.currentMode && this.gameState === 'playing') {\n      ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';\n      ctx.fillRect(w / 2 - 80, 10, 160, 30);\n\n      ctx.fillStyle = '#fff';\n      ctx.font = '18px serif';\n      ctx.textAlign = 'center';\n      ctx.fillText(`Round ${this.currentRound}/${this.currentMode.rounds}`, w / 2, 32);\n    }\n\n    // FPS counter (debug)\n    ctx.fillStyle = '#fff';\n    ctx.font = '12px monospace';\n    ctx.textAlign = 'left';\n    ctx.fillText(`FPS: ${this.fps}`, 10, 20);\n\n    // Ammo indicator (no artificial overlay - just subtle icon)\n    if (!this.playerMusket.hasAmmo()) {\n      ctx.fillStyle = 'rgba(255, 200, 100, 0.8)';\n      ctx.font = '16px serif';\n      ctx.textAlign = 'right';\n      ctx.fillText('Press R to reload', w - 20, h - 80);\n    }\n  }\n\n  private renderMenu(ctx: CanvasRenderingContext2D, w: number, h: number): void {\n    // Background\n    ctx.fillStyle = 'rgba(20, 15, 10, 0.9)';\n    ctx.fillRect(0, 0, w, h);\n\n    // Title\n    ctx.fillStyle = '#c9a55a';\n    ctx.font = 'bold 48px serif';\n    ctx.textAlign = 'center';\n    ctx.fillText('MUSKET DUEL', w / 2, 80);\n\n    ctx.fillStyle = '#888';\n    ctx.font = '18px serif';\n    ctx.fillText('A Gentleman\\'s Game of Honor', w / 2, 110);\n\n    if (this.menuSection === 'modes') {\n      // Section header\n      ctx.fillStyle = '#c9a55a';\n      ctx.font = 'bold 20px serif';\n      ctx.fillText('SELECT GAME MODE', w / 2, 150);\n\n      // Game modes\n      const modes = Object.entries(GAME_MODES);\n      let y = 190;\n\n      ctx.font = '22px serif';\n      for (let i = 0; i < modes.length; i++) {\n        const [key, mode] = modes[i];\n\n        ctx.fillStyle = '#c9a55a';\n        ctx.fillText(`${i + 1}. ${mode.name}`, w / 2, y);\n\n        ctx.fillStyle = '#666';\n        ctx.font = '13px serif';\n        ctx.fillText(mode.description, w / 2, y + 20);\n\n        ctx.font = '22px serif';\n        y += 60;\n      }\n\n      // Selected map display\n      const selectedMap = MAPS[this.selectedMapIndex];\n      ctx.fillStyle = '#555';\n      ctx.font = '14px serif';\n      ctx.fillText(`Map: ${selectedMap.name}`, w / 2, h - 100);\n      ctx.fillText('Press M to change map', w / 2, h - 80);\n\n      // Instructions\n      ctx.fillStyle = '#555';\n      ctx.fillText('Press 1-4 to select game mode', w / 2, h - 50);\n      ctx.fillText('Click to lock mouse  WASD to move  Mouse to aim  LMB to fire', w / 2, h - 30);\n    } else {\n      // Map selection\n      ctx.fillStyle = '#c9a55a';\n      ctx.font = 'bold 20px serif';\n      ctx.fillText('SELECT MAP', w / 2, 150);\n\n      let y = 190;\n      ctx.font = '20px serif';\n      for (let i = 0; i < MAPS.length; i++) {\n        const map = MAPS[i];\n        const isSelected = i === this.selectedMapIndex;\n\n        ctx.fillStyle = isSelected ? '#c9a55a' : '#777';\n        ctx.fillText(`${i + 1}. ${map.name}${isSelected ? ' ' : ''}`, w / 2, y);\n\n        ctx.fillStyle = isSelected ? '#888' : '#555';\n        ctx.font = '12px serif';\n        ctx.fillText(map.description, w / 2, y + 18);\n\n        ctx.font = '20px serif';\n        y += 50;\n      }\n\n      ctx.fillStyle = '#555';\n      ctx.font = '14px serif';\n      ctx.fillText('Press 1-6 to select map, or ESC to go back', w / 2, h - 50);\n    }\n  }\n\n  private renderEndScreen(ctx: CanvasRenderingContext2D, w: number, h: number, victory: boolean): void {\n    ctx.fillStyle = victory ? 'rgba(20, 40, 20, 0.9)' : 'rgba(40, 20, 20, 0.9)';\n    ctx.fillRect(0, 0, w, h);\n\n    ctx.fillStyle = victory ? '#6a6' : '#a66';\n    ctx.font = 'bold 48px serif';\n    ctx.textAlign = 'center';\n    ctx.fillText(victory ? 'VICTORY' : 'DEFEAT', w / 2, h / 2 - 40);\n\n    ctx.fillStyle = '#c9a55a';\n    ctx.font = '24px serif';\n    ctx.fillText(`Score: ${this.score}`, w / 2, h / 2 + 20);\n\n    ctx.fillStyle = '#888';\n    ctx.font = '18px serif';\n    ctx.fillText('Press SPACE to return to menu', w / 2, h / 2 + 80);\n  }\n\n  private renderIntermission(ctx: CanvasRenderingContext2D, w: number, h: number): void {\n    ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';\n    ctx.fillRect(0, 0, w, h);\n\n    ctx.fillStyle = '#c9a55a';\n    ctx.font = 'bold 36px serif';\n    ctx.textAlign = 'center';\n    ctx.fillText('OPPONENT DEFEATED', w / 2, h / 2 - 20);\n\n    ctx.fillStyle = '#888';\n    ctx.font = '18px serif';\n    ctx.fillText('Preparing next round...', w / 2, h / 2 + 20);\n  }\n\n  // Public methods for external control\n  handleKeyPress(key: string): void {\n    if (this.gameState === 'menu') {\n      if (this.menuSection === 'modes') {\n        // Mode selection\n        if (key === 'm' || key === 'M') {\n          this.menuSection = 'maps';\n          return;\n        }\n\n        const modeIndex = parseInt(key) - 1;\n        const modes = Object.keys(GAME_MODES);\n        if (modeIndex >= 0 && modeIndex < modes.length) {\n          this.startGame(modes[modeIndex]);\n        }\n      } else {\n        // Map selection\n        if (key === 'Escape') {\n          this.menuSection = 'modes';\n          return;\n        }\n\n        const mapIndex = parseInt(key) - 1;\n        if (mapIndex >= 0 && mapIndex < MAPS.length) {\n          this.selectedMapIndex = mapIndex;\n          this.menuSection = 'modes';\n        }\n      }\n    } else if (this.gameState === 'victory' || this.gameState === 'defeat') {\n      if (key === ' ') {\n        this.gameState = 'menu';\n        this.menuSection = 'modes';\n      }\n    }\n  }\n\n  getState(): GameState { return this.gameState; }\n  getScore(): number { return this.score; }\n  getCurrentRound(): number { return this.currentRound; }\n}\n","// Musket Duel - Main Entry Point\n\nimport { Game } from './game/game';\n\nclass MusketDuelApp {\n  private game: Game;\n  private gameCanvas: HTMLCanvasElement;\n  private uiCanvas: HTMLCanvasElement;\n  private isRunning: boolean = false;\n\n  constructor() {\n    // Create canvases\n    this.gameCanvas = document.getElementById('game-canvas') as HTMLCanvasElement;\n    this.uiCanvas = document.getElementById('ui-canvas') as HTMLCanvasElement;\n\n    if (!this.gameCanvas || !this.uiCanvas) {\n      throw new Error('Could not find canvas elements');\n    }\n\n    // Set canvas sizes\n    this.resizeCanvases();\n    window.addEventListener('resize', () => this.resizeCanvases());\n\n    // Create game instance\n    this.game = new Game(this.gameCanvas, this.uiCanvas);\n\n    // Setup keyboard handler for menu\n    document.addEventListener('keydown', (e) => {\n      this.game.handleKeyPress(e.key);\n    });\n\n    // Audio context resume on user interaction\n    document.addEventListener('click', () => {\n      // Audio will be resumed by the audio system\n    }, { once: true });\n  }\n\n  private resizeCanvases(): void {\n    const container = document.getElementById('game-container');\n    if (!container) return;\n\n    const width = Math.min(1200, window.innerWidth - 40);\n    const height = Math.min(900, window.innerHeight - 100);\n\n    // Maintain 4:3 aspect ratio\n    const aspectRatio = 4 / 3;\n    let finalWidth = width;\n    let finalHeight = width / aspectRatio;\n\n    if (finalHeight > height) {\n      finalHeight = height;\n      finalWidth = height * aspectRatio;\n    }\n\n    this.gameCanvas.width = 800;\n    this.gameCanvas.height = 600;\n    this.gameCanvas.style.width = `${finalWidth}px`;\n    this.gameCanvas.style.height = `${finalHeight}px`;\n\n    this.uiCanvas.width = 800;\n    this.uiCanvas.height = 600;\n    this.uiCanvas.style.width = `${finalWidth}px`;\n    this.uiCanvas.style.height = `${finalHeight}px`;\n  }\n\n  async start(): Promise<void> {\n    await this.game.initialize();\n    this.isRunning = true;\n    this.gameLoop(0);\n  }\n\n  private gameLoop = (timestamp: number): void => {\n    if (!this.isRunning) return;\n\n    this.game.update(timestamp);\n    requestAnimationFrame(this.gameLoop);\n  };\n\n  stop(): void {\n    this.isRunning = false;\n  }\n}\n\n// Initialize on DOM load\ndocument.addEventListener('DOMContentLoaded', async () => {\n  const app = new MusketDuelApp();\n  await app.start();\n});\n"],"names":["PI","TWO_PI","vec2Sub","a","b","vec2Length","v","vec2Normalize","len","vec2Distance","dx","dy","vec2FromAngle","angle","vec2Angle","normalizeAngle","angleDifference","diff","clamp","value","min","max","lerp","t","randomRange","Renderer","canvas","config","ctx","tableSize","i","halfWidth","fovRad","x","rayAngle","id","url","resolve","reject","img","tempCanvas","tempCtx","imgData","data","srcData","j","width","height","generator","y","r","g","texture","color","player","map","halfHeight","pitchOffset","horizonY","skyTop","skyHorizon","groundNear","groundFar","rowOffset","floorDist","fogFactor","startX","startY","dirX","dirY","mapX","mapY","deltaDistX","deltaDistY","stepX","stepY","sideDistX","sideDistY","side","hit","maxSteps","perpWallDist","wallX","tileType","textureX","fov","renderDistance","cameraX","correctedDist","wallHeight","drawStart","drawEnd","textureId","shade","fog","brightness","texX","step","texPos","texY","pixel","sprite","invDet","transformX","transformY","spriteScreenX","spriteHeight","spriteWidth","drawStartY","drawEndY","drawStartX","drawEndX","frameOffsetX","relativeAngle","stripe","sprites","sortedSprites","screenX","w","h","x1","y1","x2","y2","py","px","dst","dstR","dstG","dstB","alpha","invAlpha","blendR","blendG","blendB","InputManager","e","event","binding","key","action","DEFAULT_SOUND_CONFIG","AudioSystem","bufferSize","arrayBuffer","audioBuffer","error","buffer","cfg","source","pitchVariation","gainNode","sounds","index","distance","volumeMultiplier","pan","panNode","now","explosionOsc","explosionGain","explosionFilter","crackSource","crackGain","crackFilter","thumpOsc","thumpGain","reverbSource","reverbGain","reverbFilter","clangOsc","clangGain","ringOsc","ringGain","surface","footstepSource","gain","filter","type","impactOsc","noiseSource","noiseGain","noiseFilter","volume","frequency","osc","drawing","delay","s","DEFAULT_MUSKET_CONFIG","Musket","dt","input","swayAmount","currentStep","stepDuration","accuracy","spreadX","spreadY","dirZ","muzzleX","muzzleY","muzzleZ","speed","p","targetX","targetY","targetAngle","positions","bobSpeed","bobAmount","totalSteps","stepProgress","DEFAULT_BAYONET_CONFIG","Bayonet","enemies","progress","thrustWindup","thrustDuration","thrustRecovery","totalTime","slashWindup","slashDuration","attackType","duration","enemy","toEnemy","enemyAngle","hitType","baseDamage","critChance","isCritical","damage","knockDir","z","count","spreadAngle","attackDirection","playerAngle","hits","OPPONENT_PRESETS","Opponent","dist","steps","checkX","checkY","tileX","tileY","playerToUs","hasAmmo","fireThreshold","angleDiff","accuracyRequired","totalReloadTime","moveDir","awayAngle","toPlayer","flankAngle","attackInterval","newState","turnAmount","fakeInput","fakePlayer","amount","fromAngle","accuracySpread","DEFAULT_WEAPON_VIEW_CONFIG","WeaponView","musket","bayonet","isMoving","isSprinting","weaponOffset","aimProgress","sway","hipX","hipY","adsX","adsY","bayonetVisuals","transitionSpeed","baseX","baseY","weaponX","weaponY","scale","woodColor","woodDark","metalColor","metalLight","metalDark","brassColor","bayonetColor","bayonetShine","barrelLength","hammerAngle","state","bayonetState","bayonetExtend","bladeLength","sightAlpha","rearSightX","frontSightX","gradient","length","particles","screenY","stepName","barWidth","barHeight","SpriteGenerator","coatColor","centerX","coatRGB","coatDark","skinColor","hairColor","pantsColor","bootColor","armAngle","legOffset","weaponAngle","size","center","COAT_COLORS","createDuelField","tiles","floor","ceiling","heightMap","createCourtyard","createForestClearing","seed","seededRandom","distFromCenter","clearingRadius","createTownSquare","createBridge","createEstateGardens","MAPS","GAME_MODES","Game","gameCanvas","uiCanvas","renderConfig","by","offset","noise","base","grain","states","imageData","smokeData","smokePixels","smokeSrc","flashData","flashPixels","flashSrc","bloodData","bloodPixels","bloodSrc","modeName","mode","mapDef","opponentType","timestamp","inputState","o","opponent","moveSpeed","bayonetMult","moveX","moveY","moveLen","newX","newY","corners","corner","projectiles","proj","hitbox","bayonetHits","oppProjectiles","victory","shakeX","shakeY","allSprites","particle","cx","cy","intensity","modes","selectedMap","isSelected","modeIndex","mapIndex","MusketDuelApp","aspectRatio","finalWidth","finalHeight"],"mappings":"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"}