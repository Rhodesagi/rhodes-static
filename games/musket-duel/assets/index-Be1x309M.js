(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const n of a.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function e(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(r){if(r.ep)return;r.ep=!0;const a=e(r);fetch(r.href,a)}})();const j=Math.PI,V=Math.PI*2;function z(u,t){return{x:u.x-t.x,y:u.y-t.y}}function K(u){return Math.sqrt(u.x*u.x+u.y*u.y)}function Q(u){const t=K(u);return t===0?{x:0,y:0}:{x:u.x/t,y:u.y/t}}function D(u,t){const e=t.x-u.x,i=t.y-u.y;return Math.sqrt(e*e+i*i)}function X(u){return{x:Math.cos(u),y:Math.sin(u)}}function W(u){return Math.atan2(u.y,u.x)}function Y(u){for(;u<0;)u+=V;for(;u>=V;)u-=V;return u}function E(u,t){let e=Y(t-u);return e>j&&(e-=V),e}function G(u,t,e){return Math.max(t,Math.min(e,u))}function T(u,t,e){return u+(t-u)*e}function M(u,t){return u+Math.random()*(t-u)}class Z{canvas;ctx;imageData;pixels;depthBuffer;textures=new Map;config;cosTable;sinTable;tanTable;fisheyeCorrection;constructor(t,e){this.canvas=t,this.config=e,t.width=e.width,t.height=e.height;const i=t.getContext("2d",{alpha:!1});if(!i)throw new Error("Could not get 2D context");this.ctx=i,this.imageData=i.createImageData(e.width,e.height),this.pixels=new Uint32Array(this.imageData.data.buffer),this.depthBuffer=new Float32Array(e.width);const r=3600;this.cosTable=new Float32Array(r),this.sinTable=new Float32Array(r),this.tanTable=new Float32Array(r);for(let s=0;s<r;s++){const o=s/r*Math.PI*2;this.cosTable[s]=Math.cos(o),this.sinTable[s]=Math.sin(o),this.tanTable[s]=Math.tan(o)}this.fisheyeCorrection=new Float32Array(e.width);const a=e.width/2,n=e.fov*Math.PI/180;for(let s=0;s<e.width;s++){const o=Math.atan2(s-a,a/Math.tan(n/2));this.fisheyeCorrection[s]=Math.cos(o)}}async loadTexture(t,e){return new Promise((i,r)=>{const a=new Image;a.onload=()=>{const n=document.createElement("canvas");n.width=a.width,n.height=a.height;const s=n.getContext("2d");s.drawImage(a,0,0);const o=s.getImageData(0,0,a.width,a.height),h=new Uint32Array(a.width*a.height),c=o.data;for(let l=0;l<h.length;l++){const f=l*4;h[l]=c[f+3]<<24|c[f+2]<<16|c[f+1]<<8|c[f]}this.textures.set(t,{id:t,width:a.width,height:a.height,data:h,image:a}),i()},a.onerror=r,a.src=e})}generateProceduralTexture(t,e,i,r){const a=new Uint32Array(e*i);for(let n=0;n<i;n++)for(let s=0;s<e;s++){const[o,h,c,l]=r(s,n);a[n*e+s]=l<<24|c<<16|h<<8|o}this.textures.set(t,{id:t,width:e,height:i,data:a})}registerTexture(t,e){this.textures.set(t,e)}clear(t,e,i){const r=-16777216|i<<16|e<<8|t;this.pixels.fill(r),this.depthBuffer.fill(1/0)}renderSkyAndFloor(t,e){const{width:i,height:r}=this.config,a=r/2,n=t.pitch*r/2,s=a+n,o=[135,180,220],h=[200,220,240],c=[80,60,40],l=[60,50,35];for(let f=0;f<r;f++){const g=f*i;if(f<s){const d=f/s,p=Math.floor(T(o[0],h[0],d)),y=Math.floor(T(o[1],h[1],d)),b=Math.floor(T(o[2],h[2],d)),S=255<<24|b<<16|y<<8|p;for(let m=0;m<i;m++)this.pixels[g+m]=S}else{const d=(r-s)/(f-s+.001),p=Math.min(1,d/this.config.renderDistance),y=G(p,0,1),b=Math.floor(T(c[0],l[0],y)),S=Math.floor(T(c[1],l[1],y)),m=Math.floor(T(c[2],l[2],y)),w=255<<24|m<<16|S<<8|b;for(let v=0;v<i;v++)this.pixels[g+v]=w}}}castRay(t,e,i,r){const a=Math.cos(r),n=Math.sin(r);let s=Math.floor(e),o=Math.floor(i);const h=Math.abs(1/a),c=Math.abs(1/n);let l,f,g,d;a<0?(l=-1,g=(e-s)*h):(l=1,g=(s+1-e)*h),n<0?(f=-1,d=(i-o)*c):(f=1,d=(o+1-i)*c);let p=0,y=!1,b=100;for(;!y&&b-- >0;){if(g<d?(g+=h,s+=l,p=0):(d+=c,o+=f,p=1),s<0||s>=t.width||o<0||o>=t.height)return null;t.tiles[o][s]>0&&(y=!0)}if(!y)return null;let S,m;p===0?(S=(s-e+(1-l)/2)/a,m=i+S*n):(S=(o-i+(1-f)/2)/n,m=e+S*a),m-=Math.floor(m);const w=t.tiles[o][s];let v=m;return(p===0&&a>0||p===1&&n<0)&&(v=1-v),{distance:S,wallX:m,side:p,mapX:s,mapY:o,tileType:w,textureX:v}}renderWalls(t,e){const{width:i,height:r,fov:a,renderDistance:n}=this.config,s=r/2,o=a*Math.PI/180,h=t.pitch*r/2;for(let c=0;c<i;c++){const l=2*c/i-1,f=t.angle+Math.atan(l*Math.tan(o/2)),g=this.castRay(e,t.x,t.y,f);if(!g){this.depthBuffer[c]=1/0;continue}const d=g.distance*this.fisheyeCorrection[c];if(this.depthBuffer[c]=d,d>n)continue;const p=Math.floor(r/d),y=Math.max(0,Math.floor(s-p/2+h)),b=Math.min(r-1,Math.floor(s+p/2+h)),S=this.getTextureForTile(g.tileType),m=this.textures.get(S);if(!m){const C=g.side===1?.7:1,R=1-Math.min(1,d/n),_=Math.floor(128*C*R),O=255<<24|_<<16|_<<8|_;for(let A=y;A<=b;A++)this.pixels[A*i+c]=O;continue}const w=Math.floor(g.textureX*m.width)&m.width-1,v=m.height/p;let k=(y-h-s+p/2)*v;const x=g.side===1?.7:1,P=1-Math.min(1,d/n);for(let C=y;C<=b;C++){const R=Math.floor(k)&m.height-1;k+=v;let _=m.data[R*m.width+w],O=_&255,A=_>>8&255,I=_>>16&255;O=Math.floor(O*x*P),A=Math.floor(A*x*P),I=Math.floor(I*x*P),this.pixels[C*i+c]=255<<24|I<<16|A<<8|O}}}renderSprite(t,e){const{width:i,height:r}=this.config,a=r/2,n=e.pitch*r/2,s=t.x-e.x,o=t.y-e.y,h=1/(Math.cos(e.angle+Math.PI/2)*Math.sin(e.angle)-Math.cos(e.angle)*Math.sin(e.angle+Math.PI/2)),c=h*(Math.sin(e.angle)*s-Math.cos(e.angle)*o),l=h*(-Math.sin(e.angle+Math.PI/2)*s+Math.cos(e.angle+Math.PI/2)*o);if(l<=.1)return;const f=Math.floor(i/2*(1+c/l)),g=Math.abs(Math.floor(r/l))*t.scale,d=g,p=Math.floor(a-g/2+n+t.z*r/l),y=Math.floor(a+g/2+n+t.z*r/l),b=Math.floor(f-d/2),S=Math.floor(f+d/2),m=this.textures.get(t.texture);if(!m)return;let w=0;if(t.directional&&t.directions){let x=Math.atan2(o,s)-t.angle;for(;x<0;)x+=Math.PI*2;for(;x>=Math.PI*2;)x-=Math.PI*2;w=Math.floor(x/(Math.PI*2/t.directions))*(m.width/t.directions)}t.animated&&t.frames&&(w+=(t.currentFrame||0)*(m.width/t.frames));const v=1-Math.min(1,l/this.config.renderDistance);for(let k=b;k<S;k++){if(k<0||k>=i||l>=this.depthBuffer[k])continue;const x=Math.floor((k-b)/d*(m.width/(t.frames||1)))+w;for(let P=Math.max(0,p);P<Math.min(r,y);P++){const C=Math.floor((P-p)/g*m.height),R=m.data[C*m.width+(x&m.width-1)];if((R>>24&255)<128)continue;let O=R&255,A=R>>8&255,I=R>>16&255;O=Math.floor(O*v),A=Math.floor(A*v),I=Math.floor(I*v),this.pixels[P*i+k]=255<<24|I<<16|A<<8|O}}}renderSprites(t,e){const i=t.map(r=>({sprite:r,distance:(r.x-e.x)**2+(r.y-e.y)**2})).sort((r,a)=>a.distance-r.distance);for(const{sprite:r}of i)this.renderSprite(r,e)}getTextureForTile(t){return{1:"wall_brick",2:"wall_stone",3:"wall_wood",4:"wall_plaster",5:"wall_hedge"}[t]||"wall_brick"}present(){this.ctx.putImageData(this.imageData,0,0)}getDepthAt(t){return t<0||t>=this.config.width?1/0:this.depthBuffer[Math.floor(t)]}drawRect(t,e,i,r,a,n,s,o=255){const h=o<<24|s<<16|n<<8|a,{width:c,height:l}=this.config,f=Math.max(0,Math.floor(t)),g=Math.max(0,Math.floor(e)),d=Math.min(c,Math.floor(t+i)),p=Math.min(l,Math.floor(e+r));for(let y=g;y<p;y++){const b=y*c;for(let S=f;S<d;S++)if(o===255)this.pixels[b+S]=h;else{const m=this.pixels[b+S],w=m&255,v=m>>8&255,k=m>>16&255,x=o/255,P=1-x,C=Math.floor(a*x+w*P),R=Math.floor(n*x+v*P),_=Math.floor(s*x+k*P);this.pixels[b+S]=255<<24|_<<16|R<<8|C}}}getWidth(){return this.config.width}getHeight(){return this.config.height}getConfig(){return this.config}}class J{state={forward:!1,backward:!1,left:!1,right:!1,turnLeft:!1,turnRight:!1,fire:!1,aim:!1,reload:!1,bayonet:!1,crouch:!1,sprint:!1,interact:!1,mouseX:0,mouseY:0,mouseDeltaX:0,mouseDeltaY:0,mouseDown:!1,rightMouseDown:!1};canvas;isPointerLocked=!1;sensitivity=.002;invertY=!1;bindings={KeyW:"forward",ArrowUp:"forward",KeyS:"backward",ArrowDown:"backward",KeyA:"left",ArrowLeft:"left",KeyD:"right",ArrowRight:"right",KeyQ:"turnLeft",KeyE:"turnRight",KeyR:"reload",KeyB:"bayonet",KeyC:"crouch",ControlLeft:"crouch",ShiftLeft:"sprint",KeyF:"interact",Space:"interact"};constructor(t){this.canvas=t,this.setupEventListeners()}setupEventListeners(){document.addEventListener("keydown",this.handleKeyDown.bind(this)),document.addEventListener("keyup",this.handleKeyUp.bind(this)),this.canvas.addEventListener("click",this.requestPointerLock.bind(this)),document.addEventListener("pointerlockchange",this.handlePointerLockChange.bind(this)),document.addEventListener("mousemove",this.handleMouseMove.bind(this)),document.addEventListener("mousedown",this.handleMouseDown.bind(this)),document.addEventListener("mouseup",this.handleMouseUp.bind(this)),this.canvas.addEventListener("contextmenu",t=>t.preventDefault()),window.addEventListener("blur",this.resetState.bind(this))}handleKeyDown(t){this.bindings[t.code]&&t.preventDefault();const e=this.bindings[t.code];e&&typeof this.state[e]=="boolean"&&(this.state[e]=!0),t.code==="Escape"&&this.isPointerLocked&&document.exitPointerLock()}handleKeyUp(t){const e=this.bindings[t.code];e&&typeof this.state[e]=="boolean"&&(this.state[e]=!1)}handleMouseMove(t){this.isPointerLocked&&(this.state.mouseDeltaX=t.movementX*this.sensitivity,this.state.mouseDeltaY=t.movementY*this.sensitivity*(this.invertY?-1:1),this.state.mouseX+=this.state.mouseDeltaX,this.state.mouseY+=this.state.mouseDeltaY)}handleMouseDown(t){this.isPointerLocked&&(t.button===0?(this.state.fire=!0,this.state.mouseDown=!0):t.button===2&&(this.state.aim=!0,this.state.rightMouseDown=!0))}handleMouseUp(t){t.button===0?(this.state.fire=!1,this.state.mouseDown=!1):t.button===2&&(this.state.aim=!1,this.state.rightMouseDown=!1)}requestPointerLock(){this.canvas.requestPointerLock()}handlePointerLockChange(){this.isPointerLocked=document.pointerLockElement===this.canvas,this.isPointerLocked||this.resetState()}resetState(){this.state={forward:!1,backward:!1,left:!1,right:!1,turnLeft:!1,turnRight:!1,fire:!1,aim:!1,reload:!1,bayonet:!1,crouch:!1,sprint:!1,interact:!1,mouseX:this.state.mouseX,mouseY:this.state.mouseY,mouseDeltaX:0,mouseDeltaY:0,mouseDown:!1,rightMouseDown:!1}}update(){this.state.mouseDeltaX=0,this.state.mouseDeltaY=0}getState(){return{...this.state}}isLocked(){return this.isPointerLocked}setSensitivity(t){this.sensitivity=Math.max(1e-4,Math.min(.01,t))}setInvertY(t){this.invertY=t}setBinding(t,e){this.bindings[t]=e}getBindings(){return{...this.bindings}}}const U={volume:1,loop:!1,pitch:1,pitchVariation:0,fadeIn:0,fadeOut:0,spatial:!1,maxDistance:50,rolloffFactor:1};class tt{ctx;masterGain;sfxGain;musicGain;ambientGain;buffers=new Map;activeSounds=new Map;listener={x:0,y:0,angle:0};noiseBuffer=null;constructor(){this.ctx=new AudioContext,this.masterGain=this.ctx.createGain(),this.masterGain.connect(this.ctx.destination),this.sfxGain=this.ctx.createGain(),this.sfxGain.connect(this.masterGain),this.musicGain=this.ctx.createGain(),this.musicGain.connect(this.masterGain),this.ambientGain=this.ctx.createGain(),this.ambientGain.connect(this.masterGain),this.generateNoiseBuffer()}generateNoiseBuffer(){const t=this.ctx.sampleRate*2;this.noiseBuffer=this.ctx.createBuffer(1,t,this.ctx.sampleRate);const e=this.noiseBuffer.getChannelData(0);for(let i=0;i<t;i++)e[i]=Math.random()*2-1}async loadSound(t,e){try{const r=await(await fetch(e)).arrayBuffer(),a=await this.ctx.decodeAudioData(r);this.buffers.set(t,a)}catch(i){console.warn(`Failed to load sound: ${t}`,i)}}play(t,e={}){const i=this.buffers.get(t);if(!i)return console.warn(`Sound not found: ${t}`),null;const r={...U,...e},a=this.ctx.createBufferSource();a.buffer=i,a.loop=r.loop;const n=r.pitchVariation>0?(Math.random()-.5)*2*r.pitchVariation:0;a.playbackRate.value=r.pitch+n;const s=this.ctx.createGain();return s.gain.value=r.volume,a.connect(s),s.connect(this.sfxGain),r.fadeIn>0&&(s.gain.setValueAtTime(0,this.ctx.currentTime),s.gain.linearRampToValueAtTime(r.volume,this.ctx.currentTime+r.fadeIn)),a.start(),this.activeSounds.has(t)||this.activeSounds.set(t,[]),this.activeSounds.get(t).push(a),a.onended=()=>{const o=this.activeSounds.get(t);if(o){const h=o.indexOf(a);h>-1&&o.splice(h,1)}},a}playSpatial(t,e,i,r={}){const a=this.buffers.get(t);if(!a)return null;const n={...U,...r},s=e-this.listener.x,o=i-this.listener.y,h=Math.sqrt(s*s+o*o);if(h>n.maxDistance)return null;const c=Math.max(0,1-(h/n.maxDistance)**n.rolloffFactor),f=Math.atan2(o,s)-this.listener.angle,g=Math.sin(f),d=this.ctx.createBufferSource();d.buffer=a;const p=n.pitchVariation>0?(Math.random()-.5)*2*n.pitchVariation:0;d.playbackRate.value=n.pitch+p;const y=this.ctx.createGain();y.gain.value=n.volume*c;const b=this.ctx.createStereoPanner();return b.pan.value=g,d.connect(y),y.connect(b),b.connect(this.sfxGain),d.start(),d}playMusketShot(t,e){const i=this.ctx.currentTime,r=t-this.listener.x,a=e-this.listener.y,n=Math.sqrt(r*r+a*a),s=Math.max(.1,1-n/100),o=this.ctx.createOscillator();o.type="sawtooth",o.frequency.setValueAtTime(150,i),o.frequency.exponentialRampToValueAtTime(30,i+.15);const h=this.ctx.createGain();h.gain.setValueAtTime(.8*s,i),h.gain.exponentialRampToValueAtTime(.01,i+.2);const c=this.ctx.createBiquadFilter();if(c.type="lowpass",c.frequency.setValueAtTime(2e3,i),c.frequency.exponentialRampToValueAtTime(200,i+.15),o.connect(c),c.connect(h),h.connect(this.sfxGain),o.start(i),o.stop(i+.25),this.noiseBuffer){const g=this.ctx.createBufferSource();g.buffer=this.noiseBuffer;const d=this.ctx.createGain();d.gain.setValueAtTime(.4*s,i),d.gain.exponentialRampToValueAtTime(.01,i+.05);const p=this.ctx.createBiquadFilter();p.type="highpass",p.frequency.value=3e3,g.connect(p),p.connect(d),d.connect(this.sfxGain),g.start(i),g.stop(i+.08)}const l=this.ctx.createOscillator();l.type="sine",l.frequency.setValueAtTime(80,i),l.frequency.exponentialRampToValueAtTime(20,i+.3);const f=this.ctx.createGain();if(f.gain.setValueAtTime(.6*s,i),f.gain.exponentialRampToValueAtTime(.01,i+.3),l.connect(f),f.connect(this.sfxGain),l.start(i),l.stop(i+.35),this.noiseBuffer&&n<50){const g=this.ctx.createBufferSource();g.buffer=this.noiseBuffer;const d=this.ctx.createGain();d.gain.setValueAtTime(0,i),d.gain.linearRampToValueAtTime(.15*s,i+.05),d.gain.exponentialRampToValueAtTime(.01,i+1.5);const p=this.ctx.createBiquadFilter();p.type="lowpass",p.frequency.value=800,g.connect(p),p.connect(d),d.connect(this.sfxGain),g.start(i+.02),g.stop(i+1.5)}}playBayonetClash(){const t=this.ctx.currentTime,e=this.ctx.createOscillator();e.type="triangle",e.frequency.setValueAtTime(800+Math.random()*400,t),e.frequency.exponentialRampToValueAtTime(200,t+.3);const i=this.ctx.createGain();i.gain.setValueAtTime(.3,t),i.gain.exponentialRampToValueAtTime(.01,t+.3),e.connect(i),i.connect(this.sfxGain),e.start(t),e.stop(t+.35);const r=this.ctx.createOscillator();r.type="sine",r.frequency.setValueAtTime(1200+Math.random()*300,t);const a=this.ctx.createGain();a.gain.setValueAtTime(.15,t),a.gain.exponentialRampToValueAtTime(.01,t+.5),r.connect(a),a.connect(this.sfxGain),r.start(t),r.stop(t+.55)}playFootstep(t="dirt"){const e=this.ctx.currentTime;if(!this.noiseBuffer)return;const i=this.ctx.createBufferSource();i.buffer=this.noiseBuffer;const r=this.ctx.createGain(),a=this.ctx.createBiquadFilter();switch(t){case"dirt":a.type="lowpass",a.frequency.value=400,r.gain.setValueAtTime(.15,e);break;case"wood":a.type="bandpass",a.frequency.value=800,r.gain.setValueAtTime(.2,e);break;case"stone":a.type="highpass",a.frequency.value=500,r.gain.setValueAtTime(.12,e);break}r.gain.exponentialRampToValueAtTime(.01,e+.1),i.connect(a),a.connect(r),r.connect(this.sfxGain),i.start(e),i.stop(e+.12)}playImpact(t="flesh"){const e=this.ctx.currentTime,i=this.ctx.createOscillator();i.type="sine";const r=this.ctx.createGain();switch(t){case"flesh":i.frequency.setValueAtTime(100,e),i.frequency.exponentialRampToValueAtTime(40,e+.1),r.gain.setValueAtTime(.4,e);break;case"metal":i.frequency.setValueAtTime(600,e),i.frequency.exponentialRampToValueAtTime(100,e+.15),r.gain.setValueAtTime(.25,e);break;case"wood":i.frequency.setValueAtTime(200,e),i.frequency.exponentialRampToValueAtTime(60,e+.12),r.gain.setValueAtTime(.3,e);break}if(r.gain.exponentialRampToValueAtTime(.01,e+.15),i.connect(r),r.connect(this.sfxGain),i.start(e),i.stop(e+.2),this.noiseBuffer){const a=this.ctx.createBufferSource();a.buffer=this.noiseBuffer;const n=this.ctx.createGain();n.gain.setValueAtTime(.2,e),n.gain.exponentialRampToValueAtTime(.01,e+.08);const s=this.ctx.createBiquadFilter();s.type="lowpass",s.frequency.value=t==="flesh"?500:2e3,a.connect(s),s.connect(n),n.connect(this.sfxGain),a.start(e),a.stop(e+.1)}}playReloadStep(t){switch(this.ctx.currentTime,t){case"half_cock":this.playMechanicalClick(.3,400);break;case"handle_cartridge":this.playRustleSound(.1);break;case"bite_cartridge":this.playMechanicalClick(.15,200);break;case"prime_pan":this.playPowderSound();break;case"close_frizzen":this.playMechanicalClick(.25,600);break;case"pour_powder":this.playPowderSound();break;case"draw_ramrod":this.playMetalSlide(!0);break;case"ram_charge":this.playRammingSound();break;case"return_ramrod":this.playMetalSlide(!1);break}}playMechanicalClick(t,e){const i=this.ctx.currentTime,r=this.ctx.createOscillator();r.type="square",r.frequency.setValueAtTime(e,i),r.frequency.exponentialRampToValueAtTime(e*.5,i+.05);const a=this.ctx.createGain();a.gain.setValueAtTime(t,i),a.gain.exponentialRampToValueAtTime(.01,i+.05),r.connect(a),a.connect(this.sfxGain),r.start(i),r.stop(i+.06)}playRustleSound(t){if(!this.noiseBuffer)return;const e=this.ctx.currentTime,i=this.ctx.createBufferSource();i.buffer=this.noiseBuffer;const r=this.ctx.createGain();r.gain.setValueAtTime(t,e),r.gain.exponentialRampToValueAtTime(.01,e+.15);const a=this.ctx.createBiquadFilter();a.type="bandpass",a.frequency.value=3e3,a.Q.value=2,i.connect(a),a.connect(r),r.connect(this.sfxGain),i.start(e),i.stop(e+.2)}playPowderSound(){if(!this.noiseBuffer)return;const t=this.ctx.currentTime,e=this.ctx.createBufferSource();e.buffer=this.noiseBuffer;const i=this.ctx.createGain();i.gain.setValueAtTime(.08,t),i.gain.linearRampToValueAtTime(.15,t+.1),i.gain.exponentialRampToValueAtTime(.01,t+.4);const r=this.ctx.createBiquadFilter();r.type="highpass",r.frequency.value=4e3,e.connect(r),r.connect(i),i.connect(this.sfxGain),e.start(t),e.stop(t+.45)}playMetalSlide(t){const e=this.ctx.currentTime,i=this.ctx.createOscillator();i.type="sawtooth",t?(i.frequency.setValueAtTime(200,e),i.frequency.linearRampToValueAtTime(800,e+.3)):(i.frequency.setValueAtTime(800,e),i.frequency.linearRampToValueAtTime(200,e+.3));const r=this.ctx.createGain();r.gain.setValueAtTime(.08,e),r.gain.linearRampToValueAtTime(.12,e+.15),r.gain.exponentialRampToValueAtTime(.01,e+.35);const a=this.ctx.createBiquadFilter();a.type="bandpass",a.frequency.value=1500,a.Q.value=5,i.connect(a),a.connect(r),r.connect(this.sfxGain),i.start(e),i.stop(e+.4)}playRammingSound(){const t=this.ctx.currentTime;for(let e=0;e<3;e++){const i=e*.25,r=this.ctx.createOscillator();r.type="sine",r.frequency.setValueAtTime(120,t+i),r.frequency.exponentialRampToValueAtTime(50,t+i+.1);const a=this.ctx.createGain();a.gain.setValueAtTime(.2+e*.05,t+i),a.gain.exponentialRampToValueAtTime(.01,t+i+.15),r.connect(a),a.connect(this.sfxGain),r.start(t+i),r.stop(t+i+.2)}}setListenerPosition(t,e,i){this.listener={x:t,y:e,angle:i}}setMasterVolume(t){this.masterGain.gain.value=Math.max(0,Math.min(1,t))}setSfxVolume(t){this.sfxGain.gain.value=Math.max(0,Math.min(1,t))}setMusicVolume(t){this.musicGain.gain.value=Math.max(0,Math.min(1,t))}resume(){this.ctx.state==="suspended"&&this.ctx.resume()}stop(t){const e=this.activeSounds.get(t);e&&(e.forEach(i=>i.stop()),this.activeSounds.set(t,[]))}stopAll(){this.activeSounds.forEach((t,e)=>{t.forEach(i=>i.stop())}),this.activeSounds.clear()}}const q={aimTime:.8,fireLockTime:.15,recoilTime:.3,smokeLingerTime:3,reloadTimes:{reload_half_cock:.6,reload_handle_cartridge:.8,reload_bite_cartridge:.5,reload_prime_pan:.7,reload_close_frizzen:.3,reload_cast_about:.6,reload_pour_powder:.8,reload_seat_ball:.5,reload_draw_ramrod:.8,reload_ram_charge:1.2,reload_return_ramrod:.8,reload_shoulder:.5},baseAccuracy:.08,aimAccuracy:.02,breathSway:.015,movementPenalty:.05,muzzleVelocity:400,bulletDrop:9.8,effectiveRange:50,maxRange:150,baseDamage:100,headMultiplier:2.5,bodyMultiplier:1,limbMultiplier:.6,recoilKick:.15,recoilRecovery:3};class L{state="ready";stateTimer=0;config;aimProgress=0;breathCycle=0;currentSway={x:0,y:0};hasCharge=!0;hasPrimed=!0;recoilAmount=0;lastFireTime=0;weaponX=0;weaponY=0;weaponAngle=0;smokeParticles=[];projectiles=[];reloadStepIndex=0;static RELOAD_SEQUENCE=["reload_half_cock","reload_handle_cartridge","reload_bite_cartridge","reload_prime_pan","reload_close_frizzen","reload_cast_about","reload_pour_powder","reload_seat_ball","reload_draw_ramrod","reload_ram_charge","reload_return_ramrod","reload_shoulder"];constructor(t=q){this.config=t}update(t,e,i){switch(this.stateTimer+=t,this.breathCycle+=t*.8,this.updateSmoke(t),this.updateProjectiles(t),this.updateWeaponPosition(t,e,i),this.state){case"ready":this.handleReadyState(e);break;case"aiming":this.handleAimingState(t,e,i);break;case"firing":this.handleFiringState(t,i);break;case"fired":this.handleFiredState(t);break;default:this.state.startsWith("reload_")&&this.handleReloadState(t)}this.recoilAmount>0&&(this.recoilAmount=Math.max(0,this.recoilAmount-t*this.config.recoilRecovery))}handleReadyState(t){t.aim&&this.hasCharge&&(this.state="aiming",this.stateTimer=0,this.aimProgress=0),t.reload&&!this.hasCharge&&this.startReload()}handleAimingState(t,e,i){this.aimProgress=Math.min(1,this.aimProgress+t/this.config.aimTime);const r=this.config.breathSway*(1-this.aimProgress*.7);this.currentSway.x=Math.sin(this.breathCycle*2.1)*r,this.currentSway.y=Math.sin(this.breathCycle*1.7+.5)*r*.7,i.isMoving&&(this.currentSway.x+=Math.sin(this.breathCycle*8)*this.config.movementPenalty,this.currentSway.y+=Math.sin(this.breathCycle*6)*this.config.movementPenalty*.5),e.fire&&this.hasCharge&&(this.state="firing",this.stateTimer=0),e.aim||(this.state="ready",this.aimProgress=Math.max(0,this.aimProgress-t*2))}handleFiringState(t,e){this.stateTimer>=this.config.fireLockTime&&(this.fire(e),this.state="fired",this.stateTimer=0)}handleFiredState(t){this.stateTimer>=this.config.recoilTime&&(this.state="ready",this.hasCharge=!1,this.hasPrimed=!1)}handleReloadState(t){const e=L.RELOAD_SEQUENCE[this.reloadStepIndex],i=this.config.reloadTimes[e]||.5;this.stateTimer>=i&&(this.reloadStepIndex++,this.reloadStepIndex>=L.RELOAD_SEQUENCE.length?(this.state="ready",this.hasCharge=!0,this.hasPrimed=!0,this.reloadStepIndex=0):(this.state=L.RELOAD_SEQUENCE[this.reloadStepIndex],this.stateTimer=0))}startReload(){this.state="reload_half_cock",this.stateTimer=0,this.reloadStepIndex=0,this.aimProgress=0}fire(t){const e=T(this.config.baseAccuracy,this.config.aimAccuracy,this.aimProgress),i=M(-e,e)+this.currentSway.x,r=M(-e,e)+this.currentSway.y,a=Math.cos(t.angle+i),n=Math.sin(t.angle+i),s=t.pitch+r;this.projectiles.push({x:t.x+a*.5,y:t.y+n*.5,z:t.z+.5,vx:a*this.config.muzzleVelocity,vy:n*this.config.muzzleVelocity,vz:s*this.config.muzzleVelocity,damage:this.config.baseDamage,ownerId:"player",timeAlive:0}),this.recoilAmount=this.config.recoilKick,this.spawnMuzzleSmoke(t),this.lastFireTime=performance.now()}spawnMuzzleSmoke(t){const e=t.x+Math.cos(t.angle)*1.2,i=t.y+Math.sin(t.angle)*1.2,r=t.z+.4;for(let a=0;a<30;a++){const n=M(.5,2),s=t.angle+M(-.3,.3);this.smokeParticles.push({x:e+M(-.1,.1),y:i+M(-.1,.1),z:r+M(-.1,.1),vx:Math.cos(s)*n+M(-.3,.3),vy:Math.sin(s)*n+M(-.3,.3),vz:M(.1,.5),size:M(.3,.8),alpha:M(.6,1),life:0,maxLife:this.config.smokeLingerTime*M(.7,1.3)})}}updateSmoke(t){for(let e=this.smokeParticles.length-1;e>=0;e--){const i=this.smokeParticles[e];i.x+=i.vx*t,i.y+=i.vy*t,i.z+=i.vz*t,i.vx*=.98,i.vy*=.98,i.vz+=.1*t,i.size+=t*.3,i.life+=t,i.alpha=1-i.life/i.maxLife,i.life>=i.maxLife&&this.smokeParticles.splice(e,1)}}updateProjectiles(t){for(let e=this.projectiles.length-1;e>=0;e--){const i=this.projectiles[e];i.x+=i.vx*t,i.y+=i.vy*t,i.z+=i.vz*t,i.vz-=this.config.bulletDrop*t,i.timeAlive+=t,(i.timeAlive>2||i.z<0)&&this.projectiles.splice(e,1)}}updateWeaponPosition(t,e,i){let r=0,a=0,n=0;if(this.state==="aiming")r=0,a=-.1,n=0;else if(this.state==="ready")r=.15,a=.2,n=-.05;else if(this.state.startsWith("reload_")){const s=this.getReloadPosition();r=s.x,a=s.y,n=s.angle}if(a+=this.recoilAmount*.3,n-=this.recoilAmount*.5,this.weaponX=T(this.weaponX,r,t*10),this.weaponY=T(this.weaponY,a,t*10),this.weaponAngle=T(this.weaponAngle,n,t*8),i.isMoving&&this.state==="ready"){const s=i.isSprinting?12:8,o=i.isSprinting?.04:.02;this.weaponY+=Math.sin(this.breathCycle*s)*o,this.weaponX+=Math.sin(this.breathCycle*s*.5)*o*.5}}getReloadPosition(){return{reload_half_cock:{x:.2,y:.1,angle:-.1},reload_handle_cartridge:{x:.3,y:.2,angle:-.3},reload_bite_cartridge:{x:.25,y:.15,angle:-.4},reload_prime_pan:{x:.15,y:.1,angle:-.2},reload_close_frizzen:{x:.1,y:.1,angle:-.1},reload_cast_about:{x:0,y:.3,angle:.5},reload_pour_powder:{x:-.05,y:.35,angle:.6},reload_seat_ball:{x:-.05,y:.3,angle:.5},reload_draw_ramrod:{x:-.1,y:.2,angle:.4},reload_ram_charge:{x:-.1,y:.25,angle:.5},reload_return_ramrod:{x:-.1,y:.2,angle:.4},reload_shoulder:{x:.1,y:.15,angle:-.05}}[this.state]||{x:.15,y:.2,angle:0}}getState(){return this.state}getStateTimer(){return this.stateTimer}getAimProgress(){return this.aimProgress}getSway(){return this.currentSway}getRecoil(){return this.recoilAmount}getWeaponOffset(){return{x:this.weaponX,y:this.weaponY,angle:this.weaponAngle}}getSmokeParticles(){return this.smokeParticles}getProjectiles(){return this.projectiles}hasAmmo(){return this.hasCharge}getReloadProgress(){if(!this.state.startsWith("reload_"))return this.hasCharge?1:0;const t=L.RELOAD_SEQUENCE.length,e=L.RELOAD_SEQUENCE[this.reloadStepIndex],i=this.config.reloadTimes[e]||.5,r=this.stateTimer/i;return(this.reloadStepIndex+r)/t}getReloadStepName(){return this.state.startsWith("reload_")&&{reload_half_cock:"Half-cock the hammer",reload_handle_cartridge:"Handle cartridge",reload_bite_cartridge:"Bite cartridge",reload_prime_pan:"Prime the pan",reload_close_frizzen:"Close frizzen",reload_cast_about:"Cast about",reload_pour_powder:"Pour powder",reload_seat_ball:"Seat the ball",reload_draw_ramrod:"Draw ramrod",reload_ram_charge:"Ram the charge",reload_return_ramrod:"Return ramrod",reload_shoulder:"Shoulder arms"}[this.state]||""}removeProjectile(t){t>=0&&t<this.projectiles.length&&this.projectiles.splice(t,1)}}const $={fixTime:1.5,unfixTime:1,thrustWindup:.2,thrustDuration:.15,thrustRecovery:.4,slashWindup:.25,slashDuration:.2,slashRecovery:.5,parryDuration:.6,parryWindow:.15,recoilDuration:.5,thrustDamage:85,slashDamage:45,thrustRange:2,slashRange:1.8,thrustAngle:.15,slashAngle:.8,knockback:.5,movementPenalty:.15,attackMovementPenalty:.7};class H{state="sheathed";stateTimer=0;config;isFixed=!1;currentGuard="neutral";hasHitThisAttack=!1;lastAttackTime=0;comboCount=0;visualOffsetX=0;visualOffsetY=0;visualAngle=0;targetOffsetX=0;targetOffsetY=0;targetAngle=0;bloodParticles=[];pendingHits=[];constructor(t=$){this.config=t}update(t,e,i,r){switch(this.stateTimer+=t,this.updateBloodParticles(t),this.state){case"sheathed":this.handleSheathedState(e);break;case"fixing":this.handleFixingState();break;case"unfixing":this.handleUnfixingState();break;case"fixed":case"guard_high":case"guard_low":this.handleReadyState(t,e,i);break;case"thrust":this.handleThrustState(t,i,r);break;case"thrust_recovery":this.handleRecoveryState("thrust");break;case"slash":this.handleSlashState(t,i,r);break;case"slash_recovery":this.handleRecoveryState("slash");break;case"parry":this.handleParryState();break;case"parry_success":this.handleParrySuccessState();break;case"recoil":this.handleRecoilState();break}this.updateVisuals(t),performance.now()-this.lastAttackTime>1e3&&(this.comboCount=0)}handleSheathedState(t){t.bayonet&&(this.state="fixing",this.stateTimer=0)}handleFixingState(){const t=this.stateTimer/this.config.fixTime;this.targetOffsetY=.3-t*.1,this.targetAngle=.2*(1-t),this.stateTimer>=this.config.fixTime&&(this.state="fixed",this.isFixed=!0,this.stateTimer=0)}handleUnfixingState(){const t=this.stateTimer/this.config.unfixTime;this.targetOffsetY=.2+t*.1,this.stateTimer>=this.config.unfixTime&&(this.state="sheathed",this.isFixed=!1,this.stateTimer=0)}handleReadyState(t,e,i){e.crouch?(this.currentGuard="low",this.state="guard_low"):e.aim?(this.currentGuard="high",this.state="guard_high"):(this.currentGuard="neutral",this.state="fixed"),e.fire?this.initiateThrust():e.rightMouseDown&&this.initiateSlash(),e.bayonet&&!e.fire&&!e.rightMouseDown&&(this.state="unfixing",this.stateTimer=0),this.setGuardVisuals()}setGuardVisuals(){switch(this.currentGuard){case"high":this.targetOffsetX=0,this.targetOffsetY=-.1,this.targetAngle=-.2;break;case"low":this.targetOffsetX=.05,this.targetOffsetY=.15,this.targetAngle=.1;break;default:this.targetOffsetX=.08,this.targetOffsetY=.05,this.targetAngle=0}}initiateThrust(){this.state="thrust",this.stateTimer=0,this.hasHitThisAttack=!1,this.lastAttackTime=performance.now(),this.comboCount++}initiateSlash(){this.state="slash",this.stateTimer=0,this.hasHitThisAttack=!1,this.lastAttackTime=performance.now(),this.comboCount++}handleThrustState(t,e,i){const{thrustWindup:r,thrustDuration:a,thrustRecovery:n}=this.config,s=r+a;if(this.stateTimer<r){const o=this.stateTimer/r;this.targetOffsetX=-.1*o,this.targetOffsetY=.1*o,this.targetAngle=.1*o}else if(this.stateTimer<s){const o=(this.stateTimer-r)/a;this.targetOffsetX=-.1+.3*o,this.targetOffsetY=.1-.2*o,this.targetAngle=.1-.15*o,this.hasHitThisAttack||this.checkThrustHits(e,i)}else this.state="thrust_recovery",this.stateTimer=0}handleSlashState(t,e,i){const{slashWindup:r,slashDuration:a}=this.config,n=r+a;if(this.stateTimer<r){const s=this.stateTimer/r;this.targetOffsetX=-.2*s,this.targetOffsetY=-.1*s,this.targetAngle=-.4*s}else if(this.stateTimer<n){const s=(this.stateTimer-r)/a;this.targetOffsetX=-.2+.4*s,this.targetOffsetY=-.1+.05*s,this.targetAngle=-.4+.8*s,this.hasHitThisAttack||this.checkSlashHits(e,i)}else this.state="slash_recovery",this.stateTimer=0}handleRecoveryState(t){const e=t==="thrust"?this.config.thrustRecovery:this.config.slashRecovery,i=this.stateTimer/e;this.targetOffsetX=T(this.visualOffsetX,.08,i),this.targetOffsetY=T(this.visualOffsetY,.05,i),this.targetAngle=T(this.visualAngle,0,i),this.stateTimer>=e&&(this.state="fixed",this.stateTimer=0)}handleParryState(){this.targetOffsetX=.15,this.targetOffsetY=-.15,this.targetAngle=-.3,this.stateTimer>=this.config.parryDuration&&(this.state="fixed",this.stateTimer=0)}handleParrySuccessState(){this.stateTimer>=.2&&(this.state="fixed",this.stateTimer=0)}handleRecoilState(){const t=this.stateTimer/this.config.recoilDuration;this.targetOffsetX=.2*(1-t),this.targetOffsetY=.2*(1-t),this.targetAngle=.3*(1-t),this.stateTimer>=this.config.recoilDuration&&(this.state="fixed",this.stateTimer=0)}checkThrustHits(t,e){for(const i of e){if(i.state==="dead"||i.state==="dying"||D({x:t.x,y:t.y},{x:i.x,y:i.y})>this.config.thrustRange)continue;const a=z({x:i.x,y:i.y},{x:t.x,y:t.y}),n=W(a);if(!(Math.abs(E(t.angle,n))>this.config.thrustAngle)){this.registerHit(i,"thrust",t),this.hasHitThisAttack=!0;break}}}checkSlashHits(t,e){for(const i of e){if(i.state==="dead"||i.state==="dying"||D({x:t.x,y:t.y},{x:i.x,y:i.y})>this.config.slashRange)continue;const a=z({x:i.x,y:i.y},{x:t.x,y:t.y}),n=W(a);Math.abs(E(t.angle,n))>this.config.slashAngle||this.registerHit(i,"slash",t)}this.pendingHits.length>0&&(this.hasHitThisAttack=!0)}registerHit(t,e,i){const r=e==="thrust"?this.config.thrustDamage:this.config.slashDamage,a=Math.min(.3,this.comboCount*.1),n=Math.random()<a,s=n?r*1.5:r,o=Q(z({x:t.x,y:t.y},{x:i.x,y:i.y}));this.pendingHits.push({targetId:t.id,damage:s,knockbackX:o.x*this.config.knockback,knockbackY:o.y*this.config.knockback,hitType:e,isCritical:n}),this.spawnBlood(t.x,t.y,t.z+.5,o.x,o.y,n)}spawnBlood(t,e,i,r,a,n){const s=n?25:12;for(let o=0;o<s;o++){const h=M(1,4),c=M(-.5,.5);this.bloodParticles.push({x:t+M(-.1,.1),y:e+M(-.1,.1),z:i+M(-.1,.1),vx:(r+Math.cos(c)*.3)*h,vy:(a+Math.sin(c)*.3)*h,vz:M(.5,2),size:M(.05,.15),alpha:1,life:M(.5,1.5)})}}updateBloodParticles(t){for(let e=this.bloodParticles.length-1;e>=0;e--){const i=this.bloodParticles[e];i.x+=i.vx*t,i.y+=i.vy*t,i.z+=i.vz*t,i.vz-=15*t,i.vx*=.98,i.vy*=.98,i.life-=t,i.alpha=G(i.life,0,1),(i.life<=0||i.z<0)&&this.bloodParticles.splice(e,1)}}updateVisuals(t){this.visualOffsetX=T(this.visualOffsetX,this.targetOffsetX,t*15),this.visualOffsetY=T(this.visualOffsetY,this.targetOffsetY,t*15),this.visualAngle=T(this.visualAngle,this.targetAngle,t*15)}attemptParry(t,e){return this.state!=="fixed"&&this.state!=="guard_high"&&this.state!=="guard_low"?!1:Math.abs(E(e,t+Math.PI))<.5?(this.state="parry_success",this.stateTimer=0,!0):!1}receiveHit(){this.state!=="parry"&&this.state!=="parry_success"&&(this.state="recoil",this.stateTimer=0)}getState(){return this.state}isFixed_(){return this.isFixed}getCurrentGuard(){return this.currentGuard}getVisuals(){return{offsetX:this.visualOffsetX,offsetY:this.visualOffsetY,angle:this.visualAngle,bloodSplatter:this.bloodParticles}}getBloodParticles(){return this.bloodParticles}getPendingHits(){const t=[...this.pendingHits];return this.pendingHits=[],t}getMovementMultiplier(){return this.isFixed?this.state==="thrust"||this.state==="slash"?1-this.config.attackMovementPenalty:1-this.config.movementPenalty:1}canShoot(){return!this.isFixed||this.state==="fixed"||this.state==="guard_high"||this.state==="guard_low"}}const N={militia:{preferredRange:25,aggressionLevel:.3,accuracy:.4,reactionTime:.8,aimTime:2,moveSpeed:2.5,strafeSpeed:1.5,turnSpeed:2,flanking:!1,useCover:!1,feinting:!1,bayonetProficiency:.3,patience:.3,bravery:.4,adaptability:.2},regular:{preferredRange:20,aggressionLevel:.5,accuracy:.6,reactionTime:.5,aimTime:1.5,moveSpeed:3,strafeSpeed:2,turnSpeed:2.5,flanking:!0,useCover:!0,feinting:!1,bayonetProficiency:.5,patience:.5,bravery:.5,adaptability:.4},grenadier:{preferredRange:12,aggressionLevel:.8,accuracy:.5,reactionTime:.4,aimTime:1.2,moveSpeed:2.8,strafeSpeed:1.8,turnSpeed:2.2,flanking:!1,useCover:!1,feinting:!0,bayonetProficiency:.8,patience:.2,bravery:.9,adaptability:.3},officer:{preferredRange:18,aggressionLevel:.6,accuracy:.8,reactionTime:.3,aimTime:1,moveSpeed:3.2,strafeSpeed:2.2,turnSpeed:3,flanking:!0,useCover:!0,feinting:!0,bayonetProficiency:.7,patience:.7,bravery:.6,adaptability:.8},veteran:{preferredRange:15,aggressionLevel:.7,accuracy:.85,reactionTime:.25,aimTime:.8,moveSpeed:3.5,strafeSpeed:2.5,turnSpeed:3.5,flanking:!0,useCover:!0,feinting:!0,bayonetProficiency:.9,patience:.8,bravery:.7,adaptability:.9}};class et{id;type;x;y;z=0;angle;velocityX=0;velocityY=0;aiState="spawning";stateTimer=0;previousState="spawning";health=100;maxHealth=100;musket;bayonet;hasLineOfSight=!1;lastSeenPlayerPos=null;lastSeenTime=0;config;currentBehavior="patrol";targetPosition=null;aimProgress=0;decisionCooldown=0;threatLevel=0;animState="idle";animFrame=0;animTimer=0;lastDamageTime=0;consecutiveHits=0;playerPatternMemory=[];constructor(t,e,i,r,a="regular"){this.id=t,this.x=e,this.y=i,this.angle=r,this.type=a,this.config=N[a]||N.regular,this.musket=new L(q),this.bayonet=new H($)}update(t,e,i){switch(this.stateTimer+=t,this.decisionCooldown=Math.max(0,this.decisionCooldown-t),this.updateLineOfSight(e,i),this.updateThreatLevel(e),this.aiState){case"spawning":this.handleSpawningState();break;case"idle":case"patrol":this.handleIdleState(t,e);break;case"alert":this.handleAlertState(t,e);break;case"engaging":this.handleEngagingState(t,e,i);break;case"aiming":this.handleAimingState(t,e);break;case"firing":this.handleFiringState(t);break;case"reloading":this.handleReloadingState(t);break;case"advancing":this.handleAdvancingState(t,e,i);break;case"retreating":this.handleRetreatingState(t,e,i);break;case"flanking":this.handleFlankingState(t,e,i);break;case"charging":this.handleChargingState(t,e);break;case"melee":this.handleMeleeState(t,e);break;case"recovering":this.handleRecoveringState(t);break;case"dying":this.handleDyingState(t);break}this.x+=this.velocityX*t,this.y+=this.velocityY*t,this.updateWeapons(t,e),this.updateAnimation(t)}updateLineOfSight(t,e){const i=t.x-this.x,r=t.y-this.y,a=Math.sqrt(i*i+r*r);if(a>50){this.hasLineOfSight=!1;return}const n=Math.ceil(a*2),s=i/n,o=r/n;let h=this.x,c=this.y;for(let l=0;l<n;l++){h+=s,c+=o;const f=Math.floor(h),g=Math.floor(c);if(f>=0&&f<e.width&&g>=0&&g<e.height&&e.tiles[g][f]>0){this.hasLineOfSight=!1;return}}this.hasLineOfSight=!0,this.lastSeenPlayerPos={x:t.x,y:t.y},this.lastSeenTime=performance.now()}updateThreatLevel(t){const e=D({x:this.x,y:this.y},{x:t.x,y:t.y});this.threatLevel=G(1-e/30,0,1);const i=Math.atan2(this.y-t.y,this.x-t.x);Math.abs(E(t.angle,i))<.3&&(this.threatLevel+=.3),performance.now()-this.lastDamageTime<3e3&&(this.threatLevel+=.2),this.threatLevel=G(this.threatLevel,0,1)}handleSpawningState(){this.stateTimer>=1&&this.changeState("idle")}handleIdleState(t,e){if(this.hasLineOfSight){this.changeState("alert");return}this.angle+=Math.sin(this.stateTimer*.5)*t*.3}handleAlertState(t,e){const i=Math.atan2(e.y-this.y,e.x-this.x);this.turnToward(i,t),this.stateTimer>=this.config.reactionTime&&this.makeEngagementDecision(e)}handleEngagingState(t,e,i){D({x:this.x,y:this.y},{x:e.x,y:e.y});const r=Math.atan2(e.y-this.y,e.x-this.x);this.turnToward(r,t),this.decisionCooldown<=0&&(this.makeEngagementDecision(e),this.decisionCooldown=M(.5,1.5))}makeEngagementDecision(t){const e=D({x:this.x,y:this.y},{x:t.x,y:t.y}),i=this.musket.hasAmmo();if(e<4&&this.config.bayonetProficiency>.4&&Math.random()<this.config.aggressionLevel){this.changeState("charging");return}if(!i){e<8&&this.config.aggressionLevel>.5?this.changeState("charging"):e<this.config.preferredRange?this.changeState("retreating"):this.changeState("reloading");return}if(e<this.config.preferredRange*1.2&&e>this.config.preferredRange*.5){this.hasLineOfSight&&this.changeState("aiming");return}if(e>this.config.preferredRange){this.config.flanking&&Math.random()<.3?this.changeState("flanking"):this.changeState("advancing");return}e<this.config.preferredRange*.5&&(Math.random()<this.config.aggressionLevel?this.changeState("charging"):this.changeState("retreating"))}handleAimingState(t,e){const i=Math.atan2(e.y-this.y,e.x-this.x);this.turnToward(i,t*.5),this.aimProgress+=t/this.config.aimTime;const r=T(.6,1,this.config.patience);if(this.aimProgress>=r){const a=Math.abs(E(this.angle,i)),n=T(.2,.05,this.config.accuracy);a<n&&this.hasLineOfSight?this.changeState("firing"):this.aimProgress>=1.5&&this.changeState("engaging")}this.threatLevel>.8&&!this.config.bravery&&this.changeState("retreating")}handleFiringState(t){this.stateTimer>=.3&&(this.aimProgress=0,this.changeState("recovering"))}handleReloadingState(t){this.animState="reloading";const e=Object.values(q.reloadTimes).reduce((i,r)=>i+r,0);this.stateTimer>=e&&this.changeState("engaging"),this.threatLevel>.7&&(this.lastSeenPlayerPos?D({x:this.x,y:this.y},this.lastSeenPlayerPos):999)<8&&this.changeState("charging")}handleAdvancingState(t,e,i){const r=Math.atan2(e.y-this.y,e.x-this.x);this.turnToward(r,t);const a=X(this.angle);this.velocityX=a.x*this.config.moveSpeed,this.velocityY=a.y*this.config.moveSpeed,D({x:this.x,y:this.y},{x:e.x,y:e.y})<=this.config.preferredRange&&(this.stopMovement(),this.changeState("engaging")),this.hasLineOfSight&&this.musket.hasAmmo()&&Math.random()<.02&&(this.stopMovement(),this.changeState("aiming"))}handleRetreatingState(t,e,i){const r=Math.atan2(this.y-e.y,this.x-e.x);this.turnToward(r+Math.PI,t);const a=X(r);this.velocityX=a.x*this.config.moveSpeed*.7,this.velocityY=a.y*this.config.moveSpeed*.7,D({x:this.x,y:this.y},{x:e.x,y:e.y})>=this.config.preferredRange&&(this.stopMovement(),this.changeState("engaging")),this.stateTimer>3&&(this.stopMovement(),this.changeState("engaging"))}handleFlankingState(t,e,i){const r=Math.atan2(e.y-this.y,e.x-this.x),a=r+(Math.random()>.5?Math.PI/2:-Math.PI/2);this.turnToward(r,t);const n=X(a);this.velocityX=n.x*this.config.strafeSpeed,this.velocityY=n.y*this.config.strafeSpeed,(this.stateTimer>2||!this.hasLineOfSight)&&(this.stopMovement(),this.changeState("engaging"))}handleChargingState(t,e){const i=Math.atan2(e.y-this.y,e.x-this.x);this.turnToward(i,t*2);const r=X(this.angle);this.velocityX=r.x*this.config.moveSpeed*1.5,this.velocityY=r.y*this.config.moveSpeed*1.5,this.animState="running",D({x:this.x,y:this.y},{x:e.x,y:e.y})<2.5&&(this.stopMovement(),this.changeState("melee")),this.threatLevel>.9&&Math.random()<.1&&(this.stopMovement(),this.changeState("retreating"))}handleMeleeState(t,e){const i=D({x:this.x,y:this.y},{x:e.x,y:e.y}),r=Math.atan2(e.y-this.y,e.x-this.x);this.turnToward(r,t*3),this.animState="bayonet_thrust";const a=T(1.5,.6,this.config.bayonetProficiency);this.stateTimer>=a&&(this.stateTimer=0,this.config.feinting&&Math.random()<.3&&(this.animState="bayonet_ready")),i>4&&this.changeState("engaging")}handleRecoveringState(t){this.stopMovement(),this.stateTimer>=.5&&(this.musket.hasAmmo()?this.changeState("engaging"):this.changeState("reloading"))}handleDyingState(t){this.animState="dying",this.stopMovement(),this.stateTimer>=2&&(this.aiState="dead",this.animState="dead")}changeState(t){this.previousState=this.aiState,this.aiState=t,this.stateTimer=0}turnToward(t,e){const i=E(this.angle,t),r=G(i,-this.config.turnSpeed*e,this.config.turnSpeed*e);this.angle=Y(this.angle+r)}stopMovement(){this.velocityX=0,this.velocityY=0}updateWeapons(t,e){const i={forward:!1,backward:!1,left:!1,right:!1,turnLeft:!1,turnRight:!1,fire:this.aiState==="firing",aim:this.aiState==="aiming"||this.aiState==="firing",reload:this.aiState==="reloading",bayonet:this.aiState==="charging"||this.aiState==="melee",crouch:!1,sprint:this.aiState==="charging",interact:!1,mouseX:0,mouseY:0,mouseDeltaX:0,mouseDeltaY:0,mouseDown:!1,rightMouseDown:!1},r={x:this.x,y:this.y,z:this.z,angle:this.angle,pitch:0,velocityX:this.velocityX,velocityY:this.velocityY,velocityZ:0,isMoving:this.velocityX!==0||this.velocityY!==0,isCrouching:!1,isSprinting:this.aiState==="charging",stamina:100,health:this.health};this.musket.update(t,i,r),this.bayonet.update(t,i,r,[])}updateAnimation(t){switch(this.animTimer+=t,this.aiState){case"idle":case"alert":this.animState="idle";break;case"advancing":case"retreating":case"flanking":this.animState="walking";break;case"charging":this.animState="running";break;case"aiming":this.animState="aiming";break;case"firing":this.animState="firing";break;case"reloading":this.animState="reloading";break;case"melee":this.animState="bayonet_thrust";break}}takeDamage(t,e){this.health-=t,this.lastDamageTime=performance.now(),this.consecutiveHits++,this.health<=0?(this.health=0,this.changeState("dying")):(this.animState="hit",this.consecutiveHits>=2&&Math.random()>this.config.bravery&&this.changeState("retreating"))}getAnimState(){return this.animState}getAIState(){return this.aiState}getMusket(){return this.musket}getBayonet(){return this.bayonet}isAlive(){return this.aiState!=="dead"}isDying(){return this.aiState==="dying"}getAimProgress(){return this.aimProgress}getShootDirection(){const t=T(.15,.02,this.config.accuracy);return{angle:this.angle+M(-t,t),pitch:M(-t*.5,t*.5)}}getHitbox(){return{x:this.x,y:this.y,radius:.4,height:1.8}}}const it={baseX:.5,baseY:.85,hipOffsetX:.15,hipOffsetY:.1,adsOffsetX:0,adsOffsetY:-.1,swayAmount:.02,bobAmount:.015,bobSpeed:8,adsTransitionSpeed:6};class st{config;currentX=0;currentY=0;currentAngle=0;bobPhase=0;recoilOffset=0;muzzleFlashAlpha=0;constructor(t=it){this.config=t}update(t,e,i,r,a){const n=e.getWeaponOffset(),s=e.getAimProgress(),o=e.getSway(),h=this.config.hipOffsetX,c=this.config.hipOffsetY,l=this.config.adsOffsetX,f=this.config.adsOffsetY;let g=T(h,l,s),d=T(c,f,s);if(g+=n.x,d+=n.y,g+=o.x*(1-s*.5),d+=o.y*(1-s*.5),r){const b=a?this.config.bobSpeed*1.5:this.config.bobSpeed,S=a?this.config.bobAmount*2:this.config.bobAmount;this.bobPhase+=t*b,d+=Math.sin(this.bobPhase)*S*(1-s*.8),g+=Math.sin(this.bobPhase*.5)*S*.5*(1-s*.8)}const p=i.getVisuals();i.isFixed_()&&(g+=p.offsetX*.5,d+=p.offsetY*.5);const y=this.config.adsTransitionSpeed;this.currentX=T(this.currentX,g,t*y),this.currentY=T(this.currentY,d,t*y),this.currentAngle=T(this.currentAngle,n.angle+p.angle*.5,t*y),this.recoilOffset=T(this.recoilOffset,0,t*8),this.muzzleFlashAlpha=Math.max(0,this.muzzleFlashAlpha-t*15),e.getState()==="fired"&&e.getStateTimer()<.02&&(this.recoilOffset=.08,this.muzzleFlashAlpha=1)}render(t,e,i,r,a){const n=e*this.config.baseX,s=i*this.config.baseY,o=n+this.currentX*e,h=s+this.currentY*i+this.recoilOffset*i;t.save(),t.translate(o,h),t.rotate(this.currentAngle-this.recoilOffset*2);const c=r.getAimProgress(),l=T(1,1.3,c);t.scale(l,l),this.drawMusket(t,e,i,r,a,c),t.restore(),this.muzzleFlashAlpha>0&&this.drawMuzzleFlash(t,o,h-i*.15,this.muzzleFlashAlpha),this.drawSmoke(t,e,i,r.getSmokeParticles()),this.drawBlood(t,e,i,a.getBloodParticles()),this.drawReloadIndicator(t,e,i,r)}drawMusket(t,e,i,r,a,n){const s=i/600,o="#5c3d2e",h="#3a2518",c="#444",l="#666",f="#222",g="#b8860b",d="#9ca3af",p="#e5e7eb";t.fillStyle=o,t.beginPath(),t.moveTo(-100*s,40*s),t.quadraticCurveTo(-60*s,35*s,0,25*s),t.lineTo(30*s,20*s),t.lineTo(30*s,30*s),t.quadraticCurveTo(-20*s,35*s,-60*s,45*s),t.lineTo(-100*s,55*s),t.closePath(),t.fill(),t.strokeStyle=h,t.lineWidth=1,t.beginPath(),t.moveTo(-90*s,45*s),t.quadraticCurveTo(-40*s,38*s,20*s,28*s),t.stroke(),t.fillStyle=c;const y=T(200,160,n);t.fillRect(20*s,10*s,y*s,10*s),t.fillStyle=l,t.fillRect(20*s,10*s,y*s,3*s),t.fillStyle=g,t.fillRect(50*s,8*s,8*s,14*s),t.fillRect(120*s,8*s,8*s,14*s),t.fillStyle=l,t.beginPath(),t.roundRect(25*s,5*s,45*s,20*s,3*s),t.fill();const b=r.hasAmmo()?-.3:0;t.save(),t.translate(45*s,8*s),t.rotate(b),t.fillStyle=f,t.fillRect(-3*s,-15*s,6*s,18*s),t.fillStyle="#888",t.fillRect(-2*s,-18*s,4*s,5*s),t.restore(),t.fillStyle=c,t.fillRect(52*s,2*s,12*s,12*s),t.fillStyle=g,t.fillRect(50*s,12*s,18*s,5*s),t.strokeStyle=g,t.lineWidth=3*s,t.beginPath(),t.arc(20*s,35*s,12*s,0,Math.PI),t.stroke(),t.fillStyle=c,t.fillRect(18*s,30*s,4*s,10*s);const S=r.getState();if((S==="reload_draw_ramrod"||S==="reload_ram_charge"||S==="reload_return_ramrod")&&(t.fillStyle=o,t.fillRect(25*s,35*s,180*s,4*s)),a.isFixed_()){const m=a.getState();let w=1;m==="thrust"&&(w=1+a.getVisuals().offsetX*2),t.save(),t.translate((20+y)*s,15*s),t.fillStyle=c,t.beginPath(),t.ellipse(0,0,6*s,4*s,0,0,Math.PI*2),t.fill(),t.fillStyle=d;const v=70*w;t.beginPath(),t.moveTo(5*s,-3*s),t.lineTo(v*s,0),t.lineTo(5*s,3*s),t.closePath(),t.fill(),t.strokeStyle=p,t.lineWidth=1,t.beginPath(),t.moveTo(8*s,-2*s),t.lineTo((v-5)*s,0),t.stroke(),a.getBloodParticles().length>0&&(t.fillStyle="rgba(139, 0, 0, 0.7)",t.beginPath(),t.ellipse(30*s,0,8*s,2*s,0,0,Math.PI*2),t.fill()),t.restore()}if(n>.3){const m=(n-.3)/.7;t.globalAlpha=m,t.fillStyle=f;const w=T(60,40,n);t.fillRect(w*s,-10*s,20*s,15*s),t.fillStyle="#000",t.beginPath(),t.moveTo((w+7)*s,-10*s),t.lineTo((w+10)*s,2*s),t.lineTo((w+13)*s,-10*s),t.closePath(),t.fill(),t.fillStyle=f;const v=T(180,140,n);t.fillRect(v*s,0*s,5*s,-15*s),t.fillRect((v+1)*s,-18*s,3*s,8*s),t.globalAlpha=1}t.fillStyle="#e8c39e",t.beginPath(),t.ellipse(-20*s,30*s,18*s,12*s,-.3,0,Math.PI*2),t.fill();for(let m=0;m<4;m++)t.beginPath(),t.ellipse((-25+m*8)*s,22*s,4*s,8*s,0,0,Math.PI*2),t.fill();t.beginPath(),t.ellipse(-70*s,35*s,15*s,10*s,.2,0,Math.PI*2),t.fill()}drawMuzzleFlash(t,e,i,r){t.save(),t.translate(e+180,i),t.globalAlpha=r;const a=t.createRadialGradient(0,0,0,0,0,60);a.addColorStop(0,"rgba(255, 255, 200, 1)"),a.addColorStop(.3,"rgba(255, 200, 100, 0.8)"),a.addColorStop(.6,"rgba(255, 150, 50, 0.4)"),a.addColorStop(1,"rgba(255, 100, 0, 0)"),t.fillStyle=a,t.beginPath(),t.arc(0,0,60,0,Math.PI*2),t.fill(),t.fillStyle="rgba(255, 255, 255, 0.9)",t.beginPath(),t.arc(0,0,15,0,Math.PI*2),t.fill(),t.strokeStyle="rgba(255, 200, 100, 0.8)",t.lineWidth=2;for(let n=0;n<8;n++){const s=n/8*Math.PI*2+Math.random()*.5,o=20+Math.random()*30;t.beginPath(),t.moveTo(10*Math.cos(s),10*Math.sin(s)),t.lineTo(o*Math.cos(s),o*Math.sin(s)),t.stroke()}t.restore()}drawSmoke(t,e,i,r){}drawBlood(t,e,i,r){for(const a of r){if(a.z<.5)continue;const n=e/2+(a.x-.5)*e*.5,s=i/2+(a.y-.5)*i*.5;t.fillStyle=`rgba(139, 0, 0, ${a.alpha*.5})`,t.beginPath(),t.arc(n,s,a.size*20,0,Math.PI*2),t.fill()}}drawReloadIndicator(t,e,i,r){const a=r.getReloadProgress(),n=r.getReloadStepName();if(!n)return;const s=300,o=25,h=(e-s)/2,c=i-60;t.fillStyle="rgba(0, 0, 0, 0.6)",t.beginPath(),t.roundRect(h-5,c-5,s+10,o+30,5),t.fill(),t.fillStyle="rgba(60, 40, 20, 0.8)",t.fillRect(h,c,s,o);const l=t.createLinearGradient(h,c,h+s*a,c);l.addColorStop(0,"#8b6914"),l.addColorStop(1,"#c9a55a"),t.fillStyle=l,t.fillRect(h,c,s*a,o),t.strokeStyle="#c9a55a",t.lineWidth=2,t.strokeRect(h,c,s,o),t.fillStyle="#fff",t.font='14px "Palatino Linotype", serif',t.textAlign="center",t.fillText(n,e/2,c+o+18)}}class at{canvas;ctx;constructor(){this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d")}generateOpponentSprite(t,e,i=64,r=128){this.canvas.width=i,this.canvas.height=r;const a=this.ctx;a.clearRect(0,0,i,r);const n=i/2,s=`rgb(${e[0]}, ${e[1]}, ${e[2]})`,o=`rgb(${Math.floor(e[0]*.7)}, ${Math.floor(e[1]*.7)}, ${Math.floor(e[2]*.7)})`,h="#e8c39e",c="#3a2a1a",l="#f5f5dc",f="#2a1a0a",g="#555",d="#5c3d2e",p="#c0c0c0";let y=0,b=0,S=0,m=0;switch(t){case"walking":b=Math.sin(Date.now()*.01)*5,y=Math.sin(Date.now()*.01)*.2;break;case"running":b=Math.sin(Date.now()*.02)*8,y=Math.sin(Date.now()*.02)*.3;break;case"aiming":S=-.2,m=-10;break;case"firing":S=-.15,m=-8;break;case"reloading":S=.3,m=15;break;case"bayonet_thrust":S=-.4,m=-20;break}a.fillStyle=o,a.save(),a.translate(n-8,r*.35),a.rotate(y),a.fillRect(-4,0,8,25),a.restore(),a.fillStyle=l,a.save(),a.translate(n-6,r*.6),a.fillRect(-5,b,10,30),a.restore(),a.save(),a.translate(n+6,r*.6),a.fillRect(-5,-b,10,30),a.restore(),a.fillStyle=f,a.fillRect(n-12,r*.88+b,12,10),a.fillRect(n,r*.88-b,12,10),a.fillStyle=s,a.beginPath(),a.moveTo(n-15,r*.28),a.lineTo(n+15,r*.28),a.lineTo(n+18,r*.6),a.lineTo(n-18,r*.6),a.closePath(),a.fill(),a.fillStyle=o,a.fillRect(n-18,r*.55,36,15),a.fillStyle="#c9a55a";for(let w=0;w<5;w++)a.beginPath(),a.arc(n,r*.32+w*6,2,0,Math.PI*2),a.fill();return a.strokeStyle="#f5f5dc",a.lineWidth=4,a.beginPath(),a.moveTo(n-15,r*.3),a.lineTo(n+15,r*.55),a.stroke(),a.beginPath(),a.moveTo(n+15,r*.3),a.lineTo(n-15,r*.55),a.stroke(),a.fillStyle=h,a.fillRect(n-5,r*.22,10,8),a.fillStyle=h,a.beginPath(),a.ellipse(n,r*.15,10,12,0,0,Math.PI*2),a.fill(),a.fillStyle=c,a.beginPath(),a.ellipse(n,r*.11,11,8,0,Math.PI,Math.PI*2),a.fill(),a.fillStyle="#1a1a1a",a.beginPath(),a.moveTo(n-18,r*.08),a.lineTo(n,r*.02),a.lineTo(n+18,r*.08),a.lineTo(n+12,r*.12),a.lineTo(n-12,r*.12),a.closePath(),a.fill(),a.fillStyle="#c9a55a",a.beginPath(),a.arc(n,r*.06,3,0,Math.PI*2),a.fill(),a.save(),a.translate(n+8,r*.35),a.rotate(-y+S),a.fillStyle=s,a.fillRect(-4,0,8,25),a.fillStyle=h,a.beginPath(),a.ellipse(0,27,5,4,0,0,Math.PI*2),a.fill(),a.save(),a.translate(5+m,20),a.rotate(.3+S),a.fillStyle=d,a.beginPath(),a.moveTo(-15,5),a.lineTo(20,-5),a.lineTo(22,-2),a.lineTo(-13,8),a.closePath(),a.fill(),a.fillStyle=g,a.fillRect(15,-8,45,4),a.fillStyle=p,a.beginPath(),a.moveTo(58,-6),a.lineTo(75,-6),a.lineTo(78,-4),a.lineTo(75,-2),a.lineTo(58,-2),a.closePath(),a.fill(),a.strokeStyle="#fff",a.lineWidth=1,a.beginPath(),a.moveTo(60,-6),a.lineTo(73,-6),a.stroke(),a.restore(),a.restore(),a.fillStyle="#1a1a1a",a.beginPath(),a.arc(n-4,r*.14,1.5,0,Math.PI*2),a.arc(n+4,r*.14,1.5,0,Math.PI*2),a.fill(),a.getImageData(0,0,i,r)}generateSmokeSprite(t=32){this.canvas.width=t,this.canvas.height=t;const e=this.ctx;e.clearRect(0,0,t,t);const i=t/2,r=e.createRadialGradient(i,i,0,i,i,i);return r.addColorStop(0,"rgba(200, 200, 200, 0.8)"),r.addColorStop(.5,"rgba(180, 180, 180, 0.5)"),r.addColorStop(1,"rgba(150, 150, 150, 0)"),e.fillStyle=r,e.beginPath(),e.arc(i,i,i,0,Math.PI*2),e.fill(),e.getImageData(0,0,t,t)}generateMuzzleFlashSprite(t=48){this.canvas.width=t,this.canvas.height=t;const e=this.ctx;e.clearRect(0,0,t,t);const i=t/2,r=e.createRadialGradient(i,i,0,i,i,i);r.addColorStop(0,"rgba(255, 255, 200, 1)"),r.addColorStop(.2,"rgba(255, 200, 100, 0.9)"),r.addColorStop(.5,"rgba(255, 150, 50, 0.5)"),r.addColorStop(1,"rgba(255, 100, 0, 0)"),e.fillStyle=r,e.beginPath(),e.arc(i,i,i,0,Math.PI*2),e.fill(),e.fillStyle="rgba(255, 255, 255, 0.9)",e.beginPath();for(let a=0;a<8;a++){const n=a/8*Math.PI*2,s=a%2===0?i*.7:i*.3,o=i+Math.cos(n)*s,h=i+Math.sin(n)*s;a===0?e.moveTo(o,h):e.lineTo(o,h)}return e.closePath(),e.fill(),e.getImageData(0,0,t,t)}generateBloodSprite(t=16){this.canvas.width=t,this.canvas.height=t;const e=this.ctx;e.clearRect(0,0,t,t);const i=t/2,r=e.createRadialGradient(i,i,0,i,i,i);return r.addColorStop(0,"rgba(180, 0, 0, 1)"),r.addColorStop(.5,"rgba(139, 0, 0, 0.8)"),r.addColorStop(1,"rgba(100, 0, 0, 0)"),e.fillStyle=r,e.beginPath(),e.arc(i,i,i*.8,0,Math.PI*2),e.fill(),e.getImageData(0,0,t,t)}generateDirtSprite(t=8){this.canvas.width=t,this.canvas.height=t;const e=this.ctx;e.clearRect(0,0,t,t);const i=t/2;return e.fillStyle="rgba(80, 60, 40, 0.8)",e.beginPath(),e.arc(i,i,i*.7,0,Math.PI*2),e.fill(),e.getImageData(0,0,t,t)}}const nt={british_line:[170,30,30]};function rt(){const e=[],i=[],r=[],a=[];for(let n=0;n<32;n++){e[n]=[],i[n]=[],r[n]=[],a[n]=[];for(let s=0;s<32;s++)s===0||s===31||n===0||n===31?e[n][s]=5:s===8&&n>=10&&n<=14||s===24&&n>=18&&n<=22||s>=14&&s<=18&&n===16?e[n][s]=3:e[n][s]=0,i[n][s]=1,r[n][s]=0,a[n][s]=1}return{width:32,height:32,tiles:e,floor:i,ceiling:r,heightMap:a,entities:[],spawnPoints:[{x:5,y:16},{x:27,y:16}],lighting:{ambient:.3,fogColor:[180,190,200],fogDensity:.02,lights:[]}}}function ot(){const e=[],i=[],r=[],a=[];for(let n=0;n<40;n++){e[n]=[],i[n]=[],r[n]=[],a[n]=[];for(let s=0;s<40;s++)s===0||s===39||n===0||n===39||(s===5||s===34)&&n>=5&&n<=34&&n%4===1||(n===5||n===34)&&s>=5&&s<=34&&s%4===1?e[n][s]=2:s>=18&&s<=22&&n>=18&&n<=22?s===18||s===22||n===18||n===22?e[n][s]=2:e[n][s]=0:s===12&&n===12||s===28&&n===12||s===12&&n===28||s===28&&n===28?e[n][s]=5:e[n][s]=0,i[n][s]=2,r[n][s]=0,a[n][s]=1}return{width:40,height:40,tiles:e,floor:i,ceiling:r,heightMap:a,entities:[],spawnPoints:[{x:10,y:20},{x:30,y:20}],lighting:{ambient:.35,fogColor:[200,195,185],fogDensity:.015,lights:[]}}}function ht(){const e=[],i=[],r=[],a=[];let n=12345;const s=()=>(n=(n*1103515245+12345)%2147483648,n/2147483648);for(let o=0;o<48;o++){e[o]=[],i[o]=[],r[o]=[],a[o]=[];for(let h=0;h<48;h++){const c=Math.sqrt((h-24)**2+(o-24)**2),l=18;h<=1||h>=46||o<=1||o>=46?e[o][h]=5:c>l?s()<.4?e[o][h]=5:e[o][h]=0:c>l-3?s()<.15?e[o][h]=5:e[o][h]=0:h===20&&o>=22&&o<=26||h===28&&o>=22&&o<=26||o===24&&h>=22&&h<=26?e[o][h]=3:e[o][h]=0,i[o][h]=1,r[o][h]=0,a[o][h]=1}}return{width:48,height:48,tiles:e,floor:i,ceiling:r,heightMap:a,entities:[],spawnPoints:[{x:12,y:24},{x:36,y:24}],lighting:{ambient:.25,fogColor:[150,170,140],fogDensity:.03,lights:[]}}}function lt(){const e=[],i=[],r=[],a=[];for(let n=0;n<50;n++){e[n]=[],i[n]=[],r[n]=[],a[n]=[];for(let s=0;s<50;s++)s===0||s===49||n===0||n===49?e[n][s]=1:s>=3&&s<=12&&n>=3&&n<=12?s===3||s===12||n===3||n===12?e[n][s]=1:e[n][s]=0:s>=37&&s<=46&&n>=3&&n<=12?s===37||s===46||n===3||n===12?e[n][s]=1:e[n][s]=0:s>=3&&s<=12&&n>=37&&n<=46?s===3||s===12||n===37||n===46?e[n][s]=1:e[n][s]=0:s>=37&&s<=46&&n>=37&&n<=46?s===37||s===46||n===37||n===46?e[n][s]=1:e[n][s]=0:s>=23&&s<=27&&n>=23&&n<=27?e[n][s]=2:s>=18&&s<=20&&n===15||s>=30&&s<=32&&n===15||s>=18&&s<=20&&n===35||s>=30&&s<=32&&n===35?e[n][s]=3:e[n][s]=0,i[n][s]=(s+n)%2===0?2:1,r[n][s]=0,a[n][s]=1}return{width:50,height:50,tiles:e,floor:i,ceiling:r,heightMap:a,entities:[],spawnPoints:[{x:8,y:25},{x:42,y:25}],lighting:{ambient:.35,fogColor:[180,175,165],fogDensity:.018,lights:[]}}}function ct(){const e=[],i=[],r=[],a=[];for(let n=0;n<24;n++){e[n]=[],i[n]=[],r[n]=[],a[n]=[];for(let s=0;s<60;s++)n===0||n===23?e[n][s]=5:s>=25&&s<=35?n<=6||n>=17?e[n][s]=5:n===7||n===16?e[n][s]=2:e[n][s]=0:s<25||s>35?n<=2||n>=21?e[n][s]=5:s===8&&n>=8&&n<=16||s===52&&n>=8&&n<=16||s===15&&n===12||s===45&&n===12?e[n][s]=3:e[n][s]=0:e[n][s]=0,i[n][s]=s>=25&&s<=35?2:1,r[n][s]=0,a[n][s]=1}return{width:60,height:24,tiles:e,floor:i,ceiling:r,heightMap:a,entities:[],spawnPoints:[{x:5,y:12},{x:55,y:12}],lighting:{ambient:.35,fogColor:[170,185,200],fogDensity:.02,lights:[]}}}function ft(){const e=[],i=[],r=[],a=[];for(let n=0;n<44;n++){e[n]=[],i[n]=[],r[n]=[],a[n]=[];for(let s=0;s<44;s++)s===0||s===43||n===0||n===43?e[n][s]=1:(s===6||s===37)&&n>=6&&n<=37?e[n][s]=5:(n===6||n===37)&&s>=6&&s<=37?s>=20&&s<=24||s>=19&&s<=23?e[n][s]=0:e[n][s]=5:(s===14||s===29)&&n>=14&&n<=29?e[n][s]=5:(n===14||n===29)&&s>=14&&s<=29?s===22||s===21?e[n][s]=0:e[n][s]=5:s>=20&&s<=24&&n>=20&&n<=24?s===22&&n===22?e[n][s]=2:s===20||s===24||n===20||n===24?e[n][s]=5:e[n][s]=0:s===10&&n===10||s===33&&n===10||s===10&&n===33||s===33&&n===33?e[n][s]=2:e[n][s]=0,i[n][s]=1,r[n][s]=0,a[n][s]=1}return{width:44,height:44,tiles:e,floor:i,ceiling:r,heightMap:a,entities:[],spawnPoints:[{x:10,y:22},{x:34,y:22}],lighting:{ambient:.4,fogColor:[190,200,180],fogDensity:.012,lights:[]}}}const F=[{id:"duel_field",name:"Dueling Field",description:"A gentleman's dueling ground with sparse cover",create:rt},{id:"courtyard",name:"Manor Courtyard",description:"An elegant stone courtyard with columns",create:ot},{id:"forest",name:"Forest Clearing",description:"A woodland clearing surrounded by dense trees",create:ht},{id:"town_square",name:"Town Square",description:"A busy market square with multiple buildings",create:lt},{id:"bridge",name:"Stone Bridge",description:"A narrow bridge crossing - no retreat",create:ct},{id:"gardens",name:"Estate Gardens",description:"Formal gardens with maze-like hedgerows",create:ft}],B={duel:{name:"Gentleman's Duel",description:"A formal duel. One shot, one chance. First to land a hit wins.",rounds:3,timeLimit:0,respawn:!1,opponentTypes:["regular"]},skirmish:{name:"Skirmish",description:"Face multiple opponents in succession.",rounds:5,timeLimit:120,respawn:!1,opponentTypes:["militia","regular","regular","grenadier","officer"]},survival:{name:"Survival",description:"How long can you last against endless waves?",rounds:999,timeLimit:0,respawn:!0,opponentTypes:["militia","regular","grenadier","veteran"]},campaign:{name:"Campaign",description:"Fight through the ranks from militia to facing veteran duelists.",rounds:10,timeLimit:0,respawn:!1,opponentTypes:["militia","militia","regular","regular","regular","grenadier","grenadier","officer","officer","veteran"]}};class gt{renderer;input;audio;gameState="menu";currentMode=null;currentRound=0;roundTime=0;score=0;selectedMapIndex=0;menuSection="modes";player;playerMusket;playerBayonet;opponents=[];activeOpponent=null;map;sprites=[];screenShake=0;screenFlash=0;hitMarker=0;lastTime=0;deltaTime=0;fps=0;frameCount=0;fpsTimer=0;canvas;uiCanvas;uiCtx;weaponView;spriteGenerator;constructor(t,e){this.canvas=t,this.uiCanvas=e,this.uiCtx=e.getContext("2d");const i={width:800,height:600,fov:75,renderDistance:60,textureQuality:"high",enableLighting:!0,enableFog:!0,enableParticles:!0,enableShadows:!1};this.renderer=new Z(t,i),this.input=new J(t),this.audio=new tt,this.player=this.createPlayer(),this.playerMusket=new L,this.playerBayonet=new H,this.map=this.createDuelMap(),this.weaponView=new st,this.spriteGenerator=new at,this.generateTextures(),this.generateOpponentSprites()}createPlayer(){return{x:5,y:10,z:0,angle:0,pitch:0,velocityX:0,velocityY:0,velocityZ:0,isMoving:!1,isCrouching:!1,isSprinting:!1,stamina:100,health:100}}createDuelMap(){const i=[],r=[],a=[],n=[];for(let s=0;s<32;s++){i[s]=[],r[s]=[],a[s]=[],n[s]=[];for(let o=0;o<32;o++)o===0||o===31||s===0||s===31?i[s][o]=5:o===8&&s>=10&&s<=14||o===24&&s>=18&&s<=22||o>=14&&o<=18&&s===16?i[s][o]=3:i[s][o]=0,r[s][o]=1,a[s][o]=0,n[s][o]=1}return{width:32,height:32,tiles:i,floor:r,ceiling:a,heightMap:n,entities:[],spawnPoints:[{x:5,y:16},{x:27,y:16}],lighting:{ambient:.3,fogColor:[180,190,200],fogDensity:.02,lights:[]}}}generateTextures(){this.renderer.generateProceduralTexture("wall_brick",64,64,(t,e)=>{const n=e%8,o=Math.floor(e/8)%2===0?0:16/2;if((t+o)%16<1||n<1)return[80,80,75,255];const c=Math.random()*20-10,l=140+c,f=70+c*.5,g=60+c*.3;return[l,f,g,255]}),this.renderer.generateProceduralTexture("wall_stone",64,64,(t,e)=>{const i=Math.random()*30,r=100+Math.sin(t*.2)*10+Math.cos(e*.3)*10;return[r+i,r+i-5,r+i-10,255]}),this.renderer.generateProceduralTexture("wall_wood",64,64,(t,e)=>{const i=Math.sin(e*.8+Math.sin(t*.1)*3)*20,r=120;return[r+i,r-30+i*.5,r-60+i*.3,255]}),this.renderer.generateProceduralTexture("wall_plaster",64,64,(t,e)=>{const i=Math.random()*15;return[230-i,220-i,200-i,255]}),this.renderer.generateProceduralTexture("wall_hedge",64,64,(t,e)=>{const i=Math.random()*40;return Math.random()>.3?[30+i,80+i,30+i*.5,255]:[40,30,20,255]})}generateOpponentSprites(){const t=["idle","walking","running","aiming","firing","reloading","bayonet_thrust","hit","dying","dead"];for(const l of t){const f=this.spriteGenerator.generateOpponentSprite(l,nt.british_line,64,128),g=new Uint32Array(f.width*f.height),d=f.data;for(let p=0;p<g.length;p++){const y=p*4;g[p]=d[y+3]<<24|d[y+2]<<16|d[y+1]<<8|d[y]}this.renderer.registerTexture(`opponent_${l}`,{id:`opponent_${l}`,width:f.width,height:f.height,data:g})}const e=this.spriteGenerator.generateSmokeSprite(32),i=new Uint32Array(e.width*e.height),r=e.data;for(let l=0;l<i.length;l++){const f=l*4;i[l]=r[f+3]<<24|r[f+2]<<16|r[f+1]<<8|r[f]}this.renderer.registerTexture("smoke",{id:"smoke",width:e.width,height:e.height,data:i});const a=this.spriteGenerator.generateMuzzleFlashSprite(48),n=new Uint32Array(a.width*a.height),s=a.data;for(let l=0;l<n.length;l++){const f=l*4;n[l]=s[f+3]<<24|s[f+2]<<16|s[f+1]<<8|s[f]}this.renderer.registerTexture("muzzle_flash",{id:"muzzle_flash",width:a.width,height:a.height,data:n});const o=this.spriteGenerator.generateBloodSprite(16),h=new Uint32Array(o.width*o.height),c=o.data;for(let l=0;l<h.length;l++){const f=l*4;h[l]=c[f+3]<<24|c[f+2]<<16|c[f+1]<<8|c[f]}this.renderer.registerTexture("blood",{id:"blood",width:o.width,height:o.height,data:h})}async initialize(){this.gameState="menu"}startGame(t){const e=B[t];if(!e)return;this.currentMode=e,this.currentRound=0,this.score=0,this.gameState="loading";const i=F[this.selectedMapIndex];this.map=i.create(),this.player=this.createPlayer(),this.player.x=this.map.spawnPoints[0].x,this.player.y=this.map.spawnPoints[0].y,this.player.angle=0,this.playerMusket=new L,this.playerBayonet=new H,this.startRound()}startRound(){if(!this.currentMode)return;this.currentRound++,this.roundTime=0,this.player.x=this.map.spawnPoints[0].x,this.player.y=this.map.spawnPoints[0].y,this.player.angle=0,this.player.health=100;const t=this.currentMode.opponentTypes[Math.min(this.currentRound-1,this.currentMode.opponentTypes.length-1)];this.activeOpponent=new et(`opponent_${this.currentRound}`,this.map.spawnPoints[1].x,this.map.spawnPoints[1].y,Math.PI,t),this.opponents=[this.activeOpponent],this.gameState="playing"}update(t){this.lastTime===0&&(this.lastTime=t),this.deltaTime=Math.min((t-this.lastTime)/1e3,.1),this.lastTime=t,this.frameCount++,this.fpsTimer+=this.deltaTime,this.fpsTimer>=1&&(this.fps=this.frameCount,this.frameCount=0,this.fpsTimer=0);const e=this.input.getState();switch(this.gameState){case"playing":this.updatePlaying(e);break;case"paused":e.interact&&(this.gameState="playing");break}this.render(),this.input.update()}updatePlaying(t){const e=this.deltaTime;if(this.roundTime+=e,this.currentMode&&this.currentMode.timeLimit>0&&this.roundTime>=this.currentMode.timeLimit){this.endRound(!1);return}this.updatePlayer(t,e),this.playerMusket.update(e,t,this.player),this.playerBayonet.update(e,t,this.player,this.opponents.map(i=>({id:i.id,type:"opponent",x:i.x,y:i.y,z:i.z,angle:i.angle,state:i.getAnimState(),health:i.health,sprite:{id:i.id,x:i.x,y:i.y,z:0,texture:"opponent",scale:1}})));for(const i of this.opponents)i.update(e,this.player,this.map);this.processCombat(e),this.audio.setListenerPosition(this.player.x,this.player.y,this.player.angle),this.screenShake*=.9,this.screenFlash*=.95,this.hitMarker=Math.max(0,this.hitMarker-e*3),this.checkRoundEnd()}updatePlayer(t,e){this.input.isLocked()&&(this.player.angle=Y(this.player.angle+t.mouseDeltaX),this.player.pitch=G(this.player.pitch-t.mouseDeltaY,-.5,.5)),t.turnLeft&&(this.player.angle=Y(this.player.angle-2*e)),t.turnRight&&(this.player.angle=Y(this.player.angle+2*e));const i=t.sprint&&!t.aim?5:t.crouch?1.5:3,r=this.playerBayonet.getMovementMultiplier();let a=0,n=0;t.forward&&(a+=Math.cos(this.player.angle),n+=Math.sin(this.player.angle)),t.backward&&(a-=Math.cos(this.player.angle)*.6,n-=Math.sin(this.player.angle)*.6),t.left&&(a+=Math.cos(this.player.angle-Math.PI/2)*.7,n+=Math.sin(this.player.angle-Math.PI/2)*.7),t.right&&(a+=Math.cos(this.player.angle+Math.PI/2)*.7,n+=Math.sin(this.player.angle+Math.PI/2)*.7);const s=Math.sqrt(a*a+n*n);s>0&&(a/=s,n/=s);const o=this.player.x+a*i*r*e,h=this.player.y+n*i*r*e;this.checkCollision(o,this.player.y)||(this.player.x=o),this.checkCollision(this.player.x,h)||(this.player.y=h),this.player.isMoving=s>0,this.player.isCrouching=t.crouch,this.player.isSprinting=t.sprint&&!t.aim,this.player.isMoving&&this.player.isSprinting}checkCollision(t,e){const r=[{x:t-.3,y:e-.3},{x:t+.3,y:e-.3},{x:t-.3,y:e+.3},{x:t+.3,y:e+.3}];for(const a of r){const n=Math.floor(a.x),s=Math.floor(a.y);if(n<0||n>=this.map.width||s<0||s>=this.map.height||this.map.tiles[s][n]>0)return!0}return!1}processCombat(t){const e=this.playerMusket.getProjectiles();for(let r=e.length-1;r>=0;r--){const a=e[r];for(const o of this.opponents){if(!o.isAlive())continue;const h=o.getHitbox();if(Math.sqrt((a.x-h.x)**2+(a.y-h.y)**2)<h.radius&&a.z>0&&a.z<h.height){const l=a.damage;o.takeDamage(l,Math.atan2(a.vy,a.vx)),this.playerMusket.removeProjectile(r),this.screenShake=.05,this.hitMarker=1,this.audio.playImpact("flesh");break}}const n=Math.floor(a.x),s=Math.floor(a.y);n>=0&&n<this.map.width&&s>=0&&s<this.map.height&&this.map.tiles[s][n]>0&&(this.playerMusket.removeProjectile(r),this.audio.playImpact("wood"))}const i=this.playerBayonet.getPendingHits();for(const r of i){const a=this.opponents.find(n=>n.id===r.targetId);a&&a.isAlive()&&(a.takeDamage(r.damage,this.player.angle),this.screenShake=.08,this.hitMarker=1,this.audio.playBayonetClash(),r.isCritical&&(this.screenFlash=.3))}for(const r of this.opponents){if(!r.isAlive())continue;const a=r.getMusket().getProjectiles();for(let n=a.length-1;n>=0;n--){const s=a[n];if(Math.sqrt((s.x-this.player.x)**2+(s.y-this.player.y)**2)<.5&&s.z>0&&s.z<1.8){this.player.health-=s.damage,r.getMusket().removeProjectile(n),this.screenShake=.15,this.screenFlash=.5,this.audio.playImpact("flesh");break}}r.getBayonet().getPendingHits()}this.playerMusket.getState()==="fired"&&this.playerMusket.getStateTimer()<.02&&(this.audio.playMusketShot(this.player.x,this.player.y),this.screenShake=.1);for(const r of this.opponents)r.getMusket().getState()==="fired"&&r.getMusket().getStateTimer()<.02&&this.audio.playMusketShot(r.x,r.y)}checkRoundEnd(){if(this.player.health<=0){this.endRound(!1);return}if(this.opponents.every(e=>!e.isAlive())){this.endRound(!0);return}}endRound(t){t?(this.score+=100+Math.floor(this.player.health),this.currentMode&&this.currentRound>=this.currentMode.rounds?this.gameState="victory":(this.gameState="intermission",setTimeout(()=>this.startRound(),3e3))):this.gameState="defeat"}render(){const t=(Math.random()-.5)*this.screenShake*20,e=(Math.random()-.5)*this.screenShake*20;this.renderer.clear(100,150,200),this.renderer.renderSkyAndFloor(this.player,this.map),this.renderer.renderWalls(this.player,this.map);const i=[];for(const r of this.opponents)i.push({id:r.id,x:r.x,y:r.y,z:0,texture:"opponent_"+r.getAnimState(),scale:1,billboard:!0});for(const r of this.playerMusket.getSmokeParticles())i.push({id:`smoke_${Math.random()}`,x:r.x,y:r.y,z:r.z,texture:"smoke",scale:r.size,billboard:!0});this.renderer.renderSprites(i,this.player),this.renderer.present(),this.renderUI(t,e)}renderUI(t,e){const i=this.uiCtx,r=this.uiCanvas.width,a=this.uiCanvas.height;if(i.clearRect(0,0,r,a),i.save(),i.translate(t,e),this.screenFlash>.01&&(i.fillStyle=`rgba(255, 0, 0, ${this.screenFlash*.5})`,i.fillRect(0,0,r,a)),this.renderWeapon(i,r,a),this.renderHUD(i,r,a),this.hitMarker>0){i.strokeStyle=`rgba(255, 255, 255, ${this.hitMarker})`,i.lineWidth=2;const n=r/2,s=a/2,o=15;i.beginPath(),i.moveTo(n-o,s-o),i.lineTo(n-o/2,s-o/2),i.moveTo(n+o,s-o),i.lineTo(n+o/2,s-o/2),i.moveTo(n-o,s+o),i.lineTo(n-o/2,s+o/2),i.moveTo(n+o,s+o),i.lineTo(n+o/2,s+o/2),i.stroke()}this.gameState==="menu"?this.renderMenu(i,r,a):this.gameState==="victory"?this.renderEndScreen(i,r,a,!0):this.gameState==="defeat"?this.renderEndScreen(i,r,a,!1):this.gameState==="intermission"&&this.renderIntermission(i,r,a),i.restore()}renderWeapon(t,e,i){this.weaponView.update(this.deltaTime,this.playerMusket,this.playerBayonet,this.player.isMoving,this.player.isSprinting),this.weaponView.render(t,e,i,this.playerMusket,this.playerBayonet)}renderHUD(t,e,i){if(this.player.health<50){const r=(50-this.player.health)/50,a=t.createRadialGradient(e/2,i/2,i/3,e/2,i/2,i);a.addColorStop(0,"rgba(139, 0, 0, 0)"),a.addColorStop(1,`rgba(139, 0, 0, ${r*.5})`),t.fillStyle=a,t.fillRect(0,0,e,i)}this.currentMode&&this.gameState==="playing"&&(t.fillStyle="rgba(0, 0, 0, 0.3)",t.fillRect(e/2-80,10,160,30),t.fillStyle="#fff",t.font="18px serif",t.textAlign="center",t.fillText(`Round ${this.currentRound}/${this.currentMode.rounds}`,e/2,32)),t.fillStyle="#fff",t.font="12px monospace",t.textAlign="left",t.fillText(`FPS: ${this.fps}`,10,20),this.playerMusket.hasAmmo()||(t.fillStyle="rgba(255, 200, 100, 0.8)",t.font="16px serif",t.textAlign="right",t.fillText("Press R to reload",e-20,i-80))}renderMenu(t,e,i){if(t.fillStyle="rgba(20, 15, 10, 0.9)",t.fillRect(0,0,e,i),t.fillStyle="#c9a55a",t.font="bold 48px serif",t.textAlign="center",t.fillText("MUSKET DUEL",e/2,80),t.fillStyle="#888",t.font="18px serif",t.fillText("A Gentleman's Game of Honor",e/2,110),this.menuSection==="modes"){t.fillStyle="#c9a55a",t.font="bold 20px serif",t.fillText("SELECT GAME MODE",e/2,150);const r=Object.entries(B);let a=190;t.font="22px serif";for(let s=0;s<r.length;s++){const[o,h]=r[s];t.fillStyle="#c9a55a",t.fillText(`${s+1}. ${h.name}`,e/2,a),t.fillStyle="#666",t.font="13px serif",t.fillText(h.description,e/2,a+20),t.font="22px serif",a+=60}const n=F[this.selectedMapIndex];t.fillStyle="#555",t.font="14px serif",t.fillText(`Map: ${n.name}`,e/2,i-100),t.fillText("Press M to change map",e/2,i-80),t.fillStyle="#555",t.fillText("Press 1-4 to select game mode",e/2,i-50),t.fillText("Click to lock mouse  WASD to move  Mouse to aim  LMB to fire",e/2,i-30)}else{t.fillStyle="#c9a55a",t.font="bold 20px serif",t.fillText("SELECT MAP",e/2,150);let r=190;t.font="20px serif";for(let a=0;a<F.length;a++){const n=F[a],s=a===this.selectedMapIndex;t.fillStyle=s?"#c9a55a":"#777",t.fillText(`${a+1}. ${n.name}${s?" ":""}`,e/2,r),t.fillStyle=s?"#888":"#555",t.font="12px serif",t.fillText(n.description,e/2,r+18),t.font="20px serif",r+=50}t.fillStyle="#555",t.font="14px serif",t.fillText("Press 1-6 to select map, or ESC to go back",e/2,i-50)}}renderEndScreen(t,e,i,r){t.fillStyle=r?"rgba(20, 40, 20, 0.9)":"rgba(40, 20, 20, 0.9)",t.fillRect(0,0,e,i),t.fillStyle=r?"#6a6":"#a66",t.font="bold 48px serif",t.textAlign="center",t.fillText(r?"VICTORY":"DEFEAT",e/2,i/2-40),t.fillStyle="#c9a55a",t.font="24px serif",t.fillText(`Score: ${this.score}`,e/2,i/2+20),t.fillStyle="#888",t.font="18px serif",t.fillText("Press SPACE to return to menu",e/2,i/2+80)}renderIntermission(t,e,i){t.fillStyle="rgba(0, 0, 0, 0.7)",t.fillRect(0,0,e,i),t.fillStyle="#c9a55a",t.font="bold 36px serif",t.textAlign="center",t.fillText("OPPONENT DEFEATED",e/2,i/2-20),t.fillStyle="#888",t.font="18px serif",t.fillText("Preparing next round...",e/2,i/2+20)}handleKeyPress(t){if(this.gameState==="menu")if(this.menuSection==="modes"){if(t==="m"||t==="M"){this.menuSection="maps";return}const e=parseInt(t)-1,i=Object.keys(B);e>=0&&e<i.length&&this.startGame(i[e])}else{if(t==="Escape"){this.menuSection="modes";return}const e=parseInt(t)-1;e>=0&&e<F.length&&(this.selectedMapIndex=e,this.menuSection="modes")}else(this.gameState==="victory"||this.gameState==="defeat")&&t===" "&&(this.gameState="menu",this.menuSection="modes")}getState(){return this.gameState}getScore(){return this.score}getCurrentRound(){return this.currentRound}}class dt{game;gameCanvas;uiCanvas;isRunning=!1;constructor(){if(this.gameCanvas=document.getElementById("game-canvas"),this.uiCanvas=document.getElementById("ui-canvas"),!this.gameCanvas||!this.uiCanvas)throw new Error("Could not find canvas elements");this.resizeCanvases(),window.addEventListener("resize",()=>this.resizeCanvases()),this.game=new gt(this.gameCanvas,this.uiCanvas),document.addEventListener("keydown",t=>{this.game.handleKeyPress(t.key)}),document.addEventListener("click",()=>{},{once:!0})}resizeCanvases(){if(!document.getElementById("game-container"))return;const e=Math.min(1200,window.innerWidth-40),i=Math.min(900,window.innerHeight-100),r=4/3;let a=e,n=e/r;n>i&&(n=i,a=i*r),this.gameCanvas.width=800,this.gameCanvas.height=600,this.gameCanvas.style.width=`${a}px`,this.gameCanvas.style.height=`${n}px`,this.uiCanvas.width=800,this.uiCanvas.height=600,this.uiCanvas.style.width=`${a}px`,this.uiCanvas.style.height=`${n}px`}async start(){await this.game.initialize(),this.isRunning=!0,this.gameLoop(0)}gameLoop=t=>{this.isRunning&&(this.game.update(t),requestAnimationFrame(this.gameLoop))};stop(){this.isRunning=!1}}document.addEventListener("DOMContentLoaded",async()=>{await new dt().start()});
//# sourceMappingURL=index-Be1x309M.js.map
