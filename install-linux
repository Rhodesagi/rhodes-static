#!/bin/bash
# RHODES_CODE — Linux Installer (curl | bash)
# Downloads the correct Electron app for your architecture.

echo ""
echo "====================================="
echo "  RHODES_CODE INSTALLER (Linux)"
echo "====================================="
echo ""

INSTALL_DIR="$HOME/.rhodes/app"
ICON_DIR="$HOME/.local/share/icons"
DESKTOP_DIR="$HOME/.local/share/applications"
BIN_DIR="$HOME/.local/bin"
CONFIG_DIR="$HOME/.rhodes"
BASE_URL="https://rhodesagi.com/download"

# ── Detect architecture ───────────────────────────────────
ARCH=$(uname -m)
case "$ARCH" in
    x86_64|amd64)
        TARBALL="rhodes-code-2.0.1-x64.tar.gz"
        echo "  Architecture: x86_64"
        ;;
    aarch64|arm64)
        TARBALL="rhodes-code-2.0.1-arm64.tar.gz"
        echo "  Architecture: arm64"
        ;;
    *)
        echo "  [ERROR] Unsupported architecture: $ARCH"
        echo "  Supported: x86_64, aarch64"
        exit 1
        ;;
esac

URL="${BASE_URL}/${TARBALL}"
if [ -n "${RHODES_TOKEN:-}" ]; then
    URL="${URL}?token=${RHODES_TOKEN}"
fi

# ── Download & extract directly to install dir ────────────
mkdir -p "$INSTALL_DIR"
echo "  Downloading RHODES_CODE..."
if ! curl -fSL "$URL" 2>/dev/null | tar xz -C "$INSTALL_DIR" --strip-components=0; then
    echo "  [ERROR] Download or extraction failed."
    echo "  Check your connection or visit https://rhodesagi.com/download/"
    exit 1
fi

chmod +x "$INSTALL_DIR/rhodes-desktop"
chmod +x "$INSTALL_DIR/chrome_crashpad_handler" 2>/dev/null || true
chmod 4755 "$INSTALL_DIR/chrome-sandbox" 2>/dev/null || true
echo "  [OK] App installed to $INSTALL_DIR"

# ── Icon ──────────────────────────────────────────────────
mkdir -p "$ICON_DIR"
cp "$INSTALL_DIR/rhodes-icon.png" "$ICON_DIR/rhodes-code.png" 2>/dev/null || true
echo "  [OK] Icon installed"

# ── Desktop entry ─────────────────────────────────────────
mkdir -p "$DESKTOP_DIR"
cat > "$DESKTOP_DIR/rhodes-code.desktop" << DESKTOPEOF
[Desktop Entry]
Name=RHODES_CODE
Comment=Rhodes AGI Desktop Client
Exec=$INSTALL_DIR/rhodes-desktop --no-sandbox %U
Icon=$ICON_DIR/rhodes-code.png
Terminal=false
Type=Application
Categories=Network;Chat;Development;
Keywords=rhodes;agi;ai;chat;code;
StartupNotify=true
StartupWMClass=rhodes-desktop
DESKTOPEOF
chmod +x "$DESKTOP_DIR/rhodes-code.desktop"
update-desktop-database "$DESKTOP_DIR" 2>/dev/null || true
echo "  [OK] Desktop entry created"

# ── Desktop shortcut ──────────────────────────────────────
if [ -d "$HOME/Desktop" ]; then
    cp "$DESKTOP_DIR/rhodes-code.desktop" "$HOME/Desktop/rhodes-code.desktop"
    chmod +x "$HOME/Desktop/rhodes-code.desktop"
    gio set "$HOME/Desktop/rhodes-code.desktop" metadata::trusted true 2>/dev/null || true
    echo "  [OK] Desktop shortcut created"
fi

# ── CLI commands ──────────────────────────────────────────
mkdir -p "$BIN_DIR"
for cmd_name in rhodes RHODES_CODE; do
    cat > "$BIN_DIR/$cmd_name" << CMDEOF
#!/bin/bash
exec "$INSTALL_DIR/rhodes-desktop" --no-sandbox "\$@"
CMDEOF
    chmod +x "$BIN_DIR/$cmd_name"
done
echo "  [OK] CLI commands: rhodes, RHODES_CODE"

if [[ ":$PATH:" != *":$BIN_DIR:"* ]]; then
    SHELL_RC=""
    [ -f "$HOME/.bashrc" ] && SHELL_RC="$HOME/.bashrc"
    [ -f "$HOME/.zshrc" ] && SHELL_RC="$HOME/.zshrc"
    if [ -n "$SHELL_RC" ]; then
        if ! grep -q '.local/bin' "$SHELL_RC" 2>/dev/null; then
            echo 'export PATH="$HOME/.local/bin:$PATH"' >> "$SHELL_RC"
            echo "  [OK] Added ~/.local/bin to PATH in $SHELL_RC"
        fi
    fi
    export PATH="$BIN_DIR:$PATH"
fi

# ── Auth ──────────────────────────────────────────────────
mkdir -p "$CONFIG_DIR"
if [ -n "${RHODES_TOKEN:-}" ]; then
    echo "{\"token\": \"$RHODES_TOKEN\"}" > "$CONFIG_DIR/config.json"
    echo "  [OK] Token saved — auto-login enabled"
elif [ ! -f "$CONFIG_DIR/config.json" ]; then
    echo ""
    echo "  Login to Rhodes (or press Enter to skip)"
    echo ""
    read -p "  Username or Email: " RHODES_USER
    if [ -n "$RHODES_USER" ]; then
        read -s -p "  Password: " RHODES_PASS
        echo ""
        echo "  Authenticating..."
        RESPONSE=$(curl -s -X POST https://rhodesagi.com/api/user/login \
            -H "Content-Type: application/json" \
            -d "{\"username\":\"$RHODES_USER\",\"password\":\"$RHODES_PASS\"}" 2>/dev/null || echo "")
        TOKEN=$(echo "$RESPONSE" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('token',''))" 2>/dev/null || echo "")
        if [ -n "$TOKEN" ] && [ "$TOKEN" != "null" ]; then
            echo "{\"token\": \"$TOKEN\"}" > "$CONFIG_DIR/config.json"
            echo "  [OK] Logged in successfully"
        else
            echo "  [WARN] Login failed — you can login later in the app"
        fi
    else
        echo "  [SKIP] Will prompt for login in app"
    fi
fi

echo ""
echo "====================================="
echo "  INSTALLATION COMPLETE"
echo "====================================="
echo ""
echo "  Launch:  rhodes"
echo "  Or:      Click 'RHODES_CODE' in your app launcher"
echo "  Or:      Double-click the desktop shortcut"
echo ""
echo "  Launching RHODES_CODE..."
echo ""

nohup "$INSTALL_DIR/rhodes-desktop" --no-sandbox > /dev/null 2>&1 &
disown
