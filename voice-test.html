<!DOCTYPE html>
<html>
<head><title>Voice Test</title>
<style>
body { background: #0a0a0a; color: #00ffd5; font-family: monospace; padding: 40px; }
button { background: #111; border: 1px solid #00ffd5; color: #00ffd5; padding: 15px 30px; font-size: 18px; cursor: pointer; margin: 10px; font-family: monospace; }
button:hover { background: #1a1a1a; }
#log { margin-top: 20px; white-space: pre-wrap; font-size: 14px; border: 1px solid #333; padding: 15px; max-height: 400px; overflow-y: auto; }
.ok { color: #0f0; }
.fail { color: #f00; }
.info { color: #ff0; }
</style>
</head>
<body>
<h1>RHODES VOICE TEST</h1>
<p>Click each button to test that component:</p>

<button onclick="testTTSFetch()">1. TEST TTS FETCH</button>
<button onclick="testAudioPlay()">2. TEST AUDIO PLAY</button>
<button onclick="testFullSpeak()">3. TEST FULL SPEAK</button>
<button onclick="testVoiceChatState()">4. CHECK VOICECHAT STATE</button>

<div id="log"></div>

<audio id="tts-audio" style="display:none;"></audio>

<script>
function log(msg, cls) {
    var el = document.getElementById('log');
    var line = document.createElement('div');
    line.className = cls || '';
    line.textContent = new Date().toLocaleTimeString() + ' ' + msg;
    el.appendChild(line);
    el.scrollTop = el.scrollHeight;
}

async function testTTSFetch() {
    log('Fetching TTS from /tts/stream ...', 'info');
    try {
        var resp = await fetch('/tts/stream', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: 'Hello, this is a test of the Rhodes text to speech system.', language: 'en-US' })
        });
        log('Response status: ' + resp.status, resp.ok ? 'ok' : 'fail');
        if (resp.ok) {
            var blob = await resp.blob();
            log('Audio blob size: ' + blob.size + ' bytes', blob.size > 100 ? 'ok' : 'fail');
            window._testBlob = blob;
            log('Blob saved to window._testBlob - click TEST AUDIO PLAY next', 'info');
        } else {
            var text = await resp.text();
            log('Error body: ' + text, 'fail');
        }
    } catch(e) {
        log('Fetch error: ' + e.message, 'fail');
    }
}

async function testAudioPlay() {
    if (!window._testBlob) {
        log('No blob - click TEST TTS FETCH first', 'fail');
        return;
    }
    log('Attempting to play audio blob...', 'info');
    try {
        var url = URL.createObjectURL(window._testBlob);
        var audio = document.getElementById('tts-audio');
        audio.src = url;
        audio.onplay = function() { log('Audio PLAYING', 'ok'); };
        audio.onended = function() { log('Audio ENDED', 'ok'); URL.revokeObjectURL(url); };
        audio.onerror = function(e) { log('Audio ERROR: ' + (e.message || audio.error?.message || 'unknown'), 'fail'); };
        await audio.play();
        log('audio.play() resolved', 'ok');
    } catch(e) {
        log('Play error: ' + e.message, 'fail');
        log('This usually means autoplay is blocked - you need to click first', 'info');
    }
}

async function testFullSpeak() {
    log('Testing full TTS pipeline...', 'info');
    try {
        var resp = await fetch('/tts/stream', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: 'Testing the full speak pipeline. If you hear this, TTS is working.', language: 'en-US' })
        });
        log('Fetch status: ' + resp.status, resp.ok ? 'ok' : 'fail');
        if (!resp.ok) { log('TTS fetch failed', 'fail'); return; }
        var blob = await resp.blob();
        log('Got ' + blob.size + ' bytes', 'ok');
        var url = URL.createObjectURL(blob);
        var audio = document.getElementById('tts-audio');
        audio.src = url;
        audio.onplay = function() { log('AUDIO IS PLAYING', 'ok'); };
        audio.onended = function() { log('Audio finished', 'ok'); URL.revokeObjectURL(url); };
        audio.onerror = function() { log('Audio playback error', 'fail'); };
        await audio.play();
    } catch(e) {
        log('Error: ' + e.message, 'fail');
    }
}

function testVoiceChatState() {
    log('--- VoiceChat State ---', 'info');
    if (typeof VoiceChat === 'undefined') {
        log('VoiceChat is UNDEFINED (not loaded)', 'fail');
    } else {
        log('VoiceChat exists', 'ok');
        log('  voiceEnabled: ' + VoiceChat.voiceEnabled, VoiceChat.voiceEnabled ? 'ok' : 'fail');
        log('  audioUnlocked: ' + VoiceChat.audioUnlocked, VoiceChat.audioUnlocked ? 'ok' : 'fail');
        log('  pushToTalk: ' + VoiceChat.pushToTalk, 'info');
        log('  ttsPlaying: ' + VoiceChat.ttsPlaying, 'info');
        log('  ttsEndpoint: ' + VoiceChat.ttsEndpoint, 'info');
        log('  recognition: ' + (VoiceChat.recognition ? 'exists' : 'NULL'), VoiceChat.recognition ? 'ok' : 'fail');
        log('  isRecording: ' + VoiceChat.isRecording, 'info');
    }
    log('window.ws: ' + (window.ws ? 'exists (readyState=' + window.ws.readyState + ')' : 'NULL'), window.ws ? 'ok' : 'fail');
    if (window.ws) {
        log('  ws._ttsHooked: ' + (window.ws._ttsHooked || false), 'info');
    }
}
</script>
</body>
</html>
