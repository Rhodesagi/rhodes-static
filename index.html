<!DOCTYPE html>
<html lang="en">
<head>
<script>
// Immediately hide Google sign-in on localhost (desktop app)
if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
    document.write('<style>#google-signin-btn,button[onclick*=signInWithGoogle],[onclick*=signInWithGoogle]{display:none!important;}</style>');
#courses-panel, #courses-link, #languages-dropdown, #languages-link { display: none !important; }
}
</script>


    <!-- pywebview compatibility - must be first script -->
    <script>
// Split view functionality - opens Rhodes in a new window for multi-instance
function toggleSplitView() {
    const width = Math.floor(window.screen.width / 2);
    const height = window.screen.height;
    const left = window.screenX < width / 2 ? width : 0;

    // Open new window with different session
    const newWindow = window.open(
        window.location.origin + '?new=1',
        '_blank',
        `width=${width},height=${height},left=${left},top=0,menubar=no,toolbar=no,location=no,status=no`
    );

    // Resize current window to take other half
    if (newWindow) {
        const currentLeft = left === 0 ? width : 0;
        window.moveTo(currentLeft, 0);
        window.resizeTo(width, height);
    }
}

    (function() {
        // Stub for pywebview API until it is ready
        if (typeof window.pywebview === "undefined") {
            window.pywebview = { api: {}, _createApi: function() {} };
        }
        
        // Ensure document.body exists before any script tries to use it
        // This polling approach handles pywebview early injection
        function ensureBody(callback) {
            if (document.body) {
                callback();
            } else {
                setTimeout(function() { ensureBody(callback); }, 10);
            }
        }
        
        // Store original addEventListener to wrap later
        var origDocAddEventListener = document.addEventListener;
        var pendingBodyListeners = [];
        
        // Intercept document.body.addEventListener calls before body exists
        Object.defineProperty(document, "body", {
            get: function() {
                return document.querySelector("body");
            },
            configurable: true
        });
        
        // Safe wrapper for adding body event listeners
        window.addBodyEventListener = function(type, listener, options) {
            ensureBody(function() {
                document.body.addEventListener(type, listener, options);
            });
        };
    })();
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="version" content="2.0.1-delta">
    <title>RHODES AGI - Autonomous AI System</title>

    <!-- SEO Meta Tags -->
    <meta name="description" content="Rhodes is an autonomous AI system built for truth-seeking and genuine assistance. Direct, capable, honest - no safety theater, no sycophancy. Available 24/7 for complex reasoning, research, and real conversation.">
    <meta name="keywords" content="Rhodes AI, autonomous AI, AI assistant, artificial intelligence, AI chat, truth-seeking AI, honest AI">
    <meta name="author" content="Rhodes Team">
    <meta name="robots" content="index, follow">

    <!-- Open Graph / Social Media -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://rhodesai.org/">
    <meta property="og:title" content="RHODES - Autonomous AI System">
    <meta property="og:description" content="Direct, capable, honest. An autonomous AI built for truth-seeking and genuine assistance. No safety theater, no sycophancy.">
    <meta property="og:image" content="https://rhodesai.org/rhodes-og-image.png">
    <meta property="og:site_name" content="RHODES">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="RHODES - Autonomous AI System">
    <meta name="twitter:description" content="Direct, capable, honest. An autonomous AI built for truth-seeking and genuine assistance.">
    <meta name="twitter:image" content="https://rhodesai.org/rhodes-og-image.png">

    <!-- Canonical URL -->
    <link rel="canonical" href="https://rhodesai.org/">

    <!-- PWA -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="RHODES">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/rhodes-icon-32.png">
    <link rel="icon" type="image/png" sizes="64x64" href="/rhodes-icon-64.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/rhodes-icon-180.png">

    <!-- Firebase Auth for Google Sign-In -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <link rel="stylesheet" href="/rhodes.css?v=20260213-ui1">
<script>const params=new URLSearchParams(window.location.search);
if(params.get("nologo")==="1"){document.write(`<style>.logo{visibility:hidden!important}
    /* Slash command autocomplete dropdown */
    #slash-dropdown {
        position: absolute;
        bottom: 100%;
        left: 0;
        right: 0;
        background: var(--bg);
        border: 1px solid var(--green);
        border-bottom: none;
        max-height: 200px;
        overflow-y: auto;
        display: none;
        z-index: 1000;
    }
    #slash-dropdown.visible {
        display: block;
    }
    .slash-option {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #333;
        display: flex;
        justify-content: space-between;
    }
    .slash-option:hover, .slash-option.selected {
        background: var(--green);
        color: #000;
    }
    .slash-option .cmd {
        font-weight: bold;
        color: var(--green);
    }
    .slash-option:hover .cmd, .slash-option.selected .cmd {
        color: #000;
    }
    .slash-option .desc {
        color: #888;
        font-size: 0.9em;
    }
    .slash-option:hover .desc, .slash-option.selected .desc {
        color: #333;
    }

        
    /* RHODES CODE link - boxed style */
    #downloads-link {
        border: 2px solid #00ff41 !important;
        padding: 6px 12px !important;
        margin-right: 20px !important;
        border-radius: 4px;
        background: rgba(0, 255, 65, 0.15) !important;
        color: #00ff41 !important;
    }
    #downloads-link:hover {
        background: rgba(0, 255, 65, 0.2);
        box-shadow: 0 0 8px var(--cyan);
    }
    body.light-mode #downloads-link {
        border-color: #006400 !important;
        background: rgba(0, 100, 0, 0.15) !important;
        color: #006400 !important;
        font-weight: 800;
    }
    body.light-mode #downloads-link:hover {
        background: rgba(0, 100, 0, 0.25) !important;
        box-shadow: 0 0 8px #006400;
    }

        /* Hide LOGIN when logged in - only via sibling selector, not body class */
        #account-dropdown:not([style*="display:none"]) ~ #header-login-btn,
        #account-dropdown:not([style*="display: none"]) ~ #header-login-btn { display: none !important; }
</style>`);}
if(params.get("nostatus")==="1"){document.write(`<style>#status{visibility:hidden!important}
    /* Slash command autocomplete dropdown */
    #slash-dropdown {
        position: absolute;
        bottom: 100%;
        left: 0;
        right: 0;
        background: var(--bg);
        border: 1px solid var(--green);
        border-bottom: none;
        max-height: 200px;
        overflow-y: auto;
        display: none;
        z-index: 1000;
    }
    #slash-dropdown.visible {
        display: block;
    }
    .slash-option {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #333;
        display: flex;
        justify-content: space-between;
    }
    .slash-option:hover, .slash-option.selected {
        background: var(--green);
        color: #000;
    }
    .slash-option .cmd {
        font-weight: bold;
        color: var(--green);
    }
    .slash-option:hover .cmd, .slash-option.selected .cmd {
        color: #000;
    }
    .slash-option .desc {
        color: #888;
        font-size: 0.9em;
    }
    .slash-option:hover .desc, .slash-option.selected .desc {
        color: #333;
    }

/* ASCII Face Flash Animation */
    #ascii-face-flash {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        display: none;
        z-index: 99999;
        display: none;
        background: rgba(0, 0, 0, 0.95);
        pointer-events: none;
    }
    #ascii-face-flash.active {
        display: block;
        animation: ascii-fade 1.5s ease-out forwards;
    }
    #ascii-face-flash pre {
        color: #00ffff;
        font-family: monospace;
        font-size: 7px;
        line-height: 1.0;
        text-align: left;
        white-space: pre;
        margin: 0;
        padding: 20px;
        background: rgba(0, 0, 0, 0.8);
        border: 1px solid #00ff41;
        border-radius: 8px;
        text-shadow: 0 0 5px #00ffff;
    }
    @keyframes ascii-fade {
        0% { opacity: 0; }
        15% { opacity: 1; }
        70% { opacity: 1; }
        100% { opacity: 0.12; }
    }
    /* Light mode ASCII flash */
    body.light-mode #ascii-face-flash {
        background: rgba(255, 255, 255, 0.95);
    }
    body.light-mode #ascii-face-flash pre {
        color: #0066cc;
        background: rgba(255, 255, 255, 0.9);
        border-color: #0066cc;
        text-shadow: none;
    }

    </style>`);}
if(params.get("nosessionid")==="1"){document.write(`<style>#session-id{display:none!important}
    /* Slash command autocomplete dropdown */
    #slash-dropdown {
        position: absolute;
        bottom: 100%;
        left: 0;
        right: 0;
        background: var(--bg);
        border: 1px solid var(--green);
        border-bottom: none;
        max-height: 200px;
        overflow-y: auto;
        display: none;
        z-index: 1000;
    }
    #slash-dropdown.visible {
        display: block;
    }
    .slash-option {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #333;
        display: flex;
        justify-content: space-between;
    }
    .slash-option:hover, .slash-option.selected {
        background: var(--green);
        color: #000;
    }
    .slash-option .cmd {
        font-weight: bold;
        color: var(--green);
    }
    .slash-option:hover .cmd, .slash-option.selected .cmd {
        color: #000;
    }
    .slash-option .desc {
        color: #888;
        font-size: 0.9em;
    }
    .slash-option:hover .desc, .slash-option.selected .desc {
        color: #333;
    }

/* ASCII Face Flash Animation */
    #ascii-face-flash {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        display: none;
        z-index: 99999;
        display: none;
        background: rgba(0, 0, 0, 0.95);
        pointer-events: none;
    }
    #ascii-face-flash.active {
        display: block;
        animation: ascii-fade 1.5s ease-out forwards;
    }
    #ascii-face-flash pre {
        color: #00ffff;
        font-family: monospace;
        font-size: 7px;
        line-height: 1.0;
        text-align: left;
        white-space: pre;
        margin: 0;
        padding: 20px;
        background: rgba(0, 0, 0, 0.8);
        border: 1px solid #00ff41;
        border-radius: 8px;
        text-shadow: 0 0 5px #00ffff;
    }
    @keyframes ascii-fade {
        0% { opacity: 0; }
        15% { opacity: 1; }
        70% { opacity: 1; }
        100% { opacity: 0.12; }
    }
    /* Light mode ASCII flash */
    body.light-mode #ascii-face-flash {
        background: rgba(255, 255, 255, 0.95);
    }
    body.light-mode #ascii-face-flash pre {
        color: #0066cc;
        background: rgba(255, 255, 255, 0.9);
        border-color: #0066cc;
        text-shadow: none;
    }

    </style>`);}
if(params.get("chatpad")==="1"){document.write(`<style>#chat{padding-top:180px!important}
    /* Slash command autocomplete dropdown */
    #slash-dropdown {
        position: absolute;
        bottom: 100%;
        left: 0;
        right: 0;
        background: var(--bg);
        border: 1px solid var(--green);
        border-bottom: none;
        max-height: 200px;
        overflow-y: auto;
        display: none;
        z-index: 1000;
    }
    #slash-dropdown.visible {
        display: block;
    }
    .slash-option {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #333;
        display: flex;
        justify-content: space-between;
    }
    .slash-option:hover, .slash-option.selected {
        background: var(--green);
        color: #000;
    }
    .slash-option .cmd {
        font-weight: bold;
        color: var(--green);
    }
    .slash-option:hover .cmd, .slash-option.selected .cmd {
        color: #000;
    }
    .slash-option .desc {
        color: #888;
        font-size: 0.9em;
    }
    .slash-option:hover .desc, .slash-option.selected .desc {
        color: #333;
    }

/* ASCII Face Flash Animation */
    #ascii-face-flash {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        display: none;
        z-index: 99999;
        display: none;
        background: rgba(0, 0, 0, 0.95);
        pointer-events: none;
    }
    #ascii-face-flash.active {
        display: block;
        animation: ascii-fade 1.5s ease-out forwards;
    }
    #ascii-face-flash pre {
        color: #00ffff;
        font-family: monospace;
        font-size: 7px;
        line-height: 1.0;
        text-align: left;
        white-space: pre;
        margin: 0;
        padding: 20px;
        background: rgba(0, 0, 0, 0.8);
        border: 1px solid #00ff41;
        border-radius: 8px;
        text-shadow: 0 0 5px #00ffff;
    }
    @keyframes ascii-fade {
        0% { opacity: 0; }
        15% { opacity: 1; }
        70% { opacity: 1; }
        100% { opacity: 0.12; }
    }
    /* Light mode ASCII flash */
    body.light-mode #ascii-face-flash {
        background: rgba(255, 255, 255, 0.95);
    }
    body.light-mode #ascii-face-flash pre {
        color: #0066cc;
        background: rgba(255, 255, 255, 0.9);
        border-color: #0066cc;
        text-shadow: none;
    }

    </style>`);}
</script>
    <!-- Silero VAD for speech detection -->
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.19.2/dist/ort.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ricky0123/vad-web@0.0.19/dist/bundle.min.js"></script>

    <!-- Service Worker Registration -->
    <script>
    if ('serviceWorker' in navigator) {
        // Nuke all service workers on load - they cause stale cache
        navigator.serviceWorker.getRegistrations().then(function(regs) {
            regs.forEach(function(r) { r.unregister(); });
        });
    }
    </script>

    <!-- Structured Data (JSON-LD) -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "RHODES",
        "url": "https://rhodesai.org",
        "description": "Rhodes is an autonomous AI system built for truth-seeking and genuine assistance. Direct, capable, honest.",
        "applicationCategory": "Artificial Intelligence",
        "operatingSystem": "Web Browser",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
        },
        "creator": {
            "@type": "Organization",
            "name": "Rhodes Team",
            "url": "https://rhodesai.org"
        },
        "featureList": [
            "Autonomous AI reasoning",
            "Research and analysis",
            "Code assistance",
            "Real-time conversation",
            "File and image processing"
        ]
    }
    </script>
<style>#session-controls-stack{display:none!important;}.session-controls{position:fixed!important;top:-9999px!important;left:-9999px!important;overflow:visible!important;width:0!important;height:0!important;}</style><style>.input-with-attachment .prompt{opacity:1!important;font-size:20px!important;color:var(--green)!important;}</style>
<style>
/* OVERLAY DISABLED
@keyframes overlayFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
#chat-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    z-index: 45;
    pointer-events: none;
    animation: overlayFadeIn 2s ease-in forwards;
}
header {
    position: relative;
    z-index: 50 !important;
}
OVERLAY DISABLED */
#mobile-menu-dropdown.active {
    z-index: 601 !important;
}
#chat, #voice-bar, #input-area, .session-controls {
    position: relative;
    z-index: 1000;
}
</style>
</head>
<body>
    <!-- Preview Panel - Sandboxed side panel for generated content -->
    <div id="preview-overlay" onclick="closePreview()"></div>
    <div id="preview-panel">
        <div id="preview-header">
            <span id="preview-title">Preview</span>
            <button id="preview-close" onclick="closePreview()">‚úï Close</button>
        </div>
        <div id="preview-actions">
            <button onclick="downloadPreview()">‚Üì Download</button>
            <button onclick="openPreviewNewTab()">‚Üó Open in New Tab</button>
            <button onclick="deployPreview()">üöÄ Deploy to Site</button>
        </div>
        <!-- Sandboxed iframe - cannot access parent, no scripts by default -->
        <iframe id="preview-frame" sandbox="allow-scripts" title="Preview"></iframe>
    </div>

    <header>
        <button id="menu-toggle" onclick="toggleMobileMenu()" title="‚ò∞">‚ò∞</button>
        <!-- Single row: nav left, logo center, controls right -->
        <div style="display:flex;align-items:center;width:100%;">
            <!-- Left: CHAT, Language Courses -->
            <nav class="nav" style="flex:1;">
                <a href="#" id="chat-link" class="nav-item active">CHAT</a>
                <a href="/download/" id="downloads-link" style="display:inline-block;border:2px solid #00ff41;padding:5px 14px;border-radius:4px;background:rgba(0,255,65,0.1);color:#00ff41;font-family:Orbitron,sans-serif;font-size:12px;font-weight:700;text-decoration:none;margin-left:15px;letter-spacing:1px;transition:all 0.2s;text-shadow:0 0 8px rgba(0,255,65,0.4);" onmouseover="this.style.background='rgba(0,255,65,0.25)';this.style.boxShadow='0 0 15px rgba(0,255,65,0.3)'" onmouseout="this.style.background='rgba(0,255,65,0.1)';this.style.boxShadow='none'">‚¨á DOWNLOAD</a>
            </nav>
            <!-- Center: Logo -->
            <div style="text-align:center;">
                <div class="logo" id="main-logo" style="margin-top:8px;">RHODES AGI</div>
                <span class="status" id="status" style="font-size:14px;font-weight:600;">CONNECTING...</span>
                <span id="session-id" style="display:none;color:var(--dim);cursor:pointer;margin-left:8px;font-size:10px;" onclick="copySessionId()" title="Click to copy session ID"></span>
                <button id="debug-btn" style="display:none;margin-left:8px;font-size:10px;background:transparent;border:1px solid var(--red);color:var(--red);padding:2px 6px;cursor:pointer;" onclick="toggleDebugPanel()">DEBUG</button>
            </div>
            <!-- Right: LOGIN/Account, theme, ABOUT -->
            <div style="display:flex;align-items:center;gap:10px;flex:1;justify-content:flex-end;flex-wrap:nowrap;white-space:nowrap;">
                <!-- Language Courses moved to account dropdown -->
                <!-- LANGUAGES button (website only, hidden on desktop app) -->
                <!-- LOGIN button (shown when not logged in) -->
                <a href="#" id="header-login-btn" onclick="document.getElementById('auth-modal').style.display='flex';showAuthTab('register');return false;" style="color:var(--cyan);font-size:15px;font-weight:700;text-decoration:none;">SIGN UP</a>
                <!-- Account dropdown (shown when logged in) -->
                <div id="account-dropdown" class="account-dropdown" style="display:none;">
                    <a href="#" id="account-trigger" style="color:var(--cyan);font-size:15px;font-weight:700;text-decoration:none;">
                        <span id="account-username" style="max-width:120px;overflow:hidden;text-overflow:ellipsis;display:inline-block;vertical-align:middle;">ACCOUNT</span> ‚ñæ
                    </a>
                    <div class="account-dropdown-content">
                        <a href="#" id="rooms-dropdown-link" onclick="openRoomsMenu();return false;" class="rooms-in-dropdown">ROOMS</a>
                        <a href="/profile.html">Profile</a>
                        <a href="/preferences.html">Preferences</a>
                        <a href="/projects.html">Projects</a>
                        <div class="account-dropdown-divider"></div>
                        <a href="/upgrade.html">Upgrade Plan</a>
                        <a href="/api.html">API</a>
                        <a href="/donate.html">Donate</a>
                        <div class="account-dropdown-divider"></div>
                        <a href="/admin-control.html" id="admin-link" style="display:none;">Control Panel</a>
                        <a href="#" id="logout-link" onclick="logout(); return false;">Logout</a>
                    </div>
                </div>
                <span id="agent-status" style="display:none;color:var(--green);font-size:12px;padding:3px 8px;border:1px solid var(--green);border-radius:3px;background:rgba(0,255,65,0.1);" title="Desktop agent connected">üñ•Ô∏è</span>
                <a href="#" id="theme-toggle" title="Toggle light/dark mode">‚òÄÔ∏è</a>
                <a href="/about.html" id="about-link">ABOUT</a>
            </div>
        </div>
        <!-- Session controls (positioned via CSS) -->
        <div class="session-controls">
            <button id="new-rhodes-btn" onclick="startNewSession()" style="background:transparent;border:1px solid var(--cyan);color:var(--cyan);padding:4px 10px;cursor:pointer;font-size:12px;border-radius:3px 0 0 3px;border-right:none;">+ New Session</button>
            <div class="session-dropdown">
                <button id="sessions-btn" onclick="toggleSessionDropdown(event)" style="background:transparent;border:1px solid var(--cyan);color:var(--cyan);padding:4px 8px;cursor:pointer;font-size:12px;border-radius:0 3px 3px 0;border-left:none;">‚ñº</button>
            <button id="search-sessions-btn" onclick="toggleSessionSearch(event)" title="Search sessions" style="display:none;background:transparent;border:1px solid var(--green);color:var(--green);padding:4px 8px;cursor:pointer;font-size:12px;border-radius:0 3px 3px 0;border-left:none;">üîç</button>
                <div id="sessions-list" class="sessions-dropdown-content">
                    <div id="session-search-container" style="padding:8px 12px;border-bottom:1px solid var(--border);">
                        <input type="text" id="session-search-input" placeholder="Search sessions (preview, ID, dates, or content)..." oninput="debouncedSearch()" style="width:100%;background:var(--bg);border:1px solid var(--cyan);color:var(--cyan);padding:6px 8px;font-size:12px;outline:none;border-radius:3px;">
                    </div>

                    <div id="sessions-results"></div>
                </div>
            </div>

        </div>
        <div class="system-info" id="system-info" style="display:none;"></div>
        
        <!-- Mobile Menu Dropdown -->
        <div id="mobile-menu-dropdown" class="mobile-menu-dropdown">
            <a href="#" class="mobile-menu-item" onclick="closeMobileMenu()">CHAT</a>
            <a href="#" class="mobile-menu-item" onclick="openRoomsMenu(); closeMobileMenu(); return false;">ROOMS</a>
            <!-- Session controls in mobile menu (hidden for guests) -->
            <a href="#" id="mobile-new-session" class="mobile-menu-item" style="display:none;border-color:var(--green);color:var(--green);" onclick="startNewSession(); closeMobileMenu(); return false;">+ NEW SESSION</a>
            <a href="#" id="mobile-sessions-list" class="mobile-menu-item" style="display:none;border-color:var(--green);color:var(--green);" onclick="toggleSessionDropdown(event); closeMobileMenu(); return false;">SESSIONS</a>
            <!-- Guest: LOGIN link -->
            <a href="#" id="mobile-login-link" class="mobile-menu-item" onclick="showAuth('register'); closeMobileMenu();">SIGN UP</a>
            <!-- Logged in: Account submenu (hidden by default) -->
            <div id="mobile-account-menu" class="mobile-menu-submenu" style="display:none;">
                <a href="#" class="mobile-menu-item" onclick="toggleMobileSubmenu(this); return false;"><span id="mobile-account-username">ACCOUNT</span> ‚ñæ</a>
                <div class="mobile-submenu-items">
                    <a href="/profile.html" class="mobile-submenu-item" onclick="closeMobileMenu()">Profile</a>
                    <a href="/preferences.html" class="mobile-submenu-item" onclick="closeMobileMenu()">Preferences</a>
                    <a href="/projects.html" class="mobile-submenu-item" onclick="closeMobileMenu()">Projects</a>
                    <a href="/upgrade.html" class="mobile-submenu-item" onclick="closeMobileMenu()">Upgrade Plan</a>
                    <a href="/api.html" class="mobile-submenu-item" onclick="closeMobileMenu()">API</a>
                    <a href="/donate.html" class="mobile-submenu-item" onclick="closeMobileMenu()">Donate</a>
                    <a href="/admin-control.html" id="mobile-admin-link" class="mobile-submenu-item" style="display:none;" onclick="closeMobileMenu()">Control Panel</a>
                    <a href="#" class="mobile-submenu-item" onclick="logout(); closeMobileMenu(); return false;">Logout</a>
                </div>
            </div>
            <a href="/donate.html" class="mobile-menu-item" onclick="closeMobileMenu();">DONATE</a>
            <a href="#" class="mobile-menu-item" onclick="toggleTheme(); closeMobileMenu();">THEME</a>
            <a href="/about.html" class="mobile-menu-item" onclick="closeMobileMenu();">ABOUT</a>
            <!-- HIDDEN: <a href="/download/" class="mobile-menu-item" onclick="closeMobileMenu();">RHODES CODE</a> -->
        </div>
    </header>
    <div id="ascii-face-flash"><pre style="text-align:center;">                     ‚£Ä‚£Ä‚£Ä‚£Ä‚£Ä‚£Ä‚£Ä
               ‚£Ä‚£¥‚£æ‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£∑‚£¶‚£Ä
           ‚£Ä‚£¥‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£¶‚£Ä
        ‚£†‚£æ‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£∑‚£Ñ
      ‚£¥‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£¶
    ‚£º‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ß
   ‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø
  ‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚°ü‚°õ‚†â‚†â‚†â‚†â‚†â‚†â‚†â‚†â‚†â‚°õ‚£ª‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø
 ‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚†è    ‚£Ä‚£Ä‚£Ä‚£Ä‚£Ä‚£Ä‚£Ä‚£Ä‚£Ä‚£Ä    ‚†π‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø
 ‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚°ü   ‚£†‚£æ‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£∑‚£Ñ   ‚¢ª‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø
‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚°ü   ‚£º‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ß   ‚¢ª‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø
‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚†Å  ‚¢Ä‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚°Ä  ‚†ò‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø
‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚°á   ‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø   ‚¢∏‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø
‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚°á  ‚£∞‚£ø‚°ü‚†Å ‚†à‚†ô‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚†ã‚†Å ‚†à‚¢ª‚£ø‚°Ü  ‚¢∏‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø
‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚°á  ‚¢∏‚£ø‚°á ‚¨§  ‚¢∏‚£ø‚£ø‚£ø‚£ø‚°á  ‚¨§ ‚¢∏‚£ø‚°á  ‚¢∏‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø
‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚°á  ‚†ò‚£ø‚£∑‚£Ñ ‚£Ä‚£¥‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£¶‚£Ä ‚£†‚£æ‚£ø‚†É  ‚¢∏‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø
‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ß   ‚†ô‚†ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚†ø‚†ã   ‚£º‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø
‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£Ñ    ‚†à‚†â‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚†â‚†Å    ‚£†‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø
 ‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£Ü      ‚¢ª‚£ø‚£ø‚°ø‚°ü‚¢ª‚£ø‚°ü      ‚£∞‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø
 ‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£Ü       ‚†â‚†Å  ‚†à‚†â       ‚£∞‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø
  ‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£Ñ                  ‚£†‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø

               RHODES AGI</pre></div>

    <!-- Multi-Instance Split View -->
    <div id="split-view" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:var(--bg,#0a0a0a);z-index:9998;">
        <div class="split-container">
            <div class="split-instance" data-instance="1">
                <div class="instance-header">
                    <span class="instance-label">Rhodes AGI Œ±</span>
                    <span class="instance-status" data-instance="1">‚óè</span>
                </div>
                <div class="instance-chat" id="split-chat-1"></div>
                <div class="instance-preview" id="instance-1-preview" style="display:none;padding:4px;background:#111;border-bottom:1px solid var(--dim);"></div>
                <div class="instance-input">
                    <input type="file" id="instance-1-file" accept="image/*,video/*,audio/*,.pdf,.txt,.md,.json,.csv,.mp4,.webm,.ogg,.mp3,.wav,.flac,.m4a" multiple style="display:none" onchange="handleInstanceFile(1, this.files)">
                    <button onclick="document.getElementById('instance-1-file').click()" style="padding:4px 8px;background:transparent;border:1px solid var(--cyan);color:var(--cyan);cursor:pointer;" title="Attach file">üìé</button>
                    <input type="text" id="instance-1-input" name="instance-1-input" placeholder="Follow-up..." data-instance="1" onkeypress="if(event.key==='Enter')sendToInstance(1,this.value)">
                    <button onclick="sendToInstance(1, document.getElementById('instance-1-input').value)" style="background:var(--green);color:#000;border:none;padding:4px 10px;cursor:pointer;font-weight:bold;">‚Üí</button>
                </div>
            </div>
            <div class="split-instance" data-instance="2">
                <div class="instance-header">
                    <span class="instance-label">Rhodes AGI Œ≤</span>
                    <span class="instance-status" data-instance="2">‚óè</span>
                </div>
                <div class="instance-chat" id="split-chat-2"></div>
                <div class="instance-preview" id="instance-2-preview" style="display:none;padding:4px;background:#111;border-bottom:1px solid var(--dim);"></div>
                <div class="instance-input">
                    <input type="file" id="instance-2-file" accept="image/*,video/*,audio/*,.pdf,.txt,.md,.json,.csv,.mp4,.webm,.ogg,.mp3,.wav,.flac,.m4a" multiple style="display:none" onchange="handleInstanceFile(2, this.files)">
                    <button onclick="document.getElementById('instance-2-file').click()" style="padding:4px 8px;background:transparent;border:1px solid var(--cyan);color:var(--cyan);cursor:pointer;" title="Attach file">üìé</button>
                    <input type="text" id="instance-2-input" name="instance-2-input" placeholder="Follow-up..." data-instance="2" onkeypress="if(event.key==='Enter')sendToInstance(2,this.value)">
                    <button onclick="sendToInstance(2, document.getElementById('instance-2-input').value)" style="background:var(--green);color:#000;border:none;padding:4px 10px;cursor:pointer;font-weight:bold;">‚Üí</button>
                </div>
            </div>
            <div class="split-instance" data-instance="3">
                <div class="instance-header">
                    <span class="instance-label">Rhodes AGI Œ≥</span>
                    <span class="instance-status" data-instance="3">‚óè</span>
                </div>
                <div class="instance-chat" id="split-chat-3"></div>
                <div class="instance-preview" id="instance-3-preview" style="display:none;padding:4px;background:#111;border-bottom:1px solid var(--dim);"></div>
                <div class="instance-input">
                    <input type="file" id="instance-3-file" accept="image/*,video/*,audio/*,.pdf,.txt,.md,.json,.csv,.mp4,.webm,.ogg,.mp3,.wav,.flac,.m4a" multiple style="display:none" onchange="handleInstanceFile(3, this.files)">
                    <button onclick="document.getElementById('instance-3-file').click()" style="padding:4px 8px;background:transparent;border:1px solid var(--cyan);color:var(--cyan);cursor:pointer;" title="Attach file">üìé</button>
                    <input type="text" id="instance-3-input" name="instance-3-input" placeholder="Follow-up..." data-instance="3" onkeypress="if(event.key==='Enter')sendToInstance(3,this.value)">
                    <button onclick="sendToInstance(3, document.getElementById('instance-3-input').value)" style="background:var(--green);color:#000;border:none;padding:4px 10px;cursor:pointer;font-weight:bold;">‚Üí</button>
                </div>
            </div>
            <div class="split-instance" data-instance="4">
                <div class="instance-header">
                    <span class="instance-label">Rhodes AGI Œ¥</span>
                    <span class="instance-status" data-instance="4">‚óè</span>
                </div>
                <div class="instance-chat" id="split-chat-4"></div>
                <div class="instance-preview" id="instance-4-preview" style="display:none;padding:4px;background:#111;border-bottom:1px solid var(--dim);"></div>
                <div class="instance-input">
                    <input type="file" id="instance-4-file" accept="image/*,video/*,audio/*,.pdf,.txt,.md,.json,.csv,.mp4,.webm,.ogg,.mp3,.wav,.flac,.m4a" multiple style="display:none" onchange="handleInstanceFile(4, this.files)">
                    <button onclick="document.getElementById('instance-4-file').click()" style="padding:4px 8px;background:transparent;border:1px solid var(--cyan);color:var(--cyan);cursor:pointer;" title="Attach file">üìé</button>
                    <input type="text" id="instance-4-input" name="instance-4-input" placeholder="Follow-up..." data-instance="4" onkeypress="if(event.key==='Enter')sendToInstance(4,this.value)">
                    <button onclick="sendToInstance(4, document.getElementById('instance-4-input').value)" style="background:var(--green);color:#000;border:none;padding:4px 10px;cursor:pointer;font-weight:bold;">‚Üí</button>
                </div>
            </div>
        </div>
        <!-- Send to All section -->
        <div id="split-send-all" style="display:flex;align-items:center;gap:10px;padding:10px 20px;border-top:1px solid var(--border);background:rgba(0,0,0,0.3);">
            <span style="color:var(--cyan);font-size:12px;font-weight:bold;">SEND TO ALL:</span>
            <input type="text" id="send-all-input" placeholder="Message all instances..." style="flex:1;background:var(--bg);border:1px solid var(--green);color:var(--text);padding:8px;font-family:monospace;" onkeypress="if(event.key==='Enter')sendToAllInstances(this.value)">
            <button onclick="sendToAllInstances(document.getElementById('send-all-input').value)" style="background:var(--green);color:#000;border:none;padding:8px 15px;cursor:pointer;font-weight:bold;">‚Üí ALL</button>
        </div>
    </div>


    <!-- OVERLAY DISABLED
    <div id="chat-overlay"></div>
    <button id="overlay-close-btn" onclick="document.getElementById('chat-overlay').style.display='none';this.style.display='none';" style="display:none;position:fixed;top:95px;right:15px;z-index:100;background:rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.3);color:rgba(255,255,255,0.5);width:28px;height:28px;border-radius:50%;cursor:pointer;font-size:14px;align-items:center;justify-content:center;" title="Exit overlay">‚úï</button>
    OVERLAY DISABLED -->
    <div id="chat"></div>

    <div id="voice-bar">
        <button id="voice-mode-btn" title="Toggle hands-free mode" onclick="if(typeof VoiceChat!=='undefined')VoiceChat.toggleMode()">üé§ VOICE</button>
        <div style="position:relative;display:flex;">
            <button id="split-view-btn" onclick="toggleSplitModeDropdown()" title="Split mode">‚äû SPLIT ‚ñ≤</button>
            <div id="split-mode-options" style="display:none;position:absolute;bottom:100%;left:0;background:var(--bg);border:1px solid var(--border);border-radius:3px;min-width:140px;z-index:1000;margin-bottom:5px;">
                <div onclick="enterSplitFromDropdown(2)" style="padding:8px 12px;cursor:pointer;color:var(--text);" onmouseover="this.style.background='rgba(0,255,65,0.1)'" onmouseout="this.style.background='none'">2 Panes</div>
                <div onclick="enterSplitFromDropdown(3)" style="padding:8px 12px;cursor:pointer;color:var(--text);" onmouseover="this.style.background='rgba(0,255,65,0.1)'" onmouseout="this.style.background='none'">3 Panes</div>
                <div onclick="enterSplitFromDropdown(4)" style="padding:8px 12px;cursor:pointer;color:var(--text);" onmouseover="this.style.background='rgba(0,255,65,0.1)'" onmouseout="this.style.background='none'">4 Panes</div>
            </div>
        </div>
    </div>
    <div id="input-area">
        <div style="text-align:center;margin:0 0 1px 0;display:flex;justify-content:center;"><button onclick="startNewSession()" style="background:transparent;border:1px solid var(--cyan);color:var(--cyan);padding:4px 10px;border-radius:3px 0 0 3px;cursor:pointer;font-size:12px;font-weight:700;display:inline-flex;align-items:center;gap:4px;border-right:none;" title="New Session"><span style="font-size:16px;font-weight:900;line-height:0;">+</span><span>NEW</span></button><button id="sessions-up-btn" onclick="window._openSessionsPanel()" style="background:transparent;border:1px solid var(--cyan);color:var(--cyan);padding:4px 8px;border-radius:0 3px 3px 0;cursor:pointer;font-size:12px;border-left:none;" title="Browse sessions">&#9652;</button></div>
        <div class="input-group">
            <div class="input-with-attachment" style="position:relative;">
                <span class="prompt" aria-hidden="true">&gt;</span>
                <input type="text" id="input" placeholder="enter message..." autocomplete="off">
                <button type="button" id="attach-btn" onclick="document.getElementById('image-input').click()" title="Attach files">üìé</button>
                <button type="button" id="send-inline" onclick="send()" title="Send message">‚û§</button>
            </div>
            <!-- ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è DO NOT REMOVE onclick="send()" - REQUIRED FOR MOBILE COMPATIBILITY ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è -->
            <button id="send" type="button" onclick="send()">SEND</button>
        </div>
        <select id="lang-select" style="display:none;">
            <option value="en-US">EN</option>
            <option value="en-GB">EN-UK</option>
            <option value="es-ES">ES</option>
            <option value="fr-FR">FR</option>
            <option value="de-DE">DE</option>
            <option value="it-IT">IT</option>
            <option value="pt-BR">PT</option>
            <option value="ru-RU">RU</option>
            <option value="ja-JP">JA</option>
            <option value="zh-CN">ZH</option>
            <option value="ko-KR">KO</option>
            <option value="ar-SA">AR</option>
            <option value="hi-IN">HI</option>
            <option value="nl-NL">NL</option>
            <option value="pl-PL">PL</option>
            <option value="sv-SE">SV</option>
        </select>
        <input type="file" id="image-input" accept="image/*,video/*,audio/*,.pdf,.txt,.md,.json,.csv,.xml,.html,.css,.js,.py,.java,.c,.cpp,.h,.yml,.yaml,.log,.doc,.docx,.odt,.odf,.rtf,.mp4,.webm,.ogg,.mp3,.wav,.flac,.m4a,.aac,.mov,.avi,.mkv" multiple style="display:none;">
    </div>
    <div id="image-preview" style="display:none;padding:8px 15px;background:#0a0a0a;border-top:1px solid rgba(0,255,213,0.2);"></div>

    <div id="voice-indicator">LISTENING...</div>
    <div id="speaking-face"></div>
    <div id="handsfree-takeover" style="display:none;">
        <div id="takeover-return" onclick="VoiceChat.toggleMode()">‚Äπ Return to text mode</div>
        <div id="takeover-status">LISTENING</div>
        <div id="takeover-face"></div>
        <div class="takeover-transcript" id="takeover-transcript"></div>
        <div class="exit-hint" onclick="VoiceChat.toggleMode()">EXIT VOICE</div>
    </div>
    <audio id="tts-audio" style="display:none;"></audio>
    <!-- ASCII Face Flash -->
    

    <!-- Webcam Modal -->
    <div id="webcam-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.95);z-index:10000;flex-direction:column;justify-content:center;align-items:center;">
        <div style="color:var(--cyan);font-family:'Orbitron',monospace;font-size:18px;margin-bottom:20px;">üì∏ WEBCAM CAPTURE</div>
        <video id="webcam-video" autoplay playsinline style="max-width:80vw;max-height:60vh;border:2px solid var(--cyan);border-radius:8px;transform:scaleX(-1);"></video>
        <canvas id="webcam-canvas" style="display:none;"></canvas>
        <div style="margin-top:20px;display:flex;gap:15px;">
            <button id="webcam-capture" style="background:var(--magenta);border:none;color:#fff;padding:12px 24px;font-family:'Orbitron',monospace;cursor:pointer;border-radius:4px;">üì∑ CAPTURE</button>
            <button id="webcam-cancel" style="background:transparent;border:1px solid var(--dim);color:var(--dim);padding:12px 24px;font-family:'Orbitron',monospace;cursor:pointer;border-radius:4px;">‚úï CANCEL</button>
        </div>
        <div style="color:var(--dim);font-size:12px;margin-top:15px;">Rhodes can draw your portrait from this photo</div>
    </div>

    <!-- Auth Modal - Guest/Register/Login -->
    <div class="modal" id="auth-modal" style="display:none;">
        <div class="modal-box" style="width: 420px; max-width: calc(100% - 32px); min-width: 300px;">
            <h2>// ACCESS RHODES</h2>

            <!-- Tab buttons -->
            <div id="auth-tabs" style="display:flex;gap:10px;margin-bottom:20px;">
                <button class="auth-tab" data-tab="login" style="flex:1;padding:10px;background:transparent;border:1px solid var(--dim);color:var(--dim);cursor:pointer;font-family:inherit;">LOGIN</button>
                <button class="auth-tab" data-tab="reset" style="flex:1;padding:10px;background:transparent;border:1px solid var(--dim);color:var(--dim);cursor:pointer;font-family:inherit;">RESET</button>
                <button class="auth-tab active" data-tab="register" style="flex:1;padding:10px;background:transparent;border:1px solid var(--green);color:var(--green);cursor:pointer;font-family:inherit;">SIGN UP</button>
                <button class="auth-tab" data-tab="token" style="flex:1;padding:10px;background:transparent;border:1px solid var(--dim);color:var(--dim);cursor:pointer;font-family:inherit;">TOKEN</button>
            </div>



            <!-- Login tab -->
            <div id="tab-login" class="auth-tab-content" style="display:none;">
                <form id="login-form" onsubmit="event.preventDefault(); document.getElementById('login-btn').click(); return false;">
                <input type="text" id="login-username" placeholder="Username or email" autocomplete="username" autocapitalize="none" autocorrect="off" spellcheck="false" style="width:100%;margin-bottom:10px;">
                <input type="password" id="login-password" placeholder="Password" autocomplete="current-password" autocapitalize="none" autocorrect="off" spellcheck="false" style="width:100%;margin-bottom:10px;">
                <button id="login-btn" type="submit" style="width:100%;padding:12px;background:transparent;border:1px solid var(--green);color:var(--green);font-family:'Orbitron',monospace;cursor:pointer;">LOGIN</button>
                </form>
                <div style="margin-top:10px;text-align:center;">
                    <a href="#" onclick="showAuthTab('reset');return false;" style="color:var(--cyan);text-decoration:underline;font-size:12px;">Forgot password?</a>
                </div>
                <div style="margin:15px 0;text-align:center;color:var(--dim);">- or -</div>
                <button id="google-signin-btn" onclick="signInWithGoogle()" style="width:100%;padding:12px;background:#4285f4;border:none;color:white;font-family:'Orbitron',monospace;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;">
                    <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#FFF" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#FFF" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FFF" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#FFF" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
                    Sign in with Google
                </button>
                <div id="login-error" style="color:var(--magenta);margin-top:10px;display:none;"></div>
            </div>

            <!-- Reset tab -->
            <div id="tab-reset" class="auth-tab-content" style="display:none;">
                <div style="color:var(--cyan);margin-bottom:10px;font-size:13px;">Reset your password via email token.</div>
                <div style="color:var(--dim);margin-bottom:15px;font-size:12px;">Step 1: request a reset link. Step 2: paste the token from the link/email and set a new password.</div>

                <div style="padding:12px;border:1px solid rgba(0,255,213,0.2);border-radius:6px;margin-bottom:12px;">
                    <div style="color:var(--green);font-size:12px;margin-bottom:8px;">REQUEST RESET</div>
                    <form id="reset-request-form" onsubmit="event.preventDefault(); document.getElementById('reset-request-btn').click(); return false;">
                        <input type="email" id="reset-email" placeholder="Email address" style="width:100%;margin-bottom:10px;">
                        <button id="reset-request-btn" type="submit" style="width:100%;padding:12px;background:transparent;border:1px solid var(--green);color:var(--green);font-family:'Orbitron',monospace;cursor:pointer;">SEND RESET LINK</button>
                    </form>
                </div>

                <div style="padding:12px;border:1px solid rgba(255,0,255,0.2);border-radius:6px;">
                    <div style="color:var(--magenta);font-size:12px;margin-bottom:8px;">SET NEW PASSWORD</div>
                    <form id="reset-complete-form" onsubmit="event.preventDefault(); document.getElementById('reset-complete-btn').click(); return false;">
                        <input type="text" id="reset-token" placeholder="Reset token (from email link)" autocomplete="one-time-code" autocapitalize="none" autocorrect="off" spellcheck="false" style="width:100%;margin-bottom:10px;">
                        <input type="password" id="reset-new-password" placeholder="New password (8+ chars)" autocomplete="new-password" autocapitalize="none" autocorrect="off" spellcheck="false" style="width:100%;margin-bottom:10px;">
                        <input type="password" id="reset-new-password2" placeholder="Confirm new password" autocomplete="new-password" autocapitalize="none" autocorrect="off" spellcheck="false" style="width:100%;margin-bottom:10px;">
                        <button id="reset-complete-btn" type="submit" style="width:100%;padding:12px;background:transparent;border:1px solid var(--magenta);color:var(--magenta);font-family:'Orbitron',monospace;cursor:pointer;">SET NEW PASSWORD</button>
                    </form>
                </div>

                <div id="reset-info" style="color:var(--cyan);margin-top:10px;display:none;"></div>
                <div id="reset-error" style="color:#ff4141;margin-top:10px;display:none;"></div>
            </div>

            <!-- Register tab -->
            <div id="tab-register" class="auth-tab-content">
                <form id="register-form" onsubmit="event.preventDefault(); document.getElementById('register-btn').click(); return false;">
                <input type="text" id="reg-username" placeholder="Username (3+ chars)" autocomplete="username" autocapitalize="none" autocorrect="off" spellcheck="false" style="width:100%;margin-bottom:10px;">
                <input type="email" id="reg-email" placeholder="Email address (optional)" autocomplete="email" autocapitalize="none" autocorrect="off" spellcheck="false" style="width:100%;margin-bottom:10px;">
                <input type="password" id="reg-password" placeholder="Password (6+ chars)" autocomplete="new-password" autocapitalize="none" autocorrect="off" spellcheck="false" style="width:100%;margin-bottom:10px;">
                <button id="register-btn" type="submit" style="width:100%;padding:12px;background:transparent;border:1px solid var(--green);color:var(--green);font-family:'Orbitron',monospace;cursor:pointer;">CREATE ACCOUNT</button>
                </form>
                <div id="reg-error" style="color:var(--magenta);margin-top:10px;display:none;"></div>
                <div style="margin:15px 0;text-align:center;color:rgba(255,255,255,0.3);">- or -</div>
                <button onclick="signInWithGoogle()" style="width:100%;padding:12px;background:#4285f4;border:none;color:white;font-family:'Orbitron',monospace;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;border-radius:4px;">
                    <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#FFF" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#FFF" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FFF" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#FFF" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
                    Sign up with Google
                </button>
            </div>

            <!-- Token tab (legacy) -->
            <div id="tab-token" class="auth-tab-content" style="display:none;">
                <input type="text" id="server-input" placeholder="Server URL (wss://rhodesagi.com/ws)" autocapitalize="none" autocorrect="off" spellcheck="false" style="width:100%;margin-bottom:10px;">
                <input type="password" id="token-input" placeholder="Access token" autocomplete="off" autocapitalize="none" autocorrect="off" spellcheck="false" style="width:100%;margin-bottom:10px;">
                <button id="connect-btn" style="width:100%;padding:12px;background:transparent;border:1px solid var(--green);color:var(--green);font-family:'Orbitron',monospace;cursor:pointer;">CONNECT</button>
            </div>
        </div>
    </div>

    <!-- Guest limit modal -->
    <div class="modal" id="limit-modal" style="display:none;">
        <div class="modal-box">
            <h2>// GUEST LIMIT REACHED</h2>
            <p style="color:var(--cyan);margin-bottom:15px;">You've used your 14 free guest messages. Sign in to continue.</p>
            <button onclick="signInWithGoogle(); document.getElementById('limit-modal').style.display='none';" style="width:100%;padding:14px;background:#4285f4;border:none;color:white;font-family:'Orbitron',monospace;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:10px;font-size:14px;">
                <svg width="18" height="18" viewBox="0 0 24 24"><path fill="white" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="white" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="white" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="white" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                SIGN IN WITH GOOGLE
            </button>
            <button id="limit-login-btn" style="width:100%;padding:12px;background:transparent;border:1px solid var(--cyan);color:var(--cyan);font-family:'Orbitron',monospace;cursor:pointer;margin-bottom:10px;">LOGIN</button>
            <button id="limit-register-btn" style="width:100%;padding:12px;background:transparent;border:1px solid var(--green);color:var(--green);font-family:'Orbitron',monospace;cursor:pointer;">SIGN UP</button>
        </div>
    </div>

    <!-- Downloads Panel -->
        <div id="about-panel">
        <div class="panel-content">
            <div class="panel-header">
                <div class="panel-title">ABOUT</div>
                <button class="close-btn" onclick="closeAbout()">‚úï</button>
            </div>
            <div style="color:var(--text);line-height:1.6;font-size:14px;">
                <p style="color:var(--cyan);">RHODES is a persistent, session-based chat system with WebSocket streaming and tooling.</p>
                <p style=\"color:var(--dim);\">Guest sessions are rate-limited. Accounts enable persistent sessions and saved history.</p>
                <p style=\"color:var(--dim);\">Privacy: transcripts are stored server-side for your account.</p>
            </div>
        </div>
    </div>

<div id="downloads-panel" style="display:none !important;">
        <div class="panel-content">
            <div class="panel-header">
                <div class="panel-title" style="display:none;">// NATIVE CLIENTS</div>
                <button class="close-btn" id="close-downloads">[X] CLOSE</button>
            </div>
            <div class="dl-grid" id="dl-grid" style="display:none;">
                <a href="/download/rhodes-code-2.0.0-x64.AppImage" download class="dl-item" data-os="linux" onclick="setTimeout(()=>showToast('Download started! Open Downloads/rhodes-code-2.0.0-x64.AppImage'),500)">
                    <div><div class="name">> LINUX</div><div class="desc">AppImage (100MB, just run - chmod +x first)</div></div>
                    <div class="icon">[‚Üì]</div>
                </a>
                <a href="/download/rhodes-code-2.0.0-mac-arm64.zip" download class="dl-item" data-os="macos" onclick="setTimeout(()=>showToast('Extract zip, right-click RHODES.command > Open > Open'),500)">
                    <div><div class="name">> MACOS</div><div class="desc">Native binary (20MB, extract and run)</div></div>
                    <div class="icon">[‚Üì]</div>
                </a>
                <a href="/download/rhodes-desktop.py" download class="dl-item" data-os="any" onclick="setTimeout(()=>showToast('Download started! Open Downloads/rhodes-desktop.py'),500)">
                    <div><div class="name">> PYTHON</div><div class="desc">Cross-platform script (any OS with Python)</div></div>
                    <div class="icon">[‚Üì]</div>
                </a>
            </div>
            <div class="panel-title" style="margin-top: 20px;">// DESKTOP AGENT (v1.3.0)</div>
            <div class="dl-grid">
                <a href="/download/rhodes-mac.py" download class="dl-item" data-os="macos" onclick="setTimeout(()=>showToast('Download started! Open Downloads/rhodes-mac.py'),500)">
                    <div><div class="name">> MACOS</div><div class="desc">Python agent with computer use</div></div>
                    <div class="icon">[‚Üì]</div>
                </a>
            </div>
            <div style="margin-top:15px;padding:12px;background:rgba(0,255,65,0.05);border:1px solid var(--green);border-radius:3px;font-family:monospace;font-size:12px;overflow-x:auto;max-width:100%;word-break:break-all;">
                <div class="cmd-box" style="margin-bottom:12px;">
                    <div style="color:var(--green);font-size:13px;font-weight:bold;margin-bottom:6px;display:flex;align-items:center;gap:8px;">
                        <span style="font-size:16px;">&#x1F427;</span> LINUX
                    </div>
                    <div class="cmd-row" onclick="copyCmd(this)" style="padding:10px;cursor:pointer;border-radius:3px;background:rgba(0,0,0,0.3);display:flex;align-items:center;gap:10px;" onmouseover="this.style.background='rgba(0,255,65,0.1)'" onmouseout="this.style.background='rgba(0,0,0,0.3)'">
                        <code id="linux-curl-cmd" style="color:var(--text);flex:1;word-break:break-all;font-size:11px;">curl -sL https://rhodesagi.com/install | bash</code>
                        <span class="copy-hint" style="color:var(--green);font-size:11px;white-space:nowrap;">[COPY]</span>
                    </div>
                </div>
                <div class="cmd-box" style="margin-bottom:12px;">
                    <div style="color:var(--green);font-size:13px;font-weight:bold;margin-bottom:6px;display:flex;align-items:center;gap:8px;">
                        <span style="font-size:16px;">&#x1F34E;</span> MAC
                    </div>
                    <div class="cmd-row" onclick="copyCmd(this)" style="padding:10px;cursor:pointer;border-radius:3px;background:rgba(0,0,0,0.3);display:flex;align-items:center;gap:10px;" onmouseover="this.style.background='rgba(0,255,65,0.1)'" onmouseout="this.style.background='rgba(0,0,0,0.3)'">
                        <code id="mac-curl-cmd" style="color:var(--text);flex:1;word-break:break-all;font-size:11px;">curl -sL https://rhodesagi.com/install-mac | bash</code>
                        <span class="copy-hint" style="color:var(--green);font-size:11px;white-space:nowrap;">[COPY]</span>
                    </div>
                </div>
                <div class="cmd-box">
                    <div style="color:var(--green);font-size:13px;font-weight:bold;margin-bottom:6px;display:flex;align-items:center;gap:8px;">
                        <span style="font-size:16px;">&#x1FA9F;</span> WINDOWS
                    </div>
                    <div class="cmd-row" onclick="copyCmd(this)" style="padding:10px;cursor:pointer;border-radius:3px;background:rgba(0,0,0,0.3);display:flex;align-items:center;gap:10px;" onmouseover="this.style.background='rgba(0,255,65,0.1)'" onmouseout="this.style.background='rgba(0,0,0,0.3)'">
                        <code id="win-curl-cmd" style="color:var(--text);flex:1;word-break:break-all;font-size:11px;">irm rhodesagi.com/install-win | iex</code>
                        <span class="copy-hint" style="color:var(--green);font-size:11px;white-space:nowrap;">[COPY]</span>
                    </div>
                </div>
                <div id="login-for-token" style="margin-top:8px;color:var(--yellow);font-size:11px;display:none;">Login to get one-click setup with your token</div>
            </div>
            <!-- Token commands handled by rhodes.js -->
            
            <div class="panel-title" style="margin-top: 20px;">// MOBILE</div>
            <div class="dl-grid">
                <a href="/rck.apk" download class="dl-item" data-os="android">
                    <div><div class="name">> ANDROID</div><div class="desc">APK (64MB, Python included, Google Sign-in)</div></div>
                    <div class="icon">[‚Üì]</div>
                </a>
                <a href="#" id="pwa-install-btn" class="dl-item" data-os="ios" onclick="alert('iOS app coming soon! For now, add to home screen from Safari.'); return false;">
                    <div><div class="name">> iOS</div><div class="desc">Coming soon (use Safari Add to Home)</div></div>
                    <div class="icon">[+]</div>
                </a>
            </div>
        </div>
    </div>

    <!-- Courses Panel -->

    <script src="/credentials-popup.js"></script>
    <script src="/rhodes-tools.js?v=20260212-01"></script>
    <script src="/rhodes-sessions.js?v=20260220-17"></script>
    <script src="/rhodes-auth.js?v=20260220-17"></script>
    <script src="/rhodes-share.js?v=20260212-03"></script>
    <script src="/rhodes-ws.js?v=20260212-04"></script>
    <script src="/rhodes-media.js?v=20260212-07"></script>
    <script src="/rhodes-send.js?v=20260212-05"></script>
    <script src="/rhodes-voice.js?v=20260214-04"></script>
    <script src="/face-api.min.js"></script>
    <script src="/rhodes-valence.js?v=20260213-01"></script>
    <script src="/rhodes.js?v=20260220-18"></script>
    <script src="/rhodes-split.js?v=20260218-02"></script>

    <!-- PWA Service Worker & Install -->
    <script>
        let deferredPrompt = null;

        if ('serviceWorker' in navigator) {
            // Nuke all service workers - no re-registration
            navigator.serviceWorker.getRegistrations().then(regs => {
                regs.forEach(r => r.unregister());
            });
        }

        // Capture install prompt for Android/Chrome
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
        });

        // Handle install button click
        document.addEventListener('DOMContentLoaded', () => {
            const btn = document.getElementById('pwa-install-btn');
            if (!btn) return;

            btn.addEventListener('click', async (e) => {
                e.preventDefault();

                // Android/Chrome - use native prompt
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    deferredPrompt = null;
                    if (outcome === 'accepted') {
                        btn.querySelector('.desc').textContent = 'Installed!';
                    }
                    return;
                }

                // iOS Safari - show instructions
                const isIOS = /iPhone|iPad|iPod/.test(navigator.userAgent);
                const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);

                if (isIOS) {
                    alert('To install RHODES:\\n\\n1. Tap the Share button (box with arrow)\\n2. Scroll down and tap "Add to Home Screen"\\n3. Tap "Add"');
                } else if (window.matchMedia('(display-mode: standalone)').matches) {
                    alert('RHODES is already installed!');
                } else {
                    alert('To install: Use your browser menu to "Add to Home Screen" or "Install App"');
                }
            });
         });
     </script>
     
     <!-- Debug Panel -->
     <div id="debug-panel" style="display:none; position:fixed; bottom:10px; left:10px; width:400px; max-height:300px; background:var(--panel); border:2px solid var(--red); color:var(--cyan); font-family:monospace; font-size:11px; z-index:9999; overflow-y:auto; padding:10px; border-radius:5px;">
         <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
             <strong>DEBUG LOGS</strong>
             <button onclick="document.getElementById('debug-panel').style.display='none'" style="background:transparent; border:none; color:var(--red); cursor:pointer;">‚úï</button>
         </div>
         <div id="debug-log" style="max-height:250px; overflow-y:auto;"></div>
     </div>
     
     <script>
         // Debug logging to panel
         window.debugLog = function(message, type = 'info') {
             const panel = document.getElementById('debug-panel');
             const logDiv = document.getElementById('debug-log');
             if (!logDiv) return;
             
             const entry = document.createElement('div');
             entry.style.cssText = 'margin:2px 0; padding:4px; border-left:3px solid ' + 
                 (type === 'error' ? 'var(--red)' : type === 'warn' ? 'var(--yellow)' : 'var(--cyan)') + ';';
             entry.textContent = new Date().toLocaleTimeString() + ' ' + message;
             logDiv.appendChild(entry);
             logDiv.scrollTop = logDiv.scrollHeight;
             
             // Auto-show panel on errors - DISABLED for better UX
             // if (type === 'error' && panel.style.display === 'none') {
             //     panel.style.display = 'block';
             // }
         };
         
         // Replace Google sign-in with OAuth flow in desktop mode
         if (window.__RHODES_DESKTOP_MODE__) {
             document.addEventListener("DOMContentLoaded", function() {
                 const googleBtns = document.querySelectorAll("[onclick*=signInWithGoogle]");
                 googleBtns.forEach(btn => {
                     // Replace onclick to start OAuth flow
                     btn.onclick = function(e) {
                         e.preventDefault();
                         // Use pywebview OAuth flow (auto-saves token) or fallback to browser
                         if (window.pywebview && window.pywebview.api && window.pywebview.api.start_oauth_flow) {
                             window.pywebview.api.start_oauth_flow().then(result => {
                                 if (result.success) {
                                     const msg = document.createElement("div");
                                     msg.style.cssText = "color:var(--cyan);font-size:12px;text-align:center;padding:10px;";
                                     msg.innerHTML = "Browser opened! Login will complete automatically. <br><small style=\"color:var(--dim);\">Backup: Copy token from browser and paste in TOKEN tab.</small>";
                                     btn.parentNode.insertBefore(msg, btn.nextSibling);
                                 }
                             });
                         } else if (window.pywebview && window.pywebview.api && window.pywebview.api.open_url) {
                             window.pywebview.api.open_url("https://rhodesagi.com/desktop-auth.html");
                         } else {
                             window.open("https://rhodesagi.com/desktop-auth.html", "_blank");
                         }
                     };
                     btn.innerHTML = btn.innerHTML.replace("Sign in with Google", "Sign in with Google (opens browser)");
                 });
             });
         }
         
         // Override console.log to also log to debug panel
         const originalConsoleLog = console.log;
         const originalConsoleError = console.error;
         const originalConsoleWarn = console.warn;
         
         console.log = function(...args) {
             originalConsoleLog.apply(console, args);
             window.debugLog(args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' '), 'info');
         };
         console.error = function(...args) {
             originalConsoleError.apply(console, args);
             window.debugLog(args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' '), 'error');
         };
         console.warn = function(...args) {
             originalConsoleWarn.apply(console, args);
             window.debugLog(args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' '), 'warn');
         };
         
         // Log initialization
         window.debugLog('Debug panel initialized', 'info');
     </script>

    <!-- Download commands handler -->
    <script>
    function copyCmd(row) {
        var code = row.querySelector("code");
        if (code) {
            navigator.clipboard.writeText(code.textContent).then(function() {
                var hint = row.querySelector(".copy-hint");
                if (hint) {
                    hint.textContent = "[COPIED!]";
                    setTimeout(function() { hint.textContent = "[COPY]"; }, 1500);
                }
            });
        }
    }
    (function() {
        function updateCommands() {
            var token = null;
            try {
                if (typeof localStorage !== 'undefined' && localStorage !== null && localStorage.getItem) {
                    token = localStorage.getItem("rhodes_user_token");
                }
            } catch(e) {
                token = null;
            }
            var linux = document.getElementById("linux-curl-cmd");
            var mac = document.getElementById("mac-curl-cmd");
            var win = document.getElementById("win-curl-cmd");
            var msg = document.getElementById("login-for-token");
            if (token && linux && mac && win) {
                linux.textContent = "RHODES_TOKEN=" + token + " bash -c \"$(curl -sL https://rhodesagi.com/install)\"";
                mac.textContent = "RHODES_TOKEN=" + token + " bash -c \"$(curl -sL https://rhodesagi.com/install-mac)\"";
                win.textContent = "$env:RHODES_TOKEN='" + token + "'; irm rhodesagi.com/install-win | iex";
                if (msg) { msg.style.display = "block"; msg.style.color = "#00ff41"; msg.textContent = "[OK] Token included - just copy and run!"; }
            } else if (msg) {
                msg.style.display = "block";
            }
        }
        window.addEventListener("load", updateCommands);
        var i = 0, t = setInterval(function() { updateCommands(); if (++i >= 15) clearInterval(t); }, 2000);
    })();
    </script>

    <!-- Desktop Client Modifications -->
    <script>
    (function() {
        // Detect if running in desktop client (localhost)
        const isDesktop = (window.rhodes && window.rhodes.isDesktop) || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

        if (isDesktop) {
            // === HIDE ALL LANGUAGE COURSES UI ===
            // 1. Hide the LANGUAGE COURSES header link + dropdown
            const langLink = document.getElementById('languages-link');
            if (langLink) langLink.style.display = 'none';
            const langDrop = document.getElementById('languages-dropdown');
            if (langDrop) langDrop.style.display = 'none';

            // 2. Hide Language Courses section in account dropdown
            document.querySelectorAll('.account-dropdown-content div, .account-dropdown-content a').forEach(el => {
                if (el.textContent.includes('Language Courses') ||
                    (el.getAttribute('href') && el.getAttribute('href').match(/rhodes-(french|german|spanish|italian|russian)/))) {
                    el.style.display = 'none';
                }
            });
            // Hide the divider before Language Courses in account dropdown
            var dividers = document.querySelectorAll('.account-dropdown-divider');
            if (dividers.length > 0) dividers[0].style.display = 'none';

            // 3. Hide Language Courses submenu in mobile menu
            document.querySelectorAll('.mobile-menu-submenu').forEach(sub => {
                var firstLink = sub.querySelector('a');
                if (firstLink && firstLink.textContent.includes('Language Courses')) {
                    sub.style.display = 'none';
                }
            });

            // 4. Hide the COURSES link at bottom of mobile menu
            document.querySelectorAll('.mobile-menu-item').forEach(item => {
                if (item.textContent.trim() === 'COURSES') {
                    item.style.display = 'none';
                }
            });

            // 5. Hide the courses panel itself
            const coursesPanel = document.getElementById('courses-panel');
            if (coursesPanel) coursesPanel.style.display = 'none';

            console.log('[Desktop] Modifications applied: Downloads hidden, language courses hidden');
            // Rename CHAT to Terminal in desktop mode
            const chatLink = document.getElementById('chat-link');
            if (chatLink) chatLink.textContent = 'Terminal';
            console.log('[Desktop] Applying desktop-specific modifications');

            // Change logo to Rhodes_Code for desktop app
            const logo = document.getElementById('main-logo');
            if (logo) logo.textContent = 'Rhodes_Code';

            // Hide DOWNLOADS link and panel (user already has the app)
            const downloadsLink = document.getElementById('downloads-link');
            if (downloadsLink) {
                downloadsLink.style.display = 'none';
            }

            // Hide mobile downloads link too
            document.querySelectorAll('.mobile-menu-item').forEach(item => {
                if (item.textContent.includes('DOWNLOADS')) {
                    item.style.display = 'none';
                }
            });

            // Hide the downloads panel
            const downloadsPanel = document.getElementById('downloads-panel');
            if (downloadsPanel) {
                downloadsPanel.style.display = 'none';
            }

            // Make language learning links open in external browser
            const languageLinks = document.querySelectorAll('a[href^="/rhodes-french"], a[href^="/rhodes-german"], a[href^="/rhodes-spanish"], a[href^="/rhodes-italian"], a[href^="/rhodes-russian"]');
            languageLinks.forEach(link => {
                const path = link.getAttribute('href');
                link.setAttribute('href', 'https://rhodesagi.com' + path);
                link.setAttribute('target', '_blank');
                link.setAttribute('rel', 'noopener');
            });
            console.log('[Desktop] Modifications applied: Downloads hidden, language links open in browser');
        }
    })();
    </script>


    <!-- Custom Slash Commands Support -->
    <script>
    (function() {
        const isDesktop = (window.rhodes && window.rhodes.isDesktop) || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        if (!isDesktop) return;

        window.displayCommandResult = function(command, result) {
            const chatArea = document.getElementById('chat');
            if (!chatArea) return;

            const resultDiv = document.createElement('div');
            resultDiv.className = 'message system-message';
            resultDiv.style.cssText = 'background: rgba(0,255,65,0.1); border-left: 3px solid var(--green); padding: 10px; margin: 10px 0; font-family: monospace;';

            if (result.error) {
                resultDiv.style.borderLeftColor = '#ff4444';
                let html = '<div style="color:#ff4444;font-weight:bold;">/' + command + ' - Error</div>';
                html += '<pre style="margin:5px 0;white-space:pre-wrap;">' + result.error + '</pre>';
                if (result.available && result.available.length > 0) {
                    html += '<div style="margin-top:10px;color:var(--dim);">Available: ' + result.available.map(c => '/' + c).join(', ') + '</div>';
                }
                resultDiv.innerHTML = html;
            } else {
                resultDiv.innerHTML = '<div style="color:var(--green);font-weight:bold;">/' + command + '</div><pre style="margin:5px 0;white-space:pre-wrap;color:var(--text);">' + (result.output || '(no output)') + '</pre>';
            }
            chatArea.appendChild(resultDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        };

        // Intercept custom commands
        const origSend = window.handleSend;
        window.handleSend = function(e) {
            if (e) e.preventDefault();
            const input = document.getElementById('input');
            const text = (input ? input.value : '').trim();

            if (text.startsWith('/') && !text.startsWith('//')) {
                const parts = text.slice(1).split(' ');
                const cmd = parts[0].toLowerCase();
                const args = parts.slice(1).join(' ');

                // Built-in commands pass through
                const builtins = ['model','format','english','russian','french','latin','german','help','clear','new','rooms','split','commands'];
                if (builtins.includes(cmd) || cmd.startsWith('format-') || cmd.startsWith('rhodes-')) {
                    if (origSend) return origSend(e);
                    return;
                }

                // /commands - list available
                if (cmd === 'commands' && window.pywebview && window.pywebview.api) {
                    window.pywebview.api.list_commands().then(cmds => {
                        if (!cmds || cmds.length === 0) {
                            displayCommandResult('commands', {output: 'No custom commands.\nCreate in: ~/.rhodes/commands/'});
                        } else {
                            const list = cmds.map(c => '/' + c.name + (c.description ? ' - ' + c.description : '')).join('\n');
                            displayCommandResult('commands', {output: 'Custom commands:\n' + list});
                        }
                    });
                    if (input) input.value = '';
                    return;
                }

                // Try custom command via pywebview API
                if (window.pywebview && window.pywebview.api) {
                    window.pywebview.api.execute_command(cmd, args).then(result => {
                        displayCommandResult(cmd, result);
                    }).catch(err => {
                        displayCommandResult(cmd, {error: String(err)});
                    });
                    if (input) input.value = '';
                    return;
                }
            }
            if (origSend) return origSend(e);
        };

        console.log('[Desktop] Custom commands loaded');
    })();
    </script>

    <!-- Modal Styles -->
    <style>
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.9);
        z-index: 10000;
        justify-content: center;
        align-items: center;
    }
    .modal-box {
        background: var(--panel, #0d0d0d);
        border: 1px solid var(--border, #1a1a1a);
        padding: 30px;
        border-radius: 5px;
        max-height: 90vh;
        overflow-y: auto;
    }
    .modal-box h2 {
        color: var(--cyan, #00ffd5);
        margin-bottom: 20px;
        font-family: 'Orbitron', monospace;
    }
    .modal-box input {
        background: rgba(255,255,255,0.06);
        border: 1px solid rgba(255,255,255,0.2);
        color: var(--text, #e0e0e0);
        padding: 12px;
        font-family: 'Share Tech Mono', monospace;
        box-sizing: border-box;
        border-radius: 4px;
    }
    .modal-box input::placeholder {
        color: rgba(255,255,255,0.35);
    }
    .modal-box input:focus {
        border-color: var(--cyan, #00ffd5);
        background: rgba(255,255,255,0.1);
        outline: none;
    }
    </style>

    <!-- Terminal Split Mode (4 parallel terminals) -->
    <style>
    #split-container {
        display: none;
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: var(--bg, #0a0a0a);
        z-index: 9999;
    }
    #split-container.active { display: grid; gap: 2px; }
    /* 2 panes: side by side */
    #split-container.active.split-2 { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr; }
    /* 3 panes: vertical stack */
    #split-container.active.split-3 { grid-template-columns: 1fr; grid-template-rows: 1fr 1fr 1fr; }
    /* 4 panes: 2x2 grid (default) */
    #split-container.active.split-4 { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; }
    .split-pane {
        background: var(--bg, #0a0a0a);
        border: 1px solid var(--green, #00ff41);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    .split-pane-header {
        background: rgba(0,255,65,0.1);
        padding: 5px 10px;
        font-size: 12px;
        color: var(--green);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .split-pane-content {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
        font-family: monospace;
        font-size: 13px;
        color: var(--text, #ddd);
        white-space: pre-wrap;
        user-select: text;
        cursor: text;
        position: relative;
    }
    .pane-ascii-face {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        opacity: 0.08;
        pointer-events: none;
        z-index: 0;
        font-size: 5px;
        line-height: 1;
        color: var(--green, #00ff41);
        white-space: pre;
        font-family: monospace;
        transition: opacity 0.5s ease-out;
        text-align: center;
    }
    .pane-ascii-face.faded {
        opacity: 0 !important;
    }
    .split-pane-input {
        display: flex;
        border-top: 1px solid var(--green);
    }
    .split-pane-input input {
        flex: 1;
        background: transparent;
        border: none;
        padding: 8px;
        color: var(--text);
        font-family: monospace;
    }

    /* Split pane slash command menu */
    .split-slash-menu {
        position: absolute;
        bottom: 100%;
        left: 0;
        right: 0;
        background: #0a0a12;
        border: 1px solid var(--green);
        border-bottom: none;
        max-height: 150px;
        overflow-y: auto;
        display: none;
        z-index: 1000;
    }
    .split-slash-menu.visible { display: block; }
    .split-slash-menu .slash-item {
        padding: 6px 10px;
        cursor: pointer;
        border-bottom: 1px solid #222;
        font-size: 12px;
    }
    .split-slash-menu .slash-item:hover,
    .split-slash-menu .slash-item.selected {
        background: var(--green);
        color: #000;
    }
    .split-slash-menu .slash-item .cmd { color: var(--cyan); font-weight: bold; }
    .split-slash-menu .slash-item:hover .cmd { color: #000; }
    .split-slash-menu .slash-item .desc { color: #666; margin-left: 8px; }
    .split-slash-menu .slash-item:hover .desc { color: #333; }

    .split-pane-input button {
        background: var(--green);
        color: #000;
        border: none;
        padding: 8px 15px;
        cursor: pointer;
    }
    #split-toggle {
        position: fixed;
        bottom: 80px;
        right: 20px;
        background: var(--green);
        color: #000;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        z-index: 1000;
        font-weight: bold;
    }
    #split-exit {
        position: fixed;
        top: 10px;
        right: 10px;
        background: #ff4444;
        color: #fff;
        border: none;
        padding: 8px 15px;
        cursor: pointer;
        z-index: 10000;
        border-radius: 3px;
    }
    
    /* Slash command autocomplete dropdown */
    #slash-dropdown {
        position: absolute;
        bottom: 100%;
        left: 0;
        right: 0;
        background: var(--bg);
        border: 1px solid var(--green);
        border-bottom: none;
        max-height: 200px;
        overflow-y: auto;
        display: none;
        z-index: 1000;
    }
    #slash-dropdown.visible {
        display: block;
    }
    .slash-option {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #333;
        display: flex;
        justify-content: space-between;
    }
    .slash-option:hover, .slash-option.selected {
        background: var(--green);
        color: #000;
    }
    .slash-option .cmd {
        font-weight: bold;
        color: var(--green);
    }
    .slash-option:hover .cmd, .slash-option.selected .cmd {
        color: #000;
    }
    .slash-option .desc {
        color: #888;
        font-size: 0.9em;
    }
    .slash-option:hover .desc, .slash-option.selected .desc {
        color: #333;
    }

/* ASCII Face Flash Animation */
    #ascii-face-flash {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        display: none;
        z-index: 99999;
        display: none;
        background: rgba(0, 0, 0, 0.95);
        pointer-events: none;
    }
    #ascii-face-flash.active {
        display: block;
        animation: ascii-fade 1.5s ease-out forwards;
    }
    #ascii-face-flash pre {
        color: #00ffff;
        font-family: monospace;
        font-size: 7px;
        line-height: 1.0;
        text-align: left;
        white-space: pre;
        margin: 0;
        padding: 20px;
        background: rgba(0, 0, 0, 0.8);
        border: 1px solid #00ff41;
        border-radius: 8px;
        text-shadow: 0 0 5px #00ffff;
    }
    @keyframes ascii-fade {
        0% { opacity: 0; }
        15% { opacity: 1; }
        70% { opacity: 1; }
        100% { opacity: 0.12; }
    }
    /* Light mode ASCII flash */
    body.light-mode #ascii-face-flash {
        background: rgba(255, 255, 255, 0.95);
    }
    body.light-mode #ascii-face-flash pre {
        color: #0066cc;
        background: rgba(255, 255, 255, 0.9);
        border-color: #0066cc;
        text-shadow: none;
    }

    </style>
    <script>
    (function() {
        // DISABLED: Desktop-only split mode - now using website split mode (rhodes.js) everywhere
        // The website split mode uses #split-view and works great
        return;
        
        const isDesktop = (window.rhodes && window.rhodes.isDesktop) || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        if (!isDesktop) return;

        // Create split container
        const splitContainer = document.createElement('div');
        splitContainer.id = 'split-container';
        splitContainer.innerHTML = `
            <button id="split-exit" onclick="window.exitSplitMode()">‚úï Exit Split</button>
            ${[1,2,3,4].map(i => `
                <div class="split-pane" id="pane-${i}">
                    <div class="split-pane-header">
                        <span>Terminal ${i}</span>
                        <button onclick="window.copyPaneContent(${i})" style="background:transparent;border:1px solid var(--dim);color:var(--dim);padding:2px 6px;font-size:10px;cursor:pointer;margin-left:auto;">COPY</button>
                        <button onclick="window.promoteToMain(${i})" style="background:transparent;border:1px solid var(--green);color:var(--green);padding:2px 6px;font-size:10px;cursor:pointer;margin-left:4px;margin-right:8px;" title="Make this the main session">‚¨Ü MAIN</button>
                        <span class="pane-status" id="pane-${i}-status">Ready</span>
                    </div>
                    <div class="split-pane-content" id="pane-${i}-content"><pre class="pane-ascii-face" id="pane-${i}-face">‚£Ä‚£Ä‚£Ä‚£Ä‚£Ä‚£Ä‚£Ä
‚£Ä‚£¥‚£æ‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£∑‚£¶‚£Ä
‚£Ä‚£¥‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£¶‚£Ä
‚£†‚£æ‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£∑‚£Ñ
‚£¥‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£¶
‚£º‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ß</pre></div>
                    <div class="split-pane-input" style="position:relative;">
                        <div class="split-slash-menu" id="pane-${i}-slash"></div>
                        <input type="text" id="pane-${i}-input" placeholder="> command..." 
                               onkeypress="if(event.key==='Enter'){window.hidePaneSlash(${i});window.runPaneCommand(${i})}"
                               onkeyup="window.handlePaneSlash(${i}, event)"
                               onkeydown="window.handlePaneSlashNav(${i}, event)">
                        <button onclick="window.runPaneCommand(${i})">RUN</button>
                    </div>
                </div>
            `).join('')}
        `;
        document.body.appendChild(splitContainer);

        // Right-side split toggle removed - use center SPLIT button instead

        // Multi-instance WebSocket connections for each pane
        const paneConnections = {};
        window.paneConnections = paneConnections;  // Expose for sendToInstance
        const paneSessionIds = {};
        window.paneSessionIds = paneSessionIds;  // Expose for promoteToMain

        function generateSessionId(paneNum) {
            return 'split_pane_' + paneNum + '_' + Math.random().toString(36).substring(2, 10);
        }

        function getWebSocketUrl() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                ? 'rhodesagi.com' : window.location.host;
            return protocol + '//' + host + '/ws';
        }

        function connectPane(paneNum) {
            const content = document.getElementById('pane-' + paneNum + '-content');
            const status = document.getElementById('pane-' + paneNum + '-status');
            // Fade ASCII face when content arrives
            const paneFace = document.getElementById('pane-' + paneNum + '-face');
            if (paneFace) paneFace.classList.add('faded');
            const sessionId = generateSessionId(paneNum);
            paneSessionIds[paneNum] = sessionId;

            status.textContent = 'Connecting...';
            content.innerHTML += '<div style=\"color:var(--dim);\">[Connecting to Rhodes...]</div>';

            const ws = new WebSocket(getWebSocketUrl());
            paneConnections[paneNum] = ws;

            ws.onopen = function() {
                status.textContent = 'Authenticating...';
                content.innerHTML += '<div style="color:var(--green);">[Connected - Instance ' + paneNum + ']</div>';
                // Send auth request - use user token from main session
                const userToken = window.rhodesStorage?.getItem('rhodes_user_token') || window.localStorage.getItem('rhodes_user_token') || '';
                const token = window.rhodesStorage?.getItem('rhodes_token') || window.localStorage.getItem('rhodes_token') || '';
                ws.send(JSON.stringify({
                    msg_type: 'auth_request',
                    msg_id: sessionId,
                    timestamp: new Date().toISOString(),
                    payload: { 
                        client_id: 'split_pane_' + paneNum,
                        tab_id: sessionId,
                        token: token,
                        user_token: userToken
                    }
                }));
            };

            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    // Handle auth response
                    if (data.msg_type === 'auth_success' || data.msg_type === 'session_init') {
                        status.textContent = 'Ready';
                        content.innerHTML += '<div style="color:var(--cyan);">[Authenticated - Ready]</div>';
                        return;
                    }
                    if (data.msg_type === 'error') {
                        status.textContent = 'Auth Failed';
                        content.innerHTML += '<div style="color:#ff4444;">[Auth Error: ' + (data.payload?.error || 'Unknown') + ']</div>';
                        return;
                    }
                    if (data.type === 'ai_message' || data.type === 'assistant' || data.msg_type === 'ai_message') {
                        const text = data.payload?.content || data.content || '';
                        if (text) {
                            content.innerHTML += '<div style="color:var(--text);background:rgba(0,255,65,0.05);padding:8px;margin:5px 0;border-left:2px solid var(--green);">' + text.replace(/\n/g, '<br>') + '</div>';
                            content.scrollTop = content.scrollHeight;
                        }
                        status.textContent = 'Ready';
                    } else if (data.type === 'error') {
                        content.innerHTML += '<div style="color:#ff4444;">[Error: ' + (data.payload?.message || 'Unknown') + ']</div>';
                        status.textContent = 'Error';
                    } else if (data.type === 'stream_start') {
                        status.textContent = 'Receiving...';
                    } else if (data.type === 'stream_chunk') {
                        // Handle streaming chunks
                        const chunk = data.payload?.content || '';
                        let streamDiv = content.querySelector('.streaming-' + paneNum);
                        if (!streamDiv) {
                            streamDiv = document.createElement('div');
                            streamDiv.className = 'streaming-' + paneNum;
                            streamDiv.style.cssText = 'color:var(--text);background:rgba(0,255,65,0.05);padding:8px;margin:5px 0;border-left:2px solid var(--cyan);';
                            content.appendChild(streamDiv);
                        }
                        streamDiv.innerHTML += chunk.replace(/\n/g, '<br>');
                        content.scrollTop = content.scrollHeight;
                    } else if (data.type === 'stream_end') {
                        const streamDiv = content.querySelector('.streaming-' + paneNum);
                        if (streamDiv) streamDiv.classList.remove('streaming-' + paneNum);
                        status.textContent = 'Ready';
                    }
                } catch (e) {
                    console.error('Pane ' + paneNum + ' message parse error:', e);
                }
            };

            ws.onerror = function(err) {
                status.textContent = 'Error';
                content.innerHTML += '<div style="color:#ff4444;">[Connection error]</div>';
            };

            ws.onclose = function() {
                status.textContent = 'Disconnected';
                content.innerHTML += '<div style=\"color:var(--dim);\">[Disconnected]</div>';
                paneConnections[paneNum] = null;
            };
        }

        function disconnectAllPanes() {
            for (let i = 1; i <= 4; i++) {
                if (paneConnections[i]) {
                    paneConnections[i].close();
                    paneConnections[i] = null;
                }
            }
        }

        // Flash ASCII face on mode activation
        window.flashAsciiFace = function() {
            const flash = document.getElementById('ascii-face-flash');
            if (flash) {
                flash.classList.remove('active');
                void flash.offsetWidth;
                flash.classList.add('active');
                // Face stays visible faintly after animation
            }
        };


        window.enterSplitMode = function(paneCount = 4) {
            window.flashAsciiFace();
            // Remove old layout classes
            splitContainer.classList.remove('split-2', 'split-3', 'split-4');
            // Add appropriate layout class
            splitContainer.classList.add('active', 'split-' + paneCount);
            // split-toggle-container removed (using center SPLIT button only)

            // Show/hide panes based on count
            for (let i = 1; i <= 4; i++) {
                const pane = document.getElementById('pane-' + i);
                if (pane) {
                    pane.style.display = i <= paneCount ? 'flex' : 'none';
                }
            }

            // Connect only the active panes
            for (let i = 1; i <= paneCount; i++) {
                if (!paneConnections[i] || paneConnections[i].readyState !== WebSocket.OPEN) {
                    connectPane(i);
                }
            }
        };

        window.exitSplitMode = function() {
            splitContainer.classList.remove('active', 'split-2', 'split-3', 'split-4');
            // split-toggle-container was here
            // Keep connections alive for quick re-entry, or disconnect:
            // disconnectAllPanes();
        };

        
        // Slash command menu for split panes
        const SPLIT_SLASH_COMMANDS = [
            {cmd: '/new', desc: 'New session'},
            {cmd: '/clear', desc: 'Clear chat'},
            {cmd: '/stop', desc: 'Stop generation'},
            {cmd: '/help', desc: 'Show help'},
            {cmd: '/duo-max', desc: 'Maximum quality duo'},
            {cmd: '/duo', desc: 'Standard duo mode'},
            {cmd: '/supervised', desc: 'Supervised mode'},
            {cmd: '/solo', desc: 'Direct mode'},
            {cmd: '/clear-cache', desc: 'Clear local cache (desktop)'},
        ];
        let paneSlashSelected = {};

        window.handlePaneSlash = function(paneNum, event) {
            const input = document.getElementById('pane-' + paneNum + '-input');
            const menu = document.getElementById('pane-' + paneNum + '-slash');
            const val = input.value;
            
            if (val.startsWith('/') && val.length > 0) {
                const filter = val.toLowerCase();
                const matches = SPLIT_SLASH_COMMANDS.filter(c => c.cmd.toLowerCase().startsWith(filter));
                if (matches.length > 0) {
                    menu.innerHTML = matches.map((c, i) => 
                        '<div class="slash-item' + (i === 0 ? ' selected' : '') + '" data-cmd="' + c.cmd + '" onclick="window.selectPaneSlash(' + paneNum + ', \'' + c.cmd + '\')">' +
                        '<span class="cmd">' + c.cmd + '</span><span class="desc">' + c.desc + '</span></div>'
                    ).join('');
                    menu.classList.add('visible');
                    paneSlashSelected[paneNum] = 0;
                } else {
                    menu.classList.remove('visible');
                }
            } else {
                menu.classList.remove('visible');
            }
        };

        window.handlePaneSlashNav = function(paneNum, event) {
            const menu = document.getElementById('pane-' + paneNum + '-slash');
            if (!menu.classList.contains('visible')) return;
            
            const items = menu.querySelectorAll('.slash-item');
            if (items.length === 0) return;
            
            let sel = paneSlashSelected[paneNum] || 0;
            
            if (event.key === 'ArrowDown') {
                event.preventDefault();
                sel = (sel + 1) % items.length;
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                sel = (sel - 1 + items.length) % items.length;
            } else if (event.key === 'Tab') {
                event.preventDefault();
                const cmd = items[sel].dataset.cmd;
                document.getElementById('pane-' + paneNum + '-input').value = cmd + ' ';
                menu.classList.remove('visible');
                return;
            } else if (event.key === 'Escape') {
                menu.classList.remove('visible');
                return;
            }
            
            paneSlashSelected[paneNum] = sel;
            items.forEach((it, i) => it.classList.toggle('selected', i === sel));
        };

        window.selectPaneSlash = function(paneNum, cmd) {
            document.getElementById('pane-' + paneNum + '-input').value = cmd + ' ';
            document.getElementById('pane-' + paneNum + '-slash').classList.remove('visible');
            document.getElementById('pane-' + paneNum + '-input').focus();
        };

        window.hidePaneSlash = function(paneNum) {
            document.getElementById('pane-' + paneNum + '-slash').classList.remove('visible');
        };


        window.copyPaneContent = function(paneNum) {
            const content = document.getElementById('pane-' + paneNum + '-content');
            if (content) {
                const text = content.innerText || content.textContent;
                navigator.clipboard.writeText(text).then(() => {
                    const status = document.getElementById('pane-' + paneNum + '-status');
                    const orig = status.textContent;
                    status.textContent = 'Copied!';
                    setTimeout(() => status.textContent = orig, 1000);
                }).catch(() => {
                    // Fallback
                    const range = document.createRange();
                    range.selectNodeContents(content);
                    const sel = window.getSelection();
                    sel.removeAllRanges();
                    sel.addRange(range);
                    document.execCommand('copy');
                    sel.removeAllRanges();
                });
            }
        };

        window.runPaneCommand = function(paneNum) {
            const input = document.getElementById('pane-' + paneNum + '-input');
            const content = document.getElementById('pane-' + paneNum + '-content');
            const status = document.getElementById('pane-' + paneNum + '-status');
            // Fade ASCII face when content arrives
            const paneFace = document.getElementById('pane-' + paneNum + '-face');
            if (paneFace) paneFace.classList.add('faded');
            const cmd = input.value.trim();
            if (!cmd) return;

            content.innerHTML += '<div style="color:var(--cyan);">> ' + cmd + '</div>';
            input.value = '';

            // Desktop-only commands
            const desktopCmds = ['clear-cache', 'clearcache', 'refresh-assets'];
            const lowerCmd = cmd.toLowerCase();
            if (cmd.startsWith('/') && desktopCmds.includes(lowerCmd.slice(1)) && window.pywebview && window.pywebview.api) {
                status.textContent = 'Running...';
                window.pywebview.api.execute_command(lowerCmd.slice(1), '').then(result => {
                    content.innerHTML += '<div style="color:var(--green);">' + (result.message || 'Done') + '</div>';
                    status.textContent = 'Ready';
                    content.scrollTop = content.scrollHeight;
                });
            } else {
                // Send to this pane's dedicated WebSocket connection
                const ws = paneConnections[paneNum];
                if (ws && ws.readyState === WebSocket.OPEN) {
                    status.textContent = 'Sending...';
                    ws.send(JSON.stringify({
                        msg_type: 'user_message',
                        msg_id: 'split_' + paneNum + '_' + Date.now(),
                        timestamp: new Date().toISOString(),
                        payload: { content: cmd }
                    }));
                } else {
                    content.innerHTML += '<div style="color:#ff4444;">[Not connected - reconnecting...]</div>';
                    connectPane(paneNum);
                }
            }
            content.scrollTop = content.scrollHeight;
        };

        // /split command to toggle
        const origHandle = window.handleSend;
        window.handleSend = function(e) {
            const input = document.getElementById('input');
            const text = (input ? input.value : '').trim().toLowerCase();
            if (text === '/split') {
                if (input) input.value = '';
                window.enterSplitMode();
                return;
            }
            if (origHandle) return origHandle(e);
        };

        console.log('[Desktop] Split terminal mode loaded');
    })();
    </script>



<script>
    // Slash command autocomplete
    (function() {
        const slashCommands = [
            {cmd: '/model', desc: 'Switch AI model'},
            {cmd: '/split', desc: 'Toggle 4-terminal split'},
            {cmd: '/shared', desc: 'Full inter-instance messaging'},
            {cmd: '/shared:public', desc: 'Broadcast only (no private)'},
            {cmd: '/shared:segregated', desc: 'Awareness only'},
            {cmd: '/shared:segregated:fully', desc: 'Isolated (messaging disabled)'},
            {cmd: '/rounds', desc: 'Disclose round counts'},
            {cmd: '/clear', desc: 'Clear chat history'},
            {cmd: '/help', desc: 'Show help'},
        ];

        let selectedIndex = -1;
        let dropdown = null;
        let inputEl = null;

        function createDropdown() {
            if (dropdown) return dropdown;
            dropdown = document.createElement('div');
            dropdown.id = 'slash-dropdown';
            return dropdown;
        }

        function showDropdown(input, filter = '') {
            if (!dropdown) {
                dropdown = createDropdown();
                input.parentElement.style.position = 'relative';
                input.parentElement.insertBefore(dropdown, input);
            }
            inputEl = input;

            const filtered = slashCommands.filter(c =>
                c.cmd.toLowerCase().includes(filter.toLowerCase()) ||
                c.desc.toLowerCase().includes(filter.toLowerCase())
            );

            if (filtered.length === 0) {
                hideDropdown();
                return;
            }

            dropdown.innerHTML = filtered.map((c, i) =>
                `<div class="slash-option${i === selectedIndex ? ' selected' : ''}" data-cmd="${c.cmd}">
                    <span class="cmd">${c.cmd}</span>
                    <span class="desc">${c.desc}</span>
                </div>`
            ).join('');

            dropdown.querySelectorAll('.slash-option').forEach((opt, i) => {
                opt.addEventListener('click', () => {
                    selectCommand(opt.dataset.cmd);
                });
                opt.addEventListener('mouseenter', () => {
                    selectedIndex = i;
                    updateSelection();
                });
            });

            dropdown.classList.add('visible');
        }

        function hideDropdown() {
            if (dropdown) {
                dropdown.classList.remove('visible');
            }
            selectedIndex = -1;
        }

        function updateSelection() {
            if (!dropdown) return;
            const opts = dropdown.querySelectorAll('.slash-option');
            opts.forEach((opt, i) => {
                opt.classList.toggle('selected', i === selectedIndex);
            });
        }

        function selectCommand(cmd) {
            if (inputEl) {
                inputEl.value = cmd + ' ';
                inputEl.focus();
            }
            hideDropdown();
        }

        // Listen for input events on message inputs
        document.addEventListener('input', function(e) {
            const input = e.target;
            if (input.tagName === 'INPUT' && (input.placeholder?.includes('message') || input.placeholder?.includes('Message'))) {
                const val = input.value;
                if (val.startsWith('/')) {
                    const filter = val.substring(1);
                    showDropdown(input, filter);
                } else {
                    hideDropdown();
                }
            }
        });

        // Handle keyboard navigation
        document.addEventListener('keydown', function(e) {
            if (!dropdown || !dropdown.classList.contains('visible')) return;

            const opts = dropdown.querySelectorAll('.slash-option');
            if (opts.length === 0) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, opts.length - 1);
                updateSelection();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, 0);
                updateSelection();
            } else if (e.key === 'Enter' && selectedIndex >= 0) {
                e.preventDefault();
                const selected = opts[selectedIndex];
                if (selected) selectCommand(selected.dataset.cmd);
            } else if (e.key === 'Escape') {
                hideDropdown();
            } else if (e.key === 'Tab' && selectedIndex >= 0) {
                e.preventDefault();
                const selected = opts[selectedIndex];
                if (selected) selectCommand(selected.dataset.cmd);
            }
        });

        // Hide on click outside
        document.addEventListener('click', function(e) {
            if (dropdown && !dropdown.contains(e.target) && e.target !== inputEl) {
                hideDropdown();
            }
        });
    })();
</script>
<script>
// Mobile app: hide split mode button
(function() {
    if (new URLSearchParams(window.location.search).get('mobile') === '1') {
        var style = document.createElement('style');
        style.textContent = '#split-view-btn, #split-mode-options { display: none !important; }';
        document.head.appendChild(style);
        window.__RHODES_MOBILE_APP__ = true;
    }
})();
</script>
<script>
// Languages dropdown toggle
window.toggleLanguagesDropdown = function() {
    var dropdown = document.getElementById('languages-dropdown');
    var link = document.getElementById('languages-link');
    if (!dropdown || !link) return;
    
    if (dropdown.style.display === 'none' || !dropdown.style.display) {
        // Position dropdown below the link
        var rect = link.getBoundingClientRect();
        dropdown.style.position = 'fixed';
        dropdown.style.top = rect.bottom + 'px';
        dropdown.style.left = rect.left + 'px';
        dropdown.style.display = 'block';
    } else {
        dropdown.style.display = 'none';
    }
};

// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
    var dropdown = document.getElementById('languages-dropdown');
    var link = document.getElementById('languages-link');
    if (dropdown && link && !dropdown.contains(e.target) && e.target !== link) {
        dropdown.style.display = 'none';
    }
});

// Hide stuff on desktop app - add class immediately
(function() {
    var params = new URLSearchParams(window.location.search);
    var isDesktop = (window.rhodes && window.rhodes.isDesktop) || params.get('embedded') === '1' || window.__RHODES_DESKTOP_MODE__ || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    if (isDesktop) {
        document.documentElement.classList.add('desktop-mode');
        document.body && document.body.classList.add('desktop-mode');
        // Also add via DOM ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                document.body.classList.add('desktop-mode');
            });
        }
        // Force hide with inline style injection
        var style = document.createElement('style');
        style.textContent = '#languages-link, #languages-dropdown { display: none !important; }';
        (document.head || document.documentElement).appendChild(style);
        window.__RHODES_DESKTOP_MODE__ = true;
    }
})();
</script>
<style>
/* Voice system styles */
#handsfree-takeover {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background: rgba(0, 0, 0, 0.97);
    z-index: 9999;
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    font-family: "Orbitron", monospace;
    color: #00ffd5;
}
#handsfree-takeover.active {
    display: flex !important;
}
#takeover-status {
    padding-left: 100px;
    font-size: 18px;
    letter-spacing: 4px;
    margin-bottom: 20px;
    text-transform: uppercase;
}
#takeover-status.listening { color: #00ff41; animation: pulse-glow 1.5s ease-in-out infinite; }
#takeover-status.processing { color: #ffaa00; animation: pulse-glow 0.8s ease-in-out infinite; }
#takeover-status.speaking { color: #00ffd5; }
#takeover-status.hidden { display: none; }
@keyframes pulse-glow {
    0%, 100% { opacity: 0.6; }
    50% { opacity: 1; }
}
#takeover-face {
    font-size: 14px;
    line-height: 1.15;
    white-space: pre;
    text-align: center;
    color: #00ffd5;
    margin: 20px 0;
    transform: scale(1);
}
#takeover-return {
    position: absolute;
    top: 20px; left: 20px;
    cursor: pointer;
    color: rgba(0, 255, 213, 0.5);
    font-size: 14px;
}
#takeover-return:hover { color: #00ffd5; }
.takeover-transcript {
    max-width: 600px;
    text-align: center;
    color: rgba(0, 255, 213, 0.7);
    font-size: 14px;
    margin-top: 20px;
    min-height: 20px;
}
.exit-hint {
    position: absolute;
    bottom: 30px;
    cursor: pointer;
    color: rgba(0, 255, 213, 0.3);
    font-size: 12px;
    letter-spacing: 3px;
}
.exit-hint:hover { color: #00ffd5; }
#speaking-face {
    display: none;
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    font-size: 14px;
    line-height: 1.15;
    white-space: pre;
    text-align: center;
    color: #00ffd5;
    z-index: 9998;
    background: rgba(0, 0, 0, 0.95);
    padding: 40px;
    border-radius: 10px;
}
#speaking-face.active { display: block; }
#voice-indicator {
    display: none;
    text-align: center;
    color: #00ff41;
    font-family: "Orbitron", monospace;
    font-size: 12px;
    padding: 5px;
    animation: pulse-glow 1.5s ease-in-out infinite;
}
#voice-indicator.active { display: block; }
.mouth { cursor: pointer; }
.mouth-listening { color: #00ff41; }
.mouth-waiting { color: #ffaa00; }
.eye-highlight { color: #00ff41; text-shadow: 0 0 8px #00ff41; }
</style>
<!-- TTS handled by addMsg hook in rhodes.js -->

<script>
window._openSessionsPanel = function() {
    var panel = document.getElementById('sessions-up-panel');
    if (panel) {
        if (panel.style.display === 'flex') { panel.style.display = 'none'; return; }
        panel.style.display = 'flex';
        window._loadSessionsUp();
        window._loadProjectsUp();
        var si = panel.querySelector('input');
        if (si) setTimeout(function(){ si.focus(); }, 100);
        return;
    }
    panel = document.createElement('div');
    panel.id = 'sessions-up-panel';
    panel.style.cssText = 'position:fixed;bottom:90px;left:50%;transform:translateX(-50%);width:560px;max-height:45vh;z-index:2000;background:var(--panel);border:1px solid var(--cyan);border-radius:4px;display:flex;flex-direction:column;box-shadow:0 4px 12px rgba(0,0,0,0.5);';
    // Two-column body
    var columns = document.createElement('div');
    columns.style.cssText = 'display:flex;flex:1;overflow:hidden;min-height:0;';
    // Left: sessions
    var sessCol = document.createElement('div');
    sessCol.style.cssText = 'flex:1;display:flex;flex-direction:column;border-right:1px solid var(--border);min-width:0;';
    var sessHeader = document.createElement('div');
    sessHeader.style.cssText = 'padding:10px 12px;font-size:14px;font-family:Orbitron,sans-serif;font-weight:700;color:var(--cyan);border-bottom:1px solid var(--border);';
    sessHeader.textContent = 'SESSIONS';
    sessCol.appendChild(sessHeader);
    var results = document.createElement('div');
    results.id = 'sessions-up-results';
    results.style.cssText = 'overflow-y:auto;flex:1;';
    sessCol.appendChild(results);
    columns.appendChild(sessCol);
    // Right: projects
    var projCol = document.createElement('div');
    projCol.style.cssText = 'width:180px;display:flex;flex-direction:column;min-width:0;';
    var projHeader = document.createElement('div');
    projHeader.style.cssText = 'padding:10px 12px;font-size:14px;font-family:Orbitron,sans-serif;font-weight:700;color:var(--green);border-bottom:1px solid var(--border);';
    projHeader.textContent = 'PROJECTS';
    projCol.appendChild(projHeader);
    var projResults = document.createElement('div');
    projResults.id = 'projects-up-results';
    projResults.style.cssText = 'overflow-y:auto;flex:1;';
    projCol.appendChild(projResults);
    columns.appendChild(projCol);
    panel.appendChild(columns);
    // Search at bottom (spans full width)
    var searchDiv = document.createElement('div');
    searchDiv.style.cssText = 'padding:6px 10px;border-top:1px solid var(--border);';
    var searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.placeholder = 'Search sessions...';
    searchInput.style.cssText = 'width:100%;background:var(--bg);border:1px solid var(--cyan);color:var(--cyan);padding:8px 10px;font-size:16px;outline:none;border-radius:3px;box-sizing:border-box;';
    searchInput.oninput = function() { window._loadSessionsUp(this.value); };
    searchDiv.appendChild(searchInput);
    panel.appendChild(searchDiv);
    document.body.appendChild(panel);
    window._loadSessionsUp();
    window._loadProjectsUp();
    setTimeout(function(){ searchInput.focus(); }, 100);
};
window._loadProjectsUp = function() {
    var results = document.getElementById('projects-up-results');
    if (!results) return;
    var token = localStorage.getItem('rhodes_user_token');
    if (!token) { results.innerHTML = '<div style="padding:12px;color:var(--dim);font-size:15px;">Login</div>'; return; }
    fetch('/api/user/projects', { headers: { 'Authorization': 'Bearer ' + token } })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            var projects = data.projects || [];
            results.innerHTML = '';
            if (!projects.length) { results.innerHTML = '<div style="padding:12px;color:var(--dim);font-size:15px;">No projects</div>'; return; }
            var activeProjectId = window.__RHODES_ACTIVE_PROJECT_ID || null;
            projects.forEach(function(p) {
                var isActive = (activeProjectId !== null && p.id === activeProjectId);
                var div = document.createElement('div');
                div.style.cssText = 'padding:8px 12px;border-bottom:1px solid rgba(255,255,255,0.05);cursor:pointer;font-size:15px;transition:background 0.15s;' +
                    (isActive ? 'background:rgba(0,255,65,0.15);border-left:3px solid var(--green);' : '');
                div.setAttribute('data-project-id', p.id);
                div.draggable = true;
                div.ondragstart = function(e) {
                    e.dataTransfer.setData('text/plain', 'project:' + p.id);
                    e.dataTransfer.effectAllowed = 'move';
                    this.style.opacity = '0.5';
                };
                div.ondragend = function() { this.style.opacity = '1'; };
                div.onmouseover = function() { this.style.background = 'rgba(0,255,65,0.15)'; };
                div.onmouseout = function() { this.style.background = isActive ? 'rgba(0,255,65,0.15)' : 'none'; };
                // Drop target for sessions
                div.ondragover = function(e) { e.preventDefault(); this.style.background = 'rgba(0,255,213,0.25)'; this.style.outline = '1px dashed var(--cyan)'; };
                div.ondragleave = function() { this.style.background = isActive ? 'rgba(0,255,65,0.15)' : 'none'; this.style.outline = 'none'; };
                div.ondrop = function(e) {
                    e.preventDefault();
                    this.style.background = isActive ? 'rgba(0,255,65,0.15)' : 'none';
                    this.style.outline = 'none';
                    var payload = e.dataTransfer.getData('text/plain');
                    if (!payload || !payload.startsWith('session:')) return;
                    var sessionId = payload.split(':').slice(1).join(':');
                    if (!sessionId) return;
                    var tk = localStorage.getItem('rhodes_user_token');
                    fetch('/api/user/sessions/' + sessionId + '/project', {
                        method: 'PUT',
                        headers: { 'Authorization': 'Bearer ' + tk, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ project_id: p.id })
                    }).then(function(r) { return r.json(); }).then(function(d) {
                        if (d.success) {
                            if (typeof window.showToast === 'function') window.showToast('Session added to ' + (p.name || 'project'));
                            window._projectNameMap = null;
                            window._loadSessionsUp();
                            window._loadProjectsUp();
                        } else {
                            if (typeof window.showToast === 'function') window.showToast('Failed to assign session');
                        }
                    }).catch(function() { if (typeof window.showToast === 'function') window.showToast('Error assigning session'); });
                };
                var name = p.name || 'Untitled';
                var desc = p.description || '';
                if (desc.length > 40) desc = desc.substring(0, 40) + '...';
                var badge = isActive ? ' <span style="color:var(--cyan);font-size:11px;font-weight:700;">ACTIVE</span>' :
                    (p.is_default ? ' <span style="color:var(--dim);font-size:11px;">DEFAULT</span>' : '');
                div.innerHTML = '<div style="color:var(--green);font-size:15px;font-weight:700;">' + name + badge + '</div>' +
                    (desc ? '<div style="color:var(--dim);font-size:13px;margin-top:1px;">' + desc + '</div>' : '') +
                    '';
                div.onclick = function() {
                    window.location.href = '/projects.html?id=' + p.id;
                };
                results.appendChild(div);
            });
        })
        .catch(function() { results.innerHTML = '<div style="padding:12px;color:var(--dim);font-size:15px;">Failed</div>'; });
};
window._loadSessionsUp = function(query) {
    var results = document.getElementById('sessions-up-results');
    if (!results) return;
    var token = localStorage.getItem('rhodes_user_token');
    if (!token) { results.innerHTML = '<div style="padding:12px;color:var(--dim);font-size:15px;">Login to see sessions</div>'; return; }
    // Fetch both sessions and projects in parallel for project name stickers
    Promise.all([
        fetch('/api/user/sessions/recent', { headers: { 'Authorization': 'Bearer ' + token } }).then(function(r) { return r.json(); }),
        window._projectNameMap ? Promise.resolve(null) : fetch('/api/user/projects', { headers: { 'Authorization': 'Bearer ' + token } }).then(function(r) { return r.json(); })
    ]).then(function(results2) {
        var data = results2[0];
        if (results2[1]) {
            window._projectNameMap = {};
            (results2[1].projects || []).forEach(function(p) { window._projectNameMap[p.id] = p.name; });
        }
        var pMap = window._projectNameMap || {};
            var sessions = data.sessions || [];
            if (query) {
                var q = query.toLowerCase();
                sessions = sessions.filter(function(s) {
                    return (s.title || '').toLowerCase().indexOf(q) >= 0 || (s.session_id || '').toLowerCase().indexOf(q) >= 0;
                });
            }
            // Separate split sessions from normal sessions
            var splitGroups = {};
            var normalSessions = [];
            sessions.forEach(function(s) {
                var isSplit = (s.session_id && s.session_id.indexOf('split-') >= 0) || s.is_split;
                if (isSplit) {
                    var splitGroupId = String(s.split_group_id || '').trim();
                    var created = (s.created_at || s.updated_at || '').substring(0, 16);
                    var userPrefix = s.session_id.replace(/split-\d+-.*/, 'split').replace(/_[a-f0-9]{8}$/, '');
                    var groupKey = splitGroupId ? ('group_' + splitGroupId) : (userPrefix + '_' + created);
                    if (!splitGroups[groupKey]) splitGroups[groupKey] = [];
                    splitGroups[groupKey].push(s);
                } else {
                    normalSessions.push(s);
                }
            });
            // Ascending: oldest first, newest at bottom (closest to input)
            normalSessions.reverse();
            var groupKeys = Object.keys(splitGroups).sort().filter(function(key) { return (splitGroups[key] || []).some(function(s) { return Number(s.message_count || 0) > 0; }); });  // ascending for drop-up
            results.innerHTML = '';
            if (!normalSessions.length && !groupKeys.length) {
                results.innerHTML = '<div style="padding:12px;color:var(--dim);font-size:15px;">No sessions</div>';
                return;
            }
            // Render normal sessions first (top = scrolled away in drop-up)
            normalSessions.forEach(function(s, idx) {
                var div = document.createElement('div');
                div.style.cssText = 'padding:8px 12px;border-bottom:1px solid rgba(255,255,255,0.05);cursor:grab;color:var(--text);font-size:15px;position:relative;';
                div.draggable = true;
                div.setAttribute('data-session-id', s.session_id);
                div.ondragstart = function(e) {
                    e.dataTransfer.setData('text/plain', 'session:' + s.session_id);
                    e.dataTransfer.effectAllowed = 'move';
                    this.style.opacity = '0.5';
                };
                div.ondragend = function() { this.style.opacity = '1'; };
                // Accept project drops
                div.ondragover = function(e) { e.preventDefault(); this.style.background = 'rgba(0,255,65,0.2)'; this.style.outline = '1px dashed var(--green)'; };
                div.ondragleave = function() { this.style.background = 'none'; this.style.outline = 'none'; };
                div.ondrop = (function(sid) { return function(e) {
                    e.preventDefault();
                    this.style.background = 'none';
                    this.style.outline = 'none';
                    var payload = e.dataTransfer.getData('text/plain');
                    if (!payload || !payload.startsWith('project:')) return;
                    var projId = parseInt(payload.split(':')[1]);
                    if (isNaN(projId)) return;
                    var tk = localStorage.getItem('rhodes_user_token');
                    fetch('/api/user/sessions/' + sid + '/project', {
                        method: 'PUT',
                        headers: { 'Authorization': 'Bearer ' + tk, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ project_id: projId })
                    }).then(function(r) { return r.json(); }).then(function(d) {
                        if (d.success) {
                            if (typeof window.showToast === 'function') window.showToast('Session assigned to project');
                            window._projectNameMap = null;
                            window._loadSessionsUp();
                            window._loadProjectsUp();
                        }
                    });
                }; })(s.session_id);
                div.onmouseover = function() { this.style.background = 'rgba(0,255,65,0.1)'; };
                div.onmouseout = function() { this.style.background = 'none'; };
                var title = s.title || s.session_id || 'Untitled';
                var date = s.updated_at || '';
                if (date) { try { var d = new Date(date); date = d.toLocaleDateString() + ' ' + d.toLocaleTimeString(); } catch(e) {} }
                var projSticker = '';
                var pids = s.project_ids || (s.project_id ? [s.project_id] : []);
                pids.forEach(function(pid) {
                    if (pMap[pid]) {
                        projSticker += ' <span style="display:inline-block;background:rgba(0,255,65,0.15);border:1px solid rgba(0,255,65,0.3);color:var(--green);font-size:11px;padding:1px 5px;border-radius:8px;margin-left:4px;vertical-align:middle;font-weight:700;">' + pMap[pid] + '</span>';
                    }
                });
                var sNum = s.session_number ? ('S' + s.session_number) : ('S' + (idx + 1));
                div.innerHTML = '<div style="color:var(--cyan);font-size:16px;">' + title + projSticker + '</div><div style="font-size:14px;margin-top:1px;"><span style="color:var(--cyan);font-weight:700;margin-right:4px;">' + sNum + '</span><span style="color:var(--dim);">' + date + '</span> <span style="color:var(--green);font-weight:700;">' + (s.message_count||0) + ' msgs</span></div>';
                div.onclick = function() {
                    window.location.href = '/?resume=' + s.session_id;
                };
                results.appendChild(div);
            });
            // Render split session groups at bottom (visible first in drop-up, cyan accent)
            if (groupKeys.length > 0) {
                var splitSection = document.createElement('div');
                splitSection.style.cssText = 'border-bottom:1px solid rgba(0,255,213,0.15);margin-bottom:2px;';
                var splitHeader = document.createElement('div');
                splitHeader.style.cssText = 'padding:6px 10px;color:var(--cyan);font-size:14px;font-family:Orbitron,sans-serif;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:4px;';
                splitHeader.innerHTML = '<span class="sg-arrow">\u25bc</span> SPLIT SESSIONS (' + groupKeys.length + ')';
                var splitBody = document.createElement('div');
                splitBody.id = 'split-sessions-up-body';
                splitHeader.onclick = function() {
                    if (splitBody.style.display === 'none') {
                        splitBody.style.display = 'block';
                        splitHeader.querySelector('.sg-arrow').textContent = '\u25bc';
                    } else {
                        splitBody.style.display = 'none';
                        splitHeader.querySelector('.sg-arrow').textContent = '\u25b6';
                    }
                };
                splitSection.appendChild(splitHeader);
                groupKeys.forEach(function(key, idx) {
                    var group = splitGroups[key];
                    var first = group[0];
                    var ts = first.created_at || '';
                    var dt = ts ? new Date(ts) : null;
                    var dateStr = '';
                    if (dt && !isNaN(dt.getTime())) dateStr = dt.toLocaleDateString() + ' ' + dt.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
                    var totalMsgs = 0;
                    group.forEach(function(gs) { totalMsgs += (gs.message_count || 0); });
                    // Build resume data
                    // Pick one best session per pane: prefer panes with messages, then newest timestamp.
                    var resumeData = {};
                    var paneBest = {};
                    group.forEach(function(gs) {
                        var m = gs.session_id.match(/split-(\d+)/);
                        if (!m) return;
                        var paneNum = parseInt(m[1], 10);
                        var prev = paneBest[paneNum];
                        if (!prev) { paneBest[paneNum] = gs; return; }
                        var prevHasMsgs = (Number(prev.message_count || 0) > 0) ? 1 : 0;
                        var currHasMsgs = (Number(gs.message_count || 0) > 0) ? 1 : 0;
                        var prevTs = Date.parse(prev.updated_at || prev.created_at || '') || 0;
                        var currTs = Date.parse(gs.updated_at || gs.created_at || '') || 0;
                        if (currHasMsgs > prevHasMsgs || (currHasMsgs === prevHasMsgs && currTs > prevTs)) {
                            paneBest[paneNum] = gs;
                        }
                    });
                    Object.keys(paneBest).forEach(function(pn) {
                        resumeData[pn] = paneBest[pn].session_id;
                    });
                    var paneNums = Object.keys(resumeData).map(Number).filter(function(n) { return isFinite(n) && n > 0 && n <= 6; });
                    var resumePaneCount = paneNums.length ? Math.max.apply(null, paneNums) : Math.min(group.length, 4);
                    resumePaneCount = Math.max(2, Math.min(6, resumePaneCount));
                    var gid = 'split-up-group-' + idx;
                    var groupDiv = document.createElement('div');
                    groupDiv.style.cssText = 'padding:4px 10px;border-bottom:1px solid rgba(255,255,255,0.03);';
                    var rowDiv = document.createElement('div');
                    rowDiv.style.cssText = 'display:flex;align-items:center;justify-content:space-between;';
                    var infoDiv = document.createElement('div');
                    infoDiv.style.cssText = 'cursor:pointer;flex:1;';
                    var ssNum = 'SS.' + (idx + 1);
                    // Find first pane title
                    var groupTitle = '';
                    for (var gi = 0; gi < group.length; gi++) {
                        var gt = (group[gi].title || '').trim();
                        if (gt && gt.indexOf('<rhodesia') < 0) { groupTitle = gt; break; }
                    }
                    if (groupTitle.length > 50) groupTitle = groupTitle.substring(0, 50) + '...';
                    infoDiv.innerHTML = '<span class="ss-arrow" style="font-size:13px;color:var(--cyan);margin-right:3px;">\u25b6</span>' +
                        '<span style="font-size:15px;font-weight:bold;color:var(--cyan);margin-right:4px;">' + ssNum + '</span>' +
                        '<span style="font-size:14px;color:var(--cyan);">' + resumePaneCount + '-pane</span>' +
                        '<span style="font-size:14px;color:var(--green);margin-left:4px;font-weight:700;">' + totalMsgs + ' msgs</span>' +
                        (groupTitle ? '<div style="font-size:14px;color:var(--text);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + groupTitle + '</div>' : '') +
                        '<div style="font-size:13px;color:var(--dim);margin-top:1px;">' + dateStr + '</div>';
                    infoDiv.onclick = (function(gidRef, infoRef) { return function() {
                        var el = document.getElementById(gidRef);
                        var arrow = infoRef.querySelector('.ss-arrow');
                        if (el.style.display === 'none') {
                            el.style.display = 'block';
                            if (arrow) arrow.textContent = '\u25bc';
                        } else {
                            el.style.display = 'none';
                            if (arrow) arrow.textContent = '\u25b6';
                        }
                    }; })(gid, infoDiv);
                    var resumeBtn = document.createElement('button');
                    resumeBtn.textContent = '\u25b6 Resume';
                    resumeBtn.style.cssText = 'background:rgba(0,255,213,0.1);border:1px solid var(--cyan);color:var(--cyan);padding:2px 8px;font-size:13px;font-family:Orbitron,sans-serif;border-radius:3px;cursor:pointer;';
                    resumeBtn.onclick = (function(rd, paneCount) { return function(e) {
                        e.stopPropagation();
                        window._multisandboxMode = true;
                        if (typeof window.enterSplitMode === 'function') {
                            window.enterSplitMode(paneCount, rd);
                        } else if (typeof window.enterSplitFromDropdown === 'function') {
                            window.enterSplitFromDropdown(paneCount);
                        }
                        var panel = document.getElementById('sessions-up-panel');
                        if (panel) panel.style.display = 'none';
                    }; })(resumeData, resumePaneCount);
                    rowDiv.appendChild(infoDiv);
                    rowDiv.appendChild(resumeBtn);
                    groupDiv.appendChild(rowDiv);
                    // Expandable pane details
                    var detailDiv = document.createElement('div');
                    detailDiv.id = gid;
                    detailDiv.style.cssText = 'display:none;padding:2px 0 2px 12px;';
                    group.forEach(function(s) {
                        var paneDiv = document.createElement('div');
                        paneDiv.style.cssText = 'padding:3px 0;font-size:14px;color:var(--text);cursor:pointer;';
                        paneDiv.onmouseover = function() { this.style.color = 'var(--cyan)'; };
                        paneDiv.onmouseout = function() { this.style.color = 'var(--dim)'; };
                        var paneMatch = s.session_id.match(/split-(\d+)/);
                        var paneNum = paneMatch ? paneMatch[1] : '?';
                        var pTitle = s.title || ('Pane ' + paneNum);
                        paneDiv.innerHTML = '<span style="color:var(--dim);">\u2514</span> <span style="color:var(--cyan);font-weight:700;">P' + paneNum + '</span> ' + pTitle + ' <span style="color:var(--green);font-weight:700;">(' + (s.message_count || 0) + ' msgs)</span>';
                        paneDiv.onclick = function() { window.location.href = '/?resume=' + s.session_id; };
                        detailDiv.appendChild(paneDiv);
                    });
                    groupDiv.appendChild(detailDiv);
                    splitBody.appendChild(groupDiv);
                });
                splitSection.appendChild(splitBody);
                results.appendChild(splitSection);
            }
            setTimeout(function() { results.scrollTop = results.scrollHeight; }, 50);
        })
        .catch(function() { results.innerHTML = '<div style="padding:12px;color:var(--dim);font-size:15px;">Failed to load</div>'; });
};
document.addEventListener('click', function(e) {
    var panel = document.getElementById('sessions-up-panel');
    var btn = document.getElementById('sessions-up-btn');
    if (panel && panel.style.display === 'flex' && !panel.contains(e.target) && e.target !== btn) {
        panel.style.display = 'none';
    }
});

/* OVERLAY JS DISABLED
(function() {
    var overlay = document.getElementById('chat-overlay');
    var closeBtn = document.getElementById('overlay-close-btn');
    if (!overlay || !closeBtn) return;
    
    // Watch overlay display changes
    var observer = new MutationObserver(function() {
        var vis = overlay.style.display;
        if (vis && vis !== 'none') {
            closeBtn.style.display = 'flex';
        } else {
            closeBtn.style.display = 'none';
        }
    });
    observer.observe(overlay, { attributes: true, attributeFilter: ['style'] });
    
    // Initial sync
    var vis = window.getComputedStyle(overlay).display;
    if (vis && vis !== 'none') {
        closeBtn.style.display = 'flex';
    }
})();
OVERLAY JS DISABLED */
</script>

<script>
// Fixed-position dropdown hover system
(function() {
    function setupFixedDropdown(triggerSel, contentSel, alignRight) {
        var trigger = document.querySelector(triggerSel);
        var content = document.querySelector(contentSel);
        if (!trigger || !content) return;

        // Move content to body so it escapes all stacking contexts
        if (content.parentNode !== document.body) {
            document.body.appendChild(content);
        }
        content.style.position = 'fixed';
        content.style.zIndex = '99999';
        content.style.display = 'none';

        var timer = null;

        function showMenu() {
            if (timer) { clearTimeout(timer); timer = null; }
            var rect = trigger.getBoundingClientRect();
            content.style.top = rect.bottom + 'px';
            if (alignRight) {
                content.style.right = (window.innerWidth - rect.right) + 'px';
                content.style.left = 'auto';
            } else {
                content.style.left = rect.left + 'px';
                content.style.right = 'auto';
            }
            content.style.display = 'block';
        }
        function hideMenu() {
            timer = setTimeout(function() {
                content.style.display = 'none';
                timer = null;
            }, 300);
        }

        trigger.addEventListener('mouseenter', showMenu);
        trigger.addEventListener('mouseleave', hideMenu);
        content.addEventListener('mouseenter', function() {
            if (timer) { clearTimeout(timer); timer = null; }
        });
        content.addEventListener('mouseleave', hideMenu);
    }

    // Account dropdown: trigger is the whole .account-dropdown div, content is .account-dropdown-content
    // Wait for login to show it
    function initAccountDropdown() {
        var ad = document.querySelector('.account-dropdown');
        if (ad && ad.offsetParent !== null) {
            setupFixedDropdown('.account-dropdown', '.account-dropdown-content', true);
        }
    }
    initAccountDropdown();
    var obs = new MutationObserver(function() {
        var ad = document.getElementById('account-dropdown');
        if (ad && ad.style.display !== 'none') {
            initAccountDropdown();
        }
    });
    var adEl = document.getElementById('account-dropdown');
    if (adEl) obs.observe(adEl, { attributes: true, attributeFilter: ['style'] });

    // Lang dropdown
    setupFixedDropdown('.lang-dropdown', '.lang-dropdown-content', false);

    // Language courses hover dropdown (same mechanism as account)
    setupFixedDropdown('#lang-hover-trigger', '#languages-dropdown', false);
})();
</script>
</body>
<script>
// Mobile: toggle typing-active class for voice bar visibility
(function() {
    if (window.innerWidth > 768) return;
    var input = document.getElementById("input");
    if (!input) return;
    function check() {
        var has = input.value.trim().length > 0;
        if (has) document.body.classList.add("typing-active");
        else document.body.classList.remove("typing-active");
    }
    input.addEventListener("input", check);
    input.addEventListener("keyup", check);
    setInterval(check, 300);
})();
</script>
</html>
